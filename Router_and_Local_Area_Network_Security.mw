<!--
Copyright:

   Whonix Computer Security Education wiki page Copyright (C) Amnesia <amnesia at boum dot org>
   Whonix Computer Security Education wiki page Copyright (C) 2012 - 2018 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
   
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 3 of the License, or
   (at your option) any later version.
         
   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.
      
   You should have received a copy of the GNU General Public License
   along with this program; if not, write to:

    Free Software Foundation, Inc. 
    51 Franklin St, Fifth Floor
    Boston, MA 02110-1301, USA.

On Debian GNU/Linux systems, the complete text of the GNU General Public
License can be found in the /usr/share/common-licenses' directory.

The complete text of the GNU General Public License can also be found online on gnu.org <https://www.gnu.org/licenses/gpl.html>, in Whonix virtual machine images in /usr/share/common-licenses/GPL-3 file or on Github <https://github.com/Whonix/Whonix/blob/master/GPLv3>.
-->
<!--
The Whonix Computer Security Education wiki page is forked from the Tails Enable MAC Changer page, from this exact source <http://git.immerda.ch/?p=amnesia.git;a=blob;f=wiki/src/doc/advanced_topics/mac_changer.mdwn;hb=770c6f26f8dcd06452fef1c57dafb2878e0dee11> and on the Tails macchanger page from this exact source <http://git.immerda.ch/?p=amnesia.git;a=blob;f=wiki/src/todo/macchanger.mdwn;hb=f27853e23d7985594d54f00f30153b6acd97312e>.
-->

{{Header}}
{{#seo:
|description=Router and Local Area Network Security, Router Settings and Hardware Configurations
|og:image=https://www.whonix.org/w/images/d/d8/Router.png
}}

= Introduction =

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text       = If the Whonix-Gateway is ever compromised, it can theoretically access any computer in the [https://en.wikipedia.org/wiki/Local_area_network local area network (LAN)].
}}


Based on the threat posed by a Whonix-Gateway compromise, users who have administrator control over the home network are strongly recommended to lock down the web interface of the home router and apply the strictest settings possible.

= The State of Router Insecurity =

Most routers provided by ISPs and those widely available in electronics stores are profoundly insecure, have outdated software and firmware, enable settings by default that open exploit opportunities, and remain vulnerable if users fail to take appropriate steps. <ref name=DEFCON>https://www.defcon.org/images/defcon-18/dc-18-presentations/Heffner/DEFCON-18-Heffner-Routers.pdf</ref>

Many experienced users who are concerned about computing security overlook these problems and instead focus on general operating system and networking solutions, rather than this weak endpoint frequently targeted by attackers, including state-level adversaries. Compromised routers can easily spy on a user's activities, conduct man-in-the-middle attacks, alter unencrypted data, or send the user to websites that masquerade as webmail or on-line banking portals. <ref name=Home_Router_Security>http://www.tomsguide.com/us/home-router-security,news-19245.html</ref>

= Suitable Hardware and Router Configurations =

Experts routinely advise that low-grade routers should be avoided. Cheap models often fail to notify of firmware updates that patch security vulnerabilities, have limitations on password length for administrator access, and typically come as a less-secure, combined modem/router unit. 

Users should consider upgrading to a commercial-grade router that is normally intended for small businesses as a sensible investment in security. Further, it is safer to have a personally owned routing device that connects to an ISP-provided modem/router in order to maximize administrative control over routing and wireless features of the home network. 

Before purchase, check the router has firewall capabilities and that it supports Network Address Translation (NAT), so internal systems cannot be directly accessed from the Internet. Also check whether the router can be configured off-line, which is an advantage. Disconnect or turn-off routers/modems when they are not in use. <ref name=Home_Router_Security /> <ref>http://www.usar.army.mil/Portals/98/Documents/Slicksheet_BestPracticesForKeepingYourHomeNetworkSecure.pdf</ref>

= Accessing Router Settings =

To access and change router settings, the user must type the router's IP address into a web browser address bar and then enter the administrative login and password when prompted. Users who are unsure of the default login credentials can check the list [http://www.routerpasswords.com/ here] and search by manufacturer and model.

Routers usually have a common address like: <code>192.168.1.1</code>, but there are many alternatives depending on the make and model of the router. Check the manual that comes with the router to determine the correct address or alternatively research the manufacturer's website to determine this address. <ref name=Wireless_Lockdown>http://www.pcworld.com/article/243290/how_to_lock_down_your_wireless_network.html</ref>

If users cannot confirm the relevant address to access the router, terminal commands can be used to trace the ip route or various networking tools can be accessed to discover it.

== Linux ==

On Linux operating systems, run the following command in a terminal. <ref>In Qubes-Whonix, this command is run from the NetVM terminal.</ref>

{{CodeSelect|code=
ip route
}}

The output starting with "default via XXX.XXX.XXX.XXX" is the relevant router IP address for changing settings. 

Alternatively, most Linux desktops have a network icon which has this information: <code>Right-click on network icon</code> -> <code>Select "Connection Information" or similar</code>. 

The IP address displayed next to "Default Route" or "Gateway" is the relevant address required. <ref>https://www.howtogeek.com/233952/how-to-find-your-routers-ip-address-on-any-computer-smartphone-or-tablet/</ref>

== macOS ==

In a terminal, run. <ref>https://apple.stackexchange.com/questions/20547/how-do-i-find-my-ip-address-from-the-command-line</ref>

{{CodeSelect|code=
ifconfig
}}

This command will show all the interfaces and their respective IP and MAC addresses. 

Alternatively, look for the relevant network settings under: <code>System Preferences</code> -> <code>Network</code> -> <code>TCP/IP (hardwired)</code> or <code>Wi-Fi (wireless) section</code>. <ref>http://osxdaily.com/2011/10/05/find-router-ip-address-mac/</ref>

== Windows ==

To find the router IP address in Windows, open a command prompt.

<code>Start</code> -> <code>Search box</code> -> <code>Type cmd</code>

{{CodeSelect|code=
ipconfig
}}

The output should reveal the relevant IP address next to the "Default Gateway".

Alternatively, look for the relevant network settings under: <code>Control Panel</code> -> <code>Network and Internet</code> -> <code>View network status and tasks</code> -> <code>Left-click on the appropriate connection</code> -> <code>Left-click on "Details"</code>.

The router's IP address is to the right of the IPv4 Default Gateway. Further network and router configuration information can be found [https://mentecuriosa.net/192-168-1-254-entrar-a-la-configuracion-wi-fi-del-router/ here].

= Recommended Router Settings =

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = Many router models do not allow the user to change specific settings discussed in this section.
}}

== General Router Settings == 

To lock down the router, the following settings are recommended: <ref name=DEFCON /> <ref name=Home_Router_Security /> <ref name=Router_Security_Checklist>http://routersecurity.org/checklist.php</ref>  

=== Router Access and Management ===

* Change the default router username and password to something suitably long and random using a [[Passwords#Generating_Unbreakable_Passwords|Diceware passphrase]]. <ref>It may be sensible to tape this on the router so it is not lost in the future.</ref>
* Use the browser's incognito or private mode when accessing the administrative interface so the URL is not saved in the browser history.
* Avoid administrating the router with a smartphone application.
* Disable the HTTP interface and enable the HTTPS interface instead, preferably on a non-standard port. For example: <code>https://192.168.1.1:82</code> instead of <code>http://192.168.1.1</code>
* Disable remote administrative access and administrative access over Wi-Fi. Set administrator access only via wired ethernet connections (not possible with mesh routers).
* Disable all other remote-access protocols like [https://en.wikipedia.org/wiki/Ping_%28networking_utility%29 PING], [https://en.wikipedia.org/wiki/Telnet Telnet] and [https://en.wikipedia.org/wiki/Ssh SSH].
* If offered, disable cloud-based router management because trust is shifted to another person between the user and the router.
* Do not use mesh router systems that do not permit local administrative access.

=== Router Configuration and Services ===

* Change the [https://en.wikipedia.org/wiki/SSID Service Set ID (SSID)] which often leaks router information. Do not use personally identifying information like the apartment number you live in.
* Disable [https://en.wikipedia.org/wiki/NAT_Port_Mapping_Protocol NAT-PMP], since it has similar functionality to UPnP.
* Disable the [http://routersecurity.org/hnap.php Home Network Administrative Protocol] since it allows remote management of network devices.
* Do not bind services to the external interface. 
* Turn off [https://security.stackexchange.com/questions/38631/what-are-the-security-implications-of-enabling-upnp-in-my-home-router Universal Plug and Play (UPnP)], which can allow applications to open ports to external computers.
* If port forwarding is necessary, it should be limited to a source IP address and/or source IP address subnet.
* Set logging to on, if the feature is available. This allows for a record of unsolicited incoming connection attempts, attempted logins and so on.
* Reconfigure the router firewall rules to drop all relevant incoming packets. 
** Firewall ports should be set to "stealth" rather than "closed". This way no response is given to unsolicited external communications from attackers probing the network.

=== Router Firmware ===

Keep router firmware up-to-date at all times for better security. Set the self-updating firmware option if it is available.

=== Router Test ===

Use Gibson Research Corp.'s [https://www.grc.com/shieldsup Shields Up port-scanning service] to test the router for hundreds of common vulnerabilities, most of which can be mitigated by the router's administrator.

== Wireless Network Router Settings == 

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text       = 
'''Warning:''' [https://kryptera.se/assets/uploads/2017/10/usenix2016-wifi.pdf Recent research] suggests that WPA2 encryption may be broken. <ref>Due to flawed 802.11 random number generation (generating insufficient entropy), downgrade attacks on group keys transmitted in the 4-way handshake (forcing usage of RC4 encryption), decryption of the 128-bit group key, and injection of group traffic into unicast traffic. This means unicast wifi traffic can be decrypted.</ref> Although various countermeasures are reported in the literature and Linux distributions have already patched relevant software, users who require greater security may wish to disable Wi-Fi completely on their systems. <ref><blockquote>We tested this attack against an Asus RT-AC51U and a laptop running Windows 7. The group key was obtained by exploiting the weak random number generator as discussed in Section 3.4.1. In order to successfully perform the ARP poisoning attack against Windows, we injected malicious ARP requests. First, we were able to successfully inject the ARP packets using the group key. This confirms that the group key can be used to inject unicast packets. Once we poisoned the ARP cache of both the victim and router, they transmitted all their packets towards the broadcast MAC address. At this point we were able to successfully decrypt these broadcast packets using the group key, and read out the unicast IP packets sent by both the victim and router.</blockquote></ref>
}}


The following wireless settings are recommended: <ref name=Home_Router_Security /> <ref name=Wireless_Lockdown /> <ref name=Router_Security_Checklist />

=== Wi-Fi Configuration and Services ===

* Do not bother disabling SSID broadcasting since it is trivial to guess.
* Enable the "Block WAN Requests" option to conceal the network from other Internet users.
* Enable MAC Filtering so only specific devices may connect to the network.
* Limit the number of [https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol Dynamic Host Configuration Protocol (DHCP)] leases (connects) to the Wi-Fi network to match the number of personal devices owned.
* If you must allow use of the Wi-Fi network to visitors, set up a guest network that turns itself off after a set period.
* Use the 5-GHz band for Wi-Fi instead of the standard 2.4GHz band (if possible), since the 5 GHz band does not travel as far.
* If possible, schedule Wi-Fi networks to turn off at night and then turn on in the morning.

=== Wi-Fi Protocols ===

* Disable [https://en.wikipedia.org/wiki/Wi-Fi_Protected_Setup Wi-Fi Protected Setup (WPS)] because it allows any device to connect to the network with the relevant eight-digit PIN.
* Do not rely on the [https://en.wikipedia.org/wiki/Wired_Equivalent_Privacy WEP] and [https://en.wikipedia.org/wiki/Wi-Fi_Protected_Access WPA] standards which are cryptographically weak and have known security weaknesses. Use the [https://en.wikipedia.org/wiki/WPA2 WPA2] standard so only authorized users can use the network. <ref>Usually the WPA2 Personal standard is fine; the WPA2 Enterprise version is only required for businesses.</ref>
* Use routers that exclusively use WPA2, preferably with the AES standard (CCMP) and not TKIP which is less secure.

== Router Firmware ==

Strong consideration should be given to flashing the wired/wireless router with an open-source GNU/Linux distribution. Solutions such as [https://wiki.openwrt.org/ OpenWrt] and [https://www.dd-wrt.com/site/ DD-WRT] provide firmware that is suitable for a large variety of wired and wireless routers and embedded systems. 

The strengths of this approach are openness, regularly updated firmware images, a great number of functionalities (fully-featured), less bloat and more control over router behavior. The downside is that open-source firmware is  not free of bugs; careful research is required before attempting this procedure. Check the online guides for instructions on how to proceed and whether the home router is compatible with the available firmware.

= Network Security =

The router, router settings and firmware considerations above are insufficient to protect users who are actively targeted by advanced adversaries. Only a small minority of Whonix users need to apply the configurations found in this section.

== Introduction ==

Unfortunately, installing open source firmware on the single (untrusted) modem-router provided by the ISP is impossible for many users due to technical limitations, lock-down of the device, or incompatibility with open source firmware. Nevertheless, for utmost caution assume that any router provided by the ISP provider is unsafe out of the box. <ref>That is, potentially "back-doored".</ref> Similarly, distrust ''any'' router which comes pre-installed with proprietary firmware (which is nearly always the case). 

IC disclosures in the past decade suggest advanced implants  are targeting all common router makes and models, with this practise widespread. In some cases, large corporate providers are suspected of installing malicious, proprietary firmware with known vulnerabilities. In effect, Man-in-the-middle attacks have progressed to "Man-in-the-modem" attacks -- a logical approach, since this network end-point is notoriously weak and often overlooked by amateurs. <ref>This active surveillance technique is also far easier, reliable and likely to reap a near 100% collection rate from the target.</ref> 

It is expected that advanced implants and attacks (like MINERALIZE and RADON) enable adversaries to directly access the LAN while being inside the firewall. In the worst-case scenario, the following attacks are feasible: <ref name=router_hack>https://wikispooks.com/w/images/9/96/Full-Disclosure.pdf</ref>

* Fingerprinting of all hardware for specific protocols, software versions and MAC address.
* Man-in-the-middle attacks on HTTPS, SSH, UDP or GRE, PPTP, IPSec etc.
* Compromise of SSL certificates in real time.
* Theft of private keys.
* Uploading / downloading of content via the public ISP network.
* Marking of Tor packets leaving the computer and before they enter the Tor network to improve traffic analysis. <ref>Or even potentially redirecting Tor traffic to dedicated Tor network hosted by the attacker.</ref>
* Launching attacks to hack, disable or destroy the host OS.
* Other malicious activity like key loggers, screen loggers and so on.

See additional footnote. <ref><blockquote>
It is imperative to protect the fact that GCHQ, NSA and their Sigint partners have capabilities against specific network security technologies as well as the number and scope of successes. These capabilities are among the Sigint community’s most fragile, and the inadvertent disclosure of the simple “fact of” could alert the adversary and result in 
immediate loss of the capability.

Consequently, any admission of “fact of” a capability to defeat encryption used in specific network communication technologies or disclosure of details relating to that capability must be protected... The various types of security covered by BULLRUN include, but are not limited to, TLS/SSL, https (e.g. webmail), SSH, encrypted chat, VPNs and encrypted VOIP.</blockquote></ref>

== Advanced Network Configuration ==

For the above-mentioned reasons, a small minority of Whonix users who <u>expect to be subject to targeted attacks</u> should: <ref name=router_hack />

# Distrust all ISP-supplied equipment - place it in a militarized zone.
# Not rely on built-in features of ISP equipment like firewalls and VPNs.
# Distrust closed source firmware and devices which do not allow flashing of open source firmware.
# Always use a second router and Linux firewall which is under your control - the router must be flashed with open source firmware.
# Control all NAT on the second Linux firewall.
# <u>Experts only:</u>
** Ensure that <u>all</u> packets are encrypted when leaving the second firewall (see Outbound Defense further below).
** Configure a VPN where Squid proxy and DNS are run, with all inbound access denied except from the VPN. Logging must also be disabled.

=== Inbound Defense ===

'''Figure:''' ''Inbound Defense Configuration'' <ref name=router_hack />

[[File:Inbound_defense.png]]

Key steps: <ref name=router_hack />

* Note the second Linux firewall is placed in front of the ISP router - placing it in a militarized zone.
* A single cable connects the LAN of the ISP router to the Internet LAN port of the Linux firewall.
* Block all inbound access, including multicast packets from the ISP router.
* Run DHCP and NAT on the Linux firewall.

This configuration allows the second firewall to issue PPPOE requests via its Internet port and create a local <code>ppp0</code> device, which is its new Internet connection. All packets leaving the firewall will now be PPPOE encapsulated (encrypted).

=== Outbound Defense ===

'''Figure:''' ''Outbound Defense Configuration'' <ref name=router_hack />

[[File:Outbound_defense.png]]

Key steps: <ref>Which provide necessary protection for Tor clients.</ref> <ref name=router_hack />

* Control, own or rent a server or VM elsewhere on the Internet which is far away from the ISP - preferably in another country.
* Run OpenVPN between the Linux Firewall (blue) and the VPS server (green cloud).
* Run Squid Proxy and DNS on the VPS server and block all inbound access, except from the VPN.

=== Further Reading ===

The following sources provide evidence for various advanced backdoors and network attacks outlined in this section:

* [https://cryptome.org/2013/12/nsa-ant-firewalls.pdf Firewalls]
* [https://cryptome.org/2013/12/nsa-ant-router.pdf Routers]
* [https://cryptome.org/2013/12/nsa-qfire.pdf QFIRE Attack Networks]
* [https://cryptome.org/2013/09/nsa-bullrun-2-16-guardian-13-0905.pdf BULLRUN-NSA]
* [https://cryptome.org/2013/09/nsa-decrypt-guardian-13-0905.pdf EDHEHILL]
* [https://cryptome.org/2013/09/nsa-bullrun-brief-nyt-13-0905.pdf BULLRUN-GCHQ]
* [https://cryptome.org/2013/12/full-disclosure-comments.htm Public comments]

= References =
{{reflist|close=1}}

= License =
{{License_Amnesia|{{FULLPAGENAME}}}}

{{Footer}}

[[Category:Documentation]]
