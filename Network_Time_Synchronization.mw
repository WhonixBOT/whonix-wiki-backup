{{Header}}
<!--
Copyright:

   Whonix Advanced Security Guide wiki page Copyright (C) Amnesia <amnesia at boum dot org>
   Whonix Advanced Security Guide wiki page Copyright (C) 2012 - 2017 Patrick Schleizer <adrelanos@riseup.net>
   
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 3 of the License, or
   (at your option) any later version.
         
   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.
      
   You should have received a copy of the GNU General Public License
   along with this program; if not, write to:

    Free Software Foundation, Inc. 
    51 Franklin St, Fifth Floor
    Boston, MA 02110-1301, USA.

On Debian GNU/Linux systems, the complete text of the GNU General Public
License can be found in the /usr/share/common-licenses' directory.

The complete text of the GNU General Public License can also be found online on gnu.org <https://www.gnu.org/licenses/gpl.html>, in Whonix virtual machine images in /usr/share/common-licenses/GPL-3 file or on Github <https://github.com/Whonix/Whonix/blob/master/GPLv3>.
-->
<!--
Wiki pages found in the Advanced Security Guide contain material from the Tails Protection against cold boot attacks page; see: <http://git.immerda.ch/?p=amnesia.git;a=blob;f=wiki/src/doc/advanced_topics/cold_boot_attacks.mdwn;hb=d249db72228b498407d85fb762b49ec155871ded>.
-->
{{#seo:
|description=Network Time Synchronization
|og:image=https://www.whonix.org/w/images/e/e7/TineSynchronization2134234.jpg
}}

= Introduction =

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text       = '''Warning:''' Users should understand that the system clock inside Whonix is set to UTC to prevent against time zone leaks. This means it may be a few hours ahead or behind the user's host system clock. <i>It is strongly recommended not to change this setting.</i>
}}

= Block Networking until sdwdate Finishes =

{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = [[sdwdate-gui]] is effectively unused in Qubes, since it is not yet automatically started due to usability issues. <ref>https://phabricator.whonix.org/T534</ref> <ref>It is installed by default, and is functional when manually started. Users should check back at a later date for further news on sdwdate-GUI development.</ref> 
}}

[[sdwdate]] is functional, but there are cases where time leaks might occur before the time is changed; for example, when Tor Browser is being used before sdwdate succeeded, information relating to time or other servers, daemons, or client programs. <ref>https://phabricator.whonix.org/T533</ref> In this case, the user is only left with the protections afforded by [[Boot Clock Randomization]]. <ref>
[[Dev/TimeSync#Block_Networking_until_sdwdate_Finishes]]
</ref>

== All Whonix Users ==

To block network access until [[Sdwdate|sdwdate]] succeeds: <ref>https://forums.whonix.org/t/testers-wanted-blocking-networking-until-sdwdate-finished-status-of-sdwdate-gui/5372</ref> <ref>Time keeping is crucial for security, privacy, and anonymity. sdwdate is a Tor friendly replacement for rdate and ntpdate that sets the system's clock by communicating via onion end-to-end encrypted TCP with Tor onion webservers.</ref> 

{{Open with root rights|filename=
/etc/whonix_firewall.d/50_user.conf
}}

Copy and paste the following text.

{{CodeSelect|code=
firewall_mode=
}}

Save the file and reboot.

== [[Non-Qubes-Whonix]] ==

By default, [[sdwdate-gui]] automatically starts when Whonix-Gateway is booted. This keeps users informed about the status of the Tor network connection and sdwdate's progress, and also helps to test this feature.

== [[Qubes-Whonix]] ==

If users are willing to persist with one sdwdate-gui systray instance per VM, then it is recommended to enable sdwdate-gui autostart. This setting keeps users informed about the status of the Tor network connection and sdwdate's progress, and will help to test this feature.

To configure sdwdate-gui autostart, run.

{{Open with root rights|filename=
/usr/lib/sdwdate-gui/start-maybe
}}

Remove the following code.

<pre style="white-space: pre-wrap;">
if [ -d /usr/lib/qubes ]; then
   ## Do not automatically start sdwdate-gui in Qubes due to various issues.
   ## - https://github.com/QubesOS/qubes-issues/issues/2264
   ## - https://github.com/QubesOS/qubes-issues/issues/2268
   ## - https://phabricator.whonix.org/T534
   exit 0
fi
</pre>

Save and exit.

Developers are designing the next sdwdate-gui version so it can be conveniently enabled. Check back later for further information concerning sdwdate-gui modifications to prevent auto-start.

= Network Time Synchronization =

== Disabling NTP ==

If ISP tampering with NTP is ever confirmed, users are advised to [[Time_Attacks#GNU.2FLinux_Host|disable NTP]] and manually update the host clock out of band, for example, using a watch or [https://en.wikipedia.org/wiki/Atomic_clock atomic clock]. If the tampering is targeted and not a widescale attack, then the user already has much bigger problems to worry about than NTP; see [[Warning#Confirmation_Attacks|Confirmation Attacks]].

If users follow the advice at the link above to disable NTP on the host and manually adjust the clock out of band, this might make clearnet traffic more fingerprintable. <ref>See the [[Fingerprint]] page to discover what fingerprinting means in this case.</ref> The reason is that it introduces a device issuing clearnet traffic (such as OS updates), but without the use of NTP. It is unknown how many people have NTP which is deactivated, broken, uninstalled, or never in fact installed in the first place. Also unknown is how many people are using alternative time synchronization methods such as authenticated NTP, tails_htp, tlsdate or similar. However, search engine research suggests that very few people fall into both these categories.

== NTP Issues ==

The host system clock synchronization mechanism still uses unauthenticated NTP from a single source. This is not optimal, but there is no real solution to this problem. <ref>See Design: [[Dev/TimeSync]].</ref> A potential attack vector is created by this NTP behavior; the ISP and/or time server could either inadvertently or maliciously introduce a significant clock skew, or the host clock could simply malfunction.

If the host clock value is grossly inaccurate -- more than one hour in the past or more than 3 hours in future -- Tor cannot connect to the Tor network. <ref>In this case, Tor cannot verify the Tor consensus.</ref> This is easily solved by manually fixing the clock on the host, then powering the Whonix-Gateway (<code>sys-whonix</code>) off and on again.

Another side effect of a significantly inaccurate host clock concerns operating system (OS) updates and cryptographic verification on the host. Until the host clock is manually fixed, it may no longer be possible to download updates or verify SSL certificates correctly with the host browser.

Users should always check whether a host clock defect relates to an empty battery before assuming the ISP is tampering with NTP.

== Saving or Suspending the VM State ==

When a user suspends or saves the VM state, the clock will stop and continue after resuming, leading to a time that lags behind the correct value. This can cause later Tor connectivity problems or introduce possible adverse anonymity impacts.

The Whonix-Gateway (<code>sys-whonix</code>) state should not be suspended or saved. It is far better to  power it off when it is no longer needed. <ref>If this advice is ignored, Tor can become confused if the time is more than 1 hour in the past or more than 3 hours in the future. When this happens, Tor will only reconnect to the Tor network if the clock is manually fixed, or powered off and on again.</ref> 

Similarly, if users  suspend or save the Whonix-Workstation (<code>anon-whonix</code>) state, the clock will again lag behind the correct value. This can be manually fixed by running: <code>Start Menu</code> -> <code>Applications</code> -> <code>System</code> -> <code>Time Synchronization Monitor (sdwdate-gui)</code> -> <code>restart sdwdate</code>.

For further detailed information on network time syncing on all Whonix platforms, see [[Post_Install_Advice#Network_Time_Syncing|here]].

= Spoof the Initial Virtual Hardware Clock Offset  =

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = '''Tip:''' Spoofing the initial virtual hardware clock offset is useful to prevent [[Dev/TimeSync#Clock_Correlation_Attack|Clock Correlation Attacks]].
}}

== KVM ==
<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
For KVM, click on Expand on the right.
<div class="mw-collapsible-content">
[[KVM#XML_Modification_.28OPTIONAL.29|Edit the VM xml before import]] or [[KVM#Editing_an_imported_Machine.27s_XML_Configuration|edit the VM xml after import]] and change the following setting.
{{CodeSelect|code=
<clock offset='utc'>
}}
To.

{{CodeSelect|code=
<clock offset='variable' adjustment='123456' basis='utc'>
}}

The <code>adjustment</code> attribute takes any arbitrary value for seconds. The user must pick a random value that is unknown to others, ranging between 0 and 900 (a 15 minute range).
</div>
</div>

== Qubes ==

TODO

Unfortunately, it is not yet possible to set a random clock offset for Qubes-Whonix VMs to prevent clock correlation attacks since it is [https://phabricator.whonix.org/T440 unsupported by Xen]. A related issue is [https://phabricator.whonix.org/T389 denying Qubes-Whonix access to "clocksource=xen"], which may not be possible without Linux kernel and/or Xen patches. For a detailed discussion of these issues, see [https://groups.google.com/forum/#!topic/qubes-devel/aN3IOv6JmKw here].

== VirtualBox ==
<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
For [[VirtualBox]], click on Expand on the right.
<div class="mw-collapsible-content">
VirtualBox has a feature to spoof the initial virtual hardware clock offset by setting the clock X milliseconds in the future or past. The syntax is outlined below.

{{CodeSelect|code=
VBoxManage modifyvm <name> --biossystemtimeoffset -<milliseconds>
VBoxManage modifyvm <name> --biossystemtimeoffset +<milliseconds>
}}

It is prudent to add a random delay within the following range.

{{CodeSelect|code=
VBoxManage modifyvm <name> --biossystemtimeoffset -60000
VBoxManage modifyvm <name> --biossystemtimeoffset +60000
}}

A spoofing example is below. Users should select their own unique and random values for both the past (-) and future (+) within the specified range. Different values should be used for each distinct VM (on the host).

{{CodeSelect|code=
VBoxManage modifyvm "Whonix-Gateway" --biossystemtimeoffset -35017
VBoxManage modifyvm "Whonix-Gateway" --biossystemtimeoffset +27931

VBoxManage modifyvm "Whonix-Workstation" --biossystemtimeoffset -35017
VBoxManage modifyvm "Whonix-Workstation" --biossystemtimeoffset +27931
}}

Apart from this small <code>biossystemtimeoffset</code>, a clock skew always degrades privacy. <ref><code>biossystemtimeoffset</code> is used to unlink the virtualizer's initial clock synchronization of the VM from the host clock.</ref> <ref>After powering on a VM, it initially synchronizes the VM clock with the host clock until Whonix Timesync adjusts it.</ref> <ref>Clock skews can lead to linkability, meaning the user would be [[DoNot#Confuse_Anonymity_with_Pseudonymity|pseudonymous rather than anonymous]].</ref>

</div>
</div>

= Summary =

'''All Platforms'''

* Always run [[Sdwdate|secure]] [[Sdwdate-gui|network time synchronization]] after suspending or saving the VM state and resuming it. Preferably do not use the suspend, save and resume functions at all.
* For greater security, [[#Block_Networking_until_sdwdate_Finishes|Block Networking Until sdwdate Finishes]].
* Tor cannot connect if the host clock is grossly inaccurate. In this case, users should manually fix the host clock, before powering the Whonix-Gateway (<code>sys-whonix</code>) off and on again.
* Users should periodically check the host clock to ensure that it is accurate, or approximately so.


'''Non-Qubes-Whonix'''

* Only [[#Spoof_the_Initial_Virtual_Hardware_Clock_Offset|spoof the initial virtual hardware clock offset]] after importing the VM.


'''Qubes-Whonix'''

* Consider enabling [[#Qubes-Whonix|sdwdate-gui autostart]] to remain informed about the status of the Tor network connection and sdwdate's progress.


It is also recommended to read the [[Dev/TimeSync|TimeSync Technical Design chapter]], even though it is a difficult topic. Interested users, developers and auditors should review the footnotes immediately below for additional information, or to explore design elements and the reasoning for this entry.

= Deactivate Automatic TimeSync =

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text       = 
'''Warning:''' This action is recommended against and is usually not required. In all cases, first check with the Whonix developers.
}}

To deactivate sdwdate, run.

{{CodeSelect|code=
sudo service sdwdate stop
}}

{{CodeSelect|code=
sudo systemctl mask sdwdate
}}

= Footnotes =
{{reflist|close=1}}

= License =
{{License_Amnesia|{{FULLPAGENAME}}}}

{{Footer}}

[[Category:Documentation]]
