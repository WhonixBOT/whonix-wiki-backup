{{Header}}
{{#seo:
|description=How to Upgrade from Whonix 13.x to Whonix 14.x
|og:image=https://www.whonix.org/w/images/d/d3/Upgrade.jpg
}}

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text       = '''TESTERS ONLY!'''
}}

= High Level Overview =
1. Backup your data - ideally have a copy of the VM so it is possible to try again (if necessary). <br />
2. Consider running the optional [[#Sanity Tests]]. <br />
3. Upgrade Whonix-Workstation. <br />
4. Power off Whonix-Workstation. <br />
5. Upgrade Whonix-Gatway. <br />
6. Restart Whonix-Gateway. <br />
7. Restart Whonix-Workstation. <br />

= Sanity Tests =
<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
These are optional, but recommended. To complete sanity tests, please press on expand on the right.
<div class="mw-collapsible-content">
{{CodeSelect|code=
sudo dpkg --audit ; echo $?
}}

Expected output.

{{CodeSelect|code=
0
}}

{{CodeSelect|code=
sudo dpkg --configure -a ; echo $?
}}

Expected output.

{{CodeSelect|code=
0
}}

[[Security_Guide#Updates|Get package upgrades.]]

{{CodeSelect|code=
sudo apt-get update
}}

{{CodeSelect|code=
sudo apt-get dist-upgrade
}}

For testing purposes, install python-qt4.

{{CodeSelect|code=
sudo apt-get install python-qt4 ; echo $?
}}

{{CodeSelect|code=
## ... successful installation of python-qt4 ...
0
}}
</div>
</div>

= Upgrading =

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = Downloading a new Whonix-Gateway / Whonix-Workstation is easier than applying the following upgrade instructions, but this process should be relatively smooth.
}}


Both [[Non-Qubes-Whonix]] and [[Qubes-Whonix]] are supported.

First consider completing the [[#Sanity Tests]] described above; the system is checked for obvious and grave issues that must be fixed before attempting an upgrade. For example, if the package manager is broken due to the mixing of packages from both Debian stable and Debian testing, then the upgrade may fail part way through, leaving the system in an unstable state that is difficult to resolve.

Consider retaining the full terminal (Konsole) log. Even if the upgrade appears successful, there might be issues following reboot. To properly report a bug in the Whonix forums it is necessary to share the upgrade log so the issue can be investigated.

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = <u>If you are using Qubes-Whonix</u>: If Qubes R3.0 or R3.1 is used as the host operating system, it is strongly advised to upgrade the VMs and dom0 to R3.2 before proceeding. Only Qubes R3.2 and R4 are currently supported. <ref>https://www.qubes-os.org/downloads/</ref> Follow the [https://www.qubes-os.org/doc/upgrade-to-r3.2/ Qubes R3.1 > R3.2 upgrade instructions on the Qubes website].
}}


First, [[Security_Guide#Updates|upgrade]] the system's packages from Debian.

-----

TODO

Backup the Tor config file.

[[Non-Qubes-Whonix]] users:

{{CodeSelect|code=
sudo cp /etc/tor/torrc ~/
}}

[[Qubes-Whonix]] users:

When upgrading the TemplateVM, <code>/etc/tor/torrc</code> in the Whonix-Gateway TemplateBased ProxyVM (commonly called <code>sys-whonix</code>) will not be modified, because bind-dirs makes it persistent.

-----

Update Whonix apt sources list.

{{CodeSelect|code=
sudo whonix_repository --enable --codename stretch
}}

Update Debian apt sources list.

{{CodeSelect|code=
sudo sed -i "s/jessie/stretch/g" /etc/apt/sources.list.d/debian.list
}}

[[Qubes-Whonix]] only. Update Qubes apt sources list.

{{CodeSelect|code=
sudo sed -i "s/jessie/stretch/g" /etc/apt/sources.list.d/qubes*.list
}}

Become root.

{{CodeSelect|code=
sudo su
}}

Enable extensive debugging so the reporting of any eventual bugs is easier.

{{CodeSelect|code=
export DEBDEBUG=1
}}

{{Update}}

{{CodeSelect|code=
apt-get update
}}

Upgrade torsocks and usability-misc first. <ref>
This avoids some torsocks warnings due to the torsocks upgrade.
</ref> <ref>
Provides apt-get-noninteractive.
</ref>

{{CodeSelect|code=
apt-get install torsocks usability-misc
}}

Upgrade.

{{CodeSelect|code=
apt-get-noninteractive dist-upgrade
}}

Purge packages which are not required or deprecated in Whonix and have been replaced by new functionality. <ref>
sysfsutils - https://github.com/Whonix/Whonix/commit/d7cb15aa96bd571368b54f8a980922d9e1982250
</ref> anon-shared-kde-accessibility can be removed from the following command if accessibility tools are in use.

{{CodeSelect|code=
apt-get purge anon-shared-kde-accessibility iceweasel firefox-esr exim* unattended-upgrades cups control-port-filter-python packagekit at wpasupplicant apparmor-profile-sdwdate apparmor-profile-whonixcheck
}}

Restart whonix-legacy service. <ref>
A manual restart is required because apt-get-noninteractive is being used. This step is not crucial since it would also run after reboot.
</ref>

{{CodeSelect|code=
service whonix-legacy restart
}}

[[Update]] the package lists again. <ref>
This is required because the Whonix repository URI has been upgraded to a new location by the whonix-legacy package.
</ref>

{{CodeSelect|code=
apt-get update
}}

<div class="toccolours mw-collapsible mw-collapsed">
<u>[[Non-Qubes-Whonix]] users</u> please click on expand on the right.
<div class="mw-collapsible-content">
{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = Non-Qubes-Whonix Whonix-Gateway only!
}}


{{CodeSelect|code=
apt-get install non-qubes-whonix-gateway
}}

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = Non-Qubes-Whonix only! Whonix-Workstation only!
}}


{{CodeSelect|code=
apt-get install non-qubes-whonix-workstation
}}
</div>
</div>

<div class="toccolours mw-collapsible mw-collapsed">
<u>[[Qubes-Whonix]] users</u> please click on expand on the right.
<div class="mw-collapsible-content">
{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = Qubes-Whonix only! Whonix-Gateway only!
}}


{{CodeSelect|code=
apt-get install qubes-whonix-gateway
}}

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = Qubes-Whonix only! Whonix-Workstation only!
}}


{{CodeSelect|code=
apt-get install qubes-whonix-workstation
}}

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = Qubes-Whonix Whonix-Workstation only! Only when you upgrade from Qubes R3.2 to Qubes R4!
}}


{{CodeSelect|code=
apt-get install pulseaudio-qubes
}}
</div>
</div>

<!--
If snapshots or backups of the VM were not made, then at least /boot should be backed up.

{{CodeSelect|code=
cp -a /boot /boot.back
}}

Remove the old versions of initrd and create new ones with dracut.

{{CodeSelect|code=
rm /boot/initr*
dracut --regenerate-all
}}

Update GRUB.

{{CodeSelect|code=
update-grub
}}
-->

Remove packages which are no longer required.

{{CodeSelect|code=
apt-get autoremove
}}

Reinstall whonix-firewall. <ref>
This is because of the whonix-gw-firewall / whonix-ws-firewall to whonix-firewall package migration.
</ref>

{{CodeSelect|code=
apt-get install --reinstall whonix-firewall
}}

Systemctl unmask whonix-firewall.

{{CodeSelect|code=
systemctl unmask whonix-firewall
}}

Systemctl enable whonix-firewall.

{{CodeSelect|code=
systemctl enable whonix-firewall
}}

Delete files which are no longer required. <ref>
tor-controlport-filter was replaced by onion-grater. This deletion is of minor importance. (Only results in a useless apparmor profile.)
</ref>

{{CodeSelect|code=
sudo rm /etc/apparmor.d/usr.lib.tor-controlport-filter
}}

Remember to store the terminal (Konsole) log: <code>File</code> -> <code>Save Output As</code>

A poweroff is required.

{{CodeSelect|code=
poweroff
}}

* <u>Non-Qubes-Whonix users</u>: All necessary steps are now complete.
* <u>Qubes-Whonix users</u>: <u>In Dom0</u>

{{CodeSelect|code=
sudo qubesctl state.sls qvm.anon-whonix
}}

Only complete the next step if all upgrades should be routed through <code>sys-whonix</code>. <ref>
https://github.com/QubesOS/qubes-mgmt-salt-dom0-virtual-machines/blob/master/qvm/updates-via-whonix.sls
</ref>

{{CodeSelect|code=
sudo qubesctl state.sls qvm.updates-via-whonix
}}

The upgrade procedure is now complete.

= Update Settings in Qubes R4 =
{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = Qubes-Whonix only!
}}


After successfully cloning <code>whonix-gw</code> to <code>whonix-gw-14</code> and <code>whonix-ws</code> to <code>whonix-ws-14</code>, some users will want to configure a new <code>sys-whonix-14</code> ProxyVM and have TemplateVMs use it for future updates. Follow these steps below.

'''1.''' [[Template:Qubes_Create_Gateway_ProxyVMs|Create a new Proxy-VM]] using the <code>whonix-gw-14</code> template. Label the new VM "sys-whonix-14".<br /> 
'''2.''' Edit the ''/etc/qubes-rpc/policy/qubes.UpdatesProxy'' file to set <code>sys-whonix-14</code> as the target VM for the recently upgraded Whonix-Workstation and Whonix-Gateway. Copy and paste the text below.

<pre>whonix-ws $default allow,target=sys-whonix
whonix-ws $anyvm deny
whonix-gw $default allow,target=sys-whonix
whonix-gw $anyvm deny

whonix-ws-14 $default allow,target=sys-whonix-14
whonix-ws-14 $anyvm deny
whonix-gw-14 $default allow,target=sys-whonix-14
whonix-gw-14 $anyvm deny

## Note that policy parsing stops at the first match,
## so adding anything below "$anyvm $anyvm action" line will have no effect

## Please use a single # to start your custom comments

# Default rule for all TemplateVMs - direct the connection to sys-net
$type:TemplateVM $default allow,target=sys-net

$anyvm $anyvm deny</pre>

Save and exit.

'''3.''' After upgrading to Qubes-Whonix 14 in Qubes R4, the network setting for any Whonix TemplateVM should be set to <code>none</code> because a qrexec-based updates proxy is in use. <ref>Qubes-Whonix 13 supports this feature as well after running apt-get dist-upgrade.</ref>

= Footnotes =
<references />

[[Category:Documentation]]

{{Footer}}
