{{Header}}
{{#seo:
|description=Connection Schema: user -> proxy/VPN/SSH -> Tor
}}

== Introduction ==

'''user -> proxy/VPN/SSH -> Tor'''

Read first: [https://trac.torproject.org/projects/tor/wiki/doc/TorPlusVPN Tor Plus VPN or proxy] and [[Whonix:General_disclaimer#Whonix_VPN_disclaimer|Whonix VPN disclaimer]].

Sometimes you are '''forced to use a proxy or VPN''' to make outgoing connections, some ISP's force you, or you are in a LAN with a proxy (router), or in a corperate environment.

A proxy, VPN or SSH can also be possibly

* '''used to circumvent Tor blocks''' or to
* '''hide the fact you are using Tor''', in that case make sure you have read [[Hide Tor and Whonix from your ISP]].

VPN and SSH are preferred choice, as they support secure encryption between you and them. It's a question, how much you can trust the server, they'll see, that you are using Tor, but thanks to Tor, they won't see what you are doing. If you use your own server in a safe country, while you are in a dangerous country, that's probably your best bet. Anyway, not so many people seem to do use a tunnel before they connect to Tor, therefore it's not so well tested, do not rely on it too much.

If nothing above applies for you, skip this section.

== Tunnel Tor through proxy ==
'''user -> proxy -> Tor'''

{{ProxyWarning}}

This means, when using 'http forwarded for' http/https proxies, depending on what you are using, Tor entry guards or Tor [[Bridges|bridges]] could still know your IP.

Tor natively supports proxy settings.

On Whonix-Gateway:

Open your {{Code2|/etc/tor/torrc}}.

<pre>
sudo nano /etc/tor/torrc
</pre>

Depending on your proxy configuration, add the settings you'll need to your {{Code2|/etc/tor/torrc}}. For more information on these settings, have a look in the [https://www.torproject.org/docs/tor-manual.html.en Tor manual] and read the [https://trac.torproject.org/projects/tor/wiki/doc/TorFAQ#MyInternetconnectionrequiresanHTTPorSOCKSproxy. FAQ].

<pre>
HTTPProxy host[:port]
HTTPProxyAuthenticator username:password
HTTPSProxy host[:port]
HTTPSProxyAuthenticator username:password

Socks4Proxy host[:port]

Socks5Proxy host[:port]
Socks5ProxyUsername username
Socks5ProxyPassword password

FascistFirewall 0|1 

ReachableAddresses ADDR[/MASK][:PORT]… 
ReachableDirAddresses ADDR[/MASK][:PORT]… 
ReachableORAddresses ADDR[/MASK][:PORT]… 
</pre>

'''Note:''' You need to use the IP instead of the hostname (proxy.example.com). If you don't know the IP of your proxy, please run {{Code|nslookup proxy.example.com}} (replace proxy.example.com with the hostname of your actual proxy) in a terminal (Konsole) on your host operating system. Using IP instead of hostname might cause subtle fingerprinting issues, see <ref>https://github.com/Whonix/Whonix/issues/94</ref> for more information.

== Tunnel Tor through SSH ==
''user -> SSH -> Tor''

'''The chapter "Tunnel Tor through SSH" is not fully tested/complete. Please give feedback if it worked for you.''' This doesn't seem to be very popular, no one ever asked about it in over one year.

This chapter is about tunneling Tor through a SSH tunnel.

Setting up the VPN tunnel could be either done on the host or inside Whonix-Gateway.

1. First we have to install the ssh client.

<pre>
sudo apt-get update
sudo apt-get install ssh</pre>

2. Then be sure that your SSH connection itself is working well. SSH to your ssh server using.

<pre>ssh yourusername@your.ssh.server</pre>

3. It's recommended to set up public key authentication.

(TODO: how to create a private and public key)

<pre>cd /home/yourusername</pre>

<pre>mkdir .ssh</pre>

<pre>nano authorized_keys</pre>

Paste line beginning with {{Code|ssh-rsa ...}} (your public key) (TODO: how to create that line).

4.
Terminate SSH connection.

<pre>exit</pre>

Login again using public key authentication. (TODO: how to do that)

5. When that is working install your favorite text mode browser, for example.

<pre>apt-get install lynx</pre>

And test if the shell's external internet connection is working. Try

<pre>lynx check.torproject.org</pre>

You're done with the per-requriements.

Exit your shell.

<pre>exit</pre>

6. Now we will tell the SSH client to start a socks5 proxy server listening on localhost 127.0.0.1 port 1080. The following command has to be run in background (TODO: add line how to do that) on each start up, before Tor starts (TODO: to which file, to do that). It would be wise to activate public key authentication (TODO: how to add private key to use public key authentication).

<pre>
ssh -D 1080 your.ssh.server
</pre>

Now we have to tell Tor to use the new local ssh server.

Open your {{Code2|/etc/tor/torrc}}.

<pre>
sudo nano /etc/tor/torrc
</pre>

And add.

<pre>
## In case SSH tunnel has been setup from Whonix-Gateway.
Socks5Proxy 127.0.0.1:1080

## In case SSH tunnel has been setup on the host.
#Socks5Proxy IP:PORT
</pre>

7. (TODO: if running inside Whonix-Gateway, probably new firewall rules are required.)

8. We are done, from now on, Tor will connect through the SSH server.

== Tunnel Tor through VPN ==
=== Introduction ===
'''user -> VPN -> Tor'''

There are too many different VPN protocols. Too many to add all of them to this guide. However, at least the OpenVPN, that is Libre Software has been documented.

If you are using VPN not,

* '''because you are forced to use VPN by your ISP''', but
* want to '''add an additional layer of protection''', or
* to '''hide the fact that you are using Tor''', in that case make sure you have read [[Hide Tor and Whonix from your ISP]]

then be sure, that your VPN software is secure (ex: use OpenVPN, not pptp).

=== Use a Fail Closed Mechanism ===

This is not a Whonix specific problem. It is a general problem with VPNs. Most users are simply not aware of it. VPN's generally fail open. VPN servers and VPN software can occasionally break down without announcement. This means, if the VPN is unreachable, connections breaks down for whatever reasons and so on, in most cases, you can continue to connect to the internet without the VPN.

In case of Whonix you would be left to the protections provided by Tor. Whonix-Workstation will seamlessly continue to make "direct" connections through Tor once the VPN breaks down. If you are using the VPN only to circumvent the censorship of Tor, you may not care so much. On the other hand, if you believe a VPN improves your security, it would be rational to make sure, the VPN is always used instead only most of the time.

If you want to enforce, that the VPN gets always used:

* Whonix-Gateway: Already includes a fail closed (firewall settings {{Code|VPN_FIREWALL}} setting) mechanism, which is documented below.
* Other operating systems: See [[VPN-Firewall]].

=== How ===
==== Introduction ====
If you are forced to use a VPN server or if you are already using a VPN server, you most likely know how you can connect to it.

You can either add the VPN on the host. Whonix-Gateway will be tunneled through it.

Or you can add the VPN into Whonix-Gateway.

When your VPN is properly set up, all your connections are forced through the VPN first. If you start Tor on top of that, tunneling Tor through the VPN will work.

See also [[TestVPN|Free example VPNs working with Whonix for testing purposes]].

See also [[FAQ#What.27s_the_difference_of_installing_a_VPN_on_the_host_versus_installing_on_Whonix-Gateway.3F|What's the difference of installing a VPN on the host versus installing on Whonix-Gateway?]]

==== VPN on the Host ====
Besides what has been written above already, nothing special is required.

==== VPN on Whonix-Gateway ====
===== How =====

If you want to hide Tor by using a VPN, after install Whonix-Gateway, do the following steps before activating Tor in {{Code|whonixsetup}}.

Have a look at {{Code|/etc/whonix_firewall.d/30_default}}. To open.

<pre>
Start menu -> Applications -> System -> Whonix Default Firewall Settings
</pre>

If you are using a terminal-only Whonix-Gateway, use.

<pre>
nano /etc/whonix_firewall.d/30_default
</pre>

It contains default settings, settings you can use as template (copy and paste) and an interesting comment.

<pre>
## Please use "/etc/whonix_firewall.d/50_user" for your custom configuration,
## which will override the defaults found here. When Whonix is updated, this
## file may be overwritten.
</pre>

Create a file  {{Code|/etc/whonix_firewall.d/50_user}}. If you are using a graphical Whonix-Gateway, use.

<pre>
Start menu -> Applications -> System -> Whonix User Firewall Settings
</pre>

If you are using a terminal-only Whonix-Gateway, use.

<pre>
sudo nano /etc/whonix_firewall.d/50_user
</pre>

Add the following settings. You can skip comments (starting with {{Code|#}}). Unless you are using {{Code|seattle.vpn.riseup.net}} as your VPN service, which we use as an example, you have to adjust the {{Code|VPN_SERVERS}} variable in your config.

<pre>
###########################
## VPN-Firewall Settings ##
###########################

## Make sure Tor always connects through the VPN.
VPN_FIREWALL=1

## IP address of the VPN server.
## Get the IP using: nslookup vpn-example-server.org
## Example: seattle.vpn.riseup.net
## Some providers provide multiple VPN servers.
## You can enter multiple IP addresses, separated by spaces.
VPN_SERVERS="198.252.153.26"

## For OpenVPN.
VPN_INTERFACE=tun0

## Destinations you don not want routed through the VPN.
LOCAL_NET="192.168.1.0/24 192.168.0.0/24 127.0.0.0/8"
</pre>

Reload Whonix's Firewall.

If you are using a graphical Whonix-Gateway, use.

<pre>
Start Menu -> Applications -> System -> Reload Whonix Firewall
</pre>

Or if you are using a terminal-only Whonix-Gateway, use.

<pre>
sudo whonix_firewall
</pre>

Now setup OpenVPN. It should be able to connect. You find some help on setting up OpenVPN on the [[TestVPN]] page.

Enable Tor using whonixsetup.

If you are using a graphical Whonix-Gateway, use.

<pre>
Start Menu -> Applications -> System -> whonixsetup
</pre>

Or if you are using a terminal-only Whonix-Gateway, use.

<pre>
sudo whonixsetup
</pre>

The VPN may not be ready when Tor is attempting to connect, because the VPN connection initialization takes too long. Due to a bug in Tor, it won't keep trying to connect. You may have to manually restart Tor after boot, if whonixcheck reports, that Tor is not fully bootstrapped. The same may be necessary if your VPN software or connection temporarily broke down.

<pre>
Start Menu -> Applications -> System -> Restart Tor

Or.

sudo service tor restart
</pre>

===== Let Tor wait for OpenVPN =====
To improve this situation, if you are using OpenVPN and Debian's init script to automatically start it, add an insserv override to wait for openvpn being started.

Create a new file {{Code|/etc/insserv/overrides/tor}}. If using a graphical Whonix-Gateway.

<pre>
kdesudo kwrite /etc/insserv/overrides/tor
</pre>

Or if using the terminal-only version.

<pre>
sudo nano /etc/insserv/overrides/tor
</pre>

Add the following content.

<pre>
### BEGIN INIT INFO
# Provides:          tor
# Required-Start:    $local_fs $remote_fs $network $named $time
# Required-Stop:     $local_fs $remote_fs $network $named $time
# Should-Start:      $syslog openvpn
# Should-Stop:       $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Starts The Onion Router daemon processes
# Description:       Start The Onion Router, a TCP overlay
#                    network client that provides anonymous
#                    transport.
### END INIT INFO
</pre>

Then apply these changes by running.

<pre>
sudo update-rc.d tor defaults
</pre>

===== Limitations =====

* Only tested with OpenVPN. Most other VPN's have deficiencies anyway.
* DNS (IP address) of VPN server has to be manually resolved. There is technically no way to automatically resolve DNS without making the setup much more complex. The VPN server's IP address should not be resolved over Tor, because that's what you wanted to hide in the first place. Since outside observers will know, that you are connecting to the VPN IP anyway, it is probably save to resolve the DNS over clearnet or by asking the VPN provider if they don't already document their IPs on their website anyway.
* No support for IPv6 yet.

=====  Troubleshooting =====
====== VPN Logs ======
Check your VPN software's logs.

====== VPN Connectivity Test ======
Test if you are able to connect using your VPN.

Login as user {{Code|clearnet}}.

<pre>
sudo su clearnet
</pre>

Try connecting to check.tpo. Note, at time of writing, it looked like, that usaip free trial is probably blocking SSL, therefore it might not work.

<pre>
curl.anondist-orig --tlsv1 --proto =https -H 'Host: check.torproject.org' -k https://38.229.72.22 | grep IP
</pre>

Should show something along "Welcome to sergii". Unfortunately won't echo IP, but will show, that connectivity is functional.

Get back to normal user.

<pre>
exit
</pre>

=====  Leak Tests =====
When you shut down the VPN, neither Tor, nor Whonix-Gateway's whonixcheck/apt-get/etc. nor Whonix-Workstation should be able to connect anywhere anymore.

= Footnotes =
<references />

{{Footer}}

[[Category:Documentation]]
