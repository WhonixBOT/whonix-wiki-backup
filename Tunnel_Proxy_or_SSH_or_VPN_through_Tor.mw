{{Header}}

= Tunnel Proxy/SSH/VPN through Tor =

== Required Knowledge ==

=== Introduction ===

'''user -> Tor -> Proxy/SSH/VPN'''

Read first: [https://trac.torproject.org/projects/tor/wiki/doc/TorPlusVPN Tor Plus VPN or proxy] and [[Whonix:General_disclaimer#Whonix_VPN_disclaimer|Whonix VPN disclaimer]].

You can tunnel through Tor first and add an additional proxy, SSH or VPN hop at the very end of that chain as your "exit relay". The services you connect to, will not know, that you are using Tor <ref>Unless it's a "transparent proxy" in sense of sending http forwarded for, covered in the [https://trac.torproject.org/projects/tor/wiki/doc/TorPlusVPN Tor Plus VPN or proxy] article.</ref>. This can be useful to '''evade Tor bans''', for example, to visit websites or IRC networks who blacklisted Tor. Beware of the risks, this adds a "permanent exit relay", read [https://trac.torproject.org/projects/tor/wiki/doc/TorPlusVPN Tor Plus VPN or proxy].

To do that, go to your Whonix-Workstation and add the proxy, SSH or VPN normally, just like you would do, if you wouldn't use the Whonix-Gateway. Adding your proxy, SSH or VPN inside Whonix-Workstation will, thanks to Whonix-Gateway, result in them getting tunneled over Tor.

Protocol leaks<ref>https://trac.torproject.org/projects/tor/wiki/doc/TorifyHOWTO</ref> still apply, thought to a lesser extend. Leaks would ''only'' leak through Tor and you have best possible [[Protocol-Leak-Protection and Fingerprinting-Protection]].

=== uwt and Tor Browser ===
There are two special cases in Whonix. Applications using uwt and Tor Browser.

Applications using uwt are pre-configured to use Socks Proxy settings. <ref>...and not just TransPort, which is a security feature: [[Stream Isolation]].</ref> You may have to disable the affected uwt wrapper, in case there is one, for the application you want to tunnel. See [[Stream Isolation]] to learn what uwt and uwt wrappers are. You could [[Stream_Isolation#Deactivate_uwt_Stream_Isolation_Wrapper|disable]] them.

If you want to do it with Tor Browser, read [[Tor_Browser#Change/Remove_Proxy_Settings|Change/Remove Proxy Settings]].

=== Malware ===

Also note that once Whonix-Workstation gets rooted by malware, the VPN/SSH/proxy can be easily circumvented by the attacker and you are left to the protections by Whonix and Tor.

=== Leaks ===

If setting up socksifier, proxy settings, transparent proxy with local redirection, SSH tunnel or a VPN in a leak free manner were easy, this means while ensuring nothing will bypass the VPN, SSH or proxy, there would have been no reason to develop Whonix in the first place.

The methods described on this page are all tested and should all more or less work. Should there be any misconfiguration or leak bug, you are left to the protections by Whonix and Tor. This means, the leak will still go through Whonix-Gateway and therefore forced through Tor. The methods on this page are not as safe as a Whonix-Gateway. There were development discussions and some progress<ref>see [[Dev/Inspiration]]</ref>, about chaining multiple Gateways, VPNBOX, JonDoBOX, i2pBOX, FreenetBOX and ProxyBOX, but nothing was finished due to the lack of community interest, support and developers.

=== Web Browser ===

I don't know how anonymous it is to use (proxy/VPN/SSH ->) Tor -> Proxy/VPN/SSH -> Tor Browser -> website. How many people show up with a proxy, VPN or SSH IP using Tor Browser? This setup is so special that I believe only very few people are doing it. For this reason, I recommend against.

On the other hand, due to browser fingerprinting, I can't recommend using any browser other than Tor Browser either.

== Tunnel proxy through Tor ==

'''user -> Tor -> proxy'''

Note that the connection, between the Tor exit relay and the proxy, is in most cases, not encrypted.

=== Proxy Settings Method ===

After understanding the ''Required Knowledge'' chapter above, using proxy settings in Whonix there is no difference from using proxy settings in an ordinary why, other than that it's running inside Whonix-Workstation.

If proxy settings are honored by application or in worst case leak through Tor alone (thanks to Whonix), is another question and not in Whonix's power, see [https://trac.torproject.org/projects/tor/wiki/doc/TorifyHOWTO TorifyHOWTO].

=== Proxyfier Method ===

==== General ====

After understanding the ''Required Knowledge'' chapter above, using a Proxyfier in Whonix there is no difference from using a Proxyfier in an ordinary way, other than that it's running inside Whonix-Workstation.

If the Proxifier is leak free or in worst case leaks through Tor alone (thanks to Whonix), is another question and not in Whonix's power, see [https://trac.torproject.org/projects/tor/wiki/doc/TorifyHOWTO TorifyHOWTO].

==== uwt ====
===== Introduction =====
uwt uses torsocks. While the name implies it's Tor specific, it's not. You can point it to any socks proxy.

===== uwt - wget Example =====
<pre>
## For Tor stream isolation #1
uwt -t 5 -i 192.168.0.10 -p 9153 /usr/bin/wget.real -c https://check.torproject.org

## For Tor stream isolation #2
uwt -t 5 -i 192.168.0.10 -p 9154 /usr/bin/wget.real -c https://check.torproject.org

## For Tor stream isolation #3
## Requires deactivated wget uwt wrapper!
uwt -t 5 -i 192.168.0.10 -p 9155 /usr/bin/wget -c https://check.torproject.org

## Proxy #1
uwt -t 5 -i x.x.x.x -p xxxx /usr/bin/wget.real -c https://check.torproject.org

## Proxy #2
## Requires deactivated wget uwt wrapper!
uwt -t 5 -i x.x.x.x -p xxxx /usr/bin/wget -c https://check.torproject.org
</pre>

<ref>Using .real, i.e. /usr/bin/wget.real will circumvent the wget uwt wrapper.</ref>

For testing, if you didn't disable the wget uwt wrapper, the following command will most likely get another IP, because still using Stream Isolation.

<pre>
## Using Tor's TransPort
## (/usr/bin/wget.real original non-uwt-wrapped version)
wget.real https://check.torproject.org
</pre>

If you [[Stream_Isolation#Deactivate_uwt_Stream_Isolation_Wrapper|disabled]] wget's uwt wrapper, you could use.

<pre>
## Using Tor's TransPort
## Requires deactivated wget uwt wrapper!
wget https://check.torproject.org
</pre>

===== uwt - Tor Browser Example =====
Do not forget to [[Tor_Browser#Change.2FRemove_Proxy_Settings|Remove Proxy Settings]] from Tor Browser.

Then try this command. (Untested! Please leave feedback if it worked for you!)

<pre>
uwt -t 5 -i 192.168.0.10 -p 9153 ~/tor-browser_en-US/App/Firefox/firefox --profile ~/tor-browser_en-US/Data/profile
</pre>

See also the wget example above for more information and usage examples.

Might be also interesting:

* [[Advanced Security Guide#More than one Tor Browser in Whonix]]

==== proxychains ====
===== Warnings =====

* We don't know how well proxychains works. For example <code>torsocks has a IPv6 leak bug</code><ref>https://trac.torproject.org/projects/tor/wiki/doc/torsocks#WorkaroundforIPv6leakbug</ref>. We don't know if proxychains forces everything through the proxies. Whonix only ensures, should their be leaks, they go only through Tor.
* There are at least three different versions of proxychains. The old/original/unmaintained version on sourceforge.net and two forks on github. We don't know about that status of any of them and haven't heard of anyone looking if they do really work as expected. The two authors argue with each other and we weren't motivated to understand the conflict and to determine which version is better. However, any leaks not going through the proxy(chain) will go through Tor.

===== Instructions =====
====== General ======
Install proxychains.

<pre>sudo apt-get install proxychains</pre>

Note the uwt and Tor Browser notice in {{Code2|Required Knowledge}} above first. After you have done so it's quite simple.

Open proxychains configuration file.

<pre>kdesudo kwrite /etc/proxychains.conf</pre>

Go to the bottom of the settings file. Comment out "{{Code2|socks4 127.0.0.1 9050}}" and add for example "{{Code2|socks5 192.168.0.10 9152}}" (for Tor stream isolation) or "{{Code2|socks5 ip port}}" with an IP and port of your choice to set the proxy settings.

<pre>
[ProxyList]
## add proxy here ...
## meanwhile
## defaults set to "tor"
#socks4 127.0.0.1 9050
socks5 192.168.0.10 9152
# socks5 x.x.x.x xxxx
</pre>

Advanced. Recommendation: Why not use Tor stream isolation for the proxychains connection?

<pre>
[ProxyList]
## add proxy here ...
## meanwhile
## defaults set to "tor"
#socks4 127.0.0.1 9050
socks5 192.168.0.10 9152
socks5 x.x.x.x xxxx
</pre>

Safe the configuration file. Test afterwards.

====== test uwt wrapped application ======
For example:

<pre>proxychains /usr/bin/wget.real https://check.torproject.org</pre>

Will do.

For testing, if you didn't disable the wget uwt wrapper, the following command will most likely get another IP. (Stream Isolation)

<pre>
## Using Tor's TransPort
## (/usr/bin/wget.real original non-uwt-wrapped version)
wget.real https://check.torproject.org
</pre>

====== Tor Browser ======
Do not forget to [[Tor_Browser#Change.2FRemove_Proxy_Settings|Remove Proxy Settings]] from Tor Browser.

Then try this command.

<pre>
proxychains ~/tor-browser_en-US/App/Firefox/firefox --profile ~/tor-browser_en-US/Data/profile
</pre>

Might be also interesting:

* [[Advanced Security Guide#More than one Tor Browser in Whonix]]

=== Transparent Proxying ===

==== Introduction ====

To make clear, what this is about. Whonix-Gateway is already serving as a Transparent Proxy <ref>anonymizing middlebox</ref>, which means, that all applications not explicitly configured <ref>by uwt socksifier or proxy settings</ref> to use a SocksPort, can connect through Tor without any settings. The Transparent Proxying chapter on the ''Tunnel Proxy/SSH/VPN through Tor'' page is about configuring Whonix-Workstation also to act as a Transparent Proxy <ref>local redirection</ref>. Use case: a user wants to ensure all traffic goes through Tor (by using Whonix-Gateway) and want to additionally ensure, all traffic goes through a proxy choosen by the user behind Tor, i.e. user -> Tor -> proxy.

<ref>[https://trac.torproject.org/projects/tor/wiki/doc/TorBOX/OptionalConfigurations?version=129#TransparentProxying torproject.org wiki version 129] contains an old example using privoxy, JonDo and httpsdnsd. The new example uses redsocks and is simpler.</ref>

You always have to keep in mind, which kind of data and which kind of proxy you are using. There are CGIproxies, http(s) proxies and socks4/4a/5 proxies.

In case you redirect the network layer directly with iptables, you need a TransPort. Unfortunately very few applications, do offer a TransPort. For example, Tor supports a TransPort. In most other cases, you need to translate the different kinds of data.

Due to the nature of Transparent Proxying, we need to redirect with iptables and end up with a "Trans data stream". Because most proxies are either http or socks we need to translate this. Below we discuss a few tools which help here, not all are required, depending on what you want to do.

Required reading:

* [https://trac.torproject.org/projects/tor/wiki/doc/proxy proxy]
* [https://trac.torproject.org/projects/tor/wiki/doc/TorPlusVPN Tor Plus VPN or proxy]

===== Tools =====

Tor is a socks proxy and also has a TransPort. Unfortunately, Tor can not be directly used as a http proxy. You must also keep in mind, that Tor does not support UDP, although it offers a DnsPort..

[http://darkk.net.ru/redsocks/ redsocks] can also accept "Trans data streams" and can forward them to http'''s''', socks4 and socks5 proxies. If you were to use a http proxy (no https, without connect-method, see proxy article), you could access only http sites, no https sites. Rather redsocks can convert UDP DNS queries to TCP DNS queries.

===== DNS resolution =====

The complication (and also advantage/feature) with transparent proxying is, that the internet application (browser, etc.) is not aware of the proxy. Therefore the internet application will attempt to do the DNS resolution itself using the system, not using the proxy. The DNS requests also must be considered. Since Tor does not support UDP, we have to transmit DNS queries via TCP.

It is impossible to resolve DNS directly on the proxy, when using the proxy as a transparent proxy, see [[Dev/Inspiration#Transparent_Proxying_Method|Transparent Proxying Method]] for explanation. You need an extra DNS server, which answers over TCP.

You have several options to resolve DNS.

Either leave the setup as it is, Tor's DnsPort and therefore the Tor exit relays will still do the DNS requests. (See DNS rule #1.) This is probably not what you want, since you wanted to cloak your identity with an additional proxy after Tor.

Alternatively you can use a public DNS resolver. The instructions for [[Secondary DNS Resolver#DNSCrypt by OpenDNS]] should work out of the box (tested). (See DNS rule #2.) 

All DNS resolvers <ref>https://en.wikipedia.org/wiki/Comparison_of_DNS_server_software</ref> should work, as long TCP is supported and as long you are querying a TCP enabled DNS server. <ref>You can't simply add another public DNS resolver (i.e. OpenDNS or Google) to /etc/resolv.conf in Whonix-Workstation (i.e. Tor -> public DNS resolver), it would have no effect, as explained under [[Install_Software#Whonix-Workstation_is_firewalled|Whonix-Workstation is firewalled]].</ref>  <ref>Also [[Secondary DNS Resolver#httpsdnsd by JonDos]] might work, but you'd need to make some changes (use httpsdnsd as a system wide, Whonix-Workstation wide, DNS resolver, not just for a specific user account).</ref> <ref>DNSCrypt and httpsdnsd add the advantage, that neither the proxy nor the Tor exit relay can sniff or manipulate your DNS requests, since they are encrypted and authenticated.</ref> <ref>Or perhaps also [http://www.mulliner.org/collin/ttdnsd.php ttdnsd] with Google could work.</ref> 

Read the [[Secondary DNS Resolver|DNS related warnings]].

==== HowTo ====

Everything on Whonix-Workstation.

Get a working proxy and test if it works reliable.

Install redsocks.

<pre>
## Untested, easier. Please try and leave feedback.
sudo apt-get install redsocks

## Or compile from git.
#git clone https://github.com/darkk/redsocks.git
## Build latest stable. 0.4 at time of writing. See
## https://github.com/darkk/redsocks/tags for
## most recent tag.
#git tag -v <version>
#compile...
</pre>

Config redsocks. TODO: share config. Shouldn't be hard to do oneself. See [https://github.com/darkk/redsocks/blob/master/debian/redsocks.conf default config]. If you do, please share.

Add user redsocks.

<pre>sudo adduser redsocks</pre>

Start redsocks.

<pre>sudo -u redsocks ./redsocks</pre>

Create a fw.sh and use this firewall rules.

<pre>
#!/bin/bash
## These iptables rules redirect the traffic for all users,
## including root, with the exception of the user redsocks,
## through the proxy.

## TODO: these iptables rules need review.

## Choose either DNS rule #1 or DNS rule #2.

## For debugging/testing use this command in console.
## tail -f /var/log/syslog

## Flush old rules.
iptables -F
iptables -t nat -F
iptables -X

## Allow unlimited traffic on the loopback interface.
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT
iptables -A OUTPUT --dst 127.0.0.1 -j ACCEPT

## Established incoming connections are accepted.
iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

## Established outgoing connections are accepted.
iptables -A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

## DNS rule #1.
## Allow DNS directly through Whonix-Gateway.
#iptables -A OUTPUT --dst 192.168.0.10 -p udp --dport 53 -j ACCEPT

## DNS rule #2.
## For DNSCrypt set /etc/resolv.conf to
## nameserver 127.0.0.1
##
## sudo dnscrypt-proxy --tcp-only --user=user
##
## DNSCrypt listening on port 53
iptables -t nat -A OUTPUT --dst 127.0.0.1 -p udp --dport 53 -j ACCEPT
iptables -t nat -A OUTPUT --dst 127.0.0.1 -p tcp --dport 53 -j ACCEPT

## redsocks must be allowed to establish direct connections.
iptables -A OUTPUT -j ACCEPT -m owner --uid-owner redsocks
iptables -t nat -A OUTPUT -j ACCEPT -m owner --uid-owner redsocks

## Redirect remaining traffic to redsocks.
iptables -t nat -A OUTPUT -p tcp -j REDIRECT --to-port 12345

## TODO: UDP rule untested.
#iptables -t nat -A OUTPUT -p udp -j REDIRECT --to-port 10053

## Log blocked traffic for debugging.
iptables -A OUTPUT -j LOG --log-level 4 --log-prefix "iptables: "

## Reject all other traffic.
iptables -A OUTPUT -j REJECT
</pre>

Make the firewall script executable.

<pre>sudo chmod +x fw.sh</pre>

Apply the firewall rules.

<pre>sudo ./fw.sh</pre>

== Tunnel SSH through Tor ==

'''user -> Tor -> SSH'''

This chapter is not about connecting to a SSH server as a client (see Whonix in general and the Torify HOWTO). It is about adding an extra SSH tunnel after Tor.

Note that even though SSH supports socks5, SSH is still not able to forward UDP on its own. Have a look at the [http://zarb.org/~gc/html/udp-in-ssh-tunneling.html source] of that information. To summarize: to tunnel UDP over SSH client and shell admin need a special setup, which is for most shells, not going to happen.

A SSH tunnel will provide a local socks5 proxy. Create the SSH tunnel in the Whonix-Workstation. From there you'll end up with a local socks5 proxy. You can use this socks5 proxy following the proxy instructions above. Once the SSH tunnel is established, there are not many differences, besides the difference already clarified above about UDP and that the warning about missing encryption to the proxy does not apply to SSH tunnels, since SSH is encrypted. The SSH process needs to be allowed to access the internet directly, if you use transparent proxying, run the SSH process under an account, which is privileged to access the internet directly.

Another untested method may be [https://github.com/apenwarr/sshuttle sshuttle].

== Tunnel VPN through Tor ==

'''user -> Tor -> VPN'''

=== Notes ===

==== UDP ====

Note that you have to choose TCP transport, because Tor does not support UDP.

==== Using TransPort instead of SocksPort is required for Tor -> VPN ====
For applications configured to use SocksPort, instead of TransPort, which is the default setting for most Whonix default applications, such as [[Tor Browser]]...

SocksPort is configured for [[Stream Isolation]]. As [https://trac.torproject.org/projects/tor/wiki/doc/TorPlusVPN Tor Plus VPN or proxy] explains, you have to keep in mind, a VPN behind Tor adds a permanent exit relay.

Rather, all applications, which are configured to use SocksPort, will not be tunneled through the VPN. They will be "only" tunneled through Tor. This is because, the VPN will not touch connections to {{Code2|192.168.0.10}}, which is the Whonix-Gateway. For example, if you wish to tunnel Tor Browser through Tor -> VPN, you have to remove all proxy settings from Tor Browser, see [[Tor_Browser#Change.2FRemove_Proxy_Settings|Change/Remove Proxy Settings]]. Check.torproject.org will tell you then "{{Code2|You are not using Tor.}}" and you'll see your VPN's IP. In fact your VPN was tunneled through Tor first. (Because Whonix-Workstation can not make any non-Tor connections by design, everything is tunneled over Tor.) When you stop your VPN for test reasons ({{Code2|sudo /etc/init.d/openvpn stop}}), it will show "{{Code2|You are using Tor.}}" again.

==== Use a Fail Closed Mechanism ====

This is not a Whonix specific problem. It is a general problem with VPNs. Most users are simply not aware of it. VPN's generally fail open. VPN servers and VPN software can occasionally break down without announcement. This means, if the VPN is unreachable, connections breaks down for whatever reasons and so on, in most cases, you can continue to connect to the internet without the VPN.

Whonix-Workstation will seamlessly continue to make "direct" connections through Tor once the VPN breaks down. If you are using the VPN only to connect to websites which ban Tor, you may not care so much. On the other hand, if you believe a VPN improves your security, it would be rational to make sure, the VPN is always used instead only most of the time.

If you want to enforce, that the VPN gets always used, see [[VPN-Firewall]].

==== VPN and stream isolation ====

While you are using a VPN behind Tor, you probably also may not be able to make use of the stream isolation feature <ref>[https://trac.torproject.org/projects/tor/ticket/3455 Bug #3455: Tor Browser should set SOCKS username for a request based on referer]</ref>, which is planned for Tor Browser. This is because Tor Browser would not talk to Tor directly anymore. Tor Browser would connect to the VPN instead.

==== Identity correlation ====

By design, a VPN routes all your applications (those without any proxy settings, as explained above) through the VPN. You may not want this, as explained above ([[Stream Isolation]]). To circumvent that, you should use this Whonix-Workstation only for the particular application you want to route through the VPN. You are advised to read [[Multiple Whonix-Workstations]].

=== How ===

Just use general instructions on doing so and of course do it inside Whonix-Workstation. Don't forget to read all the notes above. Since everything is routed through Tor, the VPN can be easily tunneled through Tor.

See also [[TestVPN|Free example VPNs working with Whonix for testing purposes]].

= Footnotes / References =
<references/>

{{Footer}}

[[Category:Documentation]]
