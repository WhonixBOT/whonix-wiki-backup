{{Header}}
{{#seo:
|description=Onionizing Repositories Guide
|image=https://www.whonix.org/w/images/f/f9/Onionrepository23234.jpg
}}
{{Maintainer|
|status=stable
|about=About this {{Code2|{{PAGENAME}}}} Page
|difficulty=easy
|maintainer=[https://forums.whonix.org/users/0brand 0brand]
|support=[[Support]]
}}
= Introduction =

When software packages such as from Debian, {{project name}}, Fedora, Qubes are downloaded during installation of new packages or upgrades, by distribution default package repository default settings settings point to download sources using http or https transport protocol, which is non-ideal for security. Download over experimental Tor onion services is available for most platforms.

There are several security and privacy benefits of using Tor onion services: <ref>https://blog.torproject.org/blog/tor-heart-apt-transport-tor-and-debian-onions</ref>

* The user cannot be uniquely targeted for malicious updates - attackers are forced to attack everyone requesting the update.
* The package repository, or observers watching it, cannot track what programs are installed.
* The ISP cannot easily learn what packages are fetched.
* End-to-end authentication and encryption provides protection against man-in-the-middle attacks, like version downgrade attacks.

Be aware that enabling onion repositories may cause system updates to periodically fail due to their [https://forums.whonix.org/t/disable-onions-by-default-due-to-unreliability/6650 unreliability]. If this becomes an issue, users are encouraged to [[Operating_System_Software_and_Updates#Non-functional_Onion_Services|Re-enable Clearnet Repositories]] so packages can be updated.

If the term "comment" is unfamiliar, please follow [https://www.howtogeek.com/118389/how-to-comment-out-and-uncomment-lines-in-a-configuration-file/ this link] to learn how to comment / uncomment lines in a configuration file. 

Below are instructions for users of [[#Debian|Debian]], [[#{{Non_q_project_name}}|{{Non_q_project_name}}]] and [[#Qubes|Qubes]].

----

= Qubes =

Qubes dom0 and VMs can be onionized by editing the repository configuration files so they point to the corresponding onion mirrors. Complete the following steps in [[#dom0|dom0]] and for each template -- not all templates can be completely onionized. The instructions below consider [[#Debian Templates|Debian Templates]], [[#{{project name}} Templates|Whonix <sup>TM</sup> Templates]], and the [[#Fedora Template|Fedora Template]].

== dom0 ==

dom0 can be updated exclusively over onion services.
{{Box|text=
'''1.''' In a dom0 terminal, open the qubes-dom0.repo configuration file in a text editor.

{{CodeSelect|code=
sudo nano /etc/yum.repos.d/qubes-dom0.repo
}}

* comment the lines that contain <code>metalink</code>
* uncomment the lines that contain <code>{{Qubes onion}}</code>

Once completed, each of the four code blocks will have http(s) repository lines similar to the following example.

{{CodeSelect|code=
#baseurl = https://yum.qubes-os.org/r$releasever/current/dom0/fc25
baseurl = http://yum.{{Qubes onion}}/r$releasever/current/dom0/fc25
#metalink = https://yum.qubes-os.org/r$releasever/current/dom0/%DIST%/repodata/repomd.xml.metalink
}}

Save and exit.

'''2.''' In a dom0 terminal, open the qubes-templates.repo configuration file in a text editor.

{{CodeSelect|code=
sudo nano /etc/yum.repos.d/qubes-templates.repo
}}

* comment the lines that contain <code>metalink</code>
* uncomment the lines that contain <code>{{Qubes onion}}</code>

Once completed, each of the two code blocks will have http(s) repository lines similar to the following example. 

{{CodeSelect|code=
#baseurl = https://yum.qubes-os.org/r$releasever/templates-itl
baseurl = http://yum.{{Qubes onion}}/r$releasever/templates-itl
#metalink = https://yum.qubes-os.org/r$releasever/templates-itl/repodata/repomd.xml.metalink
}}

Save and exit.

'''3.''' In dom0 terminal, confirm both onion repositories are functional.

{{CodeSelect|code=
sudo qubes-dom0-update
}}
}}
== Debian Templates ==

Debian templates can be updated exclusively over onion services. Simply edit both Qubes and Debian sources.list files so they point to the respective onion repositories. 

==== Onionize qubes-r4.list ====
{{Box|text=
'''1.''' In Debian TempateVM, open the qubes-r4.list file in a text editor.

{{CodeSelect|code=
sudo nano /etc/apt/sources.list.d/qubes-r*.list
}}

'''2.''' Comment the first line underneath "Main qubes updates repository".

The first code block should look similar to this.

<pre> # Main qubes updates repository
#deb [arch=amd64] http://deb.qubes-os.org/r4.0/vm stretch main
#deb-src http://deb.qubes-os.org/r4.0/vm stretch main</pre>

'''3.''' Uncomment the corresponding line underneath "Qubes Tor updates repositories".

The first code block should look similar to this.

{{CodeSelect|code=
# Qubes Tor updates repositories
# Main qubes updates repository
deb [arch=amd64] http://deb.{{Qubes onion}}/r4.0/vm stretch main
#deb-src http://deb.{{Qubes onion}}/r4.0/vm stretch main
}}

Save and exit.

'''4.''' Confirm the onionized repositories are functional.

{{CodeSelect|code=
sudo apt-get update && sudo apt-get dist-upgrade
}}
}}
==== Onionize Debian sources.list ====

The sources.list file can be edited so it points to the Debian onion mirror. This is a more secure method than clearnet for updates and software installation.
{{Box|text=
{{Onionize Debian Sources.list
|filename=/etc/apt/sources.list
}}
}}
== {{project name}} Templates ==

Whonix templates can be updated exclusively over onion services by editing the Qubes, Debian and Whonix sources.list files so they point to the respective onion repositories. 

Complete the following steps in both {{gateway_product_name}} and {{workstation_product_name}} VMs.

==== Onionize qubes-r4.list ====
{{Box|text=
'''1.''' In {{project name}} TempateVM, open qubes-r4.list in a text editor.

{{CodeSelect|code=
sudo nano /etc/apt/sources.list.d/qubes-r*.list
}}

'''2.''' Comment the first line underneath "Main qubes updates repository".

The first code block should look similar to this.

<pre> # Main qubes updates repository
#deb [arch=amd64] http://deb.qubes-os.org/r4.0/vm stretch main
#deb-src http://deb.qubes-os.org/r4.0/vm stretch main</pre>

'''3.''' Uncomment the corresponding line underneath "Qubes Tor updates repositories".

The first code block should look similar to this.

{{CodeSelect|code=
# Qubes Tor updates repositories
# Main qubes updates repository
deb [arch=amd64] http://deb.{{Qubes onion}}/r4.0/vm stretch main
#deb-src http://deb.{{Qubes onion}}/r4.0/vm stretch main
}}

Save and exit.

'''4.''' Confirm the onionized repositories are functional.

{{CodeSelect|code=
sudo apt-get update && sudo apt-get dist-upgrade
}}
}}
==== Onionize debian.list ====
{{Box|text=
{{Onionize Debian Sources.list
|filename=/etc/apt/sources.list.d/debian.list
}}
}}
==== Onionize whonix.list ====

The Whonix sources.list file can be pointed to its respective v3 onion mirror with a single command.<ref>Take note that while Whonix â„¢ maintains both v2 and v3 onion addresses, it is strongly encouraged to prefer v3 .onion connections which provide additional improvements and security benefits over the v2 legacy system; see https://trac.torproject.org/projects/tor/wiki/doc/NextGenOnions.</ref> For further details on the four repository choices; see [[Project-APT-Repository#Whonix_.E2.84.A2_APT_Repository_Overview|Whonix APT Repository overview]].

In {{project name}} konsole, run.
{{CodeSelect|code=	
sudo whonix_repository --baseuri http://deb.dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion --enable --repository stable
}}

Next confirm onion repositories are functional.

{{CodeSelect|code=
sudo apt-get update && sudo apt-get dist-upgrade
}}

== Fedora Template ==

<u>Note:</u> Updating Fedora templates exclusively over [[Onion_Services|Onion Services]] is not possible -- only related Qubes repositories can be onionized. The reason is Fedora does not maintain onion service repositories.
{{Box|text=
'''1.''' In Fedora TemplateVM, open the qubes-r4.repo file in a text editor.<ref>At the time of writing Qubes-R4 was the current stable release.</ref> 

{{CodeSelect|code=
sudo gedit /etc/yum.repos.d/qubes-r*.repo
}}

* comment the lines that contain <code>metalink</code>
* uncomment the lines that contain <code>{{Qubes onion}}</code>

Once completed, each of the four code blocks will have http(s) repository lines similar to the following example.

{{CodeSelect|code=
#baseurl = https://yum.qubes-os.org/r4.0/current/vm/fc$releasever
baseurl = http://yum.{{Qubes onion}}/r4.0/current/vm/fc$releasever
}}

Save and exit.

'''2.''' In Fedora TemplateVM, confirm the onion service repositories are functional.

{{CodeSelect|code=
sudo dnf update
}}
}}
----

= Debian =

Debian hosts and VMs can be onionized by editing the Debian <ref>
Also edit Whonix sources.list if you are using [[{{project name short}} Packages for Debian Hosts|{{project name}} Packages for Debian Hosts]]
</ref> repository configuration files so they point to the corresponding onion mirrors. Complete the following steps on Debian hosts or in Debian VMs.
{{Box|text=
{{Onionize Debian Sources.list
|filename=/etc/apt/sources.list.d/debian.list
}}
}}

----

= {{Non_q_project_name}} =

{{Non_q_project_name}} VMs can be onionized by editing both the Debian and Whonix repository configuration files so they point to the corresponding onion mirrors. Complete the following steps in {{gateway_product_name}} <u>and</u> {{workstation_product_name}} VMs. 

=== Debian sources.list ===
{{Box|text=
{{Onionize Debian Sources.list
|filename=/etc/apt/sources.list.d/debian.list
}}
}}
=== {{project name}} sources.list ===

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = '''Tip:''' Four {{project name}} repositories are available: stable, stable-proposed-updates, testers and developers. Change the entry below to reflect your repository preference. <ref>[[{{project_name_short}}-APT-Repository#Whonix_.E2.84.A2_APT_Repository_Overview|Whonix APT Repository Overview]]</ref>
}}
</br>
It is possible to point the {{project name}} sources.list to the onion mirror with a single command.<ref>Take note that while Whonix â„¢ maintains both v2 and v3 onion addresses, it is strongly encouraged to prefer v3 .onion connections which provide additional improvements and security benefits over the v2 legacy system. For more details; See https://trac.torproject.org/projects/tor/wiki/doc/NextGenOnions</ref>

To use the {{project name}} v3 onion repository, run. 

{{CodeSelect|code=	
sudo whonix_repository --baseuri http://deb.dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion --enable --repository stable
}}

Confirm the onion repositories are functional.

{{CodeSelect|code=
sudo apt-get update && sudo apt-get dist-upgrade
}}

= Onionize Tor Project Updates =

Advanced users only!

For enhanced security, users can onionize Tor Project Updates; see [[Tor_Versioning|#Tor_Versioning]] for further details.

----

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
