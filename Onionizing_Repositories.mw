
{{Header}}
{{#seo:
|description=Onionizing Repositories Guide
|og:image=https://www.whonix.org/w/images/f/f9/Onionrepository23234.jpg
}}

= Introduction =

Starting with Whonix 14, Debian and Whonix packages are updated using available onion services. Qubes package updates still point to repositories with a http:// URI. However, users can optionally configure Qubes package updates to take place via a Tor onion service, but this requires manual configuration at present.

There are several security and privacy benefits of using Tor onion services: <ref>https://blog.torproject.org/blog/tor-heart-apt-transport-tor-and-debian-onions</ref>

* The user cannot be uniquely targeted for malicious updates (attackers are forced to attack everyone requesting the update).
* The package repository, or observers watching it, can't track what programs are installed.
* The ISP cannot easily learn what packages are fetched.
* End-to-end authentication and encryption provides protection against man-in-the-middle attacks (like version downgrade attacks).


{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = While Qubes and Whonix maintain both v2 and v3 onion addresses, users are strongly encouraged to prefer v3 <i>.onion</i> connections which provide additional improvements and security benefits over the v2 legacy system. <ref>https://trac.torproject.org/projects/tor/wiki/doc/NextGenOnions</ref>
}}

= Qubes Packages =

The following commands must be run in dom0 in order to use Qubesâ€™ Tor onion service repositories for each type of VM. <ref>The cat commands are optional and for confirmation only.</ref>

The downside of this approach is that repository definitions are managed by a Qubes package, meaning manual updates are needed if the the definitions change in the future.

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       =Users that are currently enforcing v2 <i>.onion</i> connections can update their system to v3 <i>.onion</i> connections by replacing all instances of the http/URI address (qubes-os.org) below with qubesos4rrrrz6n4.onion
}}

== dom0 ==

In dom0, run.
<pre>
sudo sed -i 's/yum.qubes-os.org/yum.sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion/' /etc/yum.repos.d/qubes-dom0.repo && cat /etc/yum.repos.d/qubes-dom0.repo
</pre>
<pre>
sudo sed -i 's/yum.qubes-os.org/yum.sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion/' /etc/yum.repos.d/qubes-templates.repo && cat /etc/yum.repos.d/qubes-templates.repo
</pre>

== Fedora Template ==

In dom0, run.
<pre>
qvm-run -a --nogui -p -u root <your_fedora_template> 'sed -i "s/yum.qubes-os.org/yum.sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion/" /etc/yum.repos.d/qubes-r* && cat /etc/yum.repos.d/qubes-r*'
</pre>

== Debian and Whonix Templates ==

In dom0, run.
<pre>
qvm-run -a --nogui -p -u root <your_debian_template> 'sed -i "s/deb.qubes-os.org/deb.sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion/" /etc/apt/sources.list.d/qubes-r* && cat /etc/apt/sources.list.d/qubes-r*'
</pre>

= Whonix and Debian Packages =

== Whonix Templates ==

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = '''Tip:''' [[About#Whonix_Version|From Whonix 14]], the v3 onion service is preferred for Whonix package updates, while Debian's v2 onion service is also preferred for updates. It is no longer necessary to manually configure this setting.
}}

== Debian Templates ==

Advanced Qubes-Whonix users may want to edit the sources.list of their Debian TemplateVM, so that it points to the Debian .onion mirrors. This is a more secure method for updates or general software installation.

'''1. Edit sources.list'''

Edit the debian.list file using an editor with root rights.

{{CodeSelect|code=
sudo nano /etc/apt/sources.list.d/debian.list
}}

'''2. Reference the Onionized Debian Repositories'''

Note: This setting below is for Debian stretch. Modify it accordingly if Debian buster is in use.

Cut and paste the following <i>.onion</i> mirrors and comment out (#) the corresponding http repositories.

<pre>
#deb http://ftp.debian.org/debian stretch main contrib non-free
deb http://vwakviie2ienjx6t.onion/debian stretch main contrib non-free

#deb http://security.debian.org stretch/updates main contrib non-free
deb http://sgvtcaew4bxjd7ln.onion stretch/updates main contrib non-free

#Optional Backports
#deb http://ftp.debian.org/debian stretch-backports main contrib non-free
deb http://vwakviie2ienjx6t.onion/debian stretch-backports main contrib non-free
</pre>

Save and exit.

'''3. Confirm the Onionized Repositories are Functional'''

{{CodeSelect|code=
sudo apt-get update && sudo apt-get dist-upgrade
}}

Optionally repeat steps 1 to 3 for any other Debian templates in use.

= Onionize Tor Project Updates =

Only complete this step if the [[Tor_Versioning|Newer Tor versions from The Tor Project Repository]] are being used. The Tor Project deb apt signing key must be added first (see the link above), or the user will receive error messages when completing these steps.

== Non-Qubes-Whonix and Qubes-Whonix R3.2 ==

The following commands are run in either the Whonix-Gateway or <code>whonix-gw</code> TemplateVM.

To onionize Tor Project updates first create a torproject.list file using an editor with root rights.

If you are using a graphical Whonix or Qubes-Whonix, run.

{{CodeSelect|code=
kdesudo kwrite /etc/apt/sources.list.d/torproject.list
}}

If you are using a terminal-only Whonix, run.

{{CodeSelect|code=
sudo nano /etc/apt/sources.list.d/torproject.list
}}

Next, cut and paste the following text and comment out (#) the corresponding http repository.

<pre>
#Tor Project Mirror
#deb http://deb.torproject.org/torproject.org jessie main
deb http://sdscoq7snqtznauu.onion/torproject.org jessie main
</pre>

Save and exit.

== Qubes R4 ==

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = Qubes-R4.0 TemplateVMs are non-network connected by default which will cause attempts to download the apt key in <code>whonix-gw</code> to fail. <ref>https://github.com/QubesOS/qubes-issues/issues/1854</ref>
}}

=== Add the Tor Signing Key ===

To work around this issue, users can fetch the Tor apt singing key from a (networked) <code>anon-whonix</code> AppVM, then copy the key over to <code>whonix-gw</code> in a text file.

To add the Tor Project deb apt signing key, run the following in <code>anon-whonix</code>:

{{CodeSelect|code=
sudo apt-key adv --keyserver jirk5u4osbsr34t5.onion --recv-keys A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89
}}

To display the keys fingerprint, run.

{{CodeSelect|code=
sudo apt-key adv --fingerprint A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89
}}

Compare the fingerprint displayed in the terminal with the one listed on this website https://www.torproject.org/docs/signing-keys.html ([http://expyuzz4wqqyqhjn.onion/docs/signing-keys.html v2 onion]).

In <code>anon-whonix</code>, copy the Tor singing key to a new text file named tor.key

{{CodeSelect|code=
sudo apt-key export A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89 > /tmp/tor.key
}}

In <code>anon-whonix</code>, copy the tor.key text file over to <code>whonix-gw</code>.

{{CodeSelect|code=
qvm-copy /tmp/tor.key whonix-gw
}}

If the following error appears, it can be safely ignored (hit "OK" when prompted). 
  <i>qfile-agent: Fatal error: stat whonix-gw-version (error type: No such file or directory)</i>

In <code>whonix-gw</code>, add the Tor signing key to the list of trusted keys.

{{CodeSelect|code=
sudo apt-key add ~/QubesIncoming/anon-whonix/tor.key
}}

=== Onionize the Sources File ===

To onionize Tor Project updates first create a torproject.list file using an editor with root rights.

If you are using a graphical Whonix or Qubes-Whonix, run.

{{CodeSelect|code=
kdesudo kwrite /etc/apt/sources.list.d/torproject.list
}}

If you are using a terminal-only Whonix, run.

{{CodeSelect|code=
sudo nano /etc/apt/sources.list.d/torproject.list
}}

Next, cut and paste the following text and comment out (#) the corresponding http repository.

<pre>
#Tor Project Mirror
#deb http://deb.torproject.org/torproject.org jessie main
deb http://sdscoq7snqtznauu.onion/torproject.org jessie main
</pre>

Save and exit.

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
