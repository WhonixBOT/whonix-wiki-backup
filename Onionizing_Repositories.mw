{{Header}}
{{#seo:
|description=Onionizing Repositories Guide
|og:image=https://www.whonix.org/w/images/f/f9/Onionrepository23234.jpg
}}

= Introduction =
Starting with Whonix 14, Debian and Whonix packages are preferably updated using available onion services. Clearnet is used as a fallback. <ref>
https://forums.whonix.org/t/onionizing-qubes-whonix-repositories
</ref> However, users can opt to manually configure Debian and Whonix updates to take place exclusively via a Tor onion service for better security. This is currently [[undocumented]].

Qubes package updates still point to repositories with a http:// URI. However, users can opt to manually configure Qubes package updates to take place via a Tor onion service.

There are several security and privacy benefits of using Tor onion services: <ref>https://blog.torproject.org/blog/tor-heart-apt-transport-tor-and-debian-onions</ref>

* The user cannot be uniquely targeted for malicious updates (attackers are forced to attack everyone requesting the update).
* The package repository, or observers watching it, can't track what programs are installed.
* The ISP cannot easily learn what packages are fetched.
* End-to-end authentication and encryption provides protection against man-in-the-middle attacks (like version downgrade attacks).


{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = While Qubes and Whonix maintain both v2 and v3 onion addresses, users are strongly encouraged to prefer v3 <i>.onion</i> connections which provide additional improvements and security benefits over the v2 legacy system. <ref>https://trac.torproject.org/projects/tor/wiki/doc/NextGenOnions</ref>
}}

= Qubes Packages =

Configuring Qubes to use Tor onion service repositories for updates is a simple process. Since Qubes .onion repositories definitions are installed by default, users only need to comment out the http:// URI repository definitions and uncomment the Tor .onion repositories definitions. 

If the term "comment" is unfamiliar, please follow [https://www.howtogeek.com/118389/how-to-comment-out-and-uncomment-lines-in-a-configuration-file/ this link] to learn how to comment / uncomment lines in a configuration file. 

== dom0 ==

'''1.''' In a dom0 terminal, open the qubes-dom0.repo configuration file in a text editor.

{{CodeSelect|code=
sudo nano /etc/yum.repos.d/qubes-dom0.repo
}}

Next, comment out (#) the 4 lines that contain qubes-os.org

Then, uncomment the 4 lines that contain sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion

When completed each of the 4 code blocks will have http repository lines similar to the following example.

<pre>#baseurl = http://yum.qubes-os.org/r$releasever/current/dom0/fc25
baseurl = http://yum.sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion/r$releasever/current/dom0/fc25</pre>

Save and exit.

'''2.''' In a dom0 terminal, open the qubes-templates.repo configuration file in a text editor.

{{CodeSelect|code=
sudo nano /etc/yum.repos.d/qubes-templates.repo
}}

Next, comment out (#) all lines that contain qubes-os.org

Then, uncomment all lines that contain sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion

When completed each of the 2 code blocks will have http repository lines similar to the following example. 

<pre>#baseurl = http://yum.qubes-os.org/r$releasever/templates-itl
baseurl = http://yum.sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion/r$releasever/templates-itl</pre>

Save and exit.

'''3.''' In dom0 terminal, confirm both onionized repositories are functional.

{{CodeSelect|code=
sudo qubes-dom0-update
}}

== Fedora Template ==

'''1.''' In Fedora TemplateVM, open the qubes-r4.repo configuration file in a text editor.

{{CodeSelect|code=
sudo gedit /etc/yum.repos.d/qubes-r4.repo
}}

Next, comment out (#) all lines that contain qubes-os.org

Then, uncomment all lines that contain an sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion

When completed each of the 4 code blocks will have http repository lines similar to the following example.

<pre>#baseurl = http://yum.qubes-os.org/r4.0/current/vm/fc$releasever
baseurl = http://yum.sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion/r4.0/current/vm/fc$releasever</pre>

Save and exit.

'''2.''' In Fedora terminal, confirm the onionized repositories are functional.

{{CodeSelect|code=
sudo dnf update
}}

== Debian and Whonix Templates ==

'''1.''' In Debian and Whonix TempateVMs, open the sources.list file in a text editor.

{{CodeSelect|code=
sudo nano /etc/apt/sources.list.d/qubes-r*.list
}}

'''2.''' Comment out (#) the first line under Main qubes updates repository. 

The first code block should look similar to this.

<pre> # Main qubes updates repository
#deb [arch=amd64] http://deb.qubes-os.org/r4.0/vm stretch main
#deb-src http://deb.qubes-os.org/r4.0/vm stretch main</pre>

'''3.''' Uncomment the corresponding line under Qubes Tor updates repositories. 

The first code block should look similar to this.

<pre># Qubes Tor updates repositories
# Main qubes updates repository
deb [arch=amd64] http://deb.sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion/r4.0/vm stretch main
#deb-src http://deb.sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion/r4.0/vm stretch main</pre>

Save and exit.

= Fedora Packages =
Updating Fedora packages in Qubes Fedora Template exclusively over onions is unavailable since Fedora does not provide updates over onions. 

= Whonix and Debian Packages =

== Whonix Templates ==

{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = '''Tip:''' [[About#Whonix_Version|From Whonix 14]], the v3 onion service is preferred for Whonix package updates, while Debian's v2 onion service is also preferred for updates. Clearnet is enabled by default as well as backup. It is no longer necessary to manually configure this setting, unless you like to try onion-only.
}}

== Debian Templates ==

Advanced Qubes-Whonix users may want to edit the sources.list of their Debian TemplateVM, so that it points to the Debian .onion mirrors. This is a more secure method for updates or general software installation.

'''1.''' Edit sources.list

Edit the debian.list file using an editor with root rights.

{{CodeSelect|code=
sudo nano /etc/apt/sources.list.d/debian.list
}}

'''2.''' Reference the onionized Debian repositories.

Note: This setting below is for Debian stretch. Modify it accordingly if Debian buster is in use.

Cut and paste the following <i>.onion</i> mirrors and comment out (#) the corresponding http repositories.

{{CodeSelect|code=
#deb http://ftp.debian.org/debian stretch main contrib non-free
deb http://{{Debian_onion}}/debian stretch main contrib non-free

#deb http://security.debian.org stretch/updates main contrib non-free
deb http://{{security.debian.org_onion}} stretch/updates main contrib non-free

#Optional Backports
#deb http://ftp.debian.org/debian stretch-backports main contrib non-free
deb http://{{Debian_onion}}/debian stretch-backports main contrib non-free
}}

Save and exit.

'''3.''' Confirm the onionized repositories are functional.

{{CodeSelect|code=
sudo apt-get update && sudo apt-get dist-upgrade
}}

Optionally repeat steps 1 to 3 for any other Debian templates in use.

= Onionize Tor Project Updates =

Only complete this step if the [[Tor_Versioning|Newer Tor versions from The Tor Project Repository]] are being used. The Tor Project deb apt signing key must be added first (see the link above), or the user will receive error messages when completing these steps.

== Non-Qubes-Whonix and Qubes-Whonix R3.2 ==

The following commands are run in either the Whonix-Gateway or <code>{{whonix-gw}}</code> TemplateVM.

To onionize Tor Project updates first create a torproject.list file using an editor with root rights.

If you are using a graphical Whonix or Qubes-Whonix, run.

{{CodeSelect|code=
kdesudo kwrite /etc/apt/sources.list.d/torproject.list
}}

If you are using a terminal-only Whonix, run.

{{CodeSelect|code=
sudo nano /etc/apt/sources.list.d/torproject.list
}}

Next, cut and paste the following text and comment out (#) the corresponding http repository.

{{CodeSelect|code=
#Tor Project Mirror
#deb http://deb.torproject.org/torproject.org {{Stable_Whonix_based_on_Debian_codename}} main
deb http://{{Torproject_onion}}/torproject.org {{Stable_Whonix_based_on_Debian_codename}} main
}}

Save and exit.

== Qubes R4 ==

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = Qubes R4.0 and above TemplateVMs are non-network connected by default which will cause attempts to download the apt key in <code>{{whonix-gw}}</code> to fail. <ref>https://github.com/QubesOS/qubes-issues/issues/1854</ref>
}}

=== Add the Tor Signing Key ===

To work around this issue, users can fetch the Tor apt singing key from a (networked) <code>anon-whonix</code> AppVM, then copy the key over to <code>{{whonix-gw}}</code> in a text file.

To add the Tor Project deb apt signing key, run the following in <code>anon-whonix</code>:

{{CodeSelect|code=
sudo apt-key adv --keyserver jirk5u4osbsr34t5.onion --recv-keys A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89
}}

To display the keys fingerprint, run.

{{CodeSelect|code=
sudo apt-key adv --fingerprint A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89
}}

Compare the fingerprint displayed in the terminal with the one listed on this website https://www.torproject.org/docs/signing-keys.html ([http://expyuzz4wqqyqhjn.onion/docs/signing-keys.html v2 onion]).

In <code>anon-whonix</code>, copy the Tor singing key to a new text file named tor.key

{{CodeSelect|code=
sudo apt-key export A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89 > /tmp/tor.key
}}

In <code>anon-whonix</code>, copy the tor.key text file over to <code>{{whonix-gw}}</code>.

{{CodeSelect|code=
qvm-copy /tmp/tor.key {{whonix-gw}}
}}

If the following error appears, it can be safely ignored (hit "OK" when prompted). 
  <i>qfile-agent: Fatal error: stat {{whonix-gw}}-version (error type: No such file or directory)</i>

In <code>{{whonix-gw}}</code>, add the Tor signing key to the list of trusted keys.

{{CodeSelect|code=
sudo apt-key add ~/QubesIncoming/anon-whonix/tor.key
}}

=== Onionize the Sources File ===

To onionize Tor Project updates first create a torproject.list file using an editor with root rights.

If you are using a graphical Whonix or Qubes-Whonix, run.

{{CodeSelect|code=
kdesudo kwrite /etc/apt/sources.list.d/torproject.list
}}

If you are using a terminal-only Whonix, run.

{{CodeSelect|code=
sudo nano /etc/apt/sources.list.d/torproject.list
}}

Next, cut and paste the following text and comment out (#) the corresponding http repository.

{{CodeSelect|code=
#Tor Project Mirror
#deb http://deb.torproject.org/torproject.org {{Stable_Whonix_based_on_Debian_codename}} main
deb http://{{Torproject_onion}}/torproject.org {{Stable_Whonix_based_on_Debian_codename}} main
}}

Save and exit.

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
