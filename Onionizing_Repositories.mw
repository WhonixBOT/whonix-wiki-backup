{{Header}}
{{#seo:
|description=Onionizing Repositories Guide
|image=https://www.whonix.org/w/images/f/f9/Onionrepository23234.jpg
}}
{{Maintainer|
|status=stable
|about=About this {{Code2|{{PAGENAME}}}} Page
|difficulty=easy
|maintainer=[https://forums.whonix.org/users/0brand 0brand]
|support=[[Support]]
}}
= Introduction =

When software packages such as from Debian, {{project name}}, Fedora, Qubes are downloaded during installation of new packages or upgrades, by distribution default package repository default settings settings point to download sources using http or https transport protocol, which is non-ideal for security. Download over experimental Tor onion services is available for most platforms.

There are several security and privacy benefits of using Tor onion services: <ref>https://blog.torproject.org/blog/tor-heart-apt-transport-tor-and-debian-onions</ref>

* The user cannot be uniquely targeted for malicious updates - attackers are forced to attack everyone requesting the update.
* The package repository, or observers watching it, cannot track what programs are installed.
* The ISP cannot easily learn what packages are fetched.
* End-to-end authentication and encryption provides protection against man-in-the-middle attacks, like version downgrade attacks.

Also, if onion repositories are enabled, system updates may periodically fail due to their [https://forums.whonix.org/t/disable-onions-by-default-due-to-unreliability/6650 unreliability]. If this becomes an issue, users are encouraged to [[Operating_System_Software_and_Updates#Non-functional_Onion_Services|Re-enable Clearnet Repositories]] so packages can be updated.

If the term "comment" is unfamiliar, please follow [https://www.howtogeek.com/118389/how-to-comment-out-and-uncomment-lines-in-a-configuration-file/ this link] to learn how to comment / uncomment lines in a configuration file. 

Below are instructions for users of [[#Debian|Debian]], [[#{{Non_q_project_name}}|{{Non_q_project_name}}]] and [[#Qubes|Qubes]].

----

= Qubes =
{{Box|text=
Qubes dom0 and VMs can be onionized by editing the repository configuration files so they point to the corresponding onion mirrors. Complete the following steps in [[#dom0|dom0]] and for each template -- not all templates can be completely onionized. The instructions below consider [[#Debian Templates|Debian Templates]], [[#{{project name}} Templates|Whonix <sup>TM</sup> Templates]], and the [[#Fedora Template|Fedora Template]].

== dom0 ==

dom0 can be updated exclusively over onion services.

'''1.''' In a dom0 terminal, open the qubes-dom0.repo configuration file in a text editor.

{{CodeSelect|code=
sudo nano /etc/yum.repos.d/qubes-dom0.repo
}}

* comment the lines that contain <code>metalink</code>
* uncomment the lines that contain <code>{{Qubes onion}}</code>

Once completed, each of the four code blocks will have http(s) repository lines similar to the following example.

{{CodeSelect|code=
#baseurl = https://yum.qubes-os.org/r$releasever/current/dom0/fc25
baseurl = http://yum.{{Qubes onion}}/r$releasever/current/dom0/fc25
#metalink = https://yum.qubes-os.org/r$releasever/current/dom0/%DIST%/repodata/repomd.xml.metalink
}}

Save and exit.

'''2.''' In a dom0 terminal, open the qubes-templates.repo configuration file in a text editor.

{{CodeSelect|code=
sudo nano /etc/yum.repos.d/qubes-templates.repo
}}

* comment the lines that contain <code>metalink</code>
* uncomment the lines that contain <code>{{Qubes onion}}</code>

Once completed, each of the two code blocks will have http(s) repository lines similar to the following example. 

{{CodeSelect|code=
#baseurl = https://yum.qubes-os.org/r$releasever/templates-itl
baseurl = http://yum.{{Qubes onion}}/r$releasever/templates-itl
#metalink = https://yum.qubes-os.org/r$releasever/templates-itl/repodata/repomd.xml.metalink
}}

Save and exit.

'''3.''' In dom0 terminal, confirm both onion repositories are functional.

{{CodeSelect|code=
sudo qubes-dom0-update
}}

== Debian Templates ==

Debian templates can be updated exclusively over onion services. Simply edit both Qubes and Debian sources.list files so they point to the respective onion repositories. 

==== Onionize qubes-r4.list ====

'''1.''' In Debian TempateVM, open the qubes-r4.list file in a text editor.

{{CodeSelect|code=
sudo nano /etc/apt/sources.list.d/qubes-r*.list
}}

'''2.''' Comment the first line underneath "Main qubes updates repository".

The first code block should look similar to this.

<pre> # Main qubes updates repository
#deb [arch=amd64] http://deb.qubes-os.org/r4.0/vm stretch main
#deb-src http://deb.qubes-os.org/r4.0/vm stretch main</pre>

'''3.''' Uncomment the corresponding line underneath "Qubes Tor updates repositories".

The first code block should look similar to this.

{{CodeSelect|code=
# Qubes Tor updates repositories
# Main qubes updates repository
deb [arch=amd64] http://deb.{{Qubes onion}}/r4.0/vm stretch main
#deb-src http://deb.{{Qubes onion}}/r4.0/vm stretch main
}}

Save and exit.

'''4.''' Confirm the onionized repositories are functional.

{{CodeSelect|code=
sudo apt-get update && sudo apt-get dist-upgrade
}}

==== Onionize Debian sources.list ====

The sources.list file can be edited so it points to the Debian onion mirror. This is a more secure method than clearnet for updates and software installation.

{{Onionize Debian Sources.list
|filename=/etc/apt/sources.list
}}

== {{project name}} Templates ==

Whonix templates can be updated exclusively over onion services by editing the Qubes, Debian and Whonix sources.list files so they point to the respective onion repositories. 

Complete the following steps in both {{gateway_product_name}} and {{workstation_product_name}} VMs.

==== Onionize qubes-r4.list ====
 
'''1.''' In {{project name}} TempateVM, open qubes-r4.list in a text editor.

{{CodeSelect|code=
sudo nano /etc/apt/sources.list.d/qubes-r*.list
}}

'''2.''' Comment the first line underneath "Main qubes updates repository".

The first code block should look similar to this.

<pre> # Main qubes updates repository
#deb [arch=amd64] http://deb.qubes-os.org/r4.0/vm stretch main
#deb-src http://deb.qubes-os.org/r4.0/vm stretch main</pre>

'''3.''' Uncomment the corresponding line underneath "Qubes Tor updates repositories".

The first code block should look similar to this.

{{CodeSelect|code=
# Qubes Tor updates repositories
# Main qubes updates repository
deb [arch=amd64] http://deb.{{Qubes onion}}/r4.0/vm stretch main
#deb-src http://deb.{{Qubes onion}}/r4.0/vm stretch main
}}

Save and exit.

'''4.''' Confirm the onionized repositories are functional.

{{CodeSelect|code=
sudo apt-get update && sudo apt-get dist-upgrade
}}

==== Onionize debian.list ====

{{Onionize Debian Sources.list
|filename=/etc/apt/sources.list.d/debian.list
}}

==== Onionize whonix.list ====

The Whonix sources.list file can be pointed to its respective v3 onion mirror with a single command; see [[Project-APT-Repository#Whonix_.E2.84.A2_APT_Repository_Overview|Whonix APT Repository overview]] for more details on the four repository choices.

In {{project name}} konsole, run. 

{{CodeSelect|code=	
sudo whonix_repository --baseuri http://deb.dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion --enable --repository stable
}}

Next confirm onion repositories are functional.

{{CodeSelect|code=
sudo apt-get update && sudo apt-get dist-upgrade
}}
}}

== Fedora Template ==

<u>Note:</u> Updating Fedora templates exclusively over [[Onion_Services|Onion Services]] is not possible -- only related Qubes repositories can be onionized. The reason is Fedora does not maintain onion service repositories.

'''1.''' In Fedora TemplateVM, open the qubes-r4.repo file in a text editor.<ref>At the time of writing Qubes-R4 was the current stable release.</ref> 

{{CodeSelect|code=
sudo gedit /etc/yum.repos.d/qubes-r*.repo
}}

* comment the lines that contain <code>metalink</code>
* uncomment the lines that contain <code>{{Qubes onion}}</code>

Once completed, each of the four code blocks will have http(s) repository lines similar to the following example.

{{CodeSelect|code=
#baseurl = https://yum.qubes-os.org/r4.0/current/vm/fc$releasever
baseurl = http://yum.{{Qubes onion}}/r4.0/current/vm/fc$releasever
}}

Save and exit.

'''2.''' In Fedora TemplateVM, confirm the onion service repositories are functional.

{{CodeSelect|code=
sudo dnf update
}}
----

= Debian =
{{Box|text=
Debian hosts and VMs can be onionized by editing the Debian <ref>
Also edit Whonix sources.list if you are using [[{{project name short}} Packages for Debian Hosts|{{project name}} Packages for Debian Hosts]]
</ref> repository configuration files so they point to the corresponding onion mirrors. Complete the following steps on Debian hosts or in Debian VMs.

{{Onionize Debian Sources.list
|filename=/etc/apt/sources.list.d/debian.list
}}
}}

----

= {{Non_q_project_name}} =
{{Box|text=
{{Non_q_project_name}} VMs can be onionized by editing both the Debian and Whonix repository configuration files so they point to the corresponding onion mirrors. Complete the following steps in {{gateway_product_name}} <u>and</u> {{workstation_product_name}} VMs. 

=== Debian sources.list ===
 
{{Onionize Debian Sources.list
|filename=/etc/apt/sources.list.d/debian.list
}}

=== {{project name}} sources.list ===

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = '''Tip:''' Four {{project name}} repositories are available: stable, stable-proposed-updates, testers and developers. Change the entry below to reflect your repository preference. <ref>[[{{project_name_short}}-APT-Repository#Whonix_.E2.84.A2_APT_Repository_Overview|Whonix APT Repository Overview]]</ref>
}}
</br>
It is possible to point the {{project name}} sources.list to the onion mirror with a single command.

To use the {{project name}} v3 onion repository, run. 

{{CodeSelect|code=	
sudo whonix_repository --baseuri http://deb.dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion --enable --repository stable
}}

Next confirm the onion repositories are functional.

{{CodeSelect|code=
sudo apt-get update && sudo apt-get dist-upgrade
}}
}}

----

= Onionize Tor Project Updates =

Only complete this step if [[Tor_Versioning|Newer Tor versions from The Tor Project Repository]] are in use. The Tor Project deb apt signing key must be added first (see the prior link), or error messages will appear when completing these steps.

== {{non_q_project_name_short}} ==
{{Box|text=
The following commands are run in {{gateway_product_name}}.

To onionize Tor Project updates, first create a torproject.list file using an editor.

{{Open with root rights|filename=
/etc/apt/sources.list.d/torproject.list
}}

Next, cut and paste the following text and comment out (#) the corresponding http repository.

{{CodeSelect|code=
#Tor Project Mirror
#deb http://deb.torproject.org/torproject.org {{Stable_project_version_based_on_Debian_codename}} main
deb http://{{Torproject_onion}}/torproject.org {{Stable_project_version_based_on_Debian_codename}} main
}}

Save and exit.
}}
== Qubes R4 ==

{{mbox
| type       = notice
| image      = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = In Qubes R4.0 and above, TemplateVMs are non-network connected by default. This means any attempt to download the apt key in <code>{{whonix-gw}}</code> will fail. <ref>https://github.com/QubesOS/qubes-issues/issues/1854</ref>
}}
{{Box|text=
=== Add the Tor Signing Key ===

As a workaround, the Tor apt singing key can be fetched from a (networked) <code>anon-whonix</code> AppVM, then copied over to <code>{{whonix-gw}}</code> in a text file.

'''1.''' Add the Tor Project deb apt signing key.

Run the following command in <code>anon-whonix</code>.

{{CodeSelect|code=
sudo apt-key adv --keyserver jirk5u4osbsr34t5.onion --recv-keys A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89
}}

'''2.''' Display the key's fingerprint.

Run.

{{CodeSelect|code=
sudo apt-key adv --fingerprint A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89
}}

'''3.''' Examine the key's fingerprint.

Compare the fingerprint displayed in the terminal with the one listed on this website https://www.torproject.org/docs/signing-keys.html ([http://expyuzz4wqqyqhjn.onion/docs/signing-keys.html v2 onion]).

'''4.''' Copy the Tor signing key to <code>{{whonix-gw}}</code>.

In <code>anon-whonix</code>, copy the Tor singing key to a new text file named <code>tor.key</code>.

{{CodeSelect|code=
sudo apt-key export A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89 > /tmp/tor.key
}}

In <code>anon-whonix</code>, copy the <code>tor.key</code> text file over to <code>{{whonix-gw}}</code>.

{{CodeSelect|code=
qvm-copy /tmp/tor.key {{whonix-gw}}
}}

If the following error appears, it can be safely ignored (hit "OK" when prompted). 
  <i>qfile-agent: Fatal error: stat {{whonix-gw}}-version (error type: No such file or directory)</i>

'''5.''' Add the Tor signing key to the list of trusted keys

In <code>{{whonix-gw}}</code>, run.

{{CodeSelect|code=
sudo apt-key add ~/QubesIncoming/anon-whonix/tor.key
}}

=== Onionize the Sources File ===

To onionize Tor Project updates, first create a torproject.list file using an editor.

{{Open with root rights|filename=
/etc/apt/sources.list.d/torproject.list
}}

Next, cut and paste the following text and comment out (#) the corresponding http repository.

{{CodeSelect|code=
#Tor Project Mirror
#deb http://deb.torproject.org/torproject.org {{Stable_project_version_based_on_Debian_codename}} main
deb http://{{Torproject_onion}}/torproject.org {{Stable_project_version_based_on_Debian_codename}} main
}}

Save and exit.
}}

----

----

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
