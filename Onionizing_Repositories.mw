
{{Header}}
{{#seo:
|description=Onionizing Repositories Guide
}}

= Introduction =

When Whonix, Debian and Qubes packages are installed or updated, default settings point to repositories with a http:// URI. <ref>https://www.whonix.org/wiki/Whonix-APT-Repository#Repository_Location_URI</ref> However, experimental Tor onion services are already available for the Whonix, Debian and Qubes packages.

There are several security and privacy benefits of using Tor onion services: <ref>https://blog.torproject.org/blog/tor-heart-apt-transport-tor-and-debian-onions</ref>

* The user cannot be uniquely targeted for malicious updates (attackers are forced to attack everyone requesting the update).
* The package repository, or observers watching it, can't track what programs are installed.
* The ISP cannot easily learn what packages are fetched.
* End-to-end authentication and encryption provides protection against man-in-the-middle attacks e.g. version downgrade attacks.

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = While Qubes and Whonix maintain both v2 and v3 onion addresses, users are strongly encouraged to enforce v3 <i>.onion</i> connections. This allows users to benefit from the many improvements over the v2 legacy system.<ref>https://trac.torproject.org/projects/tor/wiki/doc/NextGenOnions</ref> <ref>Tor v3.2 or higher must be running in Whonix-Gateway (`sys-whonix`).</ref>  
}}

= Qubes Packages =

The following commands must be run in dom0 in order to use Qubesâ€™ Tor onion service repositories for each type of VM. <ref>The cat commands are optional and for confirmation only.</ref>

The downside of this approach is that repository definitions are managed by a Qubes package, meaning manual updates are needed if the the definitions change in the future.

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       =Users that are currently enforcing v2 <i>.onion</i> connections can update their system to v3 <i>.onion</i> connections by replacing all instances of the http/URI address (qubes-os.org) below with qubesos4rrrrz6n4.onion
}}

== dom0 ==

In dom0, run.
<pre>
sudo sed -i 's/yum.qubes-os.org/yum.sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion/' /etc/yum.repos.d/qubes-dom0.repo && cat /etc/yum.repos.d/qubes-dom0.repo
</pre>
<pre>
sudo sed -i 's/yum.qubes-os.org/yum.sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion/' /etc/yum.repos.d/qubes-templates.repo && cat /etc/yum.repos.d/qubes-templates.repo
</pre>

== Fedora Template ==

In dom0, run.
<pre>
qvm-run -a --nogui -p -u root <your_fedora_template> 'sed -i "s/yum.qubes-os.org/yum.sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion/" /etc/yum.repos.d/qubes-r* && cat /etc/yum.repos.d/qubes-r*'
</pre>

== Debian and Whonix Templates ==

In dom0, run.
<pre>
qvm-run -a --nogui -p -u root <your_debian_template> 'sed -i "s/deb.qubes-os.org/deb.sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion/" /etc/apt/sources.list.d/qubes-r* && cat /etc/apt/sources.list.d/qubes-r*'
</pre>

= Whonix and Debian Packages =

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = '''Tip:''' [[About#Whonix_version|Whonix 14]] will prefer v3 Tor onion services (<i>.onion</i> repositories) by default, even when adding third-party resources.
}}


Until Whonix 14 is released, users may consider manually editing their sources.list to point to the Whonix and Debian <i>.onion</i> mirrors in order to install or update more securely.

The whonix.list and debian.list files in the <i>/etc/apt/sources.list.d</i> directory should be changed in ''both'' the Whonix-Workstation and Whonix-Gateway. [[Qubes-Whonix]] users note: Complete these steps in the <code>whonix-gw</code> and <code>whonix-ws</code> TemplateVMs.

'''1. Edit sources.list'''

In the Whonix-Gateway, edit the debian.list file using an editor with root rights.

If you are using a graphical Whonix or Qubes-Whonix, run.
<pre>
kdesudo kwrite /etc/apt/sources.list.d/debian.list
</pre>
If you are using a terminal-only Whonix, run.
<pre>
sudo nano /etc/apt/sources.list.d/debian.list
</pre>

'''2. Reference the Onionized Debian Repositories'''

Cut and paste the following <i>.onion</i> mirrors and comment out (#) the corresponding http repositories.

<pre>
#deb http://ftp.debian.org/debian jessie main contrib non-free
deb http://vwakviie2ienjx6t.onion/debian jessie main contrib non-free

#deb http://security.debian.org jessie/updates main contrib non-free
deb http://sgvtcaew4bxjd7ln.onion jessie/updates main contrib non-free

#Optional Backports
#deb http://ftp.debian.org/debian jessie-backports main contrib non-free
deb http://vwakviie2ienjx6t.onion/debian jessie-backports main contrib non-free
</pre>

Save and exit.

'''3. Reference the Onionized Whonix APT Repository'''

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = '''Tip:''' Whonix users have four package preferences available: stable, stable-proposed-updates, testers and developers. Change the entry below to reflect this preference. <ref>https://www.whonix.org/wiki/Whonix-APT-Repository#Whonix_APT_Repository_Overview</ref>
}}


To use the v3 onion, run. <ref>Requires Tor v3.2 or above running in Whonix-Gateway (<code>sys-whonix</code>).</ref>

<pre>
sudo whonix_repository --baseuri http://deb.dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion --enable --repository stable
</pre>

'''4. Confirm the Onionized Repositories are Functional'''

<pre>sudo apt-get update && sudo apt-get dist-upgrade</pre>

'''5. Repeat Steps 1 to 4 for the Whonix-Workstation'''

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = '''Tip:''' Qubes users can repeat these steps in the Debian TemplateVM to onionize future installations and updates.
}}


'''6. ''Optional:'' Onionize Tor Project Updates'''

Only complete this step if the [[Security_Guide#Tor_Versioning|Tor versions from The Tor Project repository]] are being used. The Tor Project deb apt signing key must be added first (see the link above), or the user will receive error messages when completing these steps.

The following commands are run in either the Whonix-Gateway or <code>whonix-gw</code> TemplateVM (for Qubes R3.2 users).

'''Note:''' Qubes-R4.0 TemplateVMs are non-network connected by default which will cause attempts to download the apt key in <code>whonix-gw</code> to fail.<ref>https://github.com/QubesOS/qubes-issues/issues/1854</ref> To work around this issue users can fetch the Tor apt singing key from a (networked) <code>anon-whonix</code> AppVM. Then copy the key over to <code>whonix-gw</code> in a text file.

To add the Tor Project deb apt signing key, run. (In <code>anon-whonix</code> VM for Qubes-R4.0) 

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = '''Note:''' Whonix 14 users must replace the address keys.gnupg.net with <i>.onion</i> address jirk5u4osbsr34t5.onion
}}


<pre>
sudo apt-key adv --keyserver keys.gnupg.net --recv-keys A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89
</pre>

To display the keys fingerprint, run.

<pre>
sudo apt-key adv --fingerprint A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89
</pre>

Compare the fingerprint displayed in terminal with the one listed on this website https://www.torproject.org/docs/signing-keys.html

(Qubes-R4.0 only!) In <code>anon-whonix</code>, copy the Tor singing key to a new text file named tor.key

<pre>
sudo apt-key export A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89 > /tmp/tor.key
</pre>

(Qubes-R4.0 only!) In <code>anon-whonix</code>, copy the tor.key text file over to <code>whonix-gw</code>.

<pre>
qvm-copy /tmp/tor.key whonix-gw
</pre>

If the following error appears, it can be safely ignored (hit "OK" when prompted). 
  <i>qfile-agent: Fatal error: stat whonix-gw-version (error type: No such file or directory)</i>

(Qubes-R4.0 only!) In <code>whonix-gw</code>, add the Tor signing key to the list of trusted keys.

<pre>
sudo apt-key add ~/QubesIncoming/anon-whonix/tor.key
</pre>

--------

To onionize Tor Project updates first create a torproject.list file using an editor with root rights.

If you are using a graphical Whonix or Qubes-Whonix, run.

<pre>
kdesudo kwrite /etc/apt/sources.list.d/torproject.list
</pre>

If you are using a terminal-only Whonix, run.

<pre>
sudo nano /etc/apt/sources.list.d/torproject.list
</pre>

Next, cut and paste the following text and comment out (#) the corresponding http repository.

<pre>
#Tor Project Mirror
#deb http://deb.torproject.org/torproject.org jessie main
deb http://sdscoq7snqtznauu.onion/torproject.org jessie main
</pre>

Save and exit.

= Footnotes =
<references/>

{{Footer}}

[[Category:Documentation]]
