{{Header}}
{{#seo:
|description=Onionizing Repositories Guide
|image=https://www.whonix.org/w/images/f/f9/Onionrepository23234.jpg
}}
{{Maintainer|
|status=stable
|about=About this {{Code2|{{PAGENAME}}}} Page
|difficulty=easy
|maintainer=[https://forums.whonix.org/users/0brand 0brand]
|support=[[Support]]
}}
= Introduction =

When{{project name}}and Debian packages are installed or updated, default settings point to repositories with a http:// URI. However, experimental Tor onion services are already available for both{{project name}}and Debian packages.

There are several security and privacy benefits of using Tor onion services: <ref>https://blog.torproject.org/blog/tor-heart-apt-transport-tor-and-debian-onions</ref>

* The user cannot be uniquely targeted for malicious updates - attackers are forced to attack everyone requesting the update.
* The package repository, or observers watching it, cannot track what programs are installed.
* The ISP cannot easily learn what packages are fetched.
* End-to-end authentication and encryption provides protection against man-in-the-middle attacks, like version downgrade attacks.

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = While{{project name}}maintains both v2 and v3 onion addresses, users are strongly encouraged to prefer v3 <i>.onion</i> connections which provide additional improvements and security benefits over the v2 legacy system. <ref>https://trac.torproject.org/projects/tor/wiki/doc/NextGenOnions</ref>
}}

= Qubes Packages =

If the term "comment" is unfamiliar, please follow [https://www.howtogeek.com/118389/how-to-comment-out-and-uncomment-lines-in-a-configuration-file/ this link] to learn how to comment / uncomment lines in a configuration file. 

== dom0 ==

'''1.''' In a dom0 terminal, open the qubes-dom0.repo configuration file in a text editor.

{{CodeSelect|code=
sudo nano /etc/yum.repos.d/qubes-dom0.repo
}}

* comment the lines that contain <code>metalink</code>
* uncomment the lines that contain <code>{{Qubes onion}}</code>

Once completed, each of the four code blocks will have http(s) repository lines similar to the following example.

{{CodeSelect|code=
#baseurl = https://yum.qubes-os.org/r$releasever/current/dom0/fc25
baseurl = http://yum.{{Qubes onion}}/r$releasever/current/dom0/fc25
#metalink = https://yum.qubes-os.org/r$releasever/current/dom0/%DIST%/repodata/repomd.xml.metalink
}}

Save and exit.

'''2.''' In a dom0 terminal, open the qubes-templates.repo configuration file in a text editor.

{{CodeSelect|code=
sudo nano /etc/yum.repos.d/qubes-templates.repo
}}

* comment the lines that contain <code>metalink</code>
* uncomment the lines that contain <code>{{Qubes onion}}</code>

Once completed, each of the two code blocks will have http(s) repository lines similar to the following example. 

{{CodeSelect|code=
#baseurl = https://yum.qubes-os.org/r$releasever/templates-itl
baseurl = http://yum.{{Qubes onion}}/r$releasever/templates-itl
#metalink = https://yum.qubes-os.org/r$releasever/templates-itl/repodata/repomd.xml.metalink
}}

Save and exit.

'''3.''' In dom0 terminal, confirm both http:// URI repositories are functional.

{{CodeSelect|code=
sudo qubes-dom0-update
}}

== Fedora Template ==

'''1.''' In Fedora TemplateVM, open the qubes-r4.repo configuration file in a text editor.

{{CodeSelect|code=
sudo gedit /etc/yum.repos.d/qubes-r4.repo
}}

* comment the lines that contain <code>metalink</code>
* uncomment the lines that contain <code>{{Qubes onion}}</code>

Once completed, each of the four code blocks will have http(s) repository lines similar to the following example.

{{CodeSelect|code=
#baseurl = https://yum.qubes-os.org/r4.0/current/vm/fc$releasever
baseurl = http://yum.{{Qubes onion}}/r4.0/current/vm/fc$releasever
}}

Save and exit.

'''2.''' In Fedora terminal, confirm the http:// URI repositories are functional.

{{CodeSelect|code=
sudo dnf update
}}

== Debian and{{project name}}Templates ==

'''1.''' In Debian and{{project name}}TempateVMs, open the sources.list file in a text editor.

{{CodeSelect|code=
sudo nano /etc/apt/sources.list.d/qubes-r*.list
}}

'''2.''' Comment the first line underneath "Main qubes updates repository".

The first code block should look similar to this.

<pre> # Main qubes updates repository
#deb [arch=amd64] http://deb.qubes-os.org/r4.0/vm stretch main
#deb-src http://deb.qubes-os.org/r4.0/vm stretch main</pre>

'''3.''' Uncomment the corresponding line underneath "Qubes Tor updates repositories".

The first code block should look similar to this.

{{CodeSelect|code=
# Qubes Tor updates repositories
# Main qubes updates repository
deb [arch=amd64] http://deb.{{Qubes onion}}/r4.0/vm stretch main
#deb-src http://deb.{{Qubes onion}}/r4.0/vm stretch main
}}

Save and exit.

= Fedora Packages =
It is not currently possible to update Fedora packages in Qubes' Fedora TemplateVM exclusively over [[Onion_Services|Onion Services]], since Fedora does not provide this update option.

={{project name}}and Debian Packages =

{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Due to issues with [https://forums.whonix.org/t/disable-onions-by-default-due-to-unreliability/6650 onion unreliability], clearnet repositories are now preferred in{{project name}}14 by default.
}}


If users enable v2 or v3 onion repositories it is possible that system updates will periodically fail due to their unreliability. If this becomes an issue, it is recommended to [[Operating_System_Software_and_Updates#Non-functional_Onion_Services|Re-enable Clearnet Repositories]] so the{{project name}}VMs can be updated. 

== Debian == 

{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = [[Qubes-Whonix]] and [[Non-Qubes-Whonix]].
}}


Advanced users can edit the sources.list files so it points to the Debian .onion mirrors. This is a more secure method for updates and software installation. Complete the following steps in both Whonix-Gateway (<code>whonix-gw-14</code>) and Whonix-Workstation (<code>whonix-ws-14</code>).

'''1.''' Edit sources.list

Edit the debian.list file using an editor with root rights.

{{CodeSelect|code=
sudo nano /etc/apt/sources.list.d/debian.list
}}

'''2.''' Reference the onionized Debian repositories.

Note: The settings below are for Debian stretch. Modify it accordingly if Debian buster is in use.

Cut and paste the following <i>.onion</i> mirrors and comment out (#) the corresponding http repositories.

{{CodeSelect|code=
#deb http://ftp.debian.org/debian stretch main contrib non-free
deb http://{{Debian_onion}}/debian stretch main contrib non-free

#deb http://security.debian.org stretch/updates main contrib non-free
deb http://{{security.debian.org_onion}} stretch/updates main contrib non-free

#Optional Backports
#deb http://ftp.debian.org/debian stretch-backports main contrib non-free
deb http://{{Debian_onion}}/debian stretch-backports main contrib non-free
}}

Save and exit.

'''3.''' Confirm the onionized repositories are functional.

{{CodeSelect|code=
sudo apt-get update && sudo apt-get dist-upgrade
}}

Optionally, repeat steps 1-3 for any other Debian templates in use.

=={{project name}}== 

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = '''Tip:'''{{project name}}users have four package preferences available: stable, stable-proposed-updates, testers and developers. Change the entry below to reflect this preference.<ref>https://www.whonix.org/wiki/Whonix-APT-Repository#Whonix_APT_Repository_Overview</ref>
}}


Whonix packages can be updated/installed via onion services using a single command.

To use the v3 onion, run.

{{CodeSelect|code=	
sudo whonix_repository --baseuri http://deb.dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion --enable --repository stable
}}

Next, confirm onion repositories are functional

{{CodeSelect|code=
sudo apt-get update && sudo apt-get dist-upgrade
}}

= Onionize Tor Project Updates =

Only complete this step if [[Tor_Versioning|Newer Tor versions from The Tor Project Repository]] are in use. The Tor Project deb apt signing key must be added first (see the prior link), or error messages will appear when completing these steps.

== Non-Qubes-Whonix and Qubes-Whonix R3.2 ==

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text    = Qubes R3.2 reached [https://www.qubes-os.org/news/2019/03/28/qubes-3-2-has-reached-eol/ EOL] on 28 March, 2019. It is strongly recommended to [https://www.qubes-os.org/downloads/ upgrade to Qubes R4.0] to stay safe.
}}


The following commands are run in either the Whonix-Gateway or <code>{{whonix-gw}}</code> TemplateVM.

To onionize Tor Project updates, first create a torproject.list file using an editor with root rights.

If you are using a graphical{{project name}}or Qubes-Whonix, run.

{{Open with root rights|filename=
/etc/apt/sources.list.d/torproject.list
}}

Next, cut and paste the following text and comment out (#) the corresponding http repository.

{{CodeSelect|code=
#Tor Project Mirror
#deb http://deb.torproject.org/torproject.org {{Stable_Whonix_based_on_Debian_codename}} main
deb http://{{Torproject_onion}}/torproject.org {{Stable_Whonix_based_on_Debian_codename}} main
}}

Save and exit.

== Qubes R4 ==

{{mbox
| type       = notice
| image      = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = In Qubes R4.0 and above, TemplateVMs are non-network connected by default. This means any attempt to download the apt key in <code>{{whonix-gw}}</code> will fail. <ref>https://github.com/QubesOS/qubes-issues/issues/1854</ref>
}}

=== Add the Tor Signing Key ===

As a workaround, the Tor apt singing key can be fetched from a (networked) <code>anon-whonix</code> AppVM, then copied over to <code>{{whonix-gw}}</code> in a text file.

To add the Tor Project deb apt signing key, run the following in <code>anon-whonix</code>:

{{CodeSelect|code=
sudo apt-key adv --keyserver jirk5u4osbsr34t5.onion --recv-keys A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89
}}

To display the key's fingerprint, run.

{{CodeSelect|code=
sudo apt-key adv --fingerprint A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89
}}

Compare the fingerprint displayed in the terminal with the one listed on this website https://www.torproject.org/docs/signing-keys.html ([http://expyuzz4wqqyqhjn.onion/docs/signing-keys.html v2 onion]).

In <code>anon-whonix</code>, copy the Tor singing key to a new text file named tor.key

{{CodeSelect|code=
sudo apt-key export A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89 > /tmp/tor.key
}}

In <code>anon-whonix</code>, copy the tor.key text file over to <code>{{whonix-gw}}</code>.

{{CodeSelect|code=
qvm-copy /tmp/tor.key {{whonix-gw}}
}}

If the following error appears, it can be safely ignored (hit "OK" when prompted). 
  <i>qfile-agent: Fatal error: stat {{whonix-gw}}-version (error type: No such file or directory)</i>

In <code>{{whonix-gw}}</code>, add the Tor signing key to the list of trusted keys.

{{CodeSelect|code=
sudo apt-key add ~/QubesIncoming/anon-whonix/tor.key
}}

=== Onionize the Sources File ===

To onionize Tor Project updates, first create a torproject.list file using an editor with root rights.

If you are using a graphical{{project name}}or Qubes-Whonix, run.

{{Open with root rights|filename=
/etc/apt/sources.list.d/torproject.list
}}

If you are using a terminal-only Whonix, run.

{{CodeSelect|code=
sudo nano /etc/apt/sources.list.d/torproject.list
}}

Next, cut and paste the following text and comment out (#) the corresponding http repository.

{{CodeSelect|code=
#Tor Project Mirror
#deb http://deb.torproject.org/torproject.org {{Stable_Whonix_based_on_Debian_codename}} main
deb http://{{Torproject_onion}}/torproject.org {{Stable_Whonix_based_on_Debian_codename}} main
}}

Save and exit.

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
