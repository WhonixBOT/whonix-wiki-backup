{{Header}}
{{#seo:
|description=Notes about Tor (The Onion Router) on Log Analysis, Non-Persistent Entry Guards, Blacklist Certain Onion Services from Connecting, Additional SocksPorts, UDP and more.
|image=https://www.whonix.org/w/images/3/32/Menger-702837640.jpg
}}

= Version Number =
To discover what Tor version is currently in use, run the following command inside Whonix-Gateway ([[Qubes-Whonix]]: <code>sys-whonix</code>).

{{CodeSelect|code=
anon-info
}}

The output should be similar to the following.

<pre>
INFO: version of the 'tor' package: 0.3.2.10-1~d80.jessie+1
</pre>

= Permissions on directory /var/run/tor are too permissive Error =
To discover if you are affected by the {{Code2|Permissions on directory /var/run/tor are too permissive}} error, <ref>
https://trac.torproject.org/projects/tor/ticket/19824
</ref> run the following command inside Whonix-Gateway ([[Qubes-Whonix]]: <code>sys-whonix</code>).

<pre>
sudo cat /var/run/tor/log | grep -i permissive
</pre>

If a user is affected, a warning similar to the following will appear.

<pre>
Aug 03 17:36:33.000 [warn] Permissions on directory /var/run/tor are too permissive.
</pre>

Currently there is only one workaround, which needs to be manually applied after every reboot.

{{CodeSelect|code=
sudo chmod --recursive 700 /var/run/tor
}}

= Log Analysis =

== Introduction ==

Analysis of Tor's log can be useful if connectivity issues emerge.

== Open Tor Log ==

Users can inspect two logs:

* The persistent Tor log: ''/var/log/tor/log''; and/or
* The Tor log since last boot: ''/var/run/tor/log'' <ref>
{{Code2|/var/run/tor/log}} is a Tor configuration file specific to Whonix and an alternative to {{Code2|/var/log/tor/log}}. The former only contains Tor's output since Whonix-Gateway (<code>sys-whonix</code>) last booted. The latter is a permanent log that persists across reboots. The former has a small usability advantage because it is shorter and should therefore contain more relevant information.
</ref>


{{open with root rights|filename=
/var/run/tor/log
}}

== Watch Tor Log ==

Users can also watch Tor's log as it is written.

{{CodeSelect|code=
sudo tail -f /var/run/tor/log
}}

This command is especially useful when Tor is reloaded or restarted simultaneously in another terminal window. 

To [[#Reload Tor|reload Tor]], run the following command.

{{CodeSelect|code=
sudo service tor@default reload
}}

To [[#Restart Tor|restart Tor]], run the following command.

{{CodeSelect|code=
sudo service tor@default restart
}}

== Non-Issues ==

{| class="wikitable" style="background-color: #fff;text-align: center"

! message / question
! answer

|-
| <u>{{Code2|Am I compromised? Does Tor's log report leaks?}}
| Tor's output is an ineffective tool for discovering serious issues such as a compromise or leaks.</u>

|-
| {{Code2|[WARN] Socks version 71 not recognized. (Tor is not an http proxy.)}}
| 
This warning is caused by [[whonixcheck]], specifically the function {{Code2|check_tor_socks_port_reachability}} which checks if a Tor SocksPort is reachable by trying to fetch it using curl. <ref>
{{CodeSelect|code=
{{Curl_Plain}} 10.152.152.10:9100
}}
</ref> No warnings appear if the function works correctly.

|-
| {{Code2|[NOTICE] You configured a non-loopback address '10.152.152.10:9179' for SocksPort. This allows everybody on your local network to use your machine as a proxy. Make sure this is what you wanted. [1 duplicate hidden]}} This notice may reference other port numbers, or the DnsPort or TransPort.
| This notice is not a concern because Tor really listens on that IP/port - it is the internal network interface for Whonix-Gateway (<code>sys-whonix</code>) that is only available to Whonix-Workstations because Whonix-Gateway (<code>sys-whonix</code>) is firewalled. See ''{{WhonixFirewall}}'' or the Whonix source code for further information.

|-
| {{Code2|[NOTICE] New control connection opened. [2 duplicates hidden]}} A higher number of duplicate messages may also appear.
| This notice is not a concern because it is caused by [[whonixcheck]]'s Tor Bootstrap Status Test, which uses Tor's ControlPort or [[Dev/CPFP|CPFP]].

|}

= See Also =

* [[Why_does_Whonix_use_Tor| Why does Whonix use Tor?]]
* [[Why is Tor slow| Why is Tor slow?]]
* [[Bridges| Censorship Circumvention - Tor Bridge Mode, using (private) (obfuscated) bridges]]
* [[Hide Tor and Whonix from your ISP| Hide the fact that you are using Tor/Whonix]] 
* [[Tor Controller| Controlling Tor]]
* [[Onion Services| Hosting Tor Onion Services, ANY, Hidden Webserver]]
* [[Comparison Of Tor Proxies CGI proxies Proxy Chains And VPN Services|Comparison of Tor, Proxies, CGI proxies, Proxy Chains and VPN Services]]


= Advanced Topics =
== Entry Guards ==
=== Introduction ===

{{Persistent Tor Entry Guards Introduction}}

<ref>
As concluded in ticket [https://phabricator.whonix.org/T469 research non-persistent Tor directory guards], these are covered by the following instructions.
</ref>

=== Manual Rotation of Tor Guards ===

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text       = The decision to manually create and utilize a new Whonix-Gateway (<code>sys-whonix</code>) is risky and should not be taken undertaken lightly!
}}


On occasion, users may be tempted to create a new Whonix-Gateway ([[Qubes-Whonix]]: <code>sys-whonix</code>) because:

* Bootstrapping is slow or regularly fails.
* Tor logs show warnings suggesting evidence of route manipulation attacks or other oddities.
* Logs reveal attempted attacks on Whonix or Tor processes, for example in AppArmor logs.
* Current Tor performance is very slow or unreliable due to collapsing circuits or other factors.
* The user is concerned about the amount of Tor data that could be revealed if the Whonix-Gateway is infected, particularly after a long period of use.


Creating a new Whonix-Gateway or <code>sys-whonix</code> will ''likely'' lead to a new set of Tor entry guards, which is [https://blog.torproject.org/improving-tors-anonymity-changing-guard-parameters proven to degrade anonymity]. Voluntary guard rotation via a new Whonix-Gateway is more dangerous than allowing "natural churn" as chosen by the Tor application for several reasons:

* It increases the likelihood of a compromised or malicious Tor guard being selected, leading to a corresponding rise in the chance of a successful [https://securityaffairs.co/wordpress/17489/intelligence/traf%EF%AC%81c-correlation-vs-anonymity-on-tor.html correlation attack] if the adversary runs Tor exit relays in the network. <ref>Even if the adversary cannot enumerate all websites visited by the user, it might reveal sites visited more regularly, such as whonix.org</ref>
* The user is more likely to traverse a [http://freehaven.net/anonbib/#feamster:wpes2004 given] [http://freehaven.net/anonbib/#DBLP:conf:ccs:EdmanS09 set] of [http://freehaven.net/anonbib/#ndss13-relay-selection Internet infrastructure links] that are under the adversary's control, such as Autonomous Systems (ASes) or Internet Exchange Points (IXPs).
* Every change of Tor guards acts like a fingerprinting mechanism, since other users are less likely to pick the same set. If the adversary is able to enumerate a user's Tor guards, and later observes someone with the same set, the chance is high the two observations stem from the same person. <ref>For example, the [https://trac.torproject.org/projects/tor/ticket/9273#comment:3 entropy associated with one, two or three guards] is 9, 17 and 25 bits, respectively.</ref>


For these reasons the Tor Project has changed its design and reduced the number of primary guard nodes to 3,  and increased the set period for guard rotation. <ref>https://trac.torproject.org/projects/tor/ticket/8240</ref> The user should also contemplate the possibility their current poor Tor performance is an attempt by an advanced adversary to cause frustration, leading to a manual change in Tor guards: <ref>https://blog.torproject.org/improving-tors-anonymity-changing-guard-parameters</ref> <ref>For example if the current set of Tor guards is not under their control.</ref>

<blockquote>We should also consider whether an adversary can *induce* congestion or resource exhaustion to cause a target user to switch away from her guard. Such an attack could work very nicely coupled with the guard enumeration attacks discussed above.</blockquote>

In one sense, users should ''welcome'' slow entry guards, since "honeypot" operators on the Tor network are unlikely to have constrained bandwidth which might chase away intended targets. This thinking aligns with intelligence disclosures which deem all Tor users to be persons of interest to state-level adversaries.

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text       = Users considering using disposable Whonix-Gateway ProxyVMs in Qubes R4 are [[Qubes/DisposableVM#Warning:_Avoid_Ephemeral_Whonix-Gateway_ProxyVMs_in_Qubes_R4|warned]] that this technique poses an even greater anonymity risk than described above; <b>new Tor guards are created during each distinct Whonix session.</b>
}}


Under certain circumstances, users will feel compelled to proceed despite the anonymity risks. In this instance, it may be safer to first try: <ref>This issue requires further research.</ref>

* One of the fallback primary entry guards.
* A configured [[Bridges|bridge]].
* Possibly [[Tunnels/Introduction|combine tunnels with Tor]].
* Creating a fresh Whonix-Gateway (<code>sys-whonix</code>), and copying across the Tor state file.


The user can also persist with poor performance and wait for normal guard rotation. <ref>Note that if the problem relates to a dead entry guard(s), Tor is configured to eventually remove them.</ref> Users should note that [[tor#Fresh_Tor_Entry_Guards_by_regenerating_Tor_State_File|regenerating the Tor state file]] poses the same anonymity risks as outlined in this section.

=== Alternating Bridges ===

If [[bridges|bridges]] are already in use, alternate bridges are recommended for different locations. If bridges are not used, consideration should be given to using entry guards in your primary location and relying on alternate bridges in different locations.

Complete the following steps on Whonix-Gateway ([[Qubes-Whonix]]: <code>sys-whonix</code>).

1. {{Disable_Tor}}

2. Configure Tor to use bridges. Refer to the [[Bridges|Bridges]] documentation.

3. Enable Tor using whonixsetup / whonix-setup-wizard at the new location.

4. Before leaving this location, disable Tor and add a different bridge address if traveling to a different area. To revert to the usual guard nodes used at home, remove the torrc bridge settings before enabling the network, or rollback to a VM snapshot created at home.

=== Copy the Tor State File to Another sys-whonix Instance ===

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = [[Qubes-Whonix]] only!
}}


On occasion, [[Qubes-Whonix]] users may want to copy the Tor state from an existing <code>sys-whonix</code> ProxyVM to another <code>sys-whonix</code> instance. For example, this is useful for testing later Whonix releases without aiding deanonymization attempts by advanced adversaries, <ref>As the same Tor entry guard is used.</ref> or creating an identical backup that does not share any other persistent data, except for the Tor state.

The following instructions copy the Tor state from <code>sys-whonix-B</code> to <code>sys-whonix-A</code>.

'''1. In <code>sys-whonix-A</code>, stop Tor'''

{{CodeSelect|code=
sudo systemctl stop tor@default
}}

'''2. In <code>sys-whonix-A</code>, remove the Tor state file'''

Note: It is likely this command will complain that the process is busy, but this can be safely ignored.

{{CodeSelect|code=
sudo rm -r /var/lib/tor
}}

'''3. In <code>sys-whonix-A</code>, ensure ''/var/lib/tor'' is empty'''

Note: This command should not produce any output.

{{CodeSelect|code=
sudo ls /var/lib/tor
}}

'''4. In <code>sys-whonix-B</code>, stop Tor'''

{{CodeSelect|code=
sudo systemctl stop tor@default
}}

'''5. In <code>sys-whonix-B</code>, copy the Tor state file across to <code>sys-whonix-A</code>'''

Note: Users must upgrade to a root prompt (<code>root@host:#</code>) for the command to exit successfully.

{{CodeSelect|code=
sudo su
}}

{{CodeSelect|code=
qvm-copy /var/lib/tor sys-whonix-A
}}

If the following error appears, it can be safely ignored (hit "OK" when prompted).

<pre>
qfile-agent: Fatal error: stat “VM” (error type: No such file or directory)
</pre> 

'''6. In <code>sys-whonix-A</code>, list the QubesIncoming directory to ensure the Tor state file was copied over successfully'''

{{CodeSelect|code=
ls ~/QubesIncoming/sys-whonix-B/tor
}}

The output should include the files below.

   <code>cached-certs cached-microdescs lock</code>
   <code>cached-microdesc-consensus cached-microdescs.new state</code>

'''7. In <code>sys-whonix-A</code>, move the newly copied Tor state file to ''/var/lib/tor'''''

{{CodeSelect|code=
sudo mv ~/QubesIncoming/sys-whonix-B/tor/* /var/lib/tor
}}

'''8. In <code>sys-whonix-A</code>, ensure all files listed in step 6 are now in ''/var/lib/tor'' and have the proper ownership'''

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = For Tor to function, files in this directory should be owned by <code>debian-tor</code>. If files do not have proper ownership, proceed to step 9. Otherwise skip to step 11.
}}


{{CodeSelect|code=
sudo ls -l /var/lib/tor
}}

Note: The first 2 lines of the output should look similar to this. Notice the proper file ownership "<code>debian-tor debian-tor</code>".

    <code>-rw------- 1 debian-tor debian-tor 20442 Feb 22 21:22 cached-certs</code>
    <code>-rw------- 1 debian-tor debian-tor 1985454 Apr 4 00:04 cached-microdesc-consensus</code>

'''9. In <code>sys-whonix-A</code>, change ownership of all files in the Tor state folder to <code>debian-tor</code>'''

{{CodeSelect|code=
sudo chown -R debian-tor:debian-tor /var/lib/tor
}}

'''10. In <code>sys-whonix-A</code>, verify Tor state files are owned by <code>debian-tor</code>'''

{{CodeSelect|code=
sudo ls -l /var/lib/tor
}}

'''11. In <code>sys-whonix-A</code>, start Tor'''

{{CodeSelect|code=
sudo systemctl start tor@default
}}

'''12. In <code>sys-whonix-B</code>, verify Tor is functioning properly'''

{{CodeSelect|code=
whonixcheck -v
}}

=== Fresh Tor Entry Guards by Regenerating the Tor State File ===

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text       = The action is inadvisable unless the user is aware of the consequences; see [[#Introduction|Introduction]]. 
}}


The following instructions manually change a user's Tor entry guards. One use case for this action is before a user permanently relocates to a new area.

Complete the following steps on Whonix-Gateway ([[Qubes-Whonix]]: <code>sys-whonix</code>).

1. {{Disable_Tor}}

2. Delete Tor's state file.

{{CodeSelect|code=
sudo rm /var/lib/tor/state
}}

3. Enable Tor using whonixsetup / whonix-setup-wizard at the new location.

=== Configure Non-Persistent Entry Guards ===

Some users may consider configuring non-persistent entry guards so they constantly change. In almost all cases this is inadvisable, because persistent entry guards are a critical security feature as explained in the [[#Introduction|introduction]]. A far more secure alternative is [[#Alternating Bridges|Alternating Bridges]], although this requires a considerable time investment.

<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
To proceed in spite of the warning, press on expand on the right.
<div class="mw-collapsible-content">
Complete these steps in Whonix-Gateway ([[Qubes-Whonix]]: <code>sys-whonix</code>).

1. If using Whonix 12 or earlier, adjust whonixcheck settings.

{{Open with root rights|filename=
/etc/whonix.d/50_user.conf
}}

Add.

{{CodeSelect|code=
whonixcheck_skip_functions+=" check_tor_pid "
}}

Save.

2. {{Disable_Tor}}

3. Modify Tor settings.

{{Open /etc/tor/torrc}}

Add.

{{CodeSelect|code=
DataDirectory /var/run/tor
}}

Save.

4. Enable Tor using whonixsetup / whonix-setup-wizard at the new location.

5. Before leaving this location, disable Tor and repeat the above steps if traveling to a different area. To revert to the usual guard nodes at home, remove the torrc setting before enabling the network, or rollback to a VM snapshot that was created there.
</div>
</div>

=== Notes ===

* The proposed Tails solutions towards AdvGoalTracking have disadvantages <ref>https://tails.boum.org/blueprint/persistent_Tor_state/</ref> <ref>https://blog.torproject.org/blog/tor-weekly-news-%E2%80%94-june-17th-2015#A_persistent_Tor_state_for_Tails</ref> and are not suitable options for Whonix. The reason is Whonix does not connect directly to a user's internet LAN, so trying to remember a network based on its SSID will not work. Unlike wireless access points, physical or virtual wired networks lack SSIDs and cannot be "remembered" that way.

* Even if it were possible, it is best to avoid letting adversaries influence guard changes in any way. Spoofing MAC addresses or SSIDs would trigger the use of the alternate entry guard recorded for another "location profile". Global networks also have generic characteristics that cannot be differentiated from the point of view of a connecting device, resulting in the same guards being used on different networks.

* Developers/Auditors-only: The development discussion related to this documentation chapter: [https://phabricator.whonix.org/T94 research non-persistent entry guards].

== Blacklist Certain Onion Services from Connecting ==

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = This procedure is experimental. Testers only.
}}

{{Open /etc/tor/torrc}}

The following is an example onion service that is added to {{Code2|/etc/tor/torrc}}. Replace {{Code2|bbbbbb6qtmqg65g6.onion}} with the actual onion service that should be blacklisted.

{{CodeSelect|code=
MapAddress bbbbbb6qtmqg65g6.onion 127.0.0.1
}}

{{Reload_Tor}}

== Additional SocksPorts ==

Adding additional Tor SocksPorts to ''/etc/tor/torrc'' is non-intuitive. <ref>https://trac.torproject.org/projects/tor/ticket/15261</ref>

As noted in the Tor man page (<code>man tor</code>):

<blockquote>
By default, an option on the command line overrides an option found in the configuration file, and an option in a configuration file overrides one in the defaults file. <br />
<br />
This rule is simple for options that take a single value, but it can become complicated for options that are allowed to occur more than once: if you specify four SOCKSPorts in your configuration file, and one more SOCKSPort on the command line, the option on the command line will replace <u>all</u> of the SOCKSPorts in the configuration file.  If this is not what you want, prefix the option name with a plus sign, and it will be appended to the previous set of options instead.
</blockquote>

Nick Mathewson from The Tor Project has also noted: <ref>https://trac.torproject.org/projects/tor/ticket/15261#comment:1</ref>

<blockquote>
So to make sure that the SocksPort in the torrc does what you want, write it as <code>+SocksPort</code>.
</blockquote>

After adding custom ports, a user would also have to edit the Whonix firewall unless they were lucky. For example, various custom ports for such use cases have already been added. Those are documented [[Stream_Isolation#How_to_mitigate_identity_correlation|here]].

= UDP =
{{Tor_UDP}}

= Reload Tor =
{{Reload_Tor}}

= Restart Tor =
{{Restart_Tor}}

= Disable Tor =
{{Disable_Tor}}

= Footnotes / References =
<references />

{{Footer}}

[[Category:Documentation]]
