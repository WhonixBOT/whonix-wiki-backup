{{Header}}
{{#seo:
|description=Notes about Tor (The Onion Router) on Log Analysis, Non-Persistent Entry Guards, Blacklist Certain Onion Services from Connecting, Additional SocksPorts, UDP and more.
|image=https://www.whonix.org/w/images/3/32/Menger-702837640.jpg
}}

= Configuration Check =
To discover if there are any Tor configuration syntax errors and to see which Tor configuration files are processed in which order, run the following command inside Whonix-Gateway ([[Qubes-Whonix]]: <code>sys-whonix</code>).

{{CodeSelect|code=
anon-verify
}}

The output should be similar to the following.

<pre>
/===================================================================\
|                      Report Summary                               |
\===================================================================/
No error detected in your Tor configuration.
Tor verify exit code: 0
/===================================================================\
|                      Tor Full Report                              |
\===================================================================/
Aug 09 19:29:56.669 [notice] Tor 0.3.3.9 (git-ca1a436fa8e53a32) running on Linux with Libevent 2.0.21-stable, OpenSSL 1.1.0f, Zlib 1.2.8, Liblzma 5.2.2, and Libzstd 1.1.2.
Aug 09 19:29:56.669 [notice] Tor can't help you if you use it wrong! Learn how to be safe at https://www.torproject.org/download/download#warning
Aug 09 19:29:56.669 [notice] Read configuration file "/usr/share/tor/tor-service-defaults-torrc".
Aug 09 19:29:56.669 [notice] Read configuration file "/etc/tor/torrc".
Aug 09 19:29:56.672 [notice] You configured a non-loopback address '10.137.8.1:5300' for DNSPort. This allows everybody on your local network to use your machine as a proxy. Make sure this is what you wanted.
Aug 09 19:29:56.672 [notice] You configured a non-loopback address '10.137.8.1:9040' for TransPort. This allows everybody on your local network to use your machine as a proxy. Make sure this is what you wanted.
Configuration was valid
/===================================================================\
|                 Used Tor Configuration Files                      |
\===================================================================/
5 files are used as Tor configuration files: 
/usr/share/tor/tor-service-defaults-torrc /etc/tor/torrc /etc/torrc.d/95_whonix.conf /usr/local/etc/torrc.d/40_tor_control_panel.conf /usr/local/etc/torrc.d/50_user.conf
=====================================================================
</pre>

= Edit Tor Configuration =
{{Open /usr/local/etc/torrc.d/50 user.conf}}

= Log Analysis =

== Introduction ==

Analysis of Tor's log can be useful if connectivity issues emerge.

== Open Tor Log ==

Users can inspect two logs:

* The persistent Tor log: ''/var/log/tor/log''; and/or
* The Tor log since last boot: ''/var/run/tor/log'' <ref>
{{Code2|/var/run/tor/log}} is a Tor configuration file specific to Whonix and an alternative to {{Code2|/var/log/tor/log}}. The former only contains Tor's output since Whonix-Gateway (<code>sys-whonix</code>) last booted. The latter is a permanent log that persists across reboots. The former has a small usability advantage because it is shorter and should therefore contain more relevant information.
</ref>

{{open with root rights|filename=
/var/run/tor/log
}}

== Watch Tor Log ==

Users can also watch Tor's log as it is written.

{{CodeSelect|code=
sudo tail -f /var/run/tor/log
}}

This command is especially useful when Tor is reloaded or restarted simultaneously in another terminal window. 

To [[#Reload Tor|reload Tor]], run the following command.

{{CodeSelect|code=
sudo service tor@default reload
}}

To [[#Restart Tor|restart Tor]], run the following command.

{{CodeSelect|code=
sudo service tor@default restart
}}

= Permissions Fix =
If error messages like the following appear.

<pre>
Oct 24 07:22:15.693 [warn] Directory /var/lib/tor/.tor cannot be read: Permission denied
</pre>

<pre>
Oct 25 12:35:07.460 [warn] Directory /var/lib/tor cannot be read: Permission denied
</pre>

<pre>
Oct 25 12:35:07.460 [warn] Failed to parse/validate config: Couldn't access private data directory "/var/lib/tor"
</pre>

Then apply the following steps.

'''1.''' {{Open a Whonix-Gateway Terminal}}

'''2.''' Apply a permissions fix for the Tor data folder.

{{CodeSelect|code=
sudo chown --recursive debian-tor:debian-tor /var/lib/tor
}}

'''3.''' {{Restart_Tor}}

Error messages should no longer appear after completing these steps. <ref>[https://phabricator.whonix.org/T855 whonixcheck check /var/lib/tor folder permission]</ref>

= Non-Issues =

{| class="wikitable" style="background-color: #fff;text-align: left"

! '''Message / Question'''
! '''Answer'''

|-
| <u>{{Code2|Am I compromised? Does Tor's log report leaks?}}
| Tor's output is an ineffective tool for discovering serious issues such as a compromise or leaks.</u>

|-
| {{Code2|[WARN] Socks version 71 not recognized. (Tor is not an http proxy.)}}
| 
This warning is caused by [[whonixcheck]], specifically the function {{Code2|check_tor_socks_port_reachability}} which checks if a Tor SocksPort is reachable by trying to fetch it using curl. <ref>
{{CodeSelect|code=
{{Curl_Plain}} 10.152.152.10:9100
}}
</ref> No warnings appear if the function works correctly.

|-
| {{Code2|[NOTICE] You configured a non-loopback address '10.152.152.10:9179' for SocksPort. This allows everybody on your local network to use your machine as a proxy. Make sure this is what you wanted. [1 duplicate hidden]}} This notice may reference other port numbers, or the DnsPort or TransPort.
| This notice is not a concern because Tor really listens on that IP/port - it is the internal network interface for Whonix-Gateway (<code>sys-whonix</code>) that is only available to Whonix-Workstations because Whonix-Gateway (<code>sys-whonix</code>) is firewalled. See ''{{WhonixFirewall}}'' or the Whonix source code for further information.

|-
| {{Code2|[NOTICE] New control connection opened. [2 duplicates hidden]}} A higher number of duplicate messages may also appear.
| This notice is not a concern because it is caused by [[whonixcheck]]'s Tor Bootstrap Status Test, which uses Tor's ControlPort or [[Dev/CPFP|CPFP]].

|}

= Version Number =
To discover what Tor version is currently in use, run the following command inside Whonix-Gateway ([[Qubes-Whonix]]: <code>sys-whonix</code>).

{{CodeSelect|code=
anon-info
}}

The output should be similar to the following.

<pre>
INFO: version of the 'tor' package: 0.3.4.8-1~d90.stretch+1
</pre>

= Advanced Topics =

== Additional SocksPorts ==

Adding additional Tor SocksPorts to ''/usr/local/etc/torrc.d/50_user.conf'' is non-intuitive. <ref>https://trac.torproject.org/projects/tor/ticket/15261</ref>

As noted in the Tor man page (<code>man tor</code>):

<blockquote>
By default, an option on the command line overrides an option found in the configuration file, and an option in a configuration file overrides one in the defaults file. <br />
<br />
This rule is simple for options that take a single value, but it can become complicated for options that are allowed to occur more than once: if you specify four SOCKSPorts in your configuration file, and one more SOCKSPort on the command line, the option on the command line will replace <u>all</u> of the SOCKSPorts in the configuration file.  If this is not what you want, prefix the option name with a plus sign, and it will be appended to the previous set of options instead.
</blockquote>

Nick Mathewson from The Tor Project has also noted: <ref>https://trac.torproject.org/projects/tor/ticket/15261#comment:1</ref>

<blockquote>
So to make sure that the SocksPort in the torrc does what you want, write it as <code>+SocksPort</code>.
</blockquote>

After adding custom ports, a user would also have to edit the Whonix firewall unless they were lucky. For example, various custom ports for such use cases have already been added. Those are documented [[Stream_Isolation#How_to_mitigate_identity_correlation|here]].

== Blacklist Certain Onion Services from Connecting ==

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = This procedure is experimental. Testers only.
}}

{{Open /usr/local/etc/torrc.d/50_user.conf}}

The following is an example onion service that is added to {{Code2|/usr/local/etc/torrc.d/50_user.conf}}. Replace {{Code2|bbbbbb6qtmqg65g6.onion}} with the actual onion service that should be blacklisted.

{{CodeSelect|code=
MapAddress bbbbbb6qtmqg65g6.onion 127.0.0.1
}}

{{Reload_Tor}}

== Entry Guards ==
{{Anchor|Manual Rotation of Tor Guards}}
{{Anchor|Security and Performance Related Issues}}
{{Anchor|Mitigate the Threat of Guard Fingerprinting}}
{{Anchor|Clone Whonix-Gateway (sys-whonix) with New Entry Guards}}
{{Anchor|Regenerate the Tor State After Saving the Tor State Folder}}
{{Anchor|Alternating Bridges}}
{{Anchor|Copy Tor State Files to Another sys-whonix Instance}}
{{Anchor|Fresh Tor Entry Guards by Regenerating the Tor State File}}
{{Anchor|Notes}}

This entry has been moved [[Tor_Entry_Guards|here]].

== Manual Bridge Configuration ==
It is recommended to first read the main [[Bridges]] article.

For the majority of users, the [[Anon_Connection_Wizard|Anon Connection Wizard]] GUI application is suitable for bridge configuration. The manual bridge configuration steps below are only recommended for advanced users.

=== Step 1: Access Tor Configuration to Add Bridges ===

{{Open_/usr/local/etc/torrc.d/50_user.conf}}

=== Step 2: Edit Tor Configuration ===

==== Use obfs3 and obfs4 Bridges ====

<div class="toccolours mw-collapsible mw-collapsed">
<div class="mw-collapsible-content">

Open {{Code2|/usr/local/etc/torrc.d/50_user.conf}} in an editor, then copy and paste the following text to enable the use of {{Code2|obfs3}} and {{Code2|obfs4}} bridges. <ref>
{{CodeSelect|code=
ClientTransportPlugin fte exec /usr/bin/fteproxy --managed
}}
</ref>

{{CodeSelect|code=
UseBridges 1
ClientTransportPlugin obfs3,obfs4 exec /usr/bin/obfs4proxy
}}

Now add the bridge IP addresses that were sourced in the [[#Finding_a_bridge_and_choosing_the_right_protocol|Finding a Bridge and Choosing the Right Protocol]] section. Copy and paste the IP addresses to the very bottom of {{Code2|/usr/local/etc/torrc.d/50_user.conf}}, <u>after the ClientTransportPlugin entries</u>. Users must ensure that "bridge" appears at the beginning of each line.

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = In the <i>obfs3</i> and <i>obfs4</i> examples below: <br />
* <u>Do not copy and paste this list of bridge entries to the {{Code2|50_user.conf}} file.</u> They will not work.
* Retrieve [https://bridges.torproject.org/bridges?transport=obfs3 obfs3 bridges] or [https://bridges.torproject.org/bridges?transport=obfs4 obfs4 bridges] from The Tor Project <u>before</u> editing this file.
* Use <u>either</u> the <i>obfs3</i> or <i>obfs4</i> protocol, not both.
* <u>Capitalization in the {{Code2|50_user.conf}} file matters.</u> For example, bridges will not connect if users type "Bridge" instead of "bridge".
}}


{{Code2|Obfs3}} example text to add to {{Code2|/usr/local/etc/torrc.d/50_user.conf}}.

{{CodeSelect|code=
bridge obfs3 109.195.132.77:22321 4352e58420e68f5e40bf7c74faddccd9d1349413
bridge obfs3 55.32.27.22:38123  4352e58420e68f5e40bf7c74faddccd9d1349413
bridge obfs3 192.24.131.513:62389 4352e58420e68f5e40bf7c74faddccd9d1349413
}}

{{Code2|Obfs4}} example text to add to {{Code2|/usr/local/etc/torrc.d/50_user.conf}}.

{{CodeSelect|code=
bridge obfs4 192.235.207.85:42086 0EEB10BF4B4FAF56D46E cert=oue8sYYw5wi4n3mf2WDOg iat-mode=0
bridge obfs4 34.218.26.20:43263 DD21A551767816A0C9495 cert=7qzS6KASquPvJU82Fm7qoJw iat-mode=0
bridge obfs4 161.217.177.95:10703 B3B8009D01BB7E5FDFAEC cert=4RaIqGiOytEXm6Hw iat-mode=0
}}

The sample text for a complete {{Code2|obfs4}} torrc file is below. Check your file is similar, except for the specific bridge entries.
<pre>
# This file is part of Whonix
# Copyright (C) 2012 - 2013 adrelanos
# See the file COPYING for copying conditions.

# Use this file for your user customizations.
# Please see /usr/local/etc/torrc.d/50_user.conf.examples for help, options, comments etc.

# Anything here will override Whonix's own Tor config customizations in /usr/share/tor/tor-service-defaults-torrc

# Enable Tor through whonixsetup or manually uncomment "DisableNetwork 0" by
# removing the # in front of it.
DisableNetwork 0
UseBridges 1
ClientTransportPlugin obfs3,obfs4 exec /usr/bin/obfs4proxy

bridge obfs4 192.235.207.85:42086 0EEB10BF4B4FAF56D46E cert=oue8sYYw5wi4n3mf2WDOg iat-mode=0
bridge obfs4 34.218.26.20:43263 DD21A551767816A0C9495 cert=7qzS6KASquPvJU82Fm7qoJw iat-mode=0
bridge obfs4 161.217.177.95:10703 B3B8009D01BB7E5FDFAEC cert=4RaIqGiOytEXm6Hw iat-mode=0
</pre>

<ref>
{{Code2|fte}} example text to add to {{Code2|/usr/local/etc/torrc.d/50_user.conf}}. 

fte is not yet supported in Whonix 14; wait for the Whonix 15 release. https://phabricator.whonix.org/T520
{{CodeSelect|code=
ClientTransportPlugin fte exec /usr/bin/fteproxy --managed
bridge fte 10.200.100.60:95128 4352e58420e68f5e40bf7c74faddccd9d1349413
bridge fte 300.100.300.80:23521 4352e58420e68f5e40bf7c74faddccd9d1349413
}}
</ref>

After {{Code2|/usr/local/etc/torrc.d/50_user.conf}} editing is finished, save and exit.

<pre>
<Ctrl-X> --> press Y --> <Enter>
</pre>

</div>
</div>

==== Use meek_lite Bridges ====

<div class="toccolours mw-collapsible mw-collapsed">
<div class="mw-collapsible-content">

Starting with Whonix 14, {{Code2|meek_lite}} bridges are available. To use them, simply add one more line to the {{Code2|/usr/local/etc/torrc.d/50_user.conf}} file. Take note the bridge type is called {{Code2|meek_lite}}, not {{Code2|meek}} which is used in Tor Browser Bundle. <ref>{{Code2|meek_lite}} actually uses a different implementation of {{Code2|obfs4proxy}}. Forum discussion: https://forums.whonix.org/t/censorship-circumvention-tor-pluggable-transports/2601/3</ref>

Open {{Code2|/usr/local/etc/torrc.d/50_user.conf}} in an editor, then copy and paste the following text to enable {{Code2|meek_lite}} bridges.

{{CodeSelect|code=
ClientTransportPlugin meek_lite exec /usr/bin/obfs4proxy
}}

An example of {{Code2|meek_lite}} text that must be added to the {{Code2|/usr/local/etc/torrc.d/50_user.conf}} file is below. The bridge in this example is functional, so a search for other {{Code2|meek_lite}} bridges is unnecessary.

{{CodeSelect|code=
bridge meek_lite 0.0.2.0:2 B9E7141C594AF25699E0079C1F0146F409495296 url=https://d2cly7j4zqgua7.cloudfront.net/ front=a0.awsstatic.com
}}

After {{Code2|/usr/local/etc/torrc.d/50_user.conf}} editing is finished, save and exit.

<pre>
<Ctrl-X> --> press Y --> <Enter>
</pre>

</div>
</div>

=== Step 3: Enable Tor ===

Follow this procedure if it has not been previously completed.

{{Enable_Tor}}

=== Step 4: Have {{Code2|/usr/local/etc/torrc.d/50_user.conf}} Changes Take Effect ===

{{Reload_Tor}}

== Tor Functions ==

=== Disable Tor ===
Disable Tor using Anon Connection Wizard (safest option).

Start Anon Connection Wizard.

{{Start_Anon_Connection_Wizard}}

Choose the {{Code2|Disable Tor}} option. Press next.

=== Reload Tor ===
{{Reload_Tor}}

=== Restart Tor ===
{{Restart_Tor}}

== UDP ==
{{Tor_UDP}}

== ICMP ==
Same as above.

= Further Reading =

* [[Why_does_Whonix_use_Tor|Why does Whonix use Tor?]]
* [[Why is Tor slow|Why is Tor slow?]]
* [[Bridges|Censorship Circumvention - Tor Bridge Mode, using (Private) (Obfuscated) Bridges]].
* [[Hide Tor and Whonix from your ISP]].
* [[Tor Controller|Controlling Tor]].
* [[Onion Services|Hosting Tor Onion Services (<u>any</u> Hidden Webserver)]].
* [[Comparison Of Tor Proxies CGI proxies Proxy Chains And VPN Services|Comparison of Tor, Proxies, CGI proxies, Proxy Chains and VPN Services]].
* [[Tor_Versioning|Newer Tor versions]].

= Footnotes / References =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
