{{#seo:
|description=Qubes-Whonix development notes.
}}
{{Header}}

= Debian Template =
https://groups.google.com/forum/#!topic/qubes-devel/EBxvtMlwp5k

= Config Files Changes =
[https://groups.google.com/d/msg/qubes-users/AqZV65yZLuU/RQlLPOn5yRsJ source]

I don't know how rpm packaging works. However, the TorVM rpm packaging seems simpler to me and introduce less overhead than Debian packaging at first view. Is there something like config-package-dev for Fedora? config-package-dev is a package to overtake ownership of other
> package's files. Such as, in Debian the Tor package owns /usr/share/tor/tor-service-defaults-torrc. Whonix needs to modify that file and keep it updated. config-package-dev can be used to avoid getting the file being overwritten when upstream releases and upgrade. Is there something like this for Fedora or is this even required? That would make a port much simpler, because for many parts, it's just diverted config files.

qubes-tor pacakages provides own config file (tor --defaults-torrc option used), so no need to override the one provided by tor package.

But to answer your question - no, rpm do not have option to take ownership of files from other packages, but to workaround this (rather sensible) limitation you can modify the config in triggers (so the file will be modified after each original package update).

= IPs =
[https://groups.google.com/d/msg/qubes-devel/jxr89--oGs0/IcA4pia70-0J source]

Qubes uses non-fixed LAN IPs? How do internal LAN IPs get assigned to TorVM / AppVMs?

QubesVm IP address is generated based on its netvm ID (subnet number) and the said VM static ID, so unless user is switching netvm, the IP is pretty static. We've chosen 10.137.<subnet-id>.<vm-id> which is quite exotic so conflicts with real LAN are very rare (even if rather harmless in isolated network).

= Tor Browser =

[https://groups.google.com/d/msg/qubes-devel/Dd0MVbIam5I/9z6GblxYQHwJ source]

In your Torless TBB launcher script for use with Qubes' transparent Tor proxy, TOR_SOCKS_HOST=10.137.3.1. Is this supposed to be the same for all Qubes machines regardless of how many ProxyVMs users have created (or other user settings)? Or is the user supposed to change this before using the script?

Perhaps it is good idea to add some firewall rule in TorVM to redirect traffic to any 10.137.0.0/16 IP + port 9050/9049 to the tor running in TorVM. This way AnonVM can use any IP as a sock proxy address.

= Run updates over Proxy/Tor =
[https://groups.google.com/d/msg/qubes-devel/2vnGqsoM9p0/0YCltU-Qs-MJ source]

Without wasting a lot space, having lots of standalone VMs... How could one persistently install software in QubesOS using package managers over Tor just for a specific VM? Routing all traffic over Tor is also an option, but not a ideal one either (having some clearnet traffic is better for various reasons).

Set TorVM as netvm for the template. By default template updates are routed via "update proxy" (simple http proxy, which allow access only to
yum-repository-like sites). This proxy is running in netvm, so after TorVM. Because of that its you need to disable 'yum-proxy-setup' service for this
template and allow some traffic in the firewall settings. Or enable 'qubes-yum-proxy' service in TorVM and ensure that its traffic goes through tor.

= Time Sync =
== Introduction ==
Discussion about insecurity of NTP: <br />
https://groups.google.com/d/msg/qubes-devel/YHK_rAUm0s0/ARrBPHrf0fkJ

[https://groups.google.com/d/msg/qubes-users/AqZV65yZLuU/Lh8T7ZL6tdIJ source]

Can Qubes OS leave VM's clocks untouched and keep time sync to the VM or is there some forced-VM-timesync-with-dom-0 that can not be turned off? In that case, that would be a bad.

Currently time synchronization is done in some silly way: qvm-sync-clock called each 6min from dom0 cron. That tool fetch the current time using
ntpdate in netvm (VM set as clockvm in qubes-prefs), then pass the result to 'date -s' in each VM.

You can disable this mechanism globally by unsetting(*) clockvm (qubes-prefs -s clockvm none).

(*) Which apparently was broken, fix will be included in updates soon.

== Instructions ==
'''UNTESTED!'''

Install a comfortable editor (optional!).

<pre>
sudo qubes-dom0-update kate
</pre>

Edit your VM settings. (Feel free to drop 'EDITOR=kate' and/or to use an editor of your choice.)

<pre>
sudo EDITOR=kate virsh edit whonix-ws
</pre>

Find the following block.

<pre>
<clock offset='utc' adjustment='reset'>
   <timer name='tsc' mode='native'/>
</clock>
</pre>

Replace it with the following.

<pre>
  <clock offset='utc'>
    <timer name='rtc' tickpolicy='catchup' track='guest'/>
    <timer name='xen' present='no'/>
  </clock>
</pre>

= How big is Qubes OS's user base? =
https://groups.google.com/d/msg/qubes-users/AqZV65yZLuU/Kib1jFLZanUJ

= IP Spoofing Protection =
[https://groups.google.com/d/msg/qubes-devel/le7-Rrq6yxY/nhhpXX1QNRsJ source]

AppVMs can't spoof each other in Qubes' network.

Corollary: stream isolation cannot be circumvented.

= Inter-VM Networking =
Current Qubes + Whonix implementation has both the Whonix-Gateway and Whonix-Workstation connected to the same backend FirewallVM and iptables forwarding is manually established between the Whonix IP addresses. This current method is really just an efficient hack for our initial Qubes + Whonix implementation. The native/proper way to network VMs in Qubes is via chaining their networking "backend" together, which is part of Xen networking structure. This is how other VMs in Qubes are networked, including TorVM. According to Qubes devs, these Xen backends provide simple point-to-point networking between VMs. So this would be advantageous for further isolation of inter-VM Whonix traffic, since, currently, all inter-VM traffic is routed through the internet-facing FirewallVM, which can also be shared by other VMs. This current implementation with a shared FirewallVM could be somewhat of a security concern for inter-VM traffic, and a reason to move to native/proper isolated point-to-point "backend" networking. Also, in the future, it is desirable to leverage full ProxyVM/ServiceVM networking between Whonix-Gateway and Whonix-Workstation, as the TorVM does. ProxyVM utilizes Xen "backend" networking but automates it with transparent Qubes GUI networking, making use of dynamically created virtual networking interfaces. Whonix may need to add onto or adjust its internal networking setup to be compatible with such native Qubes networking.

Discussions related to this topic:
* https://groups.google.com/d/topic/qubes-users/RFXoZ3zt-PE
* https://groups.google.com/d/msg/qubes-users/GhgWH5mHf2E/0LU35M6GPecJ
* https://groups.google.com/d/msg/qubes-users/GhgWH5mHf2E/96odaNoBVRwJ

= Forum Discussion =
[https://forums.whonix.org/t/qubes-whonix/374 Qubes + Whonix]

= IP =
== grep -r 10.152.152.10 * ==
<pre>
packages/anon-ws-leaktest/usr/lib/leaktest-workstation/simple_ping.py:target = "10.152.152.10"
</pre>
Let's make a patch adding command line support implementing either --qubes or --ip?

<pre>
packages/whonixcheck/usr/lib/whonixcheck/preparation:      GATEWAY_IP="10.152.152.10"
packages/whonixcheck/usr/lib/whonixcheck/preparation:      GATEWAY_IP="10.152.152.10"
</pre>
Overruleable. These variables get only set there if they are not yet set. So they can be manipulated by using environment variables, or better by dropping a config snippet to {{Code|/etc/whonix.d/40_qubes}}, {{Code|/etc/whonix.d/40_qubes}} that contains: export GATEWAY_IP="<qubes-ip>" <br /> (Make that {{Code|40_qubes_autogenerated}} if the file gets autogenerated.)

<pre>
packages/anon-kde-streamiso/usr/share/anon-kde-streamiso/share/config/kioslaverc:socksProxy=http://10.152.152.10 9122
</pre>
We could implement a package anon-kde-streamiso-qubes, that overrules anon-kde-streamiso and that gets only installed when using --qubes. ([http://lists.kde.org/?l=kde&m=141130406809446&w=2 KDE config files are stackable although debuging is a bit cumbersome].) We'd just have to make sure the path to anon-kde-streamiso-qubes comes (before or after?) anon-kde-streamiso's path in the KDEDIRS envrionment variable.

Or we could install either anon-kde-streamiso or anon-kde-streamiso-qubes (--qubes) depending on which build switch is being used.

<pre>
packages/anon-kde-streamiso/debian/control: settings are set, for KDE applications to socks 10.152.152.10:9122.
packages/anon-kde-streamiso/README.md:settings are set, for KDE applications to socks 10.152.152.10:9122.
</pre>
Just a package description strings doing nothing. Either nevermind or rewrite the comment.

<pre>
packages/whonix-base-files/etc/apt/apt.conf.d/90whonix:## running on 127.0.0.1:9104 forwarding to 10.152.152.10:9104.
packages/whonix-base-files/etc/apt/apt.conf.d/90whonix:## running on 127.0.0.1:9104 forwarding to 10.152.152.10:9104.
packages/whonix-base-files/etc/apt/apt.conf.d/90whonix:## running on 127.0.0.1:9104 forwarding to 10.152.152.10:9104.
packages/whonix-base-files/etc/apt/apt.conf.d/90whonix:#Acquire::socks::proxy "socks://10.152.152.10:9104/";
</pre>
These are just comments doing nothing. We can either nevermind or rewrite the comments.

<pre>
packages/whonix-ws-firewall/usr/bin/whonix_firewall:[ -n "$GATEWAY_IP" ] || GATEWAY_IP="10.152.152.10"
packages/whonix-ws-firewall/etc/whonix_firewall.d/30_default.conf:GATEWAY_IP="10.152.152.10"
</pre>
Overrulable. <br />
File: /etc/whonix_firewall.d/40_qubes <br />
Content: GATEWAY_IP="<qubes-ip>" <br />
Note: Keep a possible race condiation in mind. Depending on how that config snippnett is created and when whonix_firewall starts. Should the config change after whonix_firewall was already loaded, reload Whonix's firewall ("sudo whonix_firewall").

<pre>
packages/anon-shared-helper-scripts/usr/lib/anon-shared-helper-scripts/tor_bootstrap_check.bsh:            TOR_CONTROL_HOST="10.152.152.10"
packages/anon-shared-helper-scripts/usr/lib/anon-shared-helper-scripts/tor_bootstrap_check.bsh:            TOR_CONTROL_HOST="10.152.152.10"
</pre>
Overruleable. These variables get only set there if they are not yet set. So they can be manipulated by using environment variables, or better by dropping a config snippet to {{Code|/etc/whonix.d/40_qubes}}, {{Code|/etc/whonix.d/40_qubes}} and {{Code|/etc/torbrowser.d/40_qubes}} that contains: export TOR_CONTROL_HOST="<qubes-ip>" <br />
(Make that {{Code|40_qubes_autogenerated}} if the file gets autogenerated.)

<pre>
packages/uwt/usr/bin/uwt:        echo "         sudo $NAME -i 10.152.152.10 -p 9104 /usr/bin/apt-get --yes dist-upgrade"
</pre>
Just an output string when using "uwt -h". Not overrulable at the moment. We can either put both IPs in there. Or would it be worth sourcing the /etc/uwt.d folder to make that IP configurable? (It is also a performance question.)

<pre>
packages/uwt/etc/uwt.d/30_uwt_default:      uwtwrapper_gateway_ip="10.152.152.10"
</pre>
Overrulable. Create a file /etc/uwt.d/40_qubes with content: uwtwrapper_gateway_ip="<qubes-ip>".

<pre>
packages/uwt/man/uwt.1.ronn:`sudo uwt -t 5 -i 10.152.152.10 -p 9104 /usr/bin/apt-get.anondist-orig --yes dist-upgrade`
packages/uwt/man/uwt.1.ronn:    uwt -t 5 -i 10.152.152.10 -p 9109 /usr/bin/wget ${1+"$@"}
</pre>
Just a man page documentation string. We could modify the man page to cover both use cases.

<pre>
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:TransPort 10.152.152.10:9040
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:DnsPort 10.152.152.10:53 IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9050
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9100
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:#SocksPort 10.152.152.10:9100 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9101 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9102 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9103 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9104
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9105 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9106 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9107 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9108 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9109 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9110 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9111
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9112
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9113
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9114 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9115 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9116 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9117 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9118 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9119
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9120 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9121 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9122
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9123
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9124
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:##  127.0.0.1:9150 to 10.152.152.10:9150 [as part of the
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9150
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9152
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9153
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9154
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9155
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9156
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9157
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9158
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9159
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9160 IsolateDestAddr
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9161 IsolateDestAddr
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9162 IsolateDestAddr
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9163 IsolateDestAddr
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9164 IsolateDestAddr
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9165 IsolateDestAddr
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9166 IsolateDestAddr
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9167 IsolateDestAddr
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9168 IsolateDestAddr
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9169 IsolateDestAddr
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9170 IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9171 IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9172 IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9173 IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9174 IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9175 IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9176 IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9177 IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9178 IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9179 IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9180 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9181 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9182 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9183 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9184 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9185 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9186 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9187 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9188 IsolateDestAddr IsolateDestPort
packages/anon-gw-anonymizer-config/usr/share/tor/tor-service-defaults-torrc.anondist:SocksPort 10.152.152.10:9189 IsolateDestAddr IsolateDestPort
</pre>
Not overrulable. Unfortunatly Tor does not support variables in config files. Should I (Patrick) make a feature request against Tor?

If you could use static IPs, we could fall back to use Debian packaging's patching mechanism. But that would be burdensome maintenance wise. Because there would be need for a separate qubes repository, that always has the patch applied. Or users would always have to upgrade from source code, which seems inconvenient. Or can we think of something else?

<pre>
packages/tb-updater/usr/bin/update-torbrowser:      [ -n "$GATEWAY_IP" ] || GATEWAY_IP="10.152.152.10"
</pre>
Overrulable. Create a file {{Code|/etc/torbrowser.d/40_qubes}} with content: GATEWAY_IP="<qubes-ip>".

<pre>
packages/whonix-legacy/debian/whonix-legacy.preinst:         sed -i 's/192.168.0.10/10.152.152.10/g' "/home/user/.torchat/torchat.ini" || true
packages/whonix-legacy/debian/whonix-legacy.preinst:         sed -i 's/192.168.0.10/10.152.152.10/g' "/home/user/.xchat2/xchat.conf" || true
</pre>
No change required here. Only applies to Whonix 8.3.

<pre>
packages/whonix-gw-network-conf/etc/network/interfaces.whonix:       address 10.152.152.10
</pre>
TODO research: Does ifupdown support variables? If not... We have to think of something.

<pre>
packages/anon-ws-dns-conf/etc/resolv.conf.anondist:nameserver 10.152.152.10
</pre>
TODO research: Does /etc/resolv.conf support variables? If not... We have to think of something.

<pre>
packages/anon-ws-dns-conf/debian/control: 10.152.152.10, where an Anon-Gateway is supposed to provide a DnsPort on port
packages/anon-ws-dns-conf/README.md:10.152.152.10, where an Anon-Gateway is supposed to provide a DnsPort on port
</pre>
Just documentation strings. Either nevermind or patch documentation.

<pre>
packages/sdwdate-plugin-anon-shared-streamiso/etc/sdwdate.d/31_anon_dist_stream_isolation_plugin:PROXY="10.152.152.10:9108"
</pre>
Overrulable. Create a file /etc/sdwdate.d/40_qubes with content: PROXY="<qubes-ip>"

<pre>
packages/sdwdate-plugin-anon-shared-streamiso/debian/control: Sets sdwdate's proxy settings to socks 10.152.152.10:9108.
packages/sdwdate-plugin-anon-shared-streamiso/README.md:Sets sdwdate's proxy settings to socks 10.152.152.10:9108.
</pre>
Just documentation strings. Either nevermind or patch documentation.

<pre>
packages/anon-ws-disable-stacked-tor/usr/lib/anon-ws-disable-stacked-tor/torbrowser.sh:##   127.0.0.1:9050 to Whonix-Gateway 10.152.152.10:9050 and
packages/anon-ws-disable-stacked-tor/usr/lib/anon-ws-disable-stacked-tor/torbrowser.sh:##   127.0.0.1:9150 to Whonix-Gateway 10.152.152.10:9150.
packages/anon-ws-disable-stacked-tor/usr/lib/anon-ws-disable-stacked-tor/torbrowser.sh:#export TOR_SOCKS_HOST="10.152.152.10"
</pre>
Just documentation strings. Either nevermind or patch documentation.

<pre>
packages/anon-ws-disable-stacked-tor/etc/rinetd.conf.anondist:127.0.0.1        9050      10.152.152.10    9050
packages/anon-ws-disable-stacked-tor/etc/rinetd.conf.anondist:127.0.0.1        9150      10.152.152.10    9150
packages/anon-ws-disable-stacked-tor/etc/rinetd.conf.anondist:127.0.0.1        11109     10.152.152.10    9119
packages/anon-ws-disable-stacked-tor/etc/rinetd.conf.anondist:127.0.0.1        9051      10.152.152.10    9052
packages/anon-ws-disable-stacked-tor/etc/rinetd.conf.anondist:127.0.0.1        9151      10.152.152.10    9052
</pre>
Maybe [https://github.com/Whonix/Whonix/issues/341 anon-ws-disable-stacked-tor: consider replacing rinetd with rlinetd] (probably not a great idea).

TODO research: does /etc/rinetd.conf support variables? If not, we have to think of something.

<pre>
packages/whonix-ws-network-conf/etc/network/interfaces.whonix:       gateway 10.152.152.10
</pre>
Same comment as whonix-gw-network-conf/etc/network/interfaces.whonix.

<pre>
packages/anon-torchat/usr/share/anon-torchat/.torchat/torchat.ini:tor_server = 10.152.152.10
packages/anon-torchat/usr/share/anon-torchat/.torchat/torchat.ini:tor_server = 10.152.152.10
</pre>
Probably requires a package anon-torchat-qubes that conflicts with anon-torchat that gets installed when using --qubes.

<pre>
packages/xchat-improved-privacy/usr/share/xchat-improved-privacy/.xchat2/xchat.conf:# /set net_proxy_host 10.152.152.10
</pre>
Just documentation strings. Either nevermind or patch documentation.

<pre>
packages/xchat-improved-privacy/usr/share/xchat-improved-privacy/.xchat2/xchat.conf:net_proxy_host = 10.152.152.10
</pre>
Just documentation strings. Either nevermind or patch documentation.

== grep -r 10.152.152.11 * ==
<pre>
packages/whonix-ws-firewall/usr/bin/whonix_firewall:##     From 10.152.152.11 icmp_seq=1 Destination Port Unreachable
</pre>
These are just comments doing nothing. We can either nevermind or rewrite the comments. 

<pre>
packages/anon-gw-anonymizer-config/etc/tor/torrc.examples:HiddenServicePort 80 10.152.152.11:80
packages/anon-gw-anonymizer-config/etc/tor/torrc.examples:HiddenServicePort 11009 10.152.152.11:11009
packages/anon-gw-anonymizer-config/etc/tor/torrc.examples:HiddenServicePort 80 10.152.152.11:80
</pre>
These are just comments doing nothing. We can either nevermind or rewrite the comments. 

<pre>
packages/whonix-legacy/debian/whonix-legacy.preinst:         sed -i 's/192.168.0.11/10.152.152.11/g' "/home/user/.torchat/torchat.ini" || true
</pre>
Same comment as for packages/whonix-legacy/debian/whonix-legacy.preinst.

<pre>
packages/whonix-ws-network-conf/etc/network/interfaces.whonix:       address 10.152.152.11
</pre>
Same comment as for packages/whonix-gw-network-conf/etc/network/interfaces.whonix above.

<pre>
packages/anon-torchat/usr/share/anon-torchat/.torchat/torchat.ini:listen_interface = 10.152.152.11
</pre>
Same comment as for packages/anon-torchat/usr/share/anon-torchat/.torchat/torchat.ini above.

= Misc =
Random facts.

* {{Code2|AdminVM}} is a synonym for {{Code2|dom0}} <ref>https://github.com/QubesOS/qubes-issues/issues/1015</ref>.
* {{Code2|AdminVM}} is not based on Fedora Template VM. More like a standalone VM.
* Qubes Q3 RC1 {{Code2|AdminVM}} is based on Fedora 20. <ref>
https://groups.google.com/d/msg/qubes-users/zHdY6Oe58t0/qSFkLZdpng4J
<blockquote>
Actually you need rpmfusion-free-release-20.noarch.rpm, as Qubes dom0 is based on Fedora 20. 
</blockquote>
</ref>
* Qubes Q3 RC1 {{Code2|Fedora Template VM}} is based on Fedora 21.

= Time = 
<pre>
sudo mv /etc/qubes-rpc/qubes.SetDateTime /etc/qubes-rpc/qubes.SetDateTime.disabled
</pre>

= tb-updater vs TemplateVM =
== prerequisite knowledge ==
* TPO stands for The Tor Project
* The /home folder of a TemplateVM is copied to a TemplateBasedVM at creation time of the TemplateBasedVM. From then, TemplateBasedVM's /home folder is left untouched. (Source: https://groups.google.com/forum/#!topic/qubes-users/WwVJhGA-Xnc)
* Tor Browser installation path in Whonix 12 will change to ~/.tb. (https://phabricator.whonix.org/T338)
* Since Qubes-Whonix 11, Tor Browser gets installed by default for new images. (Not for in place upgrades.)
* [[Tor_Browser#Tor_Browser_Updater_.28Whonix.29|Tor Browser Updater (Whonix)]] (((https://github.com/Whonix/tb-updater))) vs
* [[Tor_Browser#Tor_Browser_Internal_Updater|Tor Browser Internal Updater]]
* Tor Browser Updater (Whonix) is unable to keep user settings (modifications such as bookmarks). It renames the old folder. Adds ".old.$(date)". So nothing is lost. Then installs a fresh one. Something important to know. This limitation can probably not be lifted in tb-updater. Upgrading Tor Browser is hard. (TPO often changed the folder layout in past.) That's what Tor Browser's internal updater is for.
* No one has demonstrated yet, that it's possible to install & run and/or update TBB to either /usr/*, /opt/* or anything of that sort. This is because within the TBB folder, by TPO default, binaries and user data is mixed. (It's a portable application. [Portable with a meaning similar to portableapps.com. Portable on USB drives or similar. Not platform, arm + anything portable.])
* By TPO default, users are supposed to have TBB in their home folder.
* It is very unlikely, that TBB will be available as regular deb package anytime soon. <ref>
* [https://trac.torproject.org/projects/tor/ticket/3994 Get TorBrowser in Debian]
* [https://trac.torproject.org/projects/tor/ticket/5236 Make a deb of the Torbrowser and add to repository]
</ref>
* A quick an dirty packaging of TBB would likely require too much maintenance effort. [Needs keeping up with upstream releases.]
* Packaging TBB is further complicated, because TBB abuses Firefox's user settings mechanism for configuring anonymity related settings. (Firefox prefs) Therefore separation of binaries and user data is difficult.
* Once TBB is in user's home folder...  [as TPO wants it] [and it does not work otherwise]... And once the user used it... And once the user stored settings there that the user cares about... [bookmarks, etc...] It gets very difficult for the TemplateVM and/or tb-updater to keep the TBB folder up to date. That's what Tor Browser Internal Updater is for.
** Unfortunately, this means, if a user had for example 5 different Qubes-Whonix-Workstation based AppVMs where Tor Browser is in use, the user would have to update each of its 5 TBBs using Tor Browser Internal Updater.
** This is an issue, because Qubes updates are already complicated. (Various templates and dom0 needs to be updated.) This adds another layer of complexity. Users also have to care about updating stuff from within their AppVMs, which is counter intuitive.
** TBB stable has automatic updates enabled by default. <ref>
https://blog.torproject.org/blog/tor-browser-50-released
<blockquote>Starting with this release, Tor Browser will now also download and apply upgrades in the background, to ensure that users upgrade quicker and with less interaction. This behavior is governed by the about:config pref app.update.auto, but we do not recommend disabling it unless you really know what you're doing.</blockquote>
</ref>

== Implementation as of Qubes-Whonix 11 ==
* As of Qubes-Whonix 11 it is confusing. Running tb-updater in the TemplateVM and restarting AppVM won't result in up to date TBB's. [Since if the TemplateVM modifies /home, this will not propagate to AppVM's /home.]

== Brainstorming ==
=== Headless TBB Internal Updater Updates in AppVMs ===
We could call a qrexec service that starts TBB in each individual AppVM heedlessly (without / with hidden gui, using xvfb or similar) so it will be fetching updates.

=== up to date versions of Tor Browsers in newly created AppVMs inherited from updated TemplateVMs ===
ship Tor Browser tarballs in Qubes TemplateVMs in /var/cache/tb-binary and extract in AppVMs at boot time to user's home folder:<br />
https://phabricator.whonix.org/T417

=== keep as is ===
Newly created Qubes-Whonix-Workstation AppVMs inherit the TBB version that came pre-installed in the Qubes-Whonix-Workstation TemplateVM. From there, TBB's internal updater keeps care of updating it.

== Forum Discussion ==
* https://forums.whonix.org/t/what-should-tor-browser-updater-whonix-do-in-a-templatevm
* https://forums.whonix.org/t/idea-for-aqrexec-service-to-install-new-versions-of-tor-browser-to-a-list-of-vms

= UpdateVM =
Moved to [[Next#Torified_dom0_Updates]].

= Upgrade through Clearnet =
Just a note about upgrading a Whonix-Gateway TemplateVM through Clearnet. Untorified! This is easily possible by setting the following environment variable.

<pre>
export UWT_DEV_PASSTHROUGH="1"
</pre>

= Build Single Qubes Package =
Source: https://groups.google.com/forum/#!topic/qubes-devel/o6pn-kV7cU0

<pre>
BACKEND_VMM=xen dpkg-buildpackage -b 
</pre>

= Build Qubes-Whonix Templates - Old =
<pre>
make get-sources
</pre>

<pre>
./setup
</pre>

override.conf
<pre>
VERBOSE = 3
DEBUG = 1
REPO_PROXY = http://127.0.0.1:3142
CHECK_BRANCH = 1

BRANCH_template_whonix = master
GIT_URL_template_whonix = https://github.com/adrelanos/qubes-template-whonix.git
</pre>

Again required?

<pre>
./setup
</pre>

<pre>
make prepare-merge
</pre>

Another time. <ref>https://github.com/QubesOS/qubes-issues/issues/1420</ref>

<pre>
make prepare-merge
</pre>

<pre>
make qubes-vm
</pre>

<pre>
make templates --debug=v
</pre>

= Build Qubes-Whonix Templates - New =

<pre>
DISTS_VM="whonix-gateway whonix-workstation" \
COMPONENTS="linux-template-builder builder builder-debian template-whonix" \
BUILDER_PLUGINS="builder-debian template-whonix" \
USE_QUBES_REPO_VERSION=3.2 \
USE_QUBES_REPO_TESTING=1 \
VERBOSE=3 \
DEBUG=1 \
REPO_PROXY=http://127.0.0.1:3142 \
BRANCH_template_whonix=master \
GIT_URL_template_whonix=https://github.com/adrelanos/qubes-template-whonix.git \
make get-sources template --debug=v
</pre>

= Test =
* works as UpdateVM
* can be used as ProxyVM for Fedora and Debian templates
* whonixcheck (--verbose) in sys-whonix, whonix, whonix-gw, whonix-ws

= Qubes VM Manger Firewall Tab Settings =
([https://www.qubes-os.org/attachment/wiki/QubesFirewall/r2b1-manager-firewall.png screenshot])

Short:<br />
Have no effect for Qubes-Whonix VMs. Can be ignored.

Long <ref>https://groups.google.com/d/msg/qubes-devel/uzgN42uEJpE/hymUCMxoCwAJ</ref>:<br />
All that settings are in separate file in the VM directory - dom0 /var/lib/qubes/appvms/whonix/firewall.xml. If the VM is running, those settings are converted to iptables syntax and loaded into QubesDB of directly connected ProxyVM. The qubes-firewall service in the ProxyVM watch for such changes and applies the rules.

I.e. in case of Whonix, the connected ProxyVM is sys-whonix. Since in Whonix qubes-firewall service is disabled (Whonix 12 <ref>https://github.com/Whonix/qubes-whonix/blob/master/lib/systemd/system/qubes-firewall.service.d/40_qubes-whonix.conf</ref>), these settings do not affect Whonix. ([https://github.com/Whonix/qubes-whonix/blob/master/lib/systemd/system/qubes-whonix-firewall.service qubes-whonix-firewall.service] is what Whonix uses.)

= Qubes Upstream Bugs =
Usability:

* [https://github.com/QubesOS/qubes-issues/issues/889 Centralized Tray Notifications]

= stable vs testing =
Building R3 vs R3.1. Comments on which branch / config to build.

https://github.com/QubesOS/qubes-issues/issues/1318#issuecomment-147133115

= Handling of file system in TemplateVMs vs TemplateBasedVMs =
== Qubes R3 ==
{| class="wikitable" style="background-color: #fff;text-align: center"

|
| root
| home

|-
| create new AppVM
| {{Yes}}
| {{Yes}}

|-
| modifications in TemmplateVMs for existing AppVMs
| {{Yes}}
| {{No}}

|}

* when you create a new AppVM, it inherits the TemplateVMs root and home folder
* when you make changes in your TemplateVM root such as installing new packages, those will be available to existing AppVMs after TemplateVM shutdown + AppVM (re)start
* when you make changes in your TemplateVM home, those will be not be available to existing AppVMs

== Qubes Proposal ==
{| class="wikitable" style="background-color: #fff;text-align: center"

|
| root
| home

|-
| create new AppVM
| {{Yes}}
| {{No}}

|-
| modifications in TemmplateVMs for existing AppVMs
| {{Yes}}
| {{No}}

|}

= Split GPG =
See [[Dev/Split_GPG]].

= sys-whonix as Qubes FirewallVM =
Goals:<br/>

* any TemplateVM behind sys-whonix should be restricted to torified updates proxy only
* Whonix TemplateVMs behind sys-whonix should be restricted to torified updates proxy only
* Whonix TemplateVMs connected to a ProxyVM other than sys-whonix should refuse to connect and show a warning [done]

Qubes tickets:<br/>

* [https://github.com/QubesOS/qubes-issues/issues/1815 Implement new firewall dom0->VM interface]
* [https://github.com/QubesOS/qubes-issues/issues/1323 mechanism to hide Qubes VM Manager 'Firewall rules' tab]
* [https://github.com/QubesOS/qubes-issues/issues/1637 Template policy, services->features, core plugins]

Tickets:<br/>

* [https://phabricator.whonix.org/T372 Qubes-Whonix Whonix-Workstation TemplateVMs block access to (torified) open internet]

= Connection Issues =
* icmp mtu connection issues?

= Matrix of Qubes VM Types =
ProxyVM
NetVM
AppVM

StandaloneVM
TemplateBasedVM
DispVM

HVM
HVM Template

= Torified Updates Proxy =
== sys-whonix ==
File /usr/share/tinyproxy/default.html gets [https://github.com/Whonix/qubes-whonix/blob/master/usr/lib/qubes-whonix/init/qubes-whonix-sysinit modified]. The following is the original.

<pre>
<head>
<title>{errno} {cause}</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
</pre>

Modified to the following.

<pre>
<head>
<title>{errno} {cause}</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="application-name" content="tor proxy"/>
</head>
</pre>

== Whonix TemplateVMs ==
Inside Whonix TemplateVMs, [https://github.com/Whonix/qubes-whonix/blob/master/usr/lib/qubes-whonix/utility_functions.sh the following command is run will be run].

<pre>
curl_output="$(UWT_DEV_PASSTHROUGH="1" curl --silent --connect-timeout 10 "${PROXY_SERVER}")" || true
</pre>

After the variables are substituted, the command actually run will be the following.

<pre>
curl_output="$(UWT_DEV_PASSTHROUGH="1" curl --silent --connect-timeout 10 "http://10.137.255.254:8082/" || true
</pre>

To simulate (test) this, run the following command.

<pre>
UWT_DEV_PASSTHROUGH="1" curl --silent --connect-timeout 10 "http://10.137.255.254:8082/" ; echo $?
</pre>

Should output the following.

<pre>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<head>
<title>403 Filtered</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="application-name" content="tor proxy"/>
</head>

<body>

<h1>Filtered</h1>

<p>The request you made has been filtered</p>

<hr />

<p><em>Generated by <a href="https://banu.com/tinyproxy/">tinyproxy</a> version 1.8.3.</em></p>

</body>

</html>
0
</pre>

That output gets `grep`ed for PROXY_META, i.e. for.

<pre>
<meta name="application-name" content="tor proxy"/>
</pre>

If that matches, the <code>whonix-secure-proxy</code> Qubes service is activated. In other words, the <code>/var/run/qubes-service/whonix-secure-proxy</code> status file is being created.

== Related ==

* [https://github.com/QubesOS/qubes-issues/issues/1957 Cache updates #1957, qubes-updates-cache, qubes-updates-proxy]
* design decision: [https://github.com/QubesOS/qubes-issues/issues/1880 Difficulty to upgrade Whonix TemplateVMs over clearnet considered a bug or feature?]
* bug: [https://forums.whonix.org/t/templates-incorrectly-think-theyre-not-connected-to-a-whonix-gateway Templates incorrectly think they're not connected to a Whonix gateway.]

= Qubes R3.2 sys-firewall broken bug =
R3.2 arbitrary ProxyVM behind sys-net

<pre>
user@proxyvmtest:~$ sudo iptables-save 
# Generated by iptables-save v1.4.21 on Fri Jul  1 16:47:03 2016
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [670:36158]
:POSTROUTING ACCEPT [0:0]
:PR-QBS - [0:0]
:PR-QBS-SERVICES - [0:0]
-A PREROUTING -j PR-QBS
-A PREROUTING -j PR-QBS-SERVICES
-A POSTROUTING -o vif+ -j ACCEPT
-A POSTROUTING -o lo -j ACCEPT
-A POSTROUTING -j MASQUERADE
-A PR-QBS -d 10.137.4.1/32 -p udp -m udp --dport 53 -j DNAT --to-destination 10.137.2.1
-A PR-QBS -d 10.137.4.1/32 -p tcp -m tcp --dport 53 -j DNAT --to-destination 10.137.2.1
-A PR-QBS -d 10.137.4.254/32 -p udp -m udp --dport 53 -j DNAT --to-destination 10.137.2.254
-A PR-QBS -d 10.137.4.254/32 -p tcp -m tcp --dport 53 -j DNAT --to-destination 10.137.2.254
COMMIT
# Completed on Fri Jul  1 16:47:03 2016
# Generated by iptables-save v1.4.21 on Fri Jul  1 16:47:03 2016
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [1590:83759]
-A INPUT -i vif+ -p udp -m udp --dport 68 -j DROP
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i vif0.0 -j ACCEPT
-A FORWARD -i vif+ -o vif+ -j DROP
COMMIT
# Completed on Fri Jul  1 16:47:03 2016
</pre>

<pre>
user@proxyvmtest:~$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
From 10.137.1.8 icmp_seq=1 Destination Host Unreachable
From 10.137.1.8 icmp_seq=2 Destination Host Unreachable
From 10.137.1.8 icmp_seq=3 Destination Host Unreachable
From 10.137.1.8 icmp_seq=4 Destination Host Unreachable
From 10.137.1.8 icmp_seq=5 Destination Host Unreachable
</pre>

R3.2 sys-net.
<pre>
[user@sys-net ~]$ sudo iptables-save
# Generated by iptables-save v1.4.21 on Fri Jul  1 16:52:29 2016
*raw
:PREROUTING ACCEPT [23024:28057124]
:OUTPUT ACCEPT [24:1578]
-A PREROUTING ! -s 10.137.1.16/32 -i vif7.0 -j DROP
-A PREROUTING ! -s 10.137.1.13/32 -i vif4.0 -j DROP
COMMIT
# Completed on Fri Jul  1 16:52:29 2016
# Generated by iptables-save v1.4.21 on Fri Jul  1 16:52:29 2016
*nat
:PREROUTING ACCEPT [837:153540]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [46:2997]
:POSTROUTING ACCEPT [0:0]
:PR-QBS - [0:0]
:PR-QBS-SERVICES - [0:0]
-A PREROUTING -j PR-QBS
-A PREROUTING -j PR-QBS-SERVICES
-A POSTROUTING -o vif+ -j ACCEPT
-A POSTROUTING -o lo -j ACCEPT
-A POSTROUTING -j MASQUERADE
-A PR-QBS -d 10.137.1.1/32 -p udp -m udp --dport 53 -j DNAT --to-destination 192.168.0.1
-A PR-QBS -d 10.137.1.1/32 -p tcp -m tcp --dport 53 -j DNAT --to-destination 192.168.0.1
-A PR-QBS-SERVICES -d 10.137.255.254/32 -i vif+ -p tcp -m tcp --dport 8082 -j REDIRECT
COMMIT
# Completed on Fri Jul  1 16:52:30 2016
# Generated by iptables-save v1.4.21 on Fri Jul  1 16:52:30 2016
*filter                                                                                                                                                       
:INPUT ACCEPT [0:0]                                                                                                                                           
:FORWARD ACCEPT [0:0]                                                                                                                                         
:OUTPUT ACCEPT [7016:300086]                                                                                                                                  
-A INPUT -i vif+ -p tcp -m tcp --dport 8082 -j ACCEPT                                                                                                         
-A INPUT -i vif+ -p tcp -m tcp --dport 8082 -j ACCEPT                                                                                                         
-A INPUT -i vif+ -p udp -m udp --dport 68 -j DROP                                                                                                             
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT                                                                                                 
-A INPUT -i vif+ -p icmp -j ACCEPT                                                                                                                            
-A INPUT -i lo -j ACCEPT                                                                                                                                      
-A INPUT -i vif+ -j REJECT --reject-with icmp-host-prohibited                                                                                                 
-A INPUT -j DROP                                                                                                                                              
-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT                                                                                               
-A FORWARD -i vif+ -o vif+ -j DROP                                                                                                                            
-A FORWARD -i vif+ -j ACCEPT                                                                                                                                  
-A FORWARD -j DROP                                                                                                                                            
COMMIT
# Completed on Fri Jul  1 16:52:30 2016
</pre>

R3.2 sys-firewall (Fedora 23 based).
<pre>
[user@sys-firewall ~]$ sudo iptables-save 
# Generated by iptables-save v1.4.21 on Fri Jul  1 16:50:05 2016
*raw
:PREROUTING ACCEPT [756:52557]
:OUTPUT ACCEPT [836:74490]
-A PREROUTING ! -s 10.137.2.10/32 -i vif3.0 -j DROP
COMMIT
# Completed on Fri Jul  1 16:50:05 2016
# Generated by iptables-save v1.4.21 on Fri Jul  1 16:50:05 2016
*nat
:PREROUTING ACCEPT [81:6289]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [48:3372]
:POSTROUTING ACCEPT [0:0]
:PR-QBS - [0:0]
:PR-QBS-SERVICES - [0:0]
-A PREROUTING -j PR-QBS
-A PREROUTING -j PR-QBS-SERVICES
-A POSTROUTING -o vif+ -j ACCEPT
-A POSTROUTING -o lo -j ACCEPT
-A POSTROUTING -j MASQUERADE
-A PR-QBS -d 10.137.2.1/32 -p udp -m udp --dport 53 -j DNAT --to-destination 10.137.1.1
-A PR-QBS -d 10.137.2.1/32 -p tcp -m tcp --dport 53 -j DNAT --to-destination 10.137.1.1
-A PR-QBS -d 10.137.2.254/32 -p udp -m udp --dport 53 -j DNAT --to-destination 10.137.1.254
-A PR-QBS -d 10.137.2.254/32 -p tcp -m tcp --dport 53 -j DNAT --to-destination 10.137.1.254
COMMIT
# Completed on Fri Jul  1 16:50:05 2016
# Generated by iptables-save v1.4.21 on Fri Jul  1 16:50:05 2016
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [836:74490]
-A INPUT -i vif+ -p udp -m udp --dport 68 -j DROP
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i vif0.0 -j ACCEPT
-A FORWARD -i vif+ -o vif+ -j DROP
-A FORWARD -s 10.137.2.10/32 -d 10.137.1.1/32 -p udp -m udp --dport 53 -j ACCEPT
-A FORWARD -s 10.137.2.10/32 -d 10.137.1.254/32 -p udp -m udp --dport 53 -j ACCEPT
-A FORWARD -s 10.137.2.10/32 -d 10.137.1.1/32 -p tcp -m tcp --dport 53 -j ACCEPT
-A FORWARD -s 10.137.2.10/32 -d 10.137.1.254/32 -p tcp -m tcp --dport 53 -j ACCEPT
-A FORWARD -s 10.137.2.10/32 -p icmp -j ACCEPT
-A FORWARD -s 10.137.2.10/32 -d 10.137.255.254/32 -p tcp -m tcp --dport 8082 -j DROP
-A FORWARD -s 10.137.2.10/32 -j ACCEPT
-A FORWARD -s 10.137.2.14/32 -d 10.137.1.1/32 -p udp -m udp --dport 53 -j ACCEPT
-A FORWARD -s 10.137.2.14/32 -d 10.137.1.254/32 -p udp -m udp --dport 53 -j ACCEPT
-A FORWARD -s 10.137.2.14/32 -d 10.137.1.1/32 -p tcp -m tcp --dport 53 -j ACCEPT
-A FORWARD -s 10.137.2.14/32 -d 10.137.1.254/32 -p tcp -m tcp --dport 53 -j ACCEPT
-A FORWARD -s 10.137.2.14/32 -p icmp -j ACCEPT
-A FORWARD -s 10.137.2.14/32 -d 10.137.255.254/32 -p tcp -m tcp --dport 8082 -j DROP
-A FORWARD -s 10.137.2.14/32 -j ACCEPT
COMMIT
# Completed on Fri Jul  1 16:50:05 2016
[user@sys-firewall ~]$
</pre>

<pre>
[user@sys-firewall ~]$ sudo systemctl --failed list-units
  UNIT                       LOAD   ACTIVE SUB    DESCRIPTION
● qubes-update-check.service loaded failed failed Qubes check for VM updates and notify dom0

LOAD   = Reflects whether the unit definition was properly loaded.
ACTIVE = The high-level unit activation state, i.e. generalization of SUB.
SUB    = The low-level unit activation state, values depend on unit type.

1 loaded units listed. Pass --all to see loaded but inactive units, too.
To show all installed unit files use 'systemctl list-unit-files'.
[user@sys-firewall ~]$ 
</pre>
<pre>
[user@sys-firewall ~]$ sudo service iptables status
Redirecting to /bin/systemctl status  iptables.service
● iptables.service
   Loaded: not-found (Reason: No such file or directory)
   Active: inactive (dead)
[user@sys-firewall ~]$ 
</pre>
<pre>
[user@sys-firewall ~]$ cat /etc/resolv.conf 
nameserver 10.137.1.1
nameserver 10.137.1.254
</pre>
<pre>
[user@sys-firewall ~]$ sudo ifconfig
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.137.1.8  netmask 255.255.255.255  broadcast 10.255.255.255
        inet6 fe80::216:3eff:fe5e:6c06  prefixlen 64  scopeid 0x20<link>
        ether 00:16:3e:5e:6c:06  txqueuelen 1000  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 243  bytes 10518 (10.2 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1  (Local Loopback)
        RX packets 124  bytes 11688 (11.4 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 124  bytes 11688 (11.4 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0                                                                                            
                                                                                                                                                              
vif3.0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500                                                                                                  
        inet 10.137.2.1  netmask 255.255.255.255  broadcast 0.0.0.0                                                                                           
        inet6 fe80::fcff:ffff:feff:ffff  prefixlen 64  scopeid 0x20<link>
        ether fe:ff:ff:ff:ff:ff  txqueuelen 32  (Ethernet)
        RX packets 102  bytes 4512 (4.4 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 110  bytes 8520 (8.3 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

vif5.0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.137.2.1  netmask 255.255.255.255  broadcast 0.0.0.0
        inet6 fe80::fcff:ffff:feff:ffff  prefixlen 64  scopeid 0x20<link>
        ether fe:ff:ff:ff:ff:ff  txqueuelen 32  (Ethernet)
        RX packets 1133  bytes 71968 (70.2 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 1100  bytes 110098 (107.5 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</pre>

<pre>
[user@sys-firewall ~]$ ps aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.1  0.4 125956  5692 ?        Ss   16:27   0:02 /sbin/init
root         2  0.0  0.0      0     0 ?        S    16:27   0:00 [kthreadd]
root         3  0.0  0.0      0     0 ?        S    16:27   0:00 [ksoftirqd/0]
root         5  0.0  0.0      0     0 ?        S<   16:27   0:00 [kworker/0:0H]
root         6  0.0  0.0      0     0 ?        S    16:27   0:00 [kworker/u8:0]
root         7  0.0  0.0      0     0 ?        S    16:27   0:01 [rcu_sched]
root         8  0.0  0.0      0     0 ?        S    16:27   0:00 [rcu_bh]
root         9  0.0  0.0      0     0 ?        S    16:27   0:00 [rcuos/0]
root        10  0.0  0.0      0     0 ?        S    16:27   0:00 [rcuob/0]
root        11  0.0  0.0      0     0 ?        S    16:27   0:00 [migration/0]
root        12  0.0  0.0      0     0 ?        S    16:27   0:00 [watchdog/0]
root        13  0.0  0.0      0     0 ?        S    16:27   0:00 [watchdog/1]
root        14  0.0  0.0      0     0 ?        S    16:27   0:00 [migration/1]
root        15  0.0  0.0      0     0 ?        S    16:27   0:00 [ksoftirqd/1]
root        17  0.0  0.0      0     0 ?        S<   16:27   0:00 [kworker/1:0H]
root        18  0.0  0.0      0     0 ?        S    16:27   0:00 [rcuos/1]
root        19  0.0  0.0      0     0 ?        S    16:27   0:00 [rcuob/1]
root        20  0.0  0.0      0     0 ?        S    16:27   0:00 [watchdog/2]
root        21  0.0  0.0      0     0 ?        S    16:27   0:00 [migration/2]
root        22  0.0  0.0      0     0 ?        S    16:27   0:00 [ksoftirqd/2]
root        24  0.0  0.0      0     0 ?        S<   16:27   0:00 [kworker/2:0H]
root        25  0.0  0.0      0     0 ?        S    16:27   0:00 [rcuos/2]
root        26  0.0  0.0      0     0 ?        S    16:27   0:00 [rcuob/2]
root        27  0.0  0.0      0     0 ?        S    16:27   0:00 [watchdog/3]
root        28  0.0  0.0      0     0 ?        S    16:27   0:00 [migration/3]
root        29  0.0  0.0      0     0 ?        S    16:27   0:00 [ksoftirqd/3]
root        31  0.0  0.0      0     0 ?        S<   16:27   0:00 [kworker/3:0H]
root        32  0.0  0.0      0     0 ?        S    16:27   0:00 [rcuos/3]
root        33  0.0  0.0      0     0 ?        S    16:27   0:00 [rcuob/3]
root        34  0.0  0.0      0     0 ?        S    16:27   0:00 [kdevtmpfs]
root        35  0.0  0.0      0     0 ?        S<   16:27   0:00 [netns]
root        36  0.0  0.0      0     0 ?        S<   16:27   0:00 [perf]
root        37  0.0  0.0      0     0 ?        S    16:27   0:00 [xenwatch]
root        38  0.0  0.0      0     0 ?        S    16:27   0:00 [xenbus]
root        39  0.0  0.0      0     0 ?        S<   16:27   0:00 [writeback]
root        40  0.0  0.0      0     0 ?        SN   16:27   0:00 [ksmd]
root        41  0.0  0.0      0     0 ?        S<   16:27   0:00 [crypto]
root        42  0.0  0.0      0     0 ?        S<   16:27   0:00 [kintegrityd]
root        43  0.0  0.0      0     0 ?        S<   16:27   0:00 [bioset]
root        44  0.0  0.0      0     0 ?        S<   16:27   0:00 [kblockd]
root        46  0.0  0.0      0     0 ?        S<   16:27   0:00 [ata_sff]
root        47  0.0  0.0      0     0 ?        S<   16:27   0:00 [md]
root        48  0.0  0.0      0     0 ?        S<   16:27   0:00 [devfreq_wq]
root        51  0.0  0.0      0     0 ?        S    16:27   0:00 [kswapd0]
root        52  0.0  0.0      0     0 ?        S<   16:27   0:00 [vmstat]
root        53  0.0  0.0      0     0 ?        S    16:27   0:00 [fsnotify_mark]
root        94  0.0  0.0      0     0 ?        S<   16:27   0:00 [kthrotld]
root        96  0.0  0.0      0     0 ?        S    16:27   0:00 [khvcd]
root        97  0.0  0.0      0     0 ?        S<   16:27   0:00 [dm_bufio_cache]
root        98  0.0  0.0      0     0 ?        S<   16:27   0:00 [ipv6_addrconf]
root       129  0.0  0.0      0     0 ?        S<   16:27   0:00 [deferwq]
root       135  0.0  0.0      0     0 ?        S<   16:27   0:00 [bioset]
root       136  0.0  0.0      0     0 ?        S<   16:27   0:00 [bioset]
root       137  0.0  0.0      0     0 ?        S<   16:27   0:00 [bioset]
root       138  0.0  0.0      0     0 ?        S<   16:27   0:00 [bioset]
root       144  0.0  0.0      0     0 ?        S    16:27   0:00 [kworker/2:1]
root       146  0.0  0.0      0     0 ?        S<   16:27   0:00 [kworker/2:1H]
root       148  0.0  0.0      0     0 ?        S<   16:27   0:00 [kworker/0:1H]
root       153  0.0  0.0      0     0 ?        S<   16:27   0:00 [kdmflush]
root       154  0.0  0.0      0     0 ?        S<   16:27   0:00 [kcopyd]
root       155  0.0  0.0      0     0 ?        S<   16:27   0:00 [bioset]
root       156  0.0  0.0      0     0 ?        S<   16:27   0:00 [bioset]
root       161  0.0  0.0      0     0 ?        S    16:27   0:00 [jbd2/dm-0-8]
root       162  0.0  0.0      0     0 ?        S<   16:27   0:00 [ext4-rsv-conver]
root       166  0.0  0.0      0     0 ?        S    16:27   0:00 [jbd2/xvdd-8]
root       167  0.0  0.0      0     0 ?        S<   16:27   0:00 [ext4-rsv-conver]
root       206  0.0  0.0      0     0 ?        S    16:27   0:00 [kworker/u8:2]
root       221  0.0  0.0      0     0 ?        S<   16:27   0:00 [kworker/3:1H]
root       223  0.0  1.0  45640 13452 ?        Ss   16:27   0:01 /usr/lib/systemd/systemd-journald
root       228  0.0  0.0      0     0 ?        S    16:27   0:00 [kauditd]
root       269  0.0  0.3  44288  3952 ?        Ss   16:27   0:00 /usr/lib/systemd/systemd-udevd
root       281  0.0  0.2 117476  2792 ?        SLs  16:27   0:00 /usr/sbin/qubesdb-daemon 0
root       283  0.0  0.0      0     0 ?        S<   16:27   0:00 [kworker/1:1H]
root       301  0.0  0.2  51280  3292 ?        S<sl 16:27   0:00 /sbin/auditd -n
root       376  0.0  0.1  82440  1728 ?        S<sl 16:27   0:00 /sbin/audispd
root       397  0.0  0.2  52236  3244 ?        S<   16:27   0:00 /usr/sbin/sedispatch
dbus       469  0.0  0.3  57096  4732 ?        Ss   16:27   0:00 /usr/bin/dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation
root       490  0.0  0.3  12152  4700 ?        Ss   16:27   0:00 /usr/sbin/haveged -w 1024 -v 1 --Foreground
root       492  0.0  0.6 437276  8724 ?        Ssl  16:27   0:00 /usr/sbin/abrtd -d -s
root       494  0.0  0.1  16824  2224 ?        SNs  16:27   0:00 /usr/sbin/alsactl -s -n 19 -c -E ALSA_CONFIG_PATH=/etc/alsa/alsactl.conf --initfile=/lib/alsa
root       496  0.1  0.0  45524   320 ?        S    16:27   0:02 /usr/sbin/meminfo-writer 30000 100000 /var/run/meminfo-writer.pid
root       499  0.0  0.2  24440  2940 ?        Ss   16:27   0:00 /usr/lib/systemd/systemd-logind
root       511  0.0  0.2  53992  3328 ?        SLs  16:27   0:00 /usr/lib/qubes/qrexec-agent
root       520  0.0  0.1  23844  2172 ?        Ss   16:27   0:00 /usr/sbin/atd -f
root       548  0.0  0.1 115800  2108 tty1     Ss+  16:27   0:00 /sbin/agetty --noclear tty1 linux
root       559  0.0  0.1 115800  2080 hvc0     Ss+  16:27   0:00 /sbin/agetty --keep-baud 115200 38400 9600 hvc0 vt220
root       564  0.0  0.2 121112  3228 ?        Ss   16:27   0:00 /bin/sh /usr/sbin/qubes-firewall
root       566  0.0  0.2 121112  3132 ?        Ss   16:27   0:00 /bin/sh /usr/sbin/qubes-netwatcher
root       582  0.0  0.2 111084  2764 ?        Sl   16:27   0:00 xenstore-watch -n 2 qubes-netvm-domid
root       583  0.0  0.2 128764  2680 ?        Ssl  16:27   0:00 /usr/sbin/xl devd --pidfile=/var/run/xldevd.pid
root       589  0.0  0.0      0     0 ?        S    16:27   0:00 [jbd2/xvdb-8]
root       590  0.0  0.0      0     0 ?        S<   16:27   0:00 [ext4-rsv-conver]
root       613  0.0  0.2  69908  3764 ?        SLs  16:27   0:01 /usr/bin/qubes-gui
root       636  0.0  0.8 314364 11176 ?        Ss   16:27   0:00 /usr/bin/abrt-dump-journal-oops -fxtD
root       653  0.0  0.6 314156  8980 ?        Ss   16:27   0:00 /usr/bin/abrt-dump-journal-xorg -fxtD
root       752  0.0  0.0      0     0 ?        S    16:27   0:00 [vif3.0-q0-guest]
root       753  0.0  0.0      0     0 ?        S    16:27   0:00 [vif3.0-q0-deall]
root       754  0.0  0.0      0     0 ?        S    16:27   0:00 [vif3.0-q1-guest]
root       755  0.0  0.0      0     0 ?        S    16:27   0:00 [vif3.0-q1-deall]
root       756  0.0  0.0      0     0 ?        S    16:27   0:00 [vif3.0-q2-guest]
root       757  0.0  0.0      0     0 ?        S    16:27   0:00 [vif3.0-q2-deall]
root       758  0.0  0.0      0     0 ?        S    16:27   0:00 [vif3.0-q3-guest]
root       759  0.0  0.0      0     0 ?        S    16:27   0:00 [vif3.0-q3-deall]
root       764  0.0  0.3 203160  5052 ?        S    16:29   0:00 su -l user -c /usr/bin/xinit /etc/X11/xinit/xinitrc -- /usr/bin/X :0 -nolisten tcp vt07 -wr -
user       774  0.0  0.3  45200  4928 ?        Ss   16:29   0:00 /usr/lib/systemd/systemd --user
user       783  0.0  0.1 170644  1928 ?        S    16:29   0:00 (sd-pam)
user       880  0.0  0.2 121112  3176 ?        Ss   16:29   0:00 -bash -c /usr/bin/xinit /etc/X11/xinit/xinitrc -- /usr/bin/X :0 -nolisten tcp vt07 -wr -confi
user       934  0.0  0.0  13960  1076 ?        S    16:29   0:00 /usr/bin/xinit /etc/X11/xinit/xinitrc -- /usr/bin/X :0 -nolisten tcp vt07 -wr -config xorg-qu
user       935  0.1  3.4 312144 44432 ?        SLl  16:29   0:02 /usr/libexec/Xorg :0 -nolisten tcp vt07 -wr -config xorg-qubes.conf
user       947  0.0  0.2 118988  2988 ?        Ss   16:29   0:00 /bin/bash /usr/bin/qubes-session
user       966  0.0  0.0  55516   452 ?        S    16:29   0:00 dbus-launch --sh-syntax --exit-with-session
user       967  0.0  0.2  56836  2676 ?        Ss   16:29   0:00 /usr/bin/dbus-daemon --fork --print-pid 5 --print-address 7 --session
user       989  0.0  0.0  51296   572 ?        Ss   16:29   0:00 /usr/bin/ssh-agent /etc/X11/xinit/Xclients
user      1002  0.0  0.4 313888  6064 ?        Sl   16:29   0:00 /usr/bin/gnome-keyring-daemon --start
user      1015  0.0  2.6 680608 34388 ?        Sl   16:29   0:00 abrt-applet
user      1023  0.0  0.6 482752  8596 ?        S<l  16:29   0:00 pulseaudio --start -n --file=/etc/pulse/qubes-default.pa --exit-idle-time=-1
rtkit     1024  0.0  0.2 195436  3696 ?        SNsl 16:29   0:00 /usr/libexec/rtkit-daemon
user      1032  0.0  0.2  54104  2984 ?        SL   16:29   0:00 /usr/bin/qrexec-client-vm dom0 qubes.WindowIconUpdater /usr/lib/qubes/icon-sender
polkitd   1036  0.0  1.1 533116 14552 ?        Ssl  16:29   0:00 /usr/lib/polkit-1/polkitd --no-debug
user      1047  0.0  2.2 660196 29104 ?        Sl   16:29   0:00 nm-applet
user      1051  0.0  0.4 337984  5716 ?        Sl   16:29   0:00 /usr/libexec/at-spi-bus-launcher
user      1070  0.0  0.3  56704  4476 ?        S    16:29   0:00 /bin/dbus-daemon --config-file=/etc/at-spi2/accessibility.conf --nofork --print-address 3
user      1072  0.0  0.3 178608  4596 ?        Sl   16:29   0:00 /usr/libexec/dconf-service
user      1076  0.0  0.5 225224  7336 ?        Sl   16:29   0:00 /usr/libexec/at-spi2-registryd --use-gnome-session
user      1080  0.0  0.4 385124  6176 ?        Sl   16:29   0:00 /usr/libexec/gvfsd
user      1085  0.0  0.0  53968  1064 ?        S    16:29   0:00 /usr/bin/qrexec-fork-server
user      1092  0.0  0.3 343480  4856 ?        Sl   16:29   0:00 /usr/libexec/gvfsd-fuse /run/user/1000/gvfs -f -o big_writes
user      1093  0.0  0.0 113652   792 ?        S    16:29   0:00 sleep inf
user      1126  0.0  0.5 144956  7476 ?        S    16:29   0:00 /usr/bin/python /usr/lib/qubes/icon-sender
root      1465  0.0  0.0   6372   804 ?        S    16:38   0:00 /usr/bin/qubesdb-watch /qubes-iptables
root      1466  0.0  0.0      0     0 ?        S    16:38   0:00 [vif5.0-q0-guest]
root      1467  0.0  0.0      0     0 ?        S    16:38   0:00 [vif5.0-q0-deall]
root      1468  0.0  0.0      0     0 ?        S    16:38   0:00 [vif5.0-q1-guest]
root      1469  0.0  0.0      0     0 ?        S    16:38   0:00 [vif5.0-q1-deall]
user      1476  0.4  5.9 1064020 77912 ?       Rl   16:39   0:05 konsole
user      1486  0.0  0.3 122432  4896 pts/0    Ss+  16:39   0:00 /bin/bash
user      1530  0.0  0.3 122300  4616 pts/1    Ss+  16:40   0:00 /bin/bash
root      1620  0.0  0.0      0     0 ?        S    16:42   0:00 [kworker/3:2]
root      1682  0.0  0.0      0     0 ?        S    16:48   0:00 [kworker/0:2]
root      1683  0.0  0.0      0     0 ?        S    16:48   0:00 [kworker/1:0]
root      1693  0.0  0.0      0     0 ?        S    16:54   0:00 [kworker/3:1]
root      1745  0.0  0.0      0     0 ?        S    16:54   0:00 [kworker/1:3]
root      1746  0.0  0.0      0     0 ?        S    16:54   0:00 [kworker/0:1]
root      1747  0.0  0.0      0     0 ?        S    16:54   0:00 [kworker/2:2]
user      5625  0.0  0.3 122432  4828 pts/2    Ss   16:59   0:00 /bin/bash
root      8691  0.0  0.0      0     0 ?        S    16:59   0:00 [kworker/0:0]
root      9694  0.0  0.0      0     0 ?        S    16:59   0:00 [kworker/3:0]
root     11308  0.0  0.0      0     0 ?        S    17:00   0:00 [kworker/2:0]
root     11359  0.0  0.0      0     0 ?        S    17:00   0:00 [kworker/0:3]
root     11360  0.0  0.0      0     0 ?        S    17:00   0:00 [kworker/1:1]
root     11361  0.0  0.0      0     0 ?        S    17:00   0:00 [kworker/1:2]
root     11362  0.0  0.0      0     0 ?        S    17:00   0:00 [kworker/u8:1]
user     17878  0.0  0.2 157760  3828 pts/2    R+   17:01   0:00 ps aux
</pre>

<pre>
[user@sys-firewall ~]$ sudo route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         gateway         0.0.0.0         UG    0      0        0 eth0
gateway         0.0.0.0         255.255.255.255 UH    0      0        0 eth0
10.137.2.10     0.0.0.0         255.255.255.255 UH    32749  0        0 vif3.0
10.137.2.14     0.0.0.0         255.255.255.255 UH    32747  0        0 vif5.0
</pre>

<pre>
[user@sys-firewall ~]$ ping 10.137.2.10
PING 10.137.2.10 (10.137.2.10) 56(84) bytes of data.
^C
--- 10.137.2.10 ping statistics ---
8 packets transmitted, 0 received, 100% packet loss, time 7000ms
</pre>

<pre>
[user@sys-firewall ~]$ ping 10.137.2.14
PING 10.137.2.14 (10.137.2.14) 56(84) bytes of data.
64 bytes from 10.137.2.14: icmp_seq=1 ttl=64 time=0.312 ms
64 bytes from 10.137.2.14: icmp_seq=2 ttl=64 time=0.389 ms
64 bytes from 10.137.2.14: icmp_seq=3 ttl=64 time=0.368 ms
64 bytes from 10.137.2.14: icmp_seq=4 ttl=64 time=0.410 ms
^C
--- 10.137.2.14 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3001ms
rtt min/avg/max/mdev = 0.312/0.369/0.410/0.043 ms
[user@sys-firewall ~]$ 
</pre>

<pre>
[user@sys-firewall ~]$ sudo time route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         gateway         0.0.0.0         UG    0      0        0 eth0
gateway         0.0.0.0         255.255.255.255 UH    0      0        0 eth0
10.137.2.10     0.0.0.0         255.255.255.255 UH    32749  0        0 vif3.0
10.137.2.14     0.0.0.0         255.255.255.255 UH    32747  0        0 vif5.0
0.00user 0.00system 1:00.07elapsed 0%CPU (0avgtext+0avgdata 4604maxresident)k
0inputs+0outputs (0major+268minor)pagefaults 0swaps
[user@sys-firewall ~]$ 
</pre>

<pre>
[user@sys-firewall ~]$ sudo service qubes-iptables status
Redirecting to /bin/systemctl status  qubes-iptables.service
● qubes-iptables.service - Qubes base firewall settings
   Loaded: loaded (/usr/lib/systemd/system/qubes-iptables.service; enabled; vendor preset: enabled)
   Active: active (exited) since Fri 2016-07-01 16:27:22 CEST; 39min ago
  Process: 467 ExecStart=/usr/lib/qubes/init/qubes-iptables start (code=exited, status=0/SUCCESS)
 Main PID: 467 (code=exited, status=0/SUCCESS)
   CGroup: /system.slice/qubes-iptables.service

Jul 01 16:27:22 sys-firewall systemd[1]: Starting Qubes base firewall settings...
Jul 01 16:27:22 sys-firewall qubes-iptables[467]: iptables: Applying firewall rules: OK
Jul 01 16:27:22 sys-firewall qubes-iptables[467]: ip6tables: Applying firewall rules: OK
Jul 01 16:27:22 sys-firewall systemd[1]: Started Qubes base firewall settings.
</pre>

<pre>
[user@sys-firewall ~]$ sudo service qubes-firewall status                                                                                             
Redirecting to /bin/systemctl status  qubes-firewall.service                                                                                                  
● qubes-firewall.service - Qubes firewall updater                                                                                                             
   Loaded: loaded (/usr/lib/systemd/system/qubes-firewall.service; enabled; vendor preset: enabled)                                                           
   Active: active (running) since Fri 2016-07-01 16:27:22 CEST; 39min ago
 Main PID: 564 (qubes-firewall)
   CGroup: /system.slice/qubes-firewall.service
           ├─ 564 /bin/sh /usr/sbin/qubes-firewall
           └─1465 /usr/bin/qubesdb-watch /qubes-iptables

Jul 01 16:27:22 sys-firewall systemd[1]: Started Qubes firewall updater.
Jul 01 16:27:22 sys-firewall systemd[1]: Starting Qubes firewall updater...
Jul 01 16:27:24 sys-firewall qubes-firewall[564]: /qubes-iptables
Jul 01 16:38:11 sys-firewall qubes-firewall[564]: /qubes-iptables
[user@sys-firewall ~]$
</pre>

= Troubleshooting =
See [[Troubleshooting#Qubes_specific]].

== Connectivity Issues ==
See [[Troubleshooting#Qubes_specific]].

= bind-dirs flow chart =
qubes-mount-dirs.service -> /usr/lib/qubes/init/mount-dirs.sh -> /usr/lib/qubes/bind-dirs.sh

= qubes-whonix-postinit.service flow chart =
qubes-whonix-postinit.service -> /usr/lib/qubes-whonix/init/qubes-whonix-postinit ->

* /usr/lib/qubes-whonix/bind-directories
* /usr/lib/qubes-whonix/replace-ips
* enable / disable Tor through qvm-service

= Qubes-Whonix 14 release testing =
* make sure /etc/systemd/system/multi-user.target.wants/qubes-whonix-firewall.service is gone
* sudo service qubes-whonix-firewall status
* sudo service whonix-firewall status

= See Also =
* [[Dev/Test|Dev/Test - How to "UnWhonix" - Instructions on how to remove Whonix Tor default networking for Whonix-Gateway. After applying these instructions, Whonix-Gateway will connect to clearnet.]]
* [https://forums.whonix.org/t/how-to-add-a-proxyvm-between-anon-whonix-and-sys-whonix-whonix-ws-email-sys-fw-whonix-whonix-gw-sys-firewall-sys-net How to add a ProxyVM between anon-whonix and sys-whonix? (whonix-ws-email -> sys-fw-whonix -> whonix-gw -> sys-firewall -> sys-net)]

= Footnotes =
<references />

{{Footer}}

[[Category:Design]]
