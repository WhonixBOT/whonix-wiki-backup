{{Header}}
{{#seo:
|description=Documentation for the NEXT Whonix version! ONLY for developers! No guarantee it really makes into the next Whonix version.
}}

= Warning =
'''Documentation for the NEXT Whonix version! ONLY for developers! No guarantee it really makes into the next Whonix version.'''

= torsion =
'''Unfinished!''' Work in progress! See also: <br />
https://github.com/special/torsion/issues/30

Security implications not researched yet.

On Whonix-Gateway, Control Port Filter Proxy<ref>[[Dev/CPFP]]</ref> needs some adjustments.

Create a file {{Code|/etc/controlportfilt.d/50_controlportfilt_torsion}}.

<pre>
kdesudo kwrite /etc/controlportfilt.d/50_controlportfilt_torsion
</pre>

Add the following content.

<pre>
## Keep existing contents of variable CONTROL_PORT_FILTER_WHITELIST
## and extend it with control port commands required by torsion as per:
## "Documentation request for Whonix setup"
## https://github.com/special/torsion/issues/30
CONTROL_PORT_FILTER_WHITELIST=(
    "${CONTROL_PORT_FILTER_WHITELIST[@]}"
    "GETINFO status/circuit-established"
    "SETCONF HiddenServiceDir"
    "SETCONF HiddenServicePort"
    "SETEVENTS STATUS_CLIENT"
)
</pre>

Restart Control Port Filter Proxy.

<pre>
sudo service controlportfiltd restart
</pre>

= onionshare =
'''Unfinished!''' Work in progress! See also: <br />
https://www.whonix.org/forum/index.php/topic,316.0.html

Security implications not researched yet.

On Whonix-Gateway, Control Port Filter Proxy<ref>[[Dev/CPFP]]</ref> needs some adjustments.

Create a file {{Code|/etc/controlportfilt.d/50_controlportfilt_torsion}}.

<pre>
kdesudo kwrite /etc/controlportfilt.d/50_controlportfilt_torsion
</pre>

Add the following content.

<pre>
## Keep existing contents of variable CONTROL_PORT_FILTER_WHITELIST
## and extend it with control port commands required by torsion as per:
## "Documentation request for Whonix setup"
## https://github.com/special/torsion/issues/30
CONTROL_PORT_FILTER_WHITELIST=(
    "${CONTROL_PORT_FILTER_WHITELIST[@]}"
    "SETCONF HiddenServiceDir"
    "SETCONF HiddenServicePort"
)
</pre>

Restart Control Port Filter Proxy.

<pre>
sudo service controlportfiltd restart
</pre>

= VPN on Whonix-Gateway =
This chapter is supposed to be added to the [[Tunnel_Tor_through_proxy_or_VPN_or_SSH]], specifically to extend the [[Tunnel_Tor_through_proxy_or_VPN_or_SSH#How]] section, if/when this feature gets finished.

Tunnel Tor through VPN <br />
'''user -> VPN -> Tor'''

If you want to hide Tor by using a VPN, do the following steps before activating Tor in {{Code|whonixsetup}}.

Have a look at {{Code|/etc/whonix_firewall.d/30_default}}. To open.

<pre>
Start menu -> Applications -> System -> Whonix Default Firewall Settings
</pre>

It contains default settings, settings you can use as template (copy and paste) and an interesting comment.

<pre>
## Please use "/etc/whonix_firewall.d/50_user" for your custom configuration,
## which will override the defaults found here. When Whonix is updated, this
## file may be overwritten.
</pre>

Create a file  {{Code|/etc/whonix_firewall.d/50_user}}. If you are using a graphical Whonix-Gateway, use.

<pre>
Start menu -> Applications -> System -> Whonix User Firewall Settings
</pre>

If you are using a terminal-only Whonix-Gateway, use.

<pre>
sudo nano /etc/whonix_firewall.d/50_user
</pre>

Add the following settings. You can skip comments (starting with {{Code|#}}). Unless you are using {{Code|seattle.vpn.riseup.net}} as your VPN service, which we use as an example, you have to adjust the {{Code|VPN_SERVERS}} variable in your config.

<pre>
ALLOW_GATEWAY_ROOT_USER=1

###########################
## VPN-Firewall Settings ##
###########################

## Make sure Tor always connects through the VPN.
VPN_FIREWALL=1

## IP address of the VPN server.
## Get the IP using: nslookup vpn-example-server.org
## Example: seattle.vpn.riseup.net
## Some providers provide multiple VPN servers.
## You can enter multiple IP addresses, separated by spaces
VPN_SERVERS="198.252.153.26"

## For OpenVPN.
VPN_INTERFACE=tun0

## Destinations you don not want routed through the VPN.
LOCAL_NET="192.168.1.0/24 192.168.0.0/24 127.0.0.0/8"
</pre>

Reload Whonix's Firewall.

If you are using a graphical Whonix-Gateway, use.

<pre>
Start Menu -> Applications -> System -> Reload Whonix Firewall
</pre>

Or if you are using a terminal-only Whonix-Gateway, use.

<pre>
sudo whonix_firewall
</pre>

Now setup OpenVPN. It should be able to connect. You find some help on setting up OpenVPN on the [[TestVPN]] page.

Test if you are able to connect using your VPN. One, less secure method would be.

<pre>
## TODO: There is no DNS and I know no test services accepting connections without DNS requests.
curl.whonix-orig https://check.torproject.org

## This is check.tpo. Should show something along "Welcome to sergii".
## Unfortunately won't echo IP, but will show, that connectivity is functional.
curl.whonix-orig 38.229.72.22
</pre>

Another more secure method, that doesn't work with a few VPNs, would be.

<pre>
## TODO: There is no DNS and I know no test services accepting connections without DNS requests.
curl.whonix-orig --tlsv1 --proto =https https://check.torproject.org 

## This is check.tpo. Should show something along "Welcome to sergii".
## Unfortunately won't echo IP, but will show, that connectivity is functional.
curl.whonix-orig --tlsv1 --proto =https 38.229.72.22
</pre>

Enable Tor using whonixsetup.

If you are using a graphical Whonix-Gateway, use.

<pre>
Start Menu -> Applications -> System -> whonixsetup
</pre>

Or if you are using a terminal-only Whonix-Gateway, use.

<pre>
sudo whonixsetup
</pre>

Done.

'''Limitations''':

* Only tested with OpenVPN. Most other VPN's have deficiencies anyway.
* DNS has to be manually resolved. There is technically no way to automatically resolve DNS without making the setup much more complex. The VPN server's IP address should not be resolved over Tor, because that's what you wanted to hide in the first place. Since outside observers will know, that you are connecting to the VPN IP anyway, it is probably save to resolve the DNS over clearnet or by asking the VPN provider if they don't already document their IPs on their website anyway.
* No support for IPv6 yet.
* TODO: Find ip-check public service for testing/showing own VPN IP. Not sure if any exists. Is this important?

'''TODO high level overview''':

* Integrate VPN-Firewall's features into Whonix-Gateway's firewall.
* Install OpenVPN on Whonix-Gateway by default. (Otherwise installing OpenVPN while hiding Tor would be very difficult for the user.)
* Make a new release integrating above points.

'''TODO technical level''':

* Make NON_TOR_WHONIXG variable configurable.
* Allow TCP and UDP to VPN server.
* No longer allow Tor to connect to any outside target when VPN_FIREWALL=1.

= Footnotes =
<references/>

{{Footer}}

[[Category:Documentation]]
