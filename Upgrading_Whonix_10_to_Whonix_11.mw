{{Header}}
{{#seo:
|description=How to Upgrade from Whonix 10.x to Whonix 11.x
}}

{{mbox
| type      = critical
| image   = [[File:Ambox_warning_pn.svg.png|40px|alt=Whonix first time users warning]]
| text       = Testers-only!
}}

= Before you start =
== If you want to upgrade Whonix-Gateway as well as Whonix-Workstation ==
1. Backup your data. (Ideally have a copy of your VM, so you can try again.) <br />
2. Consider running the optional [[#Sanity Tests]]. <br />
3. Upgrade Whonix-Workstation. <br />
4. Power off Whonix-Workstation. <br />
5. Upgrade Whonix-Gatway. <br />
6. Restart Whonix-Gateway. <br />
7. Restart Whonix-Workstation <br />

== If you only want to upgrade Whonix-Workstation ==
1. Backup your data. (Ideally have a copy of your VM, so you can try again.) <br />
2. Consider running the optional [[#Sanity Tests]]. <br />
3. Upgrade Whonix-Workstation. <br />
4. Power off Whonix-Workstation. <br />
5. [[Download|Get]] Whonix-Gatway 9.x. <br />
6. Start Whonix-Gateway. <br />
7. Start Whonix-Workstation <br />

You can ignore the following errors.

== Non-Critical Errors / Warnings ==
<pre>
[Jun 09 15:39:42] WARNING torsocks[18737]
</pre>

Other warnings / errors should be reported.

= Sanity Tests =
<pre>
sudo dpkg --audit ; echo $?
</pre>

Expected output.

<pre>
0
</pre>

<pre>
sudo dpkg --configure -a ; echo $?
</pre>

Expected output:

<pre>
0
</pre>

<pre>
sudo apt-get update
</pre>

<pre>
sudo apt-get dist-upgrade
</pre>

Test wise install python-qt4.

<pre>
sudo apt-get install python-qt4 ; echo $?
</pre>

<pre>
## ... successful installation of python-qt4 ...
0
</pre>

= Known Issues =
Upgrade of the whonix-gw-desktop-shortcuts, whonix-ww-desktop-shortcuts could take a while. <ref>
During
<pre>
sudo -u user ln -s /usr/share/applications/kde4/konsole.desktop /home/user/Desktop/
</pre>
</ref> The output "sudo: unable to resolve host host" is expected. No big issue. Just annoying time sunk. Will be fixed after upgrade.

[[Qubes]] specific.

<pre>
*** OMINOUS WARNING ***: /usr/bin/apt-get is not linked to either apt-get.anondist or apt-get.anondist-orig
</pre>

Can be ignored. (Something we ought to fix for Whonix 12.)

[[Qubes]] specific.

<pre>
/bin/bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)
/bin/bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)
bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)
bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)
bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)
</pre>

TODO

[[Qubes]] specific.

<pre>
Package configuration                                                                                                 
 ┌───────────────────────────────────────┤ Configuring iptables-persistent ├───────────────────────────────────────┐  
 │                                                                                                                 │  
 │ Current iptables rules can be saved to the configuration file /etc/iptables/rules.v4. These rules will then be  │  
 │ loaded automatically during system startup.                                                                     │  
 │                                                                                                                 │  
 │ Rules are only saved automatically during package installation. See the manual page of iptables-save(8) for     │  
 │ instructions on keeping the rules file up-to-date.                                                              │  
 │                                                                                                                 │  
 │ Save current IPv4 rules?                                                                                        │  
 │                                                                                                                 │  
 │                                 <Yes>                                    <No>                                   │  
 │                                                                                                                 │  
 └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  
</pre>

TODO

Please post any issues in [https://www.whonix.org/forum/index.php/board,1.0.html Whonix support forums].

= Upgrading =
'''[[Download|Downloading]] a new Whonix-Gateway / Whonix-Workstation will be probably easier than applying the following instructions for upgrading.'''

Consider doing the [[#Sanity Tests]] described above. They'll check if your system is affected by obvious grave issues, that you must fix before attempting to upgrade. If your package manager is broken, for example because you mixed packages from Debian stable with packages from Debian testing, then the upgrade may fail in the middle leaving your system in a difficult to resolve situation.

Consider keeping the full terminal (Konsole) log. Even if everything apparently worked, there might be issues after reboot. In case of a bug report in the forums you would be asked to share the upgrading log so the issue can be investigated.

Make sure you read [[#Known Issues]] above.

Become root.

<pre>
sudo su
</pre>

Do a usual [[Security_Guide#Updates|upgrade]] of your system's packages from Debian.

Enable Whonix's {{Code2|jessie}} repository. Don't use the {{Code2|testers}} repository until Whonix 11 has been released as stable.

<pre>
whonix_repository --enable --codename jessie
</pre>

Now we have to edit a few apt sources. The following three {{Code2|sed}} commands will do that for you. (But if you cannot or are not comfortable with using copy and paste, and you know what you are doing, you could also manually open an editor and make the described changes.)

Switch Debian sources from {{Code2|wheezy}} to {{Code2|jessie}} in {{Code2|/etc/apt/sources.list.d/debian.list}}.

<pre>
sed -i "s/wheezy/jessie/g" /etc/apt/sources.list.d/debian.list
</pre>

Switch Torproject sources from {{Code2|wheezy}} to {{Code2|jessie}} in {{Code2|/etc/apt/sources.list.d/debian.list}}.

<pre>
sed -i "s/wheezy/jessie/g" /etc/apt/sources.list.d/torproject.list
</pre>

As a [[Qubes]] user, switch Torproject sources from {{Code2|wheezy}} to {{Code2|jessie}} in {{Code2|/etc/apt/sources.list.d/qubes-r3.list}}. (Non-Qubes users can skip Qubes specific steps.)

<pre>
sed -i "s/wheezy/jessie/g" /etc/apt/sources.list.d/qubes-r3.list
</pre>

As a [[Qubes]] user, remove the {{Code2|wheezy-backports}} repository from {{Code2|/etc/apt/sources.list.d/debian.list}}. <ref>
The following line.

<pre>
deb http://ftp.us.debian.org/debian/ wheezy-backports main
</pre>

Needs to be removed from {{Code2|/etc/apt/sources.list}} because fortunatly, Qubes no longer needs it.
</ref>

<pre>
sed -i "s#deb http://ftp.us.debian.org/debian/ wheezy-backports main##g" /etc/apt/sources.list
</pre>

Enable extensive debugging so reporting eventual bugs becomes easier.

<pre>
export DEBDEBUG=1
</pre>

Set environment variable TORSOCKS_LOG_LEVEL=1 to reduce unnecessary torsocks warnings. <ref>
Disable torsocks warning spam such as.<br />
[May 20 11:45:27] WARNING torsocks[2645]: [syscall] Unsupported syscall number 224. Denying the call (in tsocks_syscall() at syscall.c:165)<br />
https://phabricator.whonix.org/T317
</ref>
<pre>
export TORSOCKS_LOG_LEVEL=1
</pre>

Update your package lists.

<pre>
apt-get update
</pre>

Let's first upgrade torsocks and uwt, so we see fewer torsocks warning later on. <ref>Due to transition from torsocks 1.x to torsocks 2.x.</ref>
<pre>
apt-get install torsocks uwt
</pre>

Upgrade.

<pre>
apt-get dist-upgrade || apt-get -f install || apt-get dist-upgrade
</pre>

It is recommended to have the {{Code2|whonix-gateway}} / {{Code2|whonix-workstation}} package installed to make sure nothing is broken. (If you like to uninstall it later as per [[Whonix Debian Packages]], you're free to do so. Still, it is recommended to re-install it before removal to make sure you're as close to official package selection as possible.)

If you are upgrading Whonix-Gateway...
<pre>
apt-get install whonix-gateway
</pre>

If you are upgrading Whonix-Workstation...
<pre>
apt-get install whonix-workstation
</pre>

Get rid of old packages.

<pre>
apt-get autoremove
</pre>

Optional: Users of [[VirtualBox]], [[KVM]] and [[Physical Isolation]] can optionally consider installation of the [https://github.com/Whonix/grub-screen-resolution grub-screen-resolution] package, which would set resolution to 1024x768 during boot. <ref>https://github.com/Whonix/grub-screen-resolution/blob/master/etc/default/grub.d/30_screen_resolution.cfg</ref> (Recommended.)

<pre>
apt-get install grub-screen-resolution
</pre>

Optional: Users of VirtualBox, KVM and Physical Isolation can optionally consider installation of the [https://github.com/Whonix/grub-output-verbose grub-output-verbose] package, which would show more verbose output during boot. For better usability, so it doesn't look like boot hangs on slow systems and to ease debugging in case of issues. <ref>https://github.com/Whonix/grub-output-verbose/blob/master/etc/default/grub.d/30_output_verbose.cfg</ref> (Recommended.)

<pre>
apt-get install grub-output-verbose
</pre>

Restore original {{Code2|/etc/default/grub}}. <ref>The grub-enable-apparmor package no longer modifies that file. Now implemented using {{Code2|/etc/default/grub.d}}. See also: https://phabricator.whonix.org/T25</ref>

<pre>
cp /etc/default/grub.anondist-orig /etc/default/grub
</pre>

Update grub. ([[Qubes]] users can skip this.)

<pre>
update-grub
</pre>

Consider applying the [[#Grub Fix]] now or after reboot.

Remember to store the terminal (Konsole) log. (File -> Save Output As)

Reboot required.

<pre>
reboot
</pre>

= Grub Fix =
Applying this fix is recommended after upgrading from Whonix 10 to Whonix 11.

Useful if you saw the the error shown on the following screenshot after boot.

[[File:grub_error_file_not_found_issue.png|400px]]

Fortunately, this fix isn't critical. The system is still bootable. To have it bootable also in future it's a good idea to fix this.

Recommended for users of [[VirtualBox]] and [[KVM]]. Not required for users of [[Qubes]], because it is not yet using grub. <ref>https://phabricator.whonix.org/T353#5523</ref> Maybe not required for users of [[Physical Isolation]].

* [[VirtualBox]] users: <code>sudo grub-install /dev/sda ; echo $?</code>
* [[KVM]] users: <code>sudo grub-install /dev/vda ; echo $?</code>
* [[Qubes]] users: Not required.
* [[Physical Isolation]] users: Probably not required.

Expected output.

<pre>
Installing for i386-pc platform.
Installation finished. No error reported.
0
</pre>

= Footnotes =
<references />

[[Category:Documentation]]

{{Footer}}
