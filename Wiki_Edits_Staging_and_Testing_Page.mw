
= <u>Note: This Page is for Wiki Staging and Testing Only!</u> =


= Connecting to a VPN before Tor (User -> VPN -> Tor -> Internet) =

== Introduction ==

{{Tunnel_Introduction}}

= Tunnel-link before Tor use cases=
----
{{Tunnel Introduction/Tunnel-link before Tor}}
----
{{Tunnel-link Warnings/Common}}

== Selecting a Service Provider ==
{{Tunnels/Challenges in Provider Location Selection}}

= VPN Configuration Options =
== Introduction ==
* [[Qubes-Whonix]] users have the option to use a [[#Separate VPN-Gateway]] but could also install the VPN software [[#Inside Whonix-Gateway]].
* [[Non-Qubes-Whonix]] users could install the VPN software [[#On the Host]] or [[#Inside Whonix-Gateway]].

<br>

What's the difference of installing a VPN on the host versus installing on Whonix-Gateway?

{{VPN_on_the_host_vs_on_Whonix-Gateway}}

== VPN Client Choice == 
* Use OpenVPN.
* Using bitmask with Qubes is not yet documented.<ref>https://github.com/leapcode/bitmask_client/issues/1009</ref>
* Other VPN clients are unsupported. We are not aware of any sane VPN client choices besides OpenVPN.

-----
==  Separate VPN-Gateway ==
[[Qubes-Whonix]] only! [[Non-Qubes-Whonix]] is [[unsupported]]!

A separate VPN-Gateway between Whonix-Gateway and sys-firewall, i.e. Whonix-Workstation -> Whonix-Gateway -> sys-vpn -> sys-firewall -> sys-net.

'''User -> VPN -> Tor -> Internet '''

These "Separate VPN-Gateway" instructions are new. You might be one of the first users. You might run into minor issues. Please test and [https://forums.whonix.org report] how it went.

{{Box|text=
'''1.''' Clone a TemplateVM for example, debian-9 and name the new template clone debian-9-vpn. <ref>
At the time of writing Debian 9 {{Stable_Whonix_based_on_Debian_codename}} was the stable release version.
</ref>

<code>Qube Manager</code> -> <code>debian-9</code> -> <code><u>C</u>lone qube</code> -> <i><code>Enter name for Qube clone:</i> debian-9-vpn</code> -> <code>Press: OK</code>

'''2.''' Create a new ProxyVM based on the newly cloned template. Name the VM <code>sys-vpn</code> and set <code>sys-firewall</code> as NetVM. Make sure to check [✔] the box for provides_network.

{{Box|text=
<code>Qube Manager</code> -> <code><u>Q</u>ube</code> -> <code>Create <u>n</u>ew qube</code>

* Name and label: <code>sys-vpn</code> (Set any color)
* Type: <code>AppVM</code>
* Template: <code>debian-9-vpn</code>
* Networking: <code>sys-firewall</code>
* Advanced:   [<code>✔</code>] Provides network 
* Press: <code>OK</code>
}}

'''3.''' Setup the VPN-Gateway as per [https://www.qubes-os.org/doc/vpn/ Qubes VPN documentation].  The instructions to configure the [https://qubes-os.org/doc/vpn/#set-up-a-proxyvm-as-a-vpn-gateway-using-iptables-and-cli-scripts VPN gateway using iptables and CLI scripts] is preferred to prevent clearnet leaks when the VPN breaks down. 

{{Box|text=
When a failed closed configuration is used and the VPN connection breaks down, all traffic originating from Whonix-Gateway (commonly called <code>sys-whonix</code>) would <u>only</u> be forced through Tor. This is what you want if you are reading this documentation chapter.

'''User -> Tor -> Internet'''

If a failed closed configuration is not used, network traffic (such as DNS queries) could leak through the VPN tunnel to the Internet when the tunnel connection breaks down.

'''User -> VPN'''(<u>clearnet leaks!</u>) '''-> Tor -> Internet'''
}}

'''4.''' Check, that your <code>sys-vpn</code> is fully functional. Test connectivity from inside the <code>sys-vpn</code> as per:
[https://qubes-os.org/doc/vpn/ Qubes VPN Documentation]
}}

<u>Note:</u> Both TCP and UDP VPN connections should work. System DNS should work out of the box so no DNS configuration is required for Whonix-Gateway.<ref>Because Whonix-Gateway does not require any clearnet DNS anyhow.</ref>

Done!

For troubleshooting, see footnote. <ref>
* Check, that your VPN-Gateway is fully functional. Test connectivity from inside the VPN-Gateway.
* Add a non-Whonix VM behind your VPN-Gateway. For example, add a debian based AppVM behind your VPN-Gateway. Figure out if the VPN-Gateway works at all before involving Whonix.
</ref>

== On the Host ==
[[Non-Qubes-Whonix]] only! (Because in Qubes, the host is non-networked by default. [[Qubes-Whonix]] users have the option to use a [[#Separate VPN-Gateway]] but could also install the VPN software [[#Inside Whonix-Gateway]].)

'''User -> VPN -> Tor -> Internet '''

When using a Whonix-Gateway virtual machine, connect to a VPN using software on the host operating system (and not on the Whonix-Workstation nor Whonix-Gateway).

Using software inside the host operating system may be more convenient if your more familiar with the host operating system than Whonix. Additionally, your VPN provider might provide custom software with tools for connecting to their servers. However, there are issues that you must consider:
* A VPN on the host operating system will route all traffic originating from the host through the VPN, as well as Whonix's traffic. It is up to your preferences, if you like this or not.
* Your VPN software may not be designed or configured to "fail closed". That is, if your VPN session suddenly disconnects, your Tor connection will be automatically sent through your ISP without going through your VPN service. 

==== How to add the VPN in Host OS ====
Use the host operating system's built-in tools to connect to your VPN or use the software provided by your VPN service.

{{Anchor|Fail Closed Mechanism}}
==== Use a Fail Closed Mechanism ====

{{Fail_Closed_Mechanism}}

If you want to ensure that all network traffic is forced through the VPN, try [https://github.com/adrelanos/VPN-Firewall VPN-Firewall].

(Or if you prefer, install the VPN in Whonix-Gateway instead since it comes with an integrated TUNNEL_FIREWALL feature. However, if you choose this configuration be sure to stay away from the standalone VPN-Firewall when you set up the VPN. This is because the standalone VPN-FIREWALL is not compatible with Whonix-Gateway)

-----

{{Anchor|VPN Software on Whonix-Gateway}}

== Inside Whonix-Gateway ==
Whonix-Gateway can be configured to connect to a VPN server before Tor with a "fail closed" mechanism. This will block all Tor traffic if the VPN disconnects. 

'''User -> VPN -> Tor -> Internet'''

===== VPN Client Choice =====
Use OpenVPN.

Using bitmask inside Whonix-Gateway for this use case is [[unsupported]] and discouraged. This is because bitmask modifies the firewall. While it might be possible to configure bitmask in Whonix-Gateway safely, documenting the steps needed to reach that point is a TODO. [https://phabricator.whonix.org/T516 help welcome]!

Other VPN clients are [[unsupported]]. We are not aware of any sane VPN client choices besides OpenVPN.

===== Whonix TUNNEL_FIREWALL vs standalone VPN-Firewall =====
{{Whonix_TUNNEL_FIREWALL_vs_standalone_VPN-Firewall}}

==== VPN Setup ====
If you are interested in [[Hide Tor and Whonix from your ISP]] (read that page first)... After installing Whonix-Gateway, do the following steps before activating Tor in {{Code|Whonix Setup Wizard}}.

===== Preparation =====
{{VPN/Setup/Preparation}}

===== Firewall Settings =====
{{Firewall Settings}}

Add the following settings. You can skip comments (starting with {{Code|#}}). Don't use {{Code|;}} for comments. <ref>That config file is a bash fragment.</ref> Likely you do not need to either uncomment (removing the {{Code|#}} in front) or modify {{Code|VPN_INTERFACE}} / {{Code|LOCAL_NET}}.

<pre>
## Make sure Tor always connects through the VPN.
## Enable: 1
## Disable: 0
## DISABELD BY DEFAULT, because it requires a VPN provider.
VPN_FIREWALL=1

## For OpenVPN.
#VPN_INTERFACE=tun0

## Destinations you don not want routed through the VPN.
## 10.0.2.2-10.0.2.24: VirtualBox DHCP
#      LOCAL_NET="\
#         127.0.0.0-127.0.0.24 \
#         192.168.0.0-192.168.0.24 \
#         192.168.1.0-192.168.1.24 \
#         10.152.152.0-10.152.152.24 \
#         10.0.2.2-10.0.2.24 \
#      "
</pre>

Save.

===== Reload Firewall =====
{{Reload Firewall}}

===== sudoers configuration =====
{{VPN/Setup/sudoers_configuration}}

===== VPN Setup =====
====== Introduction ======
{{VPN/Setup/Introduction}}

====== Get VPN Certificate ======
TODO: Documentation bug fix required. Won't work without Tor being enabled. You need to get the certificate elsewhere and then [[File Transfer]] it into Whonix-Gateway.

{{VPN/Setup/Get VPN Certificate}}

====== VPN Credentials ======
{{VPN/Setup/VPN Credentials}}

====== VPN Credentials ======
{{VPN/Setup/VPN Credentials}}

====== VPN IP Address ======
{{VPN/Setup/VPN IP Address}}

====== VPN Configuration File ======
{{Open with root rights|filename=
/etc/openvpn/openvpn.conf
}}

Add.

Note: make sure to adjust the {{Code|remote 198.252.153.226 80}} variable in your config (unless you are using {{Code|nyc.vpn.riseup.net}} as your VPN service). Replace the IP ({{Code|198.252.153.226}}) and port ({{Code|80}}) to match your VPN service.

<pre>
##############################
## VPN provider specific settings ##
##############################
auth-user-pass auth.txt

## using nyc.vpn.riseup.net 80
remote 198.252.153.226 80

ca RiseupCA.pem

remote-cert-tls server

####################################
## TUNNEL_FIREWALL specific settings ##
####################################
client
dev tun0
persist-tun
persist-key

script-security 2
#up "/etc/openvpn/update-resolv-conf script_type=up dev=tun0"
#down "/etc/openvpn/update-resolv-conf script_type=down dev=tun0"

user tunnel
iproute /usr/bin/ip_unpriv
</pre>

Do not worry about TCP mode on Whonix-Gateway. Using the VPN in TCP mode may be possible depending the services provides by your VPN provider, but is not required on Whonix-Gateway. The VPN in UDP mode should work just fine. <ref>
The Tor software cannot transport UDP yet, but it does not have to in this case. (Reference: [[Tor#UDP]].) Since the VPN connects over clearnet, UDP should just work as usual. Once the VPN is functional, Tor will have no issue to connect using it (without "knowing" it is over a VPN).
</ref> Your pick.

<ref>
The [https://github.com/Whonix/usability-misc/blob/master/usr/bin/ip_unpriv /usr/bin/ip_unpriv] wrapper script is being provided by the [https://github.com/Whonix/usability-misc usabilty-misc] package.

The [https://github.com/Whonix/usability-misc/blob/master/etc/sudoers.d/tunnel_unpriv /etc/sudoers.d/tunnel_unpriv] wrapper script is being provided by the [https://github.com/Whonix/usability-misc usabilty-misc] package.

The [https://github.com/Whonix/usability-misc/blob/master/lib/systemd/system/openvpn%40openvpn.service.d/50_unpriv.conf /lib/systemd/system/openvpn@openvpn.service.d/50_unpriv.conf] wrapper script is being provided by the [https://github.com/Whonix/usability-misc usabilty-misc] package.
</ref> <ref>We must run OpenVPN as user 'tunnel', because that is the only user besides user {{Code2|clearnet}} that will be allowed to establish external connections when using Whonix Firewall setting VPN_FIREWALL=1.</ref>

Save.

====== DNS Configuration ======
DNS configuration, resolvconf, update-resolv-conf or similar is not required for Whonix-Gateway. <ref>
Because Whonix-Gateway by default has no and needs no system DNS for its own traffic. See [[Whonix-Gateway System DNS]] if you would like to read an explanation why that is so.
</ref>

====== Configuration Folder Permissions ======
{{VPN/Setup/Configuration Folder Permissions}}

===== systemd setup =====
{{Template:VPN/Setup/Systemd}}

===== Enable Tor =====
Enable Tor using Whonix Setup Wizard.

{{whonixsetup}}

===== Troubleshooting =====
{{VPN-Firewall/Troubleshooting}}

=== How to Submit a Support Request ===
{{VPN/Setup/Support Requests}}

==== Additional Tweaks / Recommendations / Troubleshooting ====
<div class="toccolours mw-collapsible mw-collapsed">
'''If having problems with the connection / Tor is not fully bootstrapped''', please press on expand on the right.
<div class="mw-collapsible-content">
You have may have to manually restart Tor. This is because the VPN may not be ready when Tor is attempting to connect, because the VPN connection initialization takes too long. Due to a bug in Tor, it won't keep trying to connect. To fix this, you may have to manually restart Tor after boot, if whonixcheck reports that Tor is not fully bootstrapped. The same may be necessary if your VPN software or connection temporarily broke down.

'''To Manually restart Tor:'''

{{Reload Tor}}

'''Leak Tests'''

When you shut down the VPN, neither Tor, nor Whonix-Gateway's whonixcheck/apt-get/etc. nor Whonix-Workstation should be able to connect anywhere anymore.

''' Force Tor to wait for OpenVPN '''

Create a folder /etc/systemd/system/tor.service.d.

{{CodeSelect2|code=
sudo mkdir /etc/systemd/system/tor.service.d
}}

Create a file /etc/systemd/system/tor.service.d/50_user.conf.

{{Open with root rights|filename=
/etc/systemd/system/tor.service.d/50_user.conf
}}

Add the following content.

{{CodeSelect2|code=
[Unit]
After=openvpn.service
}}

Save.

At next boot, the Tor daemon will be started after the OpenVPN daemon.

Debugging: <ref>
Reload systemd.

{{CodeSelect2|code=
sudo systemctl daemon-reload
}}

Check Tor service status.

{{CodeSelect2|code=
sudo systemctl status tor
}}

{{CodeSelect2|code=
sudo systemctl status tor@default
}}

It should list the drop-in file {{Code2|/etc/systemd/system/tor.service.d/50_user.conf}}.
</ref>

'''Limitations'''
* Only tested with OpenVPN. Most other VPN's have deficiencies anyway.
* DNS (IP address) of VPN server has to be manually resolved. There is technically no way to automatically resolve DNS without making the setup much more complex. The VPN server's IP address should not be resolved over Tor, because that's what you wanted to hide in the first place. Since outside observers will know, that you are connecting to the VPN IP anyway, it is probably safe to resolve the DNS over clearnet or by asking the VPN provider if they don't already document their IPs on their website anyway.
* No support for IPv6 yet.

'''Troubleshooting VPN -> Tor'''

*If not connecting, see above to manually restart Tor
*Check your VPN software's logs.

*'''Test if you are able to connect using your VPN'''

1. Login as user {{Code|clearnet}}.

{{CodeSelect2|code=
sudo su clearnet
}}

2. Try connecting to check.tpo. Note, at time of writing, it looked like usaip free trial is probably blocking SSL, therefore it might not work.

<code>
{{Curl_Plain}} --silent {{Curl Secure}} -H 'Host: check.torproject.org' -k https://{{Check.torproject.org IP}} | grep IP
</code>

Should show something along: {{Code2|Your IP address appears to be: xxx.xxx.xxx.xxx}}

3. Get back to normal user.

{{CodeSelect2|code=
exit
}}
</div>
</div>


----
----


= _________________________________________________________________________________________________________ =
= // New Page // =

= Connecting to a Proxy before Tor =

== Introduction ==
{{Tunnel_Introduction}}

== Tunnel-link before Tor use cases ==
{{Tunnel_Introduction/Tunnel-link_before_Tor}}
----
{{Tunnel-link_Warnings/Common}}
----
{{Tunnel/Proxy_before_Tor_Warnings}}

== Selecting a Service Provider ==
{{Tunnels/Challenges_in_Provider_Location_Selection}}

== Proxy Configuration Prerequisites ==
{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = '''Tip:''' In order to configure a proxy, three things must be known: where the proxy is running, the IP and port of the proxy, and what type of proxy is being used.
}}
==== Location of the Running Proxy ====
The location of the running proxy is variable and depends on the user's system. Refer to the following resources for examples:
* Proxy software (such as [[lantern]]) create a proxy tunnel on the local computer.
** [[Qubes-Whonix]]: [[lantern]] and [[JonDonym#Connecting_to_JonDonym_before_Tor|JonDonym]] examples.
** [[Non-Qubes-Whonix]]: This is not yet fully documented, please [[contribute]]. The proxy software must run under the linux user account <code>tunnel</code> on Whonix-Gateway.
*** [[Unsupported|Undocumented]]: How to autostart custom software after reboot (systemd etc.).
*** Undocumented: Custom proxy software setup example.
* Proxy software might run on a remote computer, which is easier to set up.

<br />
==== The Proxy IP and Port ====
* If the proxy IP and port is known, the user can skip this section.
* If the user wants to run custom proxy software on Whonix-Gateway, then this is also called localhost. Usually the  proxy IP is <code>127.0.0.1</code>.
* '''Note:''' The user must use the IP instead of the hostname (proxy.example.com). If the proxy IP is unknown, then in a terminal (Konsole) on the host operating system, run {{Code|nslookup proxy.example.com}} (replace proxy.example.com with the hostname of your actual proxy). Using IP instead of hostname might cause subtle fingerprinting issues, see <ref>https://github.com/Whonix/Whonix/issues/94</ref> for more information.
<br />
==== Type of Proxy in Use ====
The user needs to know the proxy type from the following list:
* HTTPProxy
* HTTPSProxy
* Socks4Proxy
* Socks5Proxy
The user must also ascertain whether the proxy requires a username and/or password.
----
== Configure Whonix-Gateway ==
<code>'''User</code> -> <code>proxy</code> -> <code>Tor</code> -> <code>Internet'''</code>

Tor natively supports proxy settings and only requires editing of the torrc file.

==== Option 1: Use {{Code2|Anon Connection Wizard}} ====

Beginning with Whonix 14, a prefixed proxy can be configured easily using [[Anon_Connection_Wizard|Anon Connection Wizard]].
<div class="toccolours mw-collapsible mw-collapsed">
<div class="mw-collapsible-content">
===== Step 1: Start Anon Connection Wizard =====
{{Start_Anon_Connection_Wizard}}

===== Step 2: Use proxy configuration page =====
{{Anon_Connection_Wizard_Use_Proxy}}
</div>
</div>

==== Option 2: Manually configure proxy ====

<div class="toccolours mw-collapsible mw-collapsed">
<div class="mw-collapsible-content">

{{Open /usr/local/etc/torrc.d/50_user.conf}}

Depending on your proxy configuration, add the settings you'll need to your {{Code2|/usr/local/etc/torrc.d/50_user.conf}}. For more information on these settings, have a look in the [https://www.torproject.org/docs/tor-manual.html.en Tor manual] and read the [https://trac.torproject.org/projects/tor/wiki/doc/TorFAQ#MyInternetconnectionrequiresanHTTPorSOCKSproxy. FAQ].

<pre>
HTTPProxy host[:port]
HTTPProxyAuthenticator username:password
HTTPSProxy host[:port]
HTTPSProxyAuthenticator username:password

Socks4Proxy host[:port]

Socks5Proxy host[:port]
Socks5ProxyUsername username
Socks5ProxyPassword password

FascistFirewall 0|1 

ReachableAddresses ADDR[/MASK][:PORT]… 
ReachableDirAddresses ADDR[/MASK][:PORT]… 
ReachableORAddresses ADDR[/MASK][:PORT]… 
</pre>

{{Reload Tor}}

Optional: Test. Run [[whonixcheck]].

Done.
</div>
</div>
