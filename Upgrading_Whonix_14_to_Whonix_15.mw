{{Header}}
{{#seo:
|description=How to Release Upgrade from Whonix 14 to Whonix 15
|image=https://www.whonix.org/w/images/d/d3/Upgrade.jpg
}}

{{mbox
| image   = [[Image:cornues.png|40px|alt=testing]]
| text    = <u>'''Testers only!'''</u>
}}


{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    =
Are you on the right website?

* For standard ("everyday") upgrade instructions see [[Operating System Software and Updates]].
* The instruction on this page are describing how to perform a [[Release Upgrade]] from Whonix 14 to Whonix 15.
}}


{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    =
Release Upgrade: [[{{non q project name short}}|{{non q project name}}]] vs [[{{q project name short}}|{{q project name}}]]<br />
<br />
To use [[{{non q project name short}}|{{non q project name}}]] 15, users can either:

* '''A)''' upgrade existing Whonix 14 images <u>OR</u>,
* '''B)''' re-install Whonix by downloading the new release, which is much simpler than upgrading, see [[VirtualBox Testers Only Version]].

To use [[{{q project name short}}|{{q project name}}]] 15, users:

* can upgrade existing {{q_project_name}} 14 TemplateVMs.
* re-install Whonix by [[Download|downloading the new release]] is not yet possible. <ref>
Blocker: [https://github.com/QubesOS/qubes-issues/issues/4970 create Debian buster template #4970]. (Debian buster template is prerequisite for creating Whonix buster based templates.)
</ref>
}}


{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Downloading a new {{gateway_product_name}} / {{workstation_product_name}} is easier than applying the following upgrade instructions, but this process should be relatively smooth.
}}


{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text    = Note to users of [[{{q project name short}}|{{q project name}}]]:
* [https://www.qubes-os.org/news/2019/03/28/qubes-3-2-has-reached-eol/ Qubes OS 3.2 has reached End Of Life.] If you are using Qubes R3.2 or Qubes R3.2.1, upgrades are [[unsupported]].
* Qubes R4 and above is supported.
}}

= High Level Overview =

# Backup your data - ideally have a copy of the VM so it is possible to try again (if necessary). <br />
# Perform the usual [[Operating_System_Software_and_Updates#Standard_Upgrade_Steps|standard ("everyday") upgrade instructions]].
# Consider running the optional [[#Sanity Tests|sanity tests]]. <br />
# Release Upgrade {{workstation_product_name}} (<code>whonix-ws-14</code>). <br />
# Power off {{workstation_product_name}} (<code>whonix-ws-14</code>). <br />
# Release Upgrade {{gateway_product_name}} (<code>whonix-gw-14</code>). <br />
# Restart {{gateway_product_name}} (<code>whonix-gw-14</code>). <br />
# Restart {{workstation_product_name}} (<code>whonix-ws-14</code>). <br />

= Sanity Tests =
<div class="toccolours mw-collapsible mw-collapsed">
These are optional, but recommended. To complete sanity tests, please press on expand on the right.
<div class="mw-collapsible-content">
{{CodeSelect|code=
sudo dpkg --audit ; echo $?
}}

Expected output.

{{CodeSelect|code=
0
}}

{{CodeSelect|code=
sudo dpkg --configure -a ; echo $?
}}

Expected output.

{{CodeSelect|code=
0
}}

[[Security_Guide#Updates|Get package upgrades.]]

{{CodeSelect|code=
sudo apt-get update
}}

{{CodeSelect|code=
sudo apt-get dist-upgrade
}}

For testing purposes, install python-qt4.

{{CodeSelect|code=
sudo apt-get install python-qt4 ; echo $?
}}

{{CodeSelect|code=
## ... successful installation of python-qt4 ...
0
}}
</div>
</div>

= Upgrading =
== Introduction ==
First consider completing the [[#Sanity Tests|sanity tests]] described above; the system is checked for obvious and grave issues that must be fixed before attempting an upgrade. For example, if the package manager is broken due to the mixing of packages from both Debian stable and Debian testing, then the upgrade may fail part way through, leaving the system in an unstable state that is difficult to resolve.

Consider retaining the full terminal log. Even if the upgrade appears successful, there might be issues following reboot. To properly report a bug in the Whonix forums it is necessary to share the upgrade log so the issue can be investigated.

KDE vs XFCE: Whonix KDE has been [https://forums.whonix.org/t/user-poll-xfce-vs-kde-kde-deprecation-considered/6235 deprecated.] From Whonix 15, Whonix KDE is [[Unsupported|unsupported]]. You can upgrade to Whonix XFCE.

These upgrade instructions will result in removal of the KDE desktop environment to be replaced with the XFCE desktop environment. <ref>
{{non_q_project_name_short}} only since {{q_project_name}} does not have a desktop environment installed - that is up to dom0.
</ref>

These upgrade instructions will result in removal of the KDE default applications to be replaced with the XFCE default applications. <ref>
The user of course has the freedom to retain KDE applications and/or to reinstall those after the upgrade.
</ref>

== Update Package and Sources Lists ==

First, upgrade the system's packages using the [[Operating_System_Software_and_Updates#Standard_Upgrade_Steps|Standard Upgrade Steps]].

=== All Platforms ===

Update Whonix apt sources list.

{{CodeSelect|code=
sudo whonix_repository --enable --codename buster
}}

Update Debian apt sources list.

{{CodeSelect|code=
sudo sed -i "s/stretch/buster/g" /etc/apt/sources.list.d/debian.list
}}

Delete [[Install_Software#Backports|backports]], [[Install_Software#Install_from_Debian_testing|testing]], [[Install_Software#Install_from_Debian_Unstable|unstable]] repository, as well as  [[Install_Software#Install_from_Debian_testing|default release APT config]] snippet. <ref>
Only required if you previously enabled but the command is safe to run even if you did not use it earlier.
</ref>

{{CodeSelect|code=
sudo rm -f /etc/apt/sources.list.d/backports.list /etc/apt/sources.list.d/testing.list /etc/apt/sources.list.d/unstable.list /etc/apt/apt.conf.d/70defaultrelease
}}

=== {{q_project_name}} Only ===
Update Qubes apt sources list.

{{CodeSelect|code=
sudo sed -i "s/stretch/buster/g" /etc/apt/sources.list.d/qubes*.list
}}

{{Anchor|Enable Debugging and Update Select Packages}}

== Preparation ==
Become root.

{{CodeSelect|code=
sudo su
}}

Enable extensive debugging so the reporting of any eventual bugs is easier.

{{CodeSelect|code=
export DEBDEBUG=1
}}

{{Update}}

{{CodeSelect|code=
apt-get update
}}

== Upgrade ==

=== Distribution Upgrade ===
Upgrade. Run.

The following command uses [https://github.com/Whonix/usability-misc/blob/master/usr/bin/apt-get-noninteractive <code>apt-get-noninteractive</code>]. This is recommended for most users since <code>apt-get-noninteractive</code> prevents the user being asked difficult technical questions during the upgrade. It also prevents questions being asked in the middle which would stop the upgrade until the question is answered. <code>apt-get-noninteractive</code> uses <code>apt-get</code> with <code>-o Dpkg::Options::=--force-confnew</code>, which means, that <code>apt-get</code> will in case of a modified config file on the system and a new config file shipped by the distribution prefer to config file by the distribution. Old config files should be automatically moved to <code>configfile.dpkg-old</code>. <ref>
Advanced users may use <code>apt-get</code> rather than <code>apt-get-noninteractive</code>. However, it's probably best to use <code>apt-get-noninteractive</code> and to re-apply custom configs after the upgrade.
</ref> <ref>
Parameter <code>--no-install-recommends</code> prevents installation of packages (from <code>debian/control</code> <code>Recommends:</code> of packages by Debian) which are not useful, confusing or wasting disk space in inside virtual machines such as <code>xscreensaver</code>. For other reasons why Whonix uses <code>--no-install-recommends</code>, see also [[{{project name short}}_Debian_Packages#Technical_Stuff]].
</code>
</ref>

Ignore any eventual errors relating to <code>exim*</code> and/or <code>mailx</code> - these packages will be removed in the next step.

{{CodeSelect|code=
apt-get-noninteractive dist-upgrade --no-install-recommends
}}

Purge packages which are not required and broken. On some platforms these are not installed, then this step is ok too.

{{CodeSelect|code=
apt-get purge exim*
}}

=== Restart Necessary Services ===

Restart whonix-legacy service. <ref>
A manual restart is required because apt-get-noninteractive is being used. This step is not crucial since it would also run after reboot.
</ref>

{{CodeSelect|code=
service whonix-legacy restart
}}

=== Metapackage Installation ===
It's possible that the following package is already installed. This step is only here to ensure it really is.

<div class="toccolours mw-collapsible mw-collapsed">
<u>[[{{non q project name short}}|{{non q project name}}]] users</u> please click on expand on the right.
<div class="mw-collapsible-content">
{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = {{non_q_project_name_short}} only! Only complete this step in {{gateway_product_name}}!
}}


Install package <code>non-qubes-whonix-gateway-xfce</code>.

{{CodeSelect|code=
apt-get install non-qubes-whonix-gateway-xfce
}}


{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = {{non_q_project_name_short}} only! Only complete this step in Whonix-Workstation!
}}


Install package <code>non-qubes-whonix-workstation-xfce</code>.

{{CodeSelect|code=
apt-get install non-qubes-whonix-workstation-xfce
}}
</div>
</div>

<div class="toccolours mw-collapsible mw-collapsed">
<u>[[{{q project name short}}|{{q project name}}]] users</u> please click on expand on the right.
<div class="mw-collapsible-content">
{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = {{q_project_name}} only! Only complete this step in {{gateway_product_name}} (<code>whonix-gw-14</code>)!
}}


Install package <code>qubes-whonix-gateway</code>.

{{CodeSelect|code=
apt-get install qubes-whonix-gateway
}}


{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = {{q_project_name}} only! Only complete this step in {{workstation_product_name}} (<code>whonix-ws-14</code>)!
}}


Install package <code>qubes-whonix-workstation</code>.

{{CodeSelect|code=
apt-get install qubes-whonix-workstation
}}
</div>
</div>

=== Remove Unneeded Packages ===
Note: Not required for [[{{non q project name short}}|{{non q project name}}]] XFCE users.

Remove deprecated meta packages and KDE leftovers. The following is one long command for copy and paste. <ref>
If you wanted to run the commands individually you would have to remove the <code>; \</code> at the end.
</ref> <ref>
Unfortunately apt-get as of Debian buster does no longer allow a single apt-get purge command anymore followed by a list of all packages. If one of the packages wouldn't be installed already it would abort the whole command and also refuse to uninstall those which are still installed. Therefore we use <code>;</code> which means one command after another and <code>\</code> which allow to write a a single long command split into multiple lines for better readability.
</ref>

{{gateway_product_name}} <u>and</u> Whonix-Workstation:

{{CodeSelect|code=
apt-get purge --yes non-qubes-whonix-gateway ; \
apt-get purge --yes non-qubes-whonix-gateway-kde ; \
apt-get purge --yes non-qubes-whonix-workstation ; \
apt-get purge --yes non-qubes-whonix-workstation-kde ; \
apt-get purge --yes whonix-gw-kde-desktop-conf ; \
apt-get purge --yes whonix-gw-desktop-shortcuts ; \
apt-get purge --yes hardened-desktop-applications-kde ; \
apt-get purge --yes hardened-desktop-environment-essential-kde ; \
apt-get purge --yes sddm ; \
apt-get purge --yes kde-* ; \
apt-get purge --yes libkde* ; \
apt-get purge --yes qml-module-org-kde-* ; \
apt-get purge --yes polkit-kde-agent-1 ; \
apt-get purge --yes kded5 ; \
apt-get purge --yes *kdelibs* ; \
apt-get purge --yes kdesudo ; \
apt-get purge --yes ark ; \
apt-get purge --yes konsole
}}

The following packages should be purged on <u>{{gateway_product_name}} only</u>:

{{CodeSelect|code=
apt-get purge --yes vlc* ; \
apt-get purge --yes libvlc* ; \
apt-get purge --yes phonon*
}}

=== Autoremove ===

Remove packages which are no longer required.

{{CodeSelect|code=
apt-get autoremove
}}

=== Drop Back to Regular User ===
Open a terminal.

Or if you are root already (previously became root using <code>sudo su</code> exit now.

{{CodeSelect|code=
exit
}}

=== Remove Desktop Shortcuts ===
* <u>[[{{q project name short}}|{{q project name}}]] users</u>: Please skip this. <ref>
Desktop shortcuts are not visible in Qubes anyhow. You can skip this. But if you want to apply this, it should be done in every AppVM.
</ref>
<div class="toccolours mw-collapsible mw-collapsed">
* <u>[[{{non q project name short}}|{{non q project name}}]] users</u>: Please click on expand on the right.
<div class="mw-collapsible-content">
Desktop shortcuts are no longer supported by Whonix developers. <ref>
Due to issues with XFCE.
</ref>

Create folder <code>/home/user/desktop-backup</code>.

{{CodeSelect|code=
mkdir -p /home/user/desktop-backup
}}

Move any obsolete <code>.desktop</code> files out of the way. Make sure to add no extra spaces to the following command!

{{CodeSelect|code=
mv /home/user/Desktop/*.desktop /home/user/desktop-backup/
}}
</div>
</div>

=== Whonix XFCE Desktop Config ===
* <u>[[{{q project name short}}|{{q project name}}]] users</u>: Please skip this. <ref>
VM XFCE is not being used in Qubes and package [https://github.com/Whonix/whonix-xfce-desktop-config Whonix XFCE Desktop Config] does not get installed in Qubes anhow. You can skip this. But if you want to apply this, it should be done in every AppVM.
</ref>
<div class="toccolours mw-collapsible mw-collapsed">
* <u>[[{{non q project name short}}|{{non q project name}}]] users:</u> Please click on expand on the right.
<div class="mw-collapsible-content">
Create folder <code>/home/user/desktop-backup</code>.

{{CodeSelect|code=
mkdir -p /home/user/desktop-backup
}}

Reset XFCE desktop config.

{{CodeSelect|code=
mv /home/user/.config/xfce4 /home/user/desktop-backup/
}}

Delete first-boot-skel done file. <ref>
So it can be re-run.
</ref>

{{CodeSelect|code=
sudo rm -f /var/cache/anon-base-files/first-boot-skel.done
}}

Execute [https://github.com/Whonix/whonix-base-files/blob/master/usr/lib/anon-base-files/first-boot-skel <code>/usr/lib/anon-base-files/first-boot-skel</code>] to get [https://github.com/Whonix/whonix-xfce-desktop-config Whonix XFCE Desktop Config].

{{CodeSelect|code=
sudo /usr/lib/anon-base-files/first-boot-skel
}}
</div>
</div>

=== onion-grater ===
Did you previously use any applications that require an onion-grater whitelist extension such as [[OnionShare]], [[ZeroNet]] or [[Chat#Ricochet_IM|Ricochet IM]]?

* If yes: follow the instructions in this chapter.
* If not: you can skip this chapter.

* <u>[[{{q project name short}}|{{q project name}}]] users</u>: Apply this in <code>sys-whonix</code>.
* <u>[[{{non q project name short}}|{{non q project name}}]] users</u>: Apply this in in {{gateway_product_name}}.

Remove all existing onion-grater extension profiles.

{{CodeSelect|code=
sudo unlink /usr/local/etc/onion-grater-merger.d/* ; echo "$?"
}}

* If it shows <code>unlink: cannot unlink '/usr/local/etc/onion-grater-merger.d/*': No such file or directory</code> then you didn't have any onion-grater profiles before. All ok, move on the next chapter.
* If it shows <code>0</code> this means that some onion-grater profiles were deactivated. You have to reactivate them using the updated instructions.
** [[OnionShare]]: [[OnionShare#onion-grater|onion-grater instructions]]
** [[ZeroNet]]: [[ZeroNet#onion-grater_Adjustments|onion-grater instructions]]
** [[Chat#Ricochet_IM|Ricochet IM]]: [[Chat#Add_a_Ricochet_Python_Profile|onion-grater instructions]]

=== Fixes ===
[[{{q_project_name_short}}|{{q_project_name}}]] {{gateway_product_name}} (<code>whonix-gw-14</code>) only!

Fix tinyproxy path. <ref>
https://github.com/QubesOS/qubes-issues/issues/4929
</ref>

{{CodeSelect|code=
sudo sed -i "s#/usr/sbin/tinyproxy#/usr/bin/tinyproxy#g" /lib/systemd/system/qubes-updates-proxy.service
}}

=== Terminal Log ===

Remember to retain the terminal log:

<code>Edit</code> -> <code>Select All</code> -> <code>Edit</code> -> <code>Copy</code> -> <code>Open Editor</code> -> <code>Paste</code> -> <code>Save</code>

=== APT Sources Lists ===
Open a new terminal window. <ref>
Because GUI application whonix-repository-wizard should not be run as root. 
</ref>

Run [[{{project name short}}-APT-Repository|Whonix APT Repository Tool]]. <ref>
To make sure you are using the APT repository you wish to use.
</ref>

{{CodeSelect|code=
lxsu whonix-repository-wizard
}}

As explained in step [[#Distribution Upgrade]] all system configuration files in <code>/etc</code> were reset to distributor default. If you previously made any modifications to any files in folder <code>/etc/apt/sources.list.d</code>, now is the time to re-add them should you wish so.

Review all files in folder <code>/etc/apt/sources.list.d</code>.

{{CodeSelect|code=
lxsu mousepad /etc/apt/sources.list.d/*
}}

If you made any changes, please proceed now with the [[Operating System Software and Updates|standard ("everyday") upgrade instructions]].

=== Reboot ===

A reboot is required.

{{CodeSelect|code=
sudo reboot
}}

=== Start Menu  ===
* <u>[[{{non q project name short}}|{{non q project name}}]] users</u>: Please skip this. 
<div class="toccolours mw-collapsible mw-collapsed">
* <u>[[{{q project name short}}|{{q project name}}]] users:</u> Please click on expand on the right.
<div class="mw-collapsible-content">
The upgrade process cannot upgrade the user's Qubes appmenus (start menu) entries. These must be manually updated since many application that were installed by default in {{q_project_name}} 14 are no longer installed by default in {{q_project_name}} 15 due to change from KDEish to XFCEish default applications. <ref>
https://groups.google.com/d/topic/qubes-devel/pkvvm1WNznY
</ref>
	 
* <code>Qubes appmenu</code> -> <code>anon-whonix</code> -> <code>Add more shortcuts</code>
* <code>Qubes appmenu</code> -> <code>sys-whonix</code> -> <code>Add more shortcuts</code>
* <code>Qubes appmenu</code> -> <code>whonix-gw-14</code> -> <code>Add more shortcuts</code>
* <code>Qubes appmenu</code> -> <code>whonix-ws-14</code> -> <code>Add more shortcuts</code>
</div>
</div>

=== Done ===
All necessary steps are now complete.

You are advised to run [[whonixcheck]].

= Footnotes =
<ref>
This is ok.
<pre>
The following packages were automatically installed and are no longer required:
  hardened-packages-recommended-cli non-qubes-vm-enhancements-gui whonix-workstation-default-applications-gui whonix-ws-desktop-shortcuts
</pre>
</ref>

{{reflist|close=1}}

[[Category:Documentation]]

{{Footer}}
