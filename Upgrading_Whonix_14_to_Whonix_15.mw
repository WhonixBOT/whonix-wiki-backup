{{Header}}
{{#seo:
|description=How to Release Upgrade from Whonix 14 to Whonix 15
|image=https://www.whonix.org/w/images/d/d3/Upgrade.jpg
}}

{{mbox
| image   = [[Image:cornues.png|40px|alt=testing]]
| text    = <u>'''Testers only!'''</u>

* [[Non-Qubes-Whonix]]: Testers only!
* [[Qubes-Whonix]]: Entirely untested. Check back later.
}}


{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    =
Are you on the right website?

* For standard ("everyday") upgrade instructions see [[Operating System Software and Updates]].
* The instruction on this page are describing how to perform a [[Release Upgrade]] from Whonix 14 to Whonix 15.

To use Whonix 15, users can either:

* '''A)''' upgrade existing Whonix 14 templates <u>OR</u>,
* '''B)''' re-install Whonix by [[Download|downloading the new release]], which is much simpler than upgrading.
}}


{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Downloading a new Whonix-Gateway / Whonix-Workstation is easier than applying the following upgrade instructions, but this process should be relatively smooth.
}}


{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Both [[Non-Qubes-Whonix]] and [[Qubes-Whonix]] are supported.
}}


{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text    = Note to users of [[Qubes-Whonix]]:
* [https://www.qubes-os.org/news/2019/03/28/qubes-3-2-has-reached-eol/ Qubes OS 3.2 has reached End Of Life.] If you are using Qubes R3.2 or Qubes R3.2.1, upgrades are [[unsupported]].
* Qubes R4 and above is supported.
}}

= High Level Overview =

# Backup your data - ideally have a copy of the VM so it is possible to try again (if necessary). <br />
# Perform the usual [[Operating_System_Software_and_Updates#Standard_Upgrade_Steps|standard ("everyday") upgrade instructions]].
# Consider running the optional [[#Sanity Tests|sanity tests]]. <br />
# Release Upgrade Whonix-Workstation (<code>whonix-ws-14</code>). <br />
# Power off Whonix-Workstation (<code>whonix-ws-14</code>). <br />
# Release Upgrade Whonix-Gateway (<code>whonix-gw-14</code>). <br />
# Restart Whonix-Gateway (<code>whonix-gw-14</code>). <br />
# Restart Whonix-Workstation (<code>whonix-ws-14</code>). <br />

= Sanity Tests =
<div class="toccolours mw-collapsible mw-collapsed">
These are optional, but recommended. To complete sanity tests, please press on expand on the right.
<div class="mw-collapsible-content">
{{CodeSelect|code=
sudo dpkg --audit ; echo $?
}}

Expected output.

{{CodeSelect|code=
0
}}

{{CodeSelect|code=
sudo dpkg --configure -a ; echo $?
}}

Expected output.

{{CodeSelect|code=
0
}}

[[Security_Guide#Updates|Get package upgrades.]]

{{CodeSelect|code=
sudo apt-get update
}}

{{CodeSelect|code=
sudo apt-get dist-upgrade
}}

For testing purposes, install python-qt4.

{{CodeSelect|code=
sudo apt-get install python-qt4 ; echo $?
}}

{{CodeSelect|code=
## ... successful installation of python-qt4 ...
0
}}
</div>
</div>

= Upgrading =
== Introduction ==
First consider completing the [[#Sanity Tests|sanity tests]] described above; the system is checked for obvious and grave issues that must be fixed before attempting an upgrade. For example, if the package manager is broken due to the mixing of packages from both Debian stable and Debian testing, then the upgrade may fail part way through, leaving the system in an unstable state that is difficult to resolve.

Consider retaining the full terminal log. Even if the upgrade appears successful, there might be issues following reboot. To properly report a bug in the Whonix forums it is necessary to share the upgrade log so the issue can be investigated.

KDE vs XFCE: Whonix KDE has been [https://forums.whonix.org/t/user-poll-xfce-vs-kde-kde-deprecation-considered/6235 deprecated.] From Whonix 15, Whonix KDE is [[Unsupported|unsupported]]. You can upgrade to Whonix XFCE. These upgrade instructions will result in removal of the KDE desktop environment to be replaced with the XFCE desktop environment.

== Update Package and Sources Lists ==

First, upgrade the system's packages using the [[Operating_System_Software_and_Updates#Standard_Upgrade_Steps|Standard Upgrade Steps]].

=== All Platforms ===

Update Whonix apt sources list.

{{CodeSelect|code=
sudo whonix_repository --enable --codename buster
}}

Update Debian apt sources list.

{{CodeSelect|code=
sudo sed -i "s/stretch/buster/g" /etc/apt/sources.list.d/debian.list
}}

Delete [[Install_Software#Backports|backports]], [[Install_Software#Install_from_Debian_testing|testing]], [[Install_Software#Install_from_Debian_Unstable|unstable]] repository, as well as  [[Install_Software#Install_from_Debian_testing|default release APT config]] snippet. <ref>
Only required if you previously enabled but the command is safe to run even if you did not use it earlier.
</ref>

{{CodeSelect|code=
sudo rm -f /etc/apt/sources.list.d/backports.list /etc/apt/sources.list.d/testing.list /etc/apt/sources.list.d/unstable.list /etc/apt/apt.conf.d/70defaultrelease
}}

=== Qubes-Whonix Only ===
Update Qubes apt sources list.

{{CodeSelect|code=
sudo sed -i "s/stretch/buster/g" /etc/apt/sources.list.d/qubes*.list
}}

{{Anchor|Enable Debugging and Update Select Packages}}

== Preparation ==
Become root.

{{CodeSelect|code=
sudo su
}}

Enable extensive debugging so the reporting of any eventual bugs is easier.

{{CodeSelect|code=
export DEBDEBUG=1
}}

{{Update}}

{{CodeSelect|code=
apt-get update
}}

== Upgrade ==

=== Distribution Upgrade ===
Upgrade. Run.

Note: The following command uses [https://github.com/Whonix/usability-misc/blob/master/usr/bin/apt-get-noninteractive <code>apt-get-noninteractive</code>]. This is recommended for most users since <code>apt-get-noninteractive</code> prevents the user being asked difficult technical questions during the upgrade. It also prevents questions being asked in the middle which would stop the upgrade until the question is answered. <code>apt-get-noninteractive</code> uses <code>apt-get</code> with <code>-o Dpkg::Options::=--force-confnew</code>, which means, that <code>apt-get</code> will in case of a modified config file on the system and a new config file shipped by the distribution prefer to config file by the distribution. Old config files should be automatically moved to <code>configfile.dpkg-old</code>. <ref>
Advanced users may use <code>apt-get</code> rather than <code>apt-get-noninteractive</code>. However, it's probably best to use <code>apt-get-noninteractive</code> and to re-apply custom configs after the upgrade.
</ref>

{{CodeSelect|code=
apt-get-noninteractive dist-upgrade
}}

Ignore errors relating to exim* amd mailx - these packages will be removed in the next step.

Purge packages which are not required and broken.

{{CodeSelect|code=
apt-get purge exim*
}}

=== Restart Necessary Services ===

Restart whonix-legacy service. <ref>
A manual restart is required because apt-get-noninteractive is being used. This step is not crucial since it would also run after reboot.
</ref>

{{CodeSelect|code=
service whonix-legacy restart
}}

=== Install Whonix-Gateway and Whonix-Workstation ===

[[Update]] the package lists again. <ref>
This is required because the Whonix repository URI has been upgraded to a new location by the whonix-legacy package.
</ref>

{{CodeSelect|code=
apt-get update
}}

<div class="toccolours mw-collapsible mw-collapsed">
<u>[[Non-Qubes-Whonix]] users</u> please click on expand on the right.
<div class="mw-collapsible-content">
{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Non-Qubes-Whonix only! Only complete this step in Whonix-Gateway!
}}


Install package <code>non-qubes-whonix-gateway-xfce</code>.

{{CodeSelect|code=
apt-get install non-qubes-whonix-gateway-xfce
}}


{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Non-Qubes-Whonix only! Only complete this step in Whonix-Workstation!
}}


Install package <code>non-qubes-whonix-workstation-xfce</code>.

{{CodeSelect|code=
apt-get install non-qubes-whonix-workstation-xfce
}}

}}
</div>
</div>

<div class="toccolours mw-collapsible mw-collapsed">
<u>[[Qubes-Whonix]] users</u> please click on expand on the right.
<div class="mw-collapsible-content">
{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Qubes-Whonix only! Only complete this step in Whonix-Gateway (<code>whonix-gw-14</code>)!
}}


Install package <code>non-qubes-whonix-gateway-xfce</code>.

{{CodeSelect|code=
apt-get install qubes-whonix-gateway
}}

{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Qubes-Whonix only! Only complete this step in Whonix-Workstation (<code>whonix-ws-14</code>)!
}}


{{CodeSelect|code=
apt-get install qubes-whonix-workstation
}}
</div>
</div>

=== Remove Unneeded Packages ===
Note: Not required for [[Non-Qubes-Whonix]] XFCE users.

Remove deprecated meta packages and KDE leftovers. If any of these packages is not installed, just proceed trying remove the next one in the list one by one.

<pre>
apt-get purge --yes non-qubes-whonix-gateway ; \
apt-get purge --yes non-qubes-whonix-gateway-kde ; \
apt-get purge --yes non-qubes-whonix-workstation ; \
apt-get purge --yes non-qubes-whonix-workstation-kde ; \
apt-get purge --yes whonix-gw-kde-desktop-conf ; \
apt-get purge --yes whonix-gw-desktop-shortcuts ; \
apt-get purge --yes hardened-desktop-applications-kde ; \
apt-get purge --yes hardened-desktop-environment-essential-kde ; \
apt-get purge --yes sddm ; \
apt-get purge --yes kde-* ; \
apt-get purge --yes libkde* ; \
apt-get purge --yes qml-module-org-kde-* ; \
apt-get purge --yes polkit-kde-agent-1 ; \
apt-get purge --yes kded5 ; \
apt-get purge --yes *kdelibs* ; \
apt-get purge --yes kdesudo
</pre>

=== Autoremove ===

Remove packages which are no longer required.

{{CodeSelect|code=
apt-get autoremove
}}

=== Drop Back to Regular User ===
Open a terminal.

Or if you are root already (previously became root using <code>sudo su</code> exit now.

<pre>
exit
</pre>

=== Remove Desktop Shortcuts ===
Desktop shortcuts are no longer supported by Whonix developers. <ref>
Due to issues with XFCE.
</ref> You are advised to remove any.

Create folder <code>/home/user/desktop-backup</code>.

{{CodeSelect|code=
mkdir -p /home/user/desktop-backup
}}

Move any obsolete <code>.desktop</code> files out of the way. Make sure to add no extra spaces to the following command!

{{CodeSelect|code=
mv /home/user/Desktop/*.desktop /home/user/desktop-backup/
}}

=== Whonix XFCE Desktop Config ===
Optional.

Reset XFCE desktop config.

{{CodeSelect|code=
mv /home/user/.config/xfce4 /home/user/desktop-backup/
}}

Delete first-boot-skel done file. <ref>
So it can be re-run.
</ref>

{{CodeSelect|code=
sudo rm -f /var/cache/anon-base-files/first-boot-skel.done
}}

Execute [https://github.com/Whonix/whonix-base-files/blob/master/usr/lib/anon-base-files/first-boot-skel <code>/usr/lib/anon-base-files/first-boot-skel</code>] to get [https://github.com/Whonix/whonix-xfce-desktop-config Whonix XFCE Desktop Config].

{{CodeSelect|code=
sudo /usr/lib/anon-base-files/first-boot-skel
}}

=== Terminal Log ===

Remember to retain the terminal log:

<code>Edit</code> -> <code>Select All</code> -> <code>Edit</code> -> <code>Copy</code> -> <code>Open Editor</code> -> <code>Paste</code> -> <code>Save</code>

=== Whonix APT-Repository ===
Open a new terminal window. <ref>
Because GUI application whonix-repository-wizard should not be run as root. 
</ref>

Run [[Whonix-APT-Repository|Whonix APT Repository Tool]]. <ref>
To make sure you are using the APT repository you wish to use.
</ref>

{{CodeSelect|code=
kdesudo whonix-repository-wizard
}}

=== Reboot ===

A reboot is required.

{{CodeSelect|code=
sudo reboot
}}

=== Done ===
All necessary steps are now complete.

You are advised to run [[whonixcheck]].

= Footnotes =
<ref>
This is ok.
<pre>
The following packages were automatically installed and are no longer required:
  hardened-packages-recommended-cli non-qubes-vm-enhancements-gui whonix-workstation-default-applications-gui whonix-ws-desktop-shortcuts
</pre>
</ref>

{{reflist|close=1}}

[[Category:Documentation]]

{{Footer}}
