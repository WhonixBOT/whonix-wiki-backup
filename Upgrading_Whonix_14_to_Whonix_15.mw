{{Header}}
{{#seo:
|description=How to Release Upgrade from Whonix 14 to Whonix 15
|image=https://www.whonix.org/w/images/d/d3/Upgrade.jpg
}}

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text    = 
'''Untested! Do not use yet!'''
}}

__NOINDEX__

{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    =
Are you on the right website?

* For standard ("everyday") upgrade instructions see [[Operating System Software and Updates]].
* The instruction on this page are describing how to perform a [[Release Upgrade]] from Whonix 14 to Whonix 15.

To use Whonix 15, users can either:

* '''A)''' upgrade existing Whonix 14 templates <u>OR</u>,
* '''B)''' re-install Whonix by [[Download|downloading the new release]], which is much simpler than upgrading.
}}


{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Downloading a new Whonix-Gateway / Whonix-Workstation is easier than applying the following upgrade instructions, but this process should be relatively smooth.
}}


{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Both [[Non-Qubes-Whonix]] and [[Qubes-Whonix]] are supported.
}}


{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text    = Note to users of [[Qubes-Whonix]]:
* [https://www.qubes-os.org/news/2019/03/28/qubes-3-2-has-reached-eol/ Qubes OS 3.2 has reached End Of Life.] If you are using Qubes R3.2 or Qubes R3.2.1, upgrades are [[unsupported]].
* Qubes R4 and above is supported.
}}

= High Level Overview =

# Backup your data - ideally have a copy of the VM so it is possible to try again (if necessary). <br />
# Perform the usual [[Operating_System_Software_and_Updates#Standard_Upgrade_Steps|standard ("everyday") upgrade instructions]].
# Consider running the optional [[#Sanity Tests|sanity tests]]. <br />
# Release Upgrade Whonix-Workstation (<code>whonix-ws-14</code>). <br />
# Power off Whonix-Workstation (<code>whonix-ws-14</code>). <br />
# Release Upgrade Whonix-Gateway (<code>whonix-gw-14</code>). <br />
# Restart Whonix-Gateway (<code>whonix-gw-14</code>). <br />
# Restart Whonix-Workstation (<code>whonix-ws-14</code>). <br />

= Sanity Tests =
<div class="toccolours mw-collapsible mw-collapsed">
These are optional, but recommended. To complete sanity tests, please press on expand on the right.
<div class="mw-collapsible-content">
{{CodeSelect|code=
sudo dpkg --audit ; echo $?
}}

Expected output.

{{CodeSelect|code=
0
}}

{{CodeSelect|code=
sudo dpkg --configure -a ; echo $?
}}

Expected output.

{{CodeSelect|code=
0
}}

[[Security_Guide#Updates|Get package upgrades.]]

{{CodeSelect|code=
sudo apt-get update
}}

{{CodeSelect|code=
sudo apt-get dist-upgrade
}}

For testing purposes, install python-qt4.

{{CodeSelect|code=
sudo apt-get install python-qt4 ; echo $?
}}

{{CodeSelect|code=
## ... successful installation of python-qt4 ...
0
}}
</div>
</div>

= Upgrading =
== Introduction ==
First consider completing the [[#Sanity Tests|sanity tests]] described above; the system is checked for obvious and grave issues that must be fixed before attempting an upgrade. For example, if the package manager is broken due to the mixing of packages from both Debian stable and Debian testing, then the upgrade may fail part way through, leaving the system in an unstable state that is difficult to resolve.

Consider retaining the full terminal (Konsole) log. Even if the upgrade appears successful, there might be issues following reboot. To properly report a bug in the Whonix forums it is necessary to share the upgrade log so the issue can be investigated.

== Update Package and Sources Lists ==

First, upgrade the system's packages using the [[Operating_System_Software_and_Updates#Standard_Upgrade_Steps|Standard Upgrade Steps]].

=== All Platforms ===

Update Whonix apt sources list.

{{CodeSelect|code=
sudo whonix_repository --enable --codename buster-testers
}}

Update Debian apt sources list.

{{CodeSelect|code=
sudo sed -i "s/stretch/buster/g" /etc/apt/sources.list.d/debian.list
}}

Delete [[Install_Software#Backports|backports]], [[Install_Software#Install_from_Debian_testing|testing]], [[Install_Software#Install_from_Debian_Unstable|unstable]] repository, as well as  [[Install_Software#Install_from_Debian_testing|default release APT config]] snippet. <ref>
Only required if you previously enabled but the command is safe to run even if you did not use it earlier.
</ref>

{{CodeSelect|code=
sudo rm -f /etc/apt/sources.list.d/backports.list /etc/apt/sources.list.d/testing.list /etc/apt/sources.list.d/unstable.list /etc/apt/apt.conf.d/70defaultrelease
}}

=== Qubes-Whonix Only ===
Update Qubes apt sources list.

{{CodeSelect|code=
sudo sed -i "s/stretch/buster/g" /etc/apt/sources.list.d/qubes*.list
}}

{{Anchor|Enable Debugging and Update Select Packages}}

== Preparation ==
Become root.

{{CodeSelect|code=
sudo su
}}

Enable extensive debugging so the reporting of any eventual bugs is easier.

{{CodeSelect|code=
export DEBDEBUG=1
}}

{{Update}}

{{CodeSelect|code=
apt-get update
}}

== Upgrade ==

=== Distribution Upgrade ===
Run.

{{CodeSelect|code=
apt-get-noninteractive dist-upgrade
}}

Ignore errors relating to exim* amd mailx - these packages will be removed in the next step.

Purge packages which are not required or deprecated in Whonix and have been replaced by new functionality. <ref>
sysfsutils - https://github.com/Whonix/Whonix/commit/d7cb15aa96bd571368b54f8a980922d9e1982250
</ref> anon-shared-kde-accessibility and kaccessible can be excluded from the following command if accessibility tools are in use.

{{CodeSelect|code=
apt-get purge exim*
}}

=== Restart Necessary Services ===

Restart whonix-legacy service. <ref>
A manual restart is required because apt-get-noninteractive is being used. This step is not crucial since it would also run after reboot.
</ref>

{{CodeSelect|code=
service whonix-legacy restart
}}

=== Install Whonix-Gateway and Whonix-Workstation ===

[[Update]] the package lists again. <ref>
This is required because the Whonix repository URI has been upgraded to a new location by the whonix-legacy package.
</ref>

{{CodeSelect|code=
apt-get update
}}

<div class="toccolours mw-collapsible mw-collapsed">
<u>[[Non-Qubes-Whonix]] users</u> please click on expand on the right.
<div class="mw-collapsible-content">
{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Non-Qubes-Whonix only! Only complete this step in Whonix-Gateway!
}}


Install package <code>non-qubes-whonix-gateway-xfce</code>.

{{CodeSelect|code=
apt-get install non-qubes-whonix-gateway-xfce
}}


{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Non-Qubes-Whonix only! Only complete this step in Whonix-Workstation!
}}


{{CodeSelect|code=
apt-get install non-qubes-whonix-workstation-xfce
}}

}}
</div>
</div>

<div class="toccolours mw-collapsible mw-collapsed">
<u>[[Qubes-Whonix]] users</u> please click on expand on the right.
<div class="mw-collapsible-content">
{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Qubes-Whonix only! Only complete this step in Whonix-Gateway (<code>whonix-gw-14</code>)!
}}


Install package <code>non-qubes-whonix-gateway-xfce</code>.

{{CodeSelect|code=
apt-get install qubes-whonix-gateway
}}

{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Qubes-Whonix only! Only complete this step in Whonix-Workstation (<code>whonix-ws-14</code>)!
}}


{{CodeSelect|code=
apt-get install qubes-whonix-workstation
}}

=== Miscellaneous Configuration Steps ===

TODO: Is this still required?

{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Qubes-Whonix Whonix-Workstation (<code>whonix-ws</code>) only! Qubes R4 only!
}}


{{CodeSelect|code=
apt-get install pulseaudio-qubes
}}
</div>
</div>

<!--
If snapshots or backups of the VM were not made, then at least /boot should be backed up.

{{CodeSelect|code=
cp -a /boot /boot.back
}}

Remove the old versions of initrd and create new ones with dracut.

{{CodeSelect|code=
rm /boot/initr*
dracut --regenerate-all
}}

Update GRUB.

{{CodeSelect|code=
update-grub
}}
-->

=== Remove Unneeded Packages ===
Only required for Whonix KDE users which are now migrating to Whonix XFCE.

Remove deprecated meta packages and KDE leftovers.

{{CodeSelect|code=
apt-get purge non-qubes-whonix-gateway
apt-get purge non-qubes-whonix-gateway-kde
apt-get purge non-qubes-whonix-workstation
apt-get purge non-qubes-whonix-workstation-kde
apt-get purge whonix-gw-kde-desktop-conf
apt-get purge whonix-gw-desktop-shortcuts
apt-get purge hardened-desktop-applications-kde
apt-get purge hardened-desktop-environment-essential-kde
apt-get purge sddm
apt-get purge kde-*
apt-get purge libkde*
apt-get purge qml-module-org-kde-*
apt-get purge polkit-kde-agent-1
apt-get purge kded5
apt-get purge *kdelibs*
apt-get purge kdesudo
}}

=== Autoremove ===

Remove packages which are no longer required.

{{CodeSelect|code=
apt-get autoremove
}}

=== Konsole Log ===

Remember to store the terminal log:

<code>Edit</code> -> <code>Select All</code> -> <code>Edit</code> -> <code>Copy</code> -> <code>Open Editor</code> -> <code>Paste</code> -> <code>Save</code>

=== Whonix APT-Repository ===
Open a new terminal window. <ref>
Because GUI application whonix-repository-wizard should not be run as root. 
</ref>

Run [[Whonix-APT-Repository|Whonix APT Repository Tool]].

{{CodeSelect|code=
kdesudo whonix-repository-wizard
}}

A poweroff is required.

{{CodeSelect|code=
sudo poweroff
}}

All necessary steps are now complete.

= Footnotes =
{{reflist|close=1}}

[[Category:Documentation]]

{{Footer}}
