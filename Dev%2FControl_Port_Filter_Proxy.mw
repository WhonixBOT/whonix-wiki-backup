{{Header}}

= Control Port Filter Proxy =
== Introduction ==
Tor's control port has at least one, in context of Whonix, dangerous feature. Its "GETINFO address" and the answer to this request will be the real external IP of the Tor client. This can not be limited any other way, since the feature request [https://trac.torproject.org/projects/tor/ticket/8369 Option to limit information Tor's control port discloses] against Tor has not been implemented. By the way, this Tor control port feature makes also a [https://trac.torproject.org/projects/tor/wiki/doc/TorifyHOWTO/BridgeFirewall Bridge Firewall] impossible. Therefore before Whonix {{Whonix6}}, Whonix-Workstation had no access to Tor's control port. This was because, Whonix-Workstation is not supposed to have an way of finding out its own external IP address.

Before Whonix {{Whonix6}}, this also broke Tor Button's New Identity feature, which essentially sends "SIGNAL NEWNYM" to Tor's control port. While Tor Button's New Identity is still the only feature that was not available when using Tor Browser in Whonix, Tor Button in future will get more and more dependent on Tor's control port.

TBB (since version 3 alpha) [https://trac.torproject.org/projects/tor/ticket/6546#comment:33 by default performs its own control port verification]. It checks using Tor's control port(!), that the socks port Tor reports, is the same one as Tor Browser is configured to use. If it fails, and it would fail in Whonix 0.5.6, Tor Button would look like disabled and show a failure message.

In future, Tor Button will likely also use something like [https://trac.torproject.org/projects/tor/ticket/3652 "GETINFO clockskew"]. TBB developer [https://trac.torproject.org/projects/tor/ticket/8032 rejected] the idea of not adding the statement "require no access to Tor's control port" to TBB's design.

Therefore all requirements, Whonix-Workstation having no way of finding its own external IP address, joining Tor Browser's fingerprint for Whonix users, having no access for Whonix-Workstation to Tor's control port with Tor Buttons new requirement to have access to Tor's control port contradicted itself.

Control Port Filter Proxy has been implemented as a solution. It gives Whonix-Workstation access to a limited selection of Tor's control port commands, using white listing (not blacklisting). For example, it allows "SIGNAL NEWNYM" to make Tor Buttons New Identity feature available for users who use Tor Browser in Whonix-Workstation.

Tor Button would get confused by the many SocksPorts Whonix-Gateway has open (for stream isolation) due to bug [https://trac.torproject.org/projects/tor/ticket/9224 TorButton about:tor fails when using additional socks listeners]. Therefore when Control Port Filter Proxy gets asked 'GETINFO net/listeners/socks', it lies, and answers '250-net/listeners/socks="127.0.0.1:9150"'. This makes Tor Button happy and therefore it shows a "Congratulations!" (success) welcome page on its default homepage about:tor and not the failure page, which would confuse users.

For eventual further Tor control port access requirements by Tor Button, the configuration file of accepted commands has to be extended. If Tor Button would ever ask for anything which violates Whonix's design (Whonix-Workstation has no way of finding out its own external IP address in particular), such as "GETINFO address", for example if Tor Button wanted to ensure, that the user isn't using its own external IP address, a new lie would have to be added to the Control Port Filter Proxy script. In case many more lies are required, lies should go into the config file as well, for now, hard coding is sufficient.

Forum discussion, [[Special:AWCforum/st/id201|Disable Tor Control Port Proxy by default]].

== Whonix-Workstation ==
Tor Browser points to Tor control port 127.0.0.1:9151 by default (no changes by Whonix).

Whonix sets appropriate environment variables in /etc/profile.d/ for control port (9151), control port ip (127.0.0.1) and control port password "password". The latter is not really in use, its just to make Tor Button happy, because it doesn't default to some password. Tor Button sends it, but its ignored by Control Port Filter Proxy.

rinetd redirects 127.0.0.1:9151 to Whonix-Gateway 192.168.0.10:9052.

== Whonix-Gateway ==
Control Port Filter proxy listens on 127.0.0.1 port 9052, filters (white list) incoming control port messages and forwards them to the real Tor Control Port listening in 127.0.0.1:9051. Control Port Filter Proxy itself uses cookies authentication to authenticate Tor's control port. The latter is not important, since Whonix-Gateway's only purpose is running Tor, its not a multi user operating system, and if it were compromised, cookie authentication wouldn't be of help anymore either.

== Attack Surface ==
* tcpserver (ucspi-tcp debian package) (The server handling connections.)
* /bin/bash (The script interpreter.)
* controlportfilt and cpf-tcpserver (The scripts.)

== Attack Scenarios ==
Once Whonix-Workstation has been compromised, the adversary could continuously and/or using a pattern, send white listed commands to Tor. At the moment, only NEWNYM would be of interest. When the adversary is also an ISP level adversary, the adversary might be able to see the pattern being produced. This however isn't a big risk, since once Whonix-Workstation is compromised, more powerful attacks are available - An adversary could also use "Morse Code", i.e. limit the victims traffic for a few seconds to zero or close to zero, then push the traffic to its maximum. 

More worrying is the extended attack surface. See "Attack Surface" above. I am not aware of anyone having audited tcpserver or /bin/bash for vulnerabilities. Please add this information if you know more.

== Files ==
* https://github.com/Whonix/Whonix/blob/master/whonix_gateway/usr/bin/controlportfilt
* https://github.com/Whonix/Whonix/blob/master/whonix_gateway/usr/lib/whonix/cpf-tcpserver
* https://github.com/Whonix/Whonix/blob/master/whonix_gateway/etc/controlportfilt.d/30_controlportfilt_default
* https://github.com/Whonix/Whonix/blob/master/whonix_gateway/etc/init.d/controlportfiltd

== Debugging Inspiration ==
<pre>
sudo cp whonix_gateway/etc/init.d/controlportfiltd /etc/init.d/
sudo cp whonix_gateway/usr/bin/controlportfilt /usr/bin/
sudo cp whonix_gateway/usr/lib/whonix/cpf-tcpserver /usr/lib/whonix/
sudo cp whonix_workstation/etc/profile.d/20_controlportfilt.sh /etc/profile.d/
sudo cp whonix_shared/usr/bin/tor-ctrl /usr/bin/
sudo cp whonix_gateway/etc/controlportfilt.d/30_controlportfilt_defaul /etc/controlportfilt.d/

sudo service controlportfiltd restart

tail -f /var/log/controlportfilt.log
</pre>

To get a list of Control Port commands, Tor Button uses:
get into Tor Button source code

<pre>
grep -r torbutton_send_ctrl_cmd *
</pre>

= See Also =
* [https://labs.riseup.net/code/issues/6384 Tails' ticket: Filtering proxy for the Tor control port]

{{Footer}}

[[Category:Design]]
