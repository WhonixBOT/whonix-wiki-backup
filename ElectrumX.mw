{{Title|
title=How-to: Use ElectrumX Personal Server in {{project_name}}
}}
{{Header}}
{{#seo:
|description=Own Bitcoin Server for Higher Privacy
}}

{{stub}}

= Installation =
== Dependency Installation ==
'''Note:''' The following instructions should be applied in {{workstation_product_name}} ([[{{q project name short}}|{{q project name}}]]: In Template <code>{{whonix-ws}}</code>).

'''1.''' Install the [[PyLRU|Install PyLRU]]. <ref>
Not available from packages.debian.org at time of writing.

https:/packages.debian.org/pylru
</ref>

'''2.''' Install [[Bitcoin Core]].

'''3.''' Install dependencies from the Debian repository. <ref>
Installation of the [[electrum]] Bitcoin Wallet is optional. In advanced setups, the electrum wallet might be running on a different server or in a different VM.
</ref>

{{Install Package|
package=git python3-rocksdb python3-aiohttp python3-plyvel electrum
}}

== electrum Safeguard ==
'''Note:''' The following instructions should be applied in {{workstation_product_name}} ([[{{q project name short}}|{{q project name}}]]: In Template <code>{{whonix-ws}}</code>).

Optional but highly recommended.

Make sure the electrum default start menu entry (which would result in using electrum public servers) gets deleted and stays deleted even after electrum package upgrades to make sure to not accidentally start the electrum using its default start menu entry.

{{CodeSelect|code=
sudo dpkg-divert --local --divert /usr/share/applications/electrum.desktop --rename --add /usr/share/electrum-invalid
}}

== Source Code Download and Digital Software Signature Verification ==
{{Box|text=
'''Note:''' The following instructions should be applied in {{workstation_product_name}} ([[{{q project name short}}|{{q project name}}]]: App Qube <code>anon-whonix</code>).

'''1.''' {{Open_a _product_ws_terminal}}

'''2.''' Acquire the OpenPGP public key of ElectrumX developer SomberNight. <ref>
* https://github.com/spesmilo/electrum/tree/master/pubkeys
* https://github.com/spesmilo/electrum/blob/master/SECURITY.md
</ref>

{{gpg key
|url=scurl-download https://raw.githubusercontent.com/spesmilo/electrum/master/pubkeys/sombernight.asc
|source_filename=sombernight.asc
|fingerprint=6D7A2116DA909E00AC21108BB33B5F232C6271E9
|gpg_fingerprint_output=
In late-2021, the output is identical to the following.

      Key fingerprint = 4AD6 4339 DFA0 5E20 B3F6  AD51 E7B7 48CD AF5E 5ED9
}}

'''3.''' Download the ElectrumX Server source code using <code>git</code>.

{{CodeSelect|code=
git clone https://github.com/spesmilo/electrumx.git
}}

'''4.''' Change directory.

{{CodeSelect|code=
cd electrumx
}}

'''5.''' Digital signature verification.

<u>Note:</u> At the time of writing, <code>1.16.0</code> was the latest stable release. Before starting the ElectrumX source code download, browse to [https://github.com/spesmilo/electrumx/tags <code>github.com/spesmilo/electrumx/tags</code>] to verify the version number.

{{CodeSelect|code=
git tag --verify 1.16.0
}}

{{GnuPG-Success}}

{{GnuPG-Warning}} 

'''6.''' Checkout the git tag.

{{CodeSelect|code=
git checkout 1.16.0
}}
}}

= Configuration =
== Bitcoin-Qt Configuration ==
'''Note:''' The following instructions should be applied in {{workstation_product_name}} ([[{{q project name short}}|{{q project name}}]]: App Qube <code>anon-whonix</code>).

'''1.''' Create folder <code>~/.bitcoin</code>.

{{CodeSelect|code=
mkdir -p ~/.bitcoin
}}

'''2.''' {{Open File|
filename=~/.bitcoin/bitcoin.conf
}}

'''x.''' Paste the following text. <ref>
* <code>prune=0</code> is the default for bitcoind but the Bitcon-Qt GUI has a first start wizard which asks if pruning should be enabled. To avoid that first start wizard and to make sure pruning is disabled, explicitly disable pruning in configuration file.
* Quote electrumx documentation: <blockquote>You must be running a non-pruning bitcoin daemon with <code>txindex=1</code></blockquote>
</ref>

{{CodeSelect|code=
server=1
bind=127.0.0.1
rpcbind=127.0.0.1
rpcallowip=127.0.0.1
txindex=1
prune=0
rpcuser=username
rpcpassword=password
}}

'''3.''' Save.

'''4.''' Disable pruning in Bitcoin-Qt.

<code>Bitcoin Core</code> -> <code>Settings</code> -> <code>Options</code> -> <u>un</u>select <code>Prune block storage to</code> <ref>
Optional since bitcoin-qt options menu says that configuration file overrides bitcoin-qt GUI settings anyhow but better just in case to avoid any potential bugs.
</ref>

'''5.''' Terminate Bitcoin-Qt.

Close terminate Bitcoin-Qt. This is required for the following next step which requires that Bitcoin-Qt is not running.

'''6.''' Reindex the blockchain.

Start Bitcon-Qt from the command line with the <code>-reindex</code> parameter. This is because:

Quote electrumx documentation: <blockquote>If you have an existing installation of bitcoind and have not previously set this you will need to reindex the blockchain with: <code>-reindex</code></blockquote>

This step can be skipped if the user did not previously run Bitcoin Core in pruning mode.

{{CodeSelect|code=
~/bitcoin-*/bin/bitcoin-qt -reindex
}}

When Bitcoin-Qt is started next time, there is no more need for <code>-reindex</code> and it probably should not be used since it takes more time.

'''7.''' Wait for the blockchain to be synchronized.

'''8.''' Optional: [[Bitcoin_Core#Add_a_bitcoin-qt_Start_Menu_Entry|Add Bitcoin-Qt start menu entry]].

'''9.''' Optional: [[Bitcoin_Core#Autostart_bitcoin-qt|Autostart bitcoin-qt]].

Autostarting Bitcon-Qt after reboot might be desirable so it can catch up downloading the blockchain as well as to serve electrumx.

== electrumx Configuration ==

'''1.''' {{Open File|
filename=~/electrumx.conf
}}

'''2.''' Paste the following contents.

{{CodeSelect|code=
COIN=Bitcoin
DB_DIRECTORY=/home/user/.electrumx
DAEMON_URL=username:password@127.0.0.1
SERVICES=tcp://127.0.0.1:50001
PEER_DISCOVERY=self
}}

'''3.''' Save.

== electrumx User Systemd Unit Configuration ==

'''1.''' Create folder <code>~/.config/systemd/user</code>.

{{CodeSelect|code=
mkdir -p ~/.config/systemd/user
}}

'''2.''' {{Open File|
filename=~/.config/systemd/user/electrumx.service
}}

<ref>
Based on <code>~/electrumx/contrib/systemd/electrumx.service</code>
</ref>

'''3.''' Paste the following contents.

{{CodeSelect|code=
[Unit]
Description=Electrumx
After=network.target

[Service]
EnvironmentFile=/home/user/electrumx.conf
ExecStart=/home/user/electrumx/electrumx_server
LimitNOFILE=8192
TimeoutStopSec=30min

[Install]
WantedBy=multi-user.target
}}

'''4.''' Save.

'''5.''' Reload systemd user instance.

{{CodeSelect|code=
systemctl --user daemon-reload
}}

'''6.''' Optional: Enable autostart for the electrumx systemd user instance.

{{CodeSelect|code=
systemctl --user enable electrumx
}}

'''7.''' Start electrumx systemd user instance.

{{CodeSelect|code=
systemctl --user restart electrumx
}}

== Add a electrum Start Menu Entry ==

Creating a <code>electrum</code> start menu entry which only connects to ElectrumX.

This step is optional.

{{Box|text=
Inside {{Workstation product name}} ({{Q project name}}: App Qube).

'''1.''' Create folder <code>~/.local/share/applications</code>.

{{CodeSelect|code=
mkdir -p ~/.local/share/applications
}}

'''2.''' {{CodeSelect|code=
mousepad ~/.local/share/applications/electrum-with-electrumx.desktop
}}

'''3.''' Paste the following contents.

{{CodeSelect|code=
[Desktop Entry]
Name=Electrum with ElectrumX
Comment=electrum-with-electrumx
Exec=electrum --oneserver --server localhost:50001:t
Terminal=false
Type=Application
Icon=money-manager-ex
StartupWMClass=bitcoin
MimeType=x-scheme-handler/bitcoin;
Categories=Finance;
}}

'''4.''' Save.

'''5.''' {{Q project name}}: perform platform-specific steps.

In <code>dom0</code>, refresh Qubes' appmenu: <code>VM settings</code> &rarr; <code>Applications</code> &rarr; <code>Refresh Applications</code> &rarr; <code>Add desktop shortcut</code>.

'''6.''' Done.

The <code>Electrum with ElectrumX</code> start menu entry available should be available.
}}

= Usage =
'''1.''' Start Bitcoin-Qt using any method (from start menu entry, autostart or manually from the command line).

{{CodeSelect|code=
~/bitcoin-*/bin/bitcoin-qt
}}

'''2.''' Check the the blockchain download in Bitcoin-Qt is functional.

'''3.''' Run the electrumx server using any method (autostart, or manually form the command line).

{{CodeSelect|code=
systemctl --user restart electrumx
}}

'''4.''' Check that electrumx blockchain processing is functional.

See [[#Monitoring|monitoring]].

'''5.''' Start the [[electrum]] Bitcoin wallet using any method (autostart, or manually form the command line).

{{CodeSelect|code=
electrum --oneserver --server localhost:50001:t
}}

= Monitoring =
Check the status of the electrumx systemd user service.

{{CodeSelect|code=
systemctl --user status electrumx
}}

Follow the log of the electrumx systemd user service.

{{CodeSelect|code=
journalctl --user -f -u electrumx
}}

If all is going well, it should be showing output similar to the following.

<pre>
electrumx_server[7426]: INFO:Prefetcher:new block height 144,270 hash 00000000000002606168ac016368896d79c591bff2b6580db2e398faef7ec093
</pre>

= See Also =
* [[Bitcoin]]
* [[electrum]]
* [[PyLRU]] (Dependency of ElectrumX.)
* [https://github.com/spesmilo/electrumx ElectrumX Source Code Repository]
* [https://electrumx-spesmilo.readthedocs.io ElectrumX Upstream Documentation]
* https://electrumx-spesmilo.readthedocs.io/en/latest/environment.html#services

TODO: remove noindex once this wiki page is good enough
__NOINDEX__

= Donations =
After installing the electrumx server, please consider making a [[Donate|donation]] to {{project name}} to help keep it running for many years to come.

{{Pay Bitcoin Specific}}

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
