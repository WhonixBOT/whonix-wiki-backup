{{Title|
title=HowTo: Install the Testers-Only Version of Qubes-Whonix
}}
{{Header}}
{{#seo:
|description=HowTo: Install the Testers-Only Version of Qubes-Whonix
|image=https://www.whonix.org/w/images/5/55/Qubes-logo-icon.png
}}
__NOTOC__
== Introduction ==

{{Testing}}

<u>'''To install the stable version of [[Qubes-Whonix]], see [[Qubes/Install|HowTo: Install the Stable Version of Qubes-Whonix]].'''</u>

=== First time user? ===
<br />
{{First_Time_User}}

=== Installation ===
These instructions apply to Qubes R3.2 and above.

== Remove Old Versions ==

Users who are already running any version of Qubes-Whonix must [[Qubes/Uninstall|uninstall it]] before performing a complete (re-)installation. This applies to:

* Users who selected Qubes-Whonix auto-configuration when Qubes was installed.
* Users who installed Qubes-Whonix after installing the Qubes platform.

Before re-installation, back up any existing data stored in Whonix VMs. This is unnecessary if users choose to [[Upgrading Whonix 13 to Whonix 14|upgrade Whonix 13 to 14]] instead of following these instructions.

== Update dom0 ==
=== All Qubes Versions ===
{{Qubes_upgrade_dom0}}

== Configure salt using Qubes dom0 Community Testing Repository ==
Testers only.

The following command will configure Qubes dom0 salt to use Qubes' community-testing-repository for downloading Whonix.  <ref>
* [https://github.com/QubesOS/updates-status/issues/623 qubes-mgmt-salt-dom0-virtual-machines v4.0.13 (r4.0)]
* [https://github.com/QubesOS/qubes-mgmt-salt-dom0-virtual-machines/pull/15 Qubes-Whonix salt - allow choice of repository / don't hardcode repository]
* [https://github.com/QubesOS/qubes-mgmt-salt-dom0-virtual-machines/pull/15  whonix: Add pillar file for easily enabling templates testing repository]
</ref>

{{CodeSelect|code=
sudo qubesctl top.enable qvm.whonix-testing pillar=true
}}

== Community Templates Testing Repository ==
Testers only.

View the [https://github.com/QubesOS/qubes-installer-qubes-os/blob/master/qubes-release/qubes-templates.repo <code>/etc/yum.repos.d/qubes-templates.repo</code>] file.

{{CodeSelect|code=
cat /etc/yum.repos.d/qubes-templates.repo
}}

Ensure the file contains <code>[qubes-templates-community-testing]</code>. The following text should be included.

<pre>
[qubes-templates-community-testing]
name = Qubes Community Templates repository
#baseurl = https://yum.qubes-os.org/r$releasever/templates-community-testing
metalink = https://yum.qubes-os.org/r$releasever/templates-community-testing/repodata/repomd.xml.metalink
enabled = 0
fastestmirror = 1
gpgcheck = 1
gpgkey = file:///etc/pki/rpm-gpg/RPM-GPG-KEY-qubes-$releasever-templates-community
</pre>

If the <code>[qubes-templates-community-testing]</code> section is missing, then the user has probably already modified the file. In this case <code>dnf</code> <ref>Which is invoked by <code>qubes-dom0-update</code>.</ref> preserves user changes by saving updates to <code>/etc/yum.repos.d/qubes-templates.repo.rpmnew</code> <ref>Note the file extension <code>.repo.rpmnew</code>.</ref> instead of overwriting the file. Since the <code>.repo.rpmnew</code> file is ignored by <code>qubes-dom0-update</code>, users must manually update the <code>.repo</code> file.

Either:

* Manually add the changes from <code>.repo.rpmnew</code> to the <code>.repo</code> file; or
* Overwrite the <code>.repo</code> file with the <code>.repo.rpmnew</code> file:
** {{CodeSelect|code=
sudo cp /etc/yum.repos.d/qubes-templates.repo.rpmnew /etc/yum.repos.d/qubes-templates.repo
}}
** And then manually add back necessary changes. If the command fails because <code>/etc/yum.repos.d/qubes-templates.repo.rpmnew</code> does not exist, then the user probably has <code>[qubes-templates-community-testing]</code> already.

== Download Whonix Templates and Configure sys-whonix and anon-whonix ==

The recommended approach is to use <code>salt</code> (wrapped by the command <code>qubesctl</code> in Qubes), as this <u>one</u> call automatically: <ref>[[Dev/Qubes#salt]]</ref>

* Downloads both Whonix-Gateway and Whonix-Workstation TemplateVMs.
* Configures <code>sys-whonix</code> and <code>anon-whonix</code> safely. <ref>https://github.com/QubesOS/qubes-mgmt-salt-dom0-virtual-machines/blob/master/qvm/anon-whonix.sls</ref>

In dom0, run:

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text       = Before you execute the call, keep in mind that it can take a long time to execute (at least several minutes; some users reported more than 20 mins). No progress indicator is shown. Do not interrupt the salt process once it has started, or this can lead to an [https://groups.google.com/forum/?_escaped_fragment_=topic/qubes-users/fwCqxENXguY#!topic/qubes-users/fwCqxENXguY unstable system]. The process is lengthy, particularly over Tor. <ref>
[https://github.com/QubesOS/qubes-issues/issues/4215 add salt download progress indicator]
</ref>
}}

{{CodeSelect|code=
sudo qubesctl state.sls qvm.anon-whonix
}}

For troubleshooting please see footnotes: <ref>
If an error message appears stating that qubesctl does not exist or the command is not recognized, then it is necessary to enable the testing repository and install <code>salt</code>.

{{CodeSelect|code=
sudo qubes-dom0-update --best --allowerasing --enablerepo=qubes-dom0-current-testing qubes-mgmt-salt-dom0-virtual-machines
}}

Please report if this was necessary for you!
</ref> <ref>
Sometimes the Qubes Community Templates repository must also be enabled by editing <code>/etc/yum.repos.d/qubes-templates.repo</code> and setting <code>enabled = 1</code> in the <code>[qubes-templates-community]</code> section.

Please report if this was necessary for you!
</ref> <ref>
If qubesctl still does not work, try shutting down Qubes OS and rebooting the machine.

Please report if this was necessary for you!
</ref>

== Qubes R4 Only: Optional Whonix DVM Template VM ==

In Qubes R4 and above, users can choose to set up a <code>{{whonix-ws}}-dvm</code> DVM Template as a base for [[Qubes/Disposable_VM|Disposable VMs]]. <ref>https://github.com/QubesOS/qubes-mgmt-salt-dom0-virtual-machines/blob/master/qvm/{{whonix-ws}}-dvm.sls
</ref>

In dom0, run.

{{CodeSelect|code=
sudo qubesctl state.sls qvm.{{whonix-ws}}-dvm
}}

== Optional: Updates over Tor ==

=== TemplateVMs ===

To force all TemplateVM updates over Tor: <ref>https://github.com/QubesOS/qubes-mgmt-salt-dom0-virtual-machines/blob/master/qvm/updates-via-whonix.sls
</ref>

* '''R3.2:''' For each template, manually open VM settings and set NetVM to <code>sys-whonix</code>.
* '''R4:''' Use salt in dom0:
** {{CodeSelect|code=
sudo qubesctl state.sls qvm.updates-via-whonix
}}

In Qubes R4, this setting can be undone by modifying ''/etc/qubes-rpc/policy/qubes.UpdatesProxy'' <ref>https://groups.google.com/forum/?_escaped_fragment_=topic/qubes-users/_jI2uWPPMMA#!topic/qubes-users/_jI2uWPPMMA</ref>

=== dom0 ===

To force dom0 updates over Tor, set Qubes dom0 UpdateVM to <code>sys-whonix</code>.

{{CodeSelect|code=
qubes-prefs updatevm sys-whonix
}}

To revert this change, run.

{{CodeSelect|code=
qubes-prefs updatevm sys-firewall
}}

== Optional: Enable AppArmor ==
{{Qubes_AppArmor}}

== Update and Launch Applications ==
 
Before starting applications in the Whonix-Workstation AppVM, [[Qubes/Update|update both Whonix-Gateway and Whonix-Workstation TemplateVMs]]. 

To launch an application like [[Tor Browser|Tor Browser]]:

<code>Qubes App Launcher (blue/grey "Q")</code> -> <code>{{Code2|Domain: anon-whonix}}</code> -> <code>Tor Browser (AnonDist)</code>

To learn about known bugs affecting this release, see [[Known_Issues#Qubes-Whonix|here]].

== Additional Information ==  
<div class="toccolours mw-collapsible mw-collapsed">
If you are interested, click on Expand on the right.
<div class="mw-collapsible-content">
* {{Post Install Advice}}
* [[#Stay tuned|Stay tuned]]!

== Known Bugs ==
{{Known_bugs}}

==  Stay Tuned ==
{{Stay_tuned}}
</div>
</div>
{{reflist|close=1}}
{{Template:Qubes}}
{{Footer}}
[[Category:Documentation]]
