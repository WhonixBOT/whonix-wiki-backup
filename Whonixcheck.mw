{{Header}}
{{#seo:
|description=Whonix Security Check Application. Sanity Test. Leak Test. Update Check.
}}

[[Image:whonixcheck_gui.png|thumb|whonixcheck done]]

[[Image:whonixcheck_progress.png|thumb|whonixcheck in progress]]

[[Image:whonixcheck_cli.png|thumb|whonixcheck in Konsole]]

[[Image:writing to tty1 by adrelanos.png|thumb|

[[Desktop#whonixcheck.2Ftimesync_writing_to_tty1|Automatically started whonixcheck writing to tty1.]]]]
= Introduction =
{{Code2|whonixcheck}} is a bash script, checking many important things. Supports to be run in console and also has a grapical progress meter and graphical info popup for the results. It's stored in {{Code|/usr/bin/whonixcheck}} and in {{Code|/usr/lib/whonix/whonixcheck/}}. Whonix will also work without that script. It's only checks things, it doesn't change things. Nothing is compiled, it's just a script and anyone can read the source code.

The whonixcheck script was inspired by https://check.torproject.org. In past when people were still recommended to use proxy settings to torify web browsers, it was an important check. While manual torification of web browsers is nowadays recommended against, the Tor Browser Bundle, which is securely pre-configured, still visits check.tpo and checks if everything is okay. Check.tpo also checks if the Tor Browser Bundle version is up to date (technically Tor Button downloads version information and checks locally).

While check.tpo just checks the browser, Whonix is more than a browser. It's a complete operating system. Therefore when the browser starts, it's already too late. It has to be checked earlier, because the user might not start the browser. That's why whonixcheck will be automatically started after boot/login (if it hasn't been recently run, i.e. if whonxicheck has been completed within 24 hours earlier).

whonixcheck will run once every day, even if the system is not restarted. The motivation behind that is also to inform long running systems.

Some users wish to hide the fact from their ISP, they they are using Tor and Whonix. See [[Hide Tor and Whonix from your ISP]] article. While only a fraction of users goes through the procedures to hide Tor, it is still desirable to hide the fact they're using Whonix. We're better of if adversaries can't distinguish between lets say TBB and Whonix users. When whonixcheck is automatically started, it waits a randomized amount of time (between 60 and 500 seconds). Although it would be Tor's job to prevent any kinds of conclusions from the amount of traffic and the traffic pattern, this feature is supposed to aid to obfuscation of that kind of traffic analysis. Starting Tor and instantly having a lot of traffic (from whonixcheck) might be easier to distinguish than waiting a randomized amount of time until that kind of traffic flows.

= Checks =
* If run either on bare metal ([[Physical Isolation]]) or inside VirtualBox. Warns when using an unsupported (by Whonix developers) virtualizer. Reports only if not. Otherwise quiet unless using --verbose.
* Checks if the clock source is KVMClock and warns if that is the case. Might probably only happen for users using the [[KVM]] instructions. Reports only if KVMClock is detected. Otherwise quiet unless using --verbose.
* Checks that whonixsetup is done. Reports only if not. Otherwise quiet unless using --verbose.
* Checks that Tor is enabled. Reports only if not. Otherwise quiet unless using --verbose.
* Check the validity of Tor's config files by using {{Code|sudo tor --verify-config}}. Whonix-Gateway only. Reports only error. Otherwise quiet unless using --verbose.
* Check if a package manager is currently running. Waits as long as a package manager is running until it continues. It waits, because the Tor package or [[Dev/CPFP]] is currently upgraded, connection checks would fail. Otherwise quiet unless using --verbose.
* Checks, that Tor has been enabled (i.e., that {{Code|DisableNetwork 1}}) has been commented out from /etc/tor/torrc (by whonixsetup or manually). Reports only if not. Otherwise quiet unless using --verbose.
* Check if the Tor process (pid) is running. Only on Whonix-Gateway. Reports error if not. Otherwise quiet unless using --verbose.
* Whonix 9 and above: Checks if IP forwarding is disabled on gateway.
* Whonix 9 and above, when using --verbose: Checks if {{Code|~/.whonix/msgdispatcher-error.log}} or {{Code|~/.whonix/whonix_torbrowser_updater_error.log}} exist and reports, if so.
* Whonix 9 and above: Checks if [[Dev/CPFP|Control Port Filter Proxy]] is running.
* Tor connection / IP
** Tor Bootstrap Status
** downloads https://check.torproject.org with curl through extra SocksPort
** downloads https://check.torproject.org with curl through TransPort
** The Whonix design ensures, that never the users real IP can be detected. Why check it anyway? Sometimes check.tpo reports false positives and fails to detect Tor exit nodes. The user should be informed about that possibility. That reduces support requests and bad press. It's fine to investigate if the Tor exit node could not be detected, but we're quite confident, that the outcome will be, that it's a Tor exit node IP. Some users may do dangerous and/or unsupported things, such as changing Whonix-Workstation's network interface from {{Code|internal}} network {{Code|"Whonix"}} to {{Code|bridged}} or {{Code|NAT}} or other creative and adventurous things, such as using virtualizers which are entirely unsupported and untested by Whonix developers. Last but not least, users can and are encouraged to install upgrades using {{Code|apt-get}} and free to install arbitrary packages on Whonix-Workstation. In a totally unexpected case, that may open up for a leak and whonixcheck is Whonix's last layer of defenses against such leaks.
* Tor Browser version
** downloads https://check.torproject.org/RecommendedTBBVersions with curl through extra SocksPort
* operating system updates
** Run ''apt-get update'' through apt-get SocksPort and inform about the system being up to date or requiring updates.
* [[Download#Whonix_Version_Check_and_Whonix_News|Whonix version and Whonix news]]
** Supposed to work even if Whonix repository is down / changed.
** Supposed to work also for users who do not wish to use [[Whonix-APT-Repository]] (at all times).
** Not yet implemented: to [[Dev/ptt|defeat a permanent takedown threat]].
** Downloads Whonix News Files with curl through extra whonix news SocksPort.
** Is supposed to reflect most important news for people not even following Whonix Important Blog. In theory, if an IP leak in Whonix where found or exit nodes actively exploiting apt-get traffic, this would be used to briefly inform users about the danger.
** [[Dev/News|Whonix News Format]]
** Whonix version and news file must be signed by Whonix developer Patrick.
** Patrick's gpg key got copied to {{Code2|whonix_shared/usr/share/whonix/keys/whonix-keys.d/}} at build time.
** Warns if the file can not be gpg verified with Patrick's gpg key. In that case version and news is ignored.
** Messages signed more than one month ago are rejected and the user is informed about the message being no longer valid.
** Also see [[Trust]].
* Whonix 9 and above: Hostname
** Checks, if {{Code|hostname --fqdn}} outputs {{Code|host.localdomain}}.
** Checks, if {{Code|hostname }} outputs {{Code|host}}.
** Checks, if {{Code|hostname --ip-address }} outputs {{Code|127.0.0.1}}.
** Checks, if {{Code|hostname --domain }} outputs {{Code|localdomain}}.
* Informs if [[Whonix-APT-Repository]] is enabled and if yes, which one is enabled.

= Security =
The ''ca-certificates'' Debian package is installed on Whonix. Curl will verify the SSL certificate for downloads from check.tpo (SocksPort Test, TransPort Test, Tor Browser version check) and aborts if the certificate is not valid.

Attack surface for this script includes at least curl, apt-get, gpg, grep, sed, bash, uwt, torsocks, zenity, pgrep. Patrick believes, that benefits outweigh the risks not running those checks. The user is free to ''sudo chmod -x /usr/bin/whonixcheck'' and Patrick remains as always open for reviews and suggestions.

Also see [[SSL]].

== SSL Certificate Pinning ==
=== Introduction ===
In whonixcheck 1.1-1 / Whonix 10 and above there will be an optional torproject.org certificate pinning option for SocksPort Test, TransPort Test and Tor Browser Update Check. If you want to use this, see below.

=== How ===
In Whonix-Gateway and Whonix-Workstation.

To enable this on a by case base, use the --pin-tpo-cert command line option. Example.

<pre>
whonixcheck --pin-tpo-cert
</pre>

Or to permanently enable this.

Create a file {{Code2|/etc/whonix.d/50_user}}.

<pre>
sudo nano /etc/whonix.d/50_user
</pre>

Add.

<pre>
PIN_TPO_CERT="true"
</pre>

=== Default ===
Reasons for not enabling this feature by default:
* The feature is experimental.
* Implementation.
** torbrowser-launcher is not installable from Debian stable at time of writing. TODO: expand
** Whonix is still installing [https://github.com/Whonix/tb-updater tb-updater] rather than [https://github.com/micahflee/torbrowser-launcher/ torbrowser-launcher] by default because, see [https://github.com/Whonix/Whonix/issues/346#issuecomment-57012249 ticket]. So the certificate file {{Code2|/usr/share/torbrowser-launcher/torproject.pem}} is not installed by default.
** We would also have to install torbrowser-launcher on Whonix-Gateway, so the certificate file {{Code2|/usr/share/torbrowser-launcher/torproject.pem}} gets installed by default. But since by Whonix design, users must not use Tor Browser in Whonix-Gateway, we would have to hide (config-package-dev displace) torbrowser-launcher's start menu entries as well as build a wrapper around  its binaries to warn against this. This is doable, but no one has implemented that yet.
* Maintenance burden.
** [https://trac.torproject.org/projects/tor/ticket/5789 The Tor Project (TPO) refused to maintain an OpenPGP signed certificate]. (They are excused: maintenance burden. TODO: expand)
** Relying on [https://github.com/micahflee/torbrowser-launcher/ torbrowser-launcher] to maintain The Tor Project's SSL certificate file {{Code2|/usr/share/torbrowser-launcher/torproject.pem}}.
*** One time the maintainer of torbrowser-launcher was busy and needed ~1 month to upgrade TPO's SSL certificate file. ([https://github.com/micahflee/torbrowser-launcher/issues/84 reference]) He is excused, because he is a volunteer maintaining the software, under no obligations, probably earning no money with torbrowser-launcher, having other obligations. This is Libre Software. Thank you for torbrowser-launcher!
*** The plan of the maintainer of torbrowser-launcher is to wait until the certificate breaks before upgrading it. This is already the best the maintainer can do in the absence of better support from TPO for this use case. No blame here. Everyone is excused here, also TPO, since maintaining this adds up to the maintenance burden. ([https://github.com/micahflee/torbrowser-launcher/issues/45 reference])
*** See also [https://github.com/micahflee/torbrowser-launcher/issues?q=pin torbrowser-launcher issues search "pin"] for eventual further issues with pinning.

TODO: expand

= Debugging =
If you think whonixcheck is stuck, it most likely isn't. Just {{Code2|apt-get update}} sometimes needs a very long time. In any case, you can check it's latest status messages here.

<pre>
cat /var/lib/whonix/whonixcheck/whonixcheck_message_x
</pre>

= Footnotes =
<references/>

{{Footer}}

[[Category:Documentation]] [[Category:Design]]
