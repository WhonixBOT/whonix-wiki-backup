{{Header}}
{{#seo:
|description=Development Notes for adding KVM support to Whonix.
}}

= Links =
* [[Special:AWCforum/st/id306/]]
* [[KVM|KVM instructions work in progress]]
* [https://github.com/Whonix/Whonix/issues/121 KVM Support github ticket]

= Blockers =
== How to disable KVMClock? ==
How to adjust KVM to have clock=vm on host.

See http://www.linux-kvm.org/page/KVMClock

http://libvirt.org/formatdomain.html#elementsTime

https://www.redhat.com/archives/libvir-list/2010-March/msg01293.html

https://doc.opensuse.org/products/draft/SLES/SLES-kvm_sd_draft/cha.qemu.running.html#cha.qemu.running.gen_opts.rtc

ls /sys/devices/system/clocksource/clocksource0/current_clocksource

To ensure that you have successfully isolated the vm clock form the host's you must run this in the vm:

sudo chmod -x /etc/init.d/sdwdate

You should verify then that no time changes on the host affect the vm.

== Instructions include how to set clock to UTC? ==
How to use -rtc clock=vm ?

== Weaker warning against KVM in whonixcheck ==
As soon as all blockers have been sorted out. We could recommend using [[KVM]] instructions.

== qcow2 compression ==
There is a minor issue with the new extra qcow2 images, which are now preallocated. Upload would take ~250 hours per image. Looks like they're not [https://en.wikipedia.org/wiki/Sparse_file sparse files] anymore. I'll manually compress and upload them. No need for a new tag, no need to delay the release further.

= Non-Blockers =
== SPICE security implications ==
http://lists.freedesktop.org/archives/spice-devel/2013-December/015810.html

http://lists.freedesktop.org/archives/spice-devel/2014-January/015815.html

== Enable virtio by default? ==
Probably yes?

https://wiki.debian.org/DebianKVMGuests

== Do KVM instructions need changes to activate virtio? ==
Do [[KVM]] instructions need changes to activate virtio?

== How to get virtio running for storage? ==
http://wiki.libvirt.org/page/Virtio

== Boot from virtio block device? ==
What is http://www.linux-kvm.org/page/Boot_from_virtio_block_device good for? Required?

== How to check if virtio storage access is in use or an eventually existing fallback driver? ==
How to check if virtio storage access is in use or an eventually existing fallback driver?

== How to check if virtio network is really in use or an eventually existing fallback driver? ==
/sys/devices/virtio-pci/0/net/eth0/statistics/rx_bytes seems not to exist on Debian Wheezy.

== How to enable AppArmor / SELinux for KVM on Debian? ==

Details on how to install, configure and enable SELinux enforcing mode:
https://wiki.debian.org/SELinux/Setup#Steps_to_setup_SELinux <-- This is a start, but incomplete. When following these instructions it gets difficult at the "audit2why -al" step, because it shows a ton of policy violations which are non-trivial to fix without learning a lot about SELinux.

== How to add a random time offset? ==
Having a small random offset (similar to [[Advanced_Security_Guide#Network_Time_Synchronization]]) would be a good thing.

== Is it possible to add 64, 128 or even more MB to the virtual graphics card using the command line to boost graphics performance? ==

Yes. Can be realised by virsh command as per the steps in here:
http://serverfault.com/questions/346301/how-to-increase-video-memory-in-libvirt-kvm-gui

== Script/automate creation of VM description files? ==
So not following manual instructions is required anymore, but copy/paste some commands end up with the correct VM configuration.

== Script/automate creation and upload of raw images? ==
Because raw images have better performance than raw images? http://www.linux-kvm.org/page/Qcow2

True that performance is better, but I don't think it supports snapshots AFAIK.
For something that supports snapshots and has better performance than qcow2 there is QED. A format developed by IBM for the QEMU project recently, that promises just that.

== Set cluster_size 512 - 2MB for better performance? ==
HulaHoop1 wrote: The qcow2 defaults seem fine to me, however the one parameter of interest we should play with is image's : 'cluster_size' 512 - 2MB the larger the size the better performance but the size is bigger. I think we should try the largest and see if the image size stays reasonable.

adrelanos wrote:

When using (Whonix 7.7.8.0):
      qemu-img \
         convert \
            -p \
            -O qcow2 \
            -o preallocation=metadata \
            "$WHONIX_BINARY/$VMNAME.img" \
            "$WHONIX_BINARY/$VMNAME-$whonix_build_whonix_version_new.qcow2"

du -h --apparent-size file.img <br />
100 GB

du -h file.img <br />
2,5 GB

When using (Whonix 7.7.8.0):
      qemu-img \
         convert \
            -p \
            -O qcow2 \
            -o cluster_size=2M \
            -o preallocation=metadata \
            "$WHONIX_BINARY/$VMNAME.img" \
            "$WHONIX_BINARY/$VMNAME-$whonix_build_whonix_version_new.qcow2"

du -h --apparent-size file.img <br />
2,9 GB

du -h file.img <br />
2,9 GB

File size grew a bit. Not too much. We could use this.

It remains to be tested, if the images work well using these settings. (The apparent size should be shown as 100 GB, but is only 2,9 GB. Needs testing if 100 GB can be used after the image is in use.)

"qemu-img info file.img" however, shows 2,9 GB actual size and 100 GB virtual size.

git tag 7.8.0.1 and above will be using the "-o cluster_size=2M" option.

== KVM Instructions recommend to use a no cache policy? ==
As per [http://www.ilsistemista.net/index.php/virtualization/11-kvm-io-slowness-on-rhel-6.html?start=7 blog post] it is recommended to use a no cache policy. Do our KVM instructions need changes to incorporate this?

= Answered Questions =
== Leak Tests? ==
[[HulaHoop1]] sorted that out in [[Special:AWCforum/st/id306/]].

== Hardware serials? ==
[[HulaHoop1]] sorted that out in [[Special:AWCforum/st/id306/]].

== whonixcheck KVMClock ==
Whonixcheck should check if /sys/devices/system/clocksource/clocksource0/current_clocksource is kvm-clock and warn if it does.

Implemented: https://github.com/Whonix/Whonix/commit/2584c3bdcd9a98181c7535f963a615d257e0fefd

== Script/automate creation and upload of qcow2 images? ==
Done.

== Verifiable Builds for qcow2 images==
The https://github.com/Whonix/Whonix/blob/master/help-steps/analyze_image requires supports raw, vdi, vmdk, qcow and qcow2 images as well as .ova appliances.

== metadata preallocated images ==
For better performance. (As per [http://www.ilsistemista.net/index.php/virtualization/11-kvm-io-slowness-on-rhel-6.html blog post].) Done in 7.7.8.0.

= Footnotes =
<references />

{{Footer}}

[[Category:Documentation]]
