{{Header}}
{{#seo:
|description=Documentation for package security-misc.
}}

= Stable Features =
[https://github.com/Whonix/security-misc#enhances-misc-security-settings Described here].

= Testing Features =
== Restrict Hardware Information to Root ==
See [[Whonix-Workstation_Security_Hardening#Restrict_Hardware_Information_to_Root|Restrict Hardware Information to Root]].

https://forums.whonix.org/t/restrict-hardware-information-to-root-testers-wanted/8618

== SUID Disabler and Permission Hardener ==
=== Introduction ===
SUID Disabler and Permission Hardener aims to increase the security of the system by improving [[Dev/Strong_Linux_User_Account_Isolation|Strong Linux User Account Isolation]], reducing attack surface through disabling of SUID enabled binaries. Some SUID binaries have a history of privilege escalation security vulnerabilities.

[https://github.com/QubesOS/qubes-issues/issues/2695 Quote] security researcher Solar Designer:

<blockquote>Ideally, there should be no SUID binaries reachable from the user account, as otherwise significant extra attack surface inside the VM is exposed (dynamic linker, libc startup, portions of Linux kernel including ELF loader, etc.)</blockquote>

SUID Disabler and Permission Hardener configuration folders are <code>/etc/permission-hardening.d</code> and <code>/usr/local/etc/permission-hardening.d</code>.

* [https://github.com/Whonix/security-misc/blob/master/etc/permission-hardening.d/30_default.conf default config file]
* [https://github.com/Whonix/security-misc/blob/master/usr/lib/security-misc/permission-hardening <code>/usr/lib/security-misc/permission-hardening</code>].
* [https://github.com/Whonix/security-misc/blob/master/usr/lib/security-misc/permission-hardening-undo <code>/usr/lib/security-misc/permission-hardening-undo</code>].
* [https://github.com/Whonix/security-misc/blob/master/lib/systemd/system/permission-hardening.service systemd unit file]

=== Enable SUID Disabler and Permission Hardener ===
==== Temporary Until Package Re-Installation ====
As long as SUID Disabler and Permission Hardener is for testers-only, it is recommended to initially manually run from the command line. Optional. This is useful to better understand what SUID Disabler and Permission Hardener is actually doing.

{{CodeSelect|code=
sudo /usr/lib/security-misc/permission-hardening
}}

However, if any package that ships any SUID binary is re-installed, the SUID bit will be re-enabled. Therefore it is recommend to permanently enable SUID Disabler and Permission Hardener to ensure that re-installed packages will keep previously disabled SUID binaries permanently disabled.

==== Permanently ====
Only required doing once. Enable systemd unit.

{{CodeSelect|code=
sudo systemctl enable permission-hardening.service
}}

Only required doing once. Start systemd unit.

{{CodeSelect|code=
sudo systemctl start permission-hardening.service
}}

=== Show dpkg-statoverride List ===
SUID Disabler is based on the standard Debian tool <code>dpkg-statoverride</code> ([https://manpages.debian.org/dpkg-statoverride man page]). It is a tool to reliably override ownership and mode of files.

SUID Disabler would be incomplete if it did not use <code>dpkg-statoverride</code>. This is because when a package is upgraded or re-installed, <code>dpkg</code> would reset the original file permissions. I.e. re-enable SUID. To prevent a race condition (malware abusing SUID before SUID can re-disable), <code>dpkg-statoverride</code> is being used.

It might be helpful to view the list of overwritten dpkg file permissions.

{{CodeSelect|code=
dpkg-statoverride --list
}}

Note that even when not using SUID Disabler at all, Debian (and a few other packages) by default adds a few dpkg statoverwrites by themselves. Not all entries in the list of dpkg statoverwrites are the caused by SUID Disabler. Therefore SUID Disabler maintains its own lists of changes. It records permissions before it applies any changes as well as records the new permissions set by SUID Disabler. In case of any issues it might however be useful to check the list of file permission changes enforced by <code>dpkg-statoverride</code>.

=== View List of Debian Default File Permissions Before SUID Disabler ===
File <code>/var/lib/permission-hardening/existing_mode/statoverride</code> records modes before changing them using SUID Disabler and Permission Hardener.

{{CodeSelect|code=
cat /var/lib/permission-hardening/existing_mode/statoverride
}}

=== View List of Permissions Changed by SUID Disabler and Permission Hardener ===
File <code>/var/lib/permission-hardening/new_mode/statoverride</code> now records modes that were changed by SUID Disabler and Permission Hardener.

{{CodeSelect|code=
cat /var/lib/permission-hardening/new_mode/statoverride
}}

=== Compare Changes by SUID Disabler and Permission Hardener ===
To view previous modes and how these were changed (replace <code>meld</code> with your favorite <code>diff</code> viewer):

{{CodeSelect|code=
meld /var/lib/permission-hardening/existing_mode/statoverride /var/lib/permission-hardening/new_mode/statoverride
}}

=== Debugging ===
Look what SUID Disabler and Permission Hardener is actually doing. Most interesting to run this command during initial enabling of SUID Disabler and Permission Hardener.

{{CodeSelect|code=
sudo journalctl --no-pager -b -o cat -u permission-hardening
}}

=== Re-Enable Specific SUID Binaries ===
In next upgrade of security-misc.

Syntax:

{{CodeSelect|code=
sudo /usr/lib/security-misc/permission-hardening-undo /full/path/to/file
}}

Example:

{{CodeSelect|code=
sudo /usr/lib/security-misc/permission-hardening-undo /usr/sbin/exim4
}}

=== Disable SUID Disabler and Permission Hardener ===
Undo all changes. The following command is is only efficient until upgrade of package security-misc or reboot. To disable permanently the subsequent <code>systemctl</code> commands are required as well.

{{CodeSelect|code=
sudo /usr/lib/security-misc/permission-hardening-undo all
}}

Stop systemd unit.

{{CodeSelect|code=
sudo systemctl stop permission-hardening.service
}}

Mask systemd unit.

{{CodeSelect|code=
sudo systemctl mask permission-hardening.service
}}

=== SUID SGID Hardening Issues ===
This is a list of SUID / SGID programs which have their <code>set-user-id</code> bit and/or <code>set-group-id</code> bit removed. 

To use the following programs you need to:

* either use [[root]] rights, OR
* restore SUID / SGID (undocumented)

Standard GNU/Linux utilities:

* These tools probably are used much nowadays on Linux desktop single user computers. If you need any of this, you are better off using root.
* <code>passwd</code> [https://manpages.debian.org/passwd man] (change user password)
* <code>chage</code> [https://manpages.debian.org/chage man] (change user password expiry information)
* <code>expiry</code> [https://manpages.debian.org/expiry man] (check and enforce password expiration policy)
* <code>chfn</code> [https://manpages.debian.org/chfn man] (change real user name and information)
* <code>chsh</code> [https://manpages.debian.org/chsh man] (change login shell)
* <code>gpasswd</code> [https://manpages.debian.org/gpasswd man] (administer <code>/etc/group</code> and <code>/etc/gshadow</code>)
* <code>newgrp</code> [https://manpages.debian.org/newgrp man] (log in to a new group)

applications related:

* <code>/usr/lib/kde4/libexec/fileshareset</code>: dolphin
* <code>/usr/lib/openssh/ssh-keysign</code>
* <code>ssh-agent</code>
* <code>pppd</code> [https://manpages.debian.org/pppd man] (Point-to-Point Protocol Daemon) Dial up modem only?

root rights related:

* <code>su</code>: substitute user. See also [[Root#Substitute_User_.28su.29_Command|documentation about <code>su</code>]]
* <code>pkexec</code> [https://forums.whonix.org/t/cannot-use-pkexec/8129 some issues unrelated to SUID]
* <code>/usr/lib/kde4/libexec/kdesud</code>

mount related:

* <code>mount</code>
* <code>umount</code>
* <code>fusermount</code>
* <code>mount.nfs</code>
* <code>mount.cifs</code>
* <code>ntfs-3g</code>
* <code>/usr/lib/eject/dmcrypt-get-device</code>

virtualization related:

* <code>/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic</code> (Manage nics in another network namespace) Does [[Anbox]] need this?

namespace related:

* <code>newgidmap</code> [https://manpages.debian.org/newgidmap man] (set the gid mapping of a user namespace)
* <code>newuidmap</code> [https://manpages.debian.org/newuidmap man] (set the uid mapping of a user namespace)

crontab related:

* You are better off editing any non-root user's crontab with root rights.
* <code>crontab</code> [https://manpages.debian.org/crontab man] (Manage users crontab files)
* <code>at</code> [https://manpages.debian.org/at man] (executes commands at a specified time)

local mail, mailspool, printing related:

* Related to local mail, mailspool. Webmail and e-mail clients should be fine. These tools probably are used much nowadays on Linux desktop single user computers.
* <code>dotlockfile</code> [https://manpages.debian.org/dotlockfile man] (Utility to manage lockfiles)
* <code>dotlock.mailutils</code> [https://manpages.debian.org/dotlock.mailutils man] (lock mail spool files) Also related to printing?
* <code>exim4</code> [https://manpages.debian.org/exim4 man] (Mail Transfer Agent)
* <code>/usr/lib/evolution/camel-lock-helper-1.2</code> See [https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=336755 this].

system local messaging:

* Even more obscure than above. Linux multi user systems could send each other local messages.
* <code>wall</code> [https://manpages.debian.org/wall man] (write a message to all users)
* <code>write</code> / <code>bsd-write</code> [https://manpages.debian.org/bsd-write man] (send a message to another user)

<code>Network Information Server</code> (<code>NIS</code>):

* <code>unix_chkpwd</code> [https://manpages.debian.org/unix_chkpwd man] (Helper binary that verifies the password of the current user) Related to <code>Network Information Server</code> (<code>NIS</code>)? See [https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=155583 this discussion]. Does not look important.

=== Permission Hardener Issues ===
The following folders are only readable with root rights.

* <code>/boot</code>: breaks KVM direct kernel boot using kernel images located in <code>/boot</code>. I.e. when using KVM to boot a kernel from the host disk located in <code>/boot</code> this will not be possible by default. The safest alternative would be using another file location for kernel images or inside VM kernel images.

= Experimental Features =
Unreleased. (Developers only.) Will flow into other repositories as per usual.

{{anchor|suid}}
== Console Lockdown ==
TODO: document

Will be default in {{Project name}} build version <code>15.0.0.7.8</code> and above. Unreleased.

Using pam_access.

* https://github.com/Whonix/security-misc/blob/master/etc/security/access-security-misc.conf
* https://github.com/Whonix/security-misc/blob/master/usr/share/pam-configs/console-lockdown-security-misc

To enable for older builds of {{Project name}}.

Add user <code>user</code> to group <code>console</code>.

{{CodeSelect|code=
sudo adduser user console
}}

Enable pam console lockdown.

{{CodeSelect|code=
sudo pam-auth-update --enable console-lockdown-security-misc
}}

== Remount Secure ==
Feature not ready!

* https://forums.whonix.org/t/re-mount-home-and-other-with-noexec-and-nosuid-among-other-useful-mount-options-for-better-security/7707/27
* https://github.com/Whonix/security-misc/blob/master/lib/systemd/system/remount-secure.service
* https://github.com/Whonix/security-misc/blob/master/usr/lib/security-misc/remount-secure

{{CodeSelect|code=
sudo touch /etc/noexec
}}

{{Anchor|install}
= Installation of security-misc =
{{mbox
| image   = [[File:Ambox_notice.png|40px|alt=Whonix / Kicksecure default admin password is: changeme]]
| text    =
This chapter is only required for users which aren't users of Whonix or Kicksecure. That is because security-misc is installed by default in Whonix and Kicksecure.
}}

Prerequisites:

{{Kicksecure Prerequisites}}

{{Project-APT-Repository-Add}}

{{Box|text=
Install <code>security-misc</code>.

{{Install Package|package=
security-misc
}}
}}

= References =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
