<!--
Copyright:

   Whonix Computer Security Education wiki page Copyright (C) Amnesia <amnesia at boum dot org>
   Whonix Computer Security Education wiki page Copyright (C) 2012 - 2018 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
   
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 3 of the License, or
   (at your option) any later version.
         
   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.
      
   You should have received a copy of the GNU General Public License
   along with this program; if not, write to:

    Free Software Foundation, Inc. 
    51 Franklin St, Fifth Floor
    Boston, MA 02110-1301, USA.

On Debian GNU/Linux systems, the complete text of the GNU General Public
License can be found in the /usr/share/common-licenses' directory.

The complete text of the GNU General Public License can also be found online on gnu.org <https://www.gnu.org/licenses/gpl.html>, in Whonix virtual machine images in /usr/share/common-licenses/GPL-3 file or on Github <https://github.com/Whonix/Whonix/blob/master/GPLv3>.
-->
<!--
The Whonix Computer Security Education wiki page is forked from the Tails Enable MAC Changer page, from this exact source <http://git.immerda.ch/?p=amnesia.git;a=blob;f=wiki/src/doc/advanced_topics/mac_changer.mdwn;hb=770c6f26f8dcd06452fef1c57dafb2878e0dee11> and on the Tails macchanger page from this exact source <http://git.immerda.ch/?p=amnesia.git;a=blob;f=wiki/src/todo/macchanger.mdwn;hb=f27853e23d7985594d54f00f30153b6acd97312e>.
-->

{{Header}}
{{#seo:
|description=Disabling TCP and ICMP Timestamps for Better Security and Privacy
|og:image=https://www.whonix.org/w/images/9/9c/Timestamps.jpg
}}

= Disable TCP Timestamps =

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = TCP timestamps provide protection against [https://en.wikipedia.org/wiki/Protection_Against_Wrapped_Sequence_Numbers#TCP_timestamps wrapped sequence numbers]. 
}}


The downside of TCP timestamps is adversaries can remotely calculate the system uptime and boot time of the machine and the host's clock down to millisecond precision. These calculated uptimes and boot times can also help to detect hidden network-enabled operating systems, as well as link spoofed IP and MAC addresses together and more. <ref>http://forensicswiki.org/wiki/TCP_timestamps</ref> 

To prevent this information leaking to an adversary, it is recommended to disable TCP timestamps on any operating systems being used. The less information available to attackers, the greater the security.

{{Anchor|Linux or Qubes}}
== Qubes ==

TCP timestamps are disabled by default in Qubes R3.1 and above. <ref>https://github.com/QubesOS/qubes-issues/issues/1344</ref>

== Linux ==
<ref>
Temporary disabling TCP timestamps for testing purposes.

Note: Users can skip this temporary option and instead apply the chapter's main instructions if a permanent solution is desired.

To dynamically disable TCP timestamping on Linux (when using Qubes: in the NetVM).

Become root.

{{CodeSelect|code=
sudo su
}}

Disable TCP timestamps.

{{CodeSelect|code=
echo 0 > /proc/sys/net/ipv4/tcp_timestamps
}}
</ref>

Open a terminal (Konsole).

Become root.

{{CodeSelect|code=
sudo su
}}

Add the following line to {{Code2|/etc/sysctl.d/tcp_timestamps.conf}}.

{{CodeSelect|code=
net.ipv4.tcp_timestamps = 0
}}

To do that, use the following command.

{{CodeSelect|code=
echo "net.ipv4.tcp_timestamps = 0" > /etc/sysctl.d/tcp_timestamps.conf
}}

To apply the sysctl settings without a reboot, run the following command.

{{CodeSelect|code=
sysctl -p
}}

Check if the changes have been properly set.

{{CodeSelect|code=
sysctl -a | grep net.ipv4.tcp_timestamps
}}

If it worked correctly, the system should provide the following output.

<pre>
net.ipv4.tcp_timestamps = 0
</pre>
== Windows ==

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = The user must have administrator privileges.
}}


To disable TCP timestamps on Windows, run the following root command.

{{CodeSelect|code=
netsh int tcp set global timestamps=disabled
}}

== Other Operating Systems ==

=== macOS ===

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = This procedure is untested. It should also work for BSD-like operating systems.
}}


Users must disable rfc1323 which handles TCP timestamps. To check system-set TCP values, run. <ref>https://serverfault.com/questions/216956/how-to-check-tcp-timeout-in-linux-macos</ref>

{{CodeSelect|code=
sysctl net.inet.tcp
}}

A value of 1 against <code>net.inet.tcp.rfc1323</code> indicates it is enabled, while 0 indicates it is disabled.

To permanently disable TCP timestamps, run. <ref>https://macosx.com/threads/slow-tcp-ip-smc-router.9132/</ref> <ref>https://seconfig.sytes.net/blog/p/9201755583327191420/office-where-mac-computers-couldn-t-browse-https-sites</ref>

{{CodeSelect|code=
sudo su
}}

{{CodeSelect|code=
echo net.inet.tcp.rfc1323=0 > /etc/sysctl.conf
}}

To temporarily disable TCP timestamps (until reboot) for testing purposes, run. 

{{CodeSelect|code=
sudo sysctl -w net.inet.tcp.rfc1323=0
}}

TODO: expand.

= Disable ICMP Timestamps =

The Internet Control Message Protocol (ICMP) is used by network devices, including routers, to send operational information and error messages such as whether a service is available or if a host/router cannot be reached. Unlike TCP and UDP, it is a network level, not transport layer protocol. Commonly network utilities are based on ICMP messages, such as ''traceroute'' and ''ping''. <ref>https://en.wikipedia.org/wiki/ICMP_Timestamp</ref> 

The ICMP protocol includes timestamps for time synchronization, with the originating timestamp being set to the time (in milliseconds since midnight) since the sender last touched the packet. A timestamp reply is also generated, consisting of the originating timestamp (sent by the sender) as well as a "receive timestamp", which captures when the timestamp was received and a reply sent. <ref>https://en.wikipedia.org/wiki/ICMP_Timestamp#Timestamp</ref>

== Qubes ==

ICMP timestamps are disabled by default in Qubes R3.1 and above. <ref>https://github.com/QubesOS/qubes-issues/issues/1346</ref>

== Linux ==

ICMP timestamps need to be blocked with the [[#Firewall|firewall]]. <ref>Advanced users can of course use IP tables. For example in [https://lists.debian.org/debian-firewall/1999/12/msg00010.html Debian]: <code>ipchains -p icmp -s $INTIP/0 13 -i $INTIF -j DENY</code> and <code>ipchains -p icmp -s 0.0.0.0/0 14 -i $EXTIF -j DENY</code></ref> This is distribution dependent and varies widely as does having a firewall enabled on your specific OS. Be aware that some distributions do not turn on the firewall by default. 

There are many differing ways to accomplish blocking ICMP timestamps via the command line, therefore users are recommended to consult the specific distribution's documentation. <ref>For instance, [http://www.thegeekstuff.com/2010/07/how-to-disable-ping-replies-in-linux/ Debian users] could edit the <i>/etc/systcl.conf</i> file manually and add <code>net.ipv4.icmp_echo_ignore_all = 1</code></ref> The most straightforward way is to download a GUI front-end (like gufw) to configure the firewall and have it set to silently drop all incoming connections by default, and allow only outgoing traffic from the machine.

== Windows ==

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = This is untested.
}}


Recent Windows operating systems (Win 10, Win 8/8.1, Win 7) should have disabled ICMP settings by default in the Windows firewall. <ref>http://www.sysprobs.com/enable-ping-reply-and-ftp-traffic-in-windows-10-and-server</ref> 

=== From the Menu ===

The status of ICMP timestamps can be manually checked and changed on Windows systems via the Firewall settings. <ref>https://answers.microsoft.com/en-us/windows/forum/windows_7-security/check-icmp-timestamp-response/062ffa99-ffae-4ab0-a328-84371ed46ed8?tab=question&status=AllReplies#tabs</ref>

<code>Right-click on Start button</code> -> <code>Select Control Panel</code> -> <code>Select Windows Firewall</code> -> <code>Select Advanced Settings tab</code>

The ICMP Settings dialog box should show the ICMP timestamp is disabled: <code>Allow incoming timestamp request</code> is unchecked. <ref>https://msdn.microsoft.com/en-us/library/ms912869%28v=winembedded.5%29.aspx</ref>

=== From the Command Line ===

ICMP timestamp responses can be disabled via the netsh command line utility. This is necessary for Vista and earlier Windows versions. <ref>https://social.technet.microsoft.com/Forums/windows/en-US/219f3dcc-3e5b-4d9b-88ae-137215575c7f/icmp-timestamp-response?forum=w7itprosecurity</ref>

Open a terminal.

Run as an administrator.

{{CodeSelect|code=
netsh firewall set icmpsetting 13 disable
}}

Outgoing ICMP timestamp responses are now blocked.

== Other Operating Systems ==

=== macOS ===

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = This is untested.
}}


MacOS systems should have ICMP timestamps disabled by default. Therefore, if the firewall is enabled and "Stealth Mode" is set, the system should not respond to any ICMP requests. This is how to check the system is properly secured: <ref>http://osxdaily.com/2015/11/18/enable-stealth-mode-mac-os-x-firewall/</ref>

<code>Menu</code> -> <code>System Preferences</code> -> <code>Security & Privacy</code> -> <code>Select the Firewall tab</code> -> <code>Check Firewall is On</code> -> <code>Click Firewall Options</code> -> <code>Enable Stealth Mode</code> -> <code>Click OK</code>

The "Block all incoming connections" checkbox should also be enabled for greater security. 

The user can also manually change or check the timestamp status of ICMP, since the system variable is  <code>net.inet.icmp.timestamp</code> in the <i>/etc/sysctl.conf</i> file. <ref>https://security.stackexchange.com/questions/46090/why-is-icmp-timestamping-disabled-on-os-x</ref> 

To permanently disable ICMP timestamps. <ref>https://superuser.com/questions/680200/os-x-how-to-make-it-reply-to-icmp-time-stamp-query</ref>

{{CodeSelect|code=
sudo sh -c "echo net.inet.icmp.timestamp=0 >> /etc/sysctl.conf"
}}

=== OpenBSD ===

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = This is untested.
}}


The easiest solution is to configure the firewall to block incoming and outgoing ICMP packets with ICMP types 13 (timestamp request) and 14 (timestamp response). <ref>https://beyondsecurity.zendesk.com/hc/en-us/articles/203609549--How-can-I-mitigate-ICMP-Timestamp-</ref>

Alternatively, set the relevant sysctl variable to 0 (it is enabled by default). In a terminal, run.

{{CodeSelect|code=
sysctl -w net.inet.icmp.tstamprepl=0
}}

TODO: expand.

= References =
{{reflist|close=1}}

= License =
{{License_Amnesia|{{FULLPAGENAME}}}}

{{Footer}}

[[Category:Documentation]]
