{{Header}}
{{#seo:
|description=Compartmentalization. Better separation of different tasks and/or pseudonyms by using multiple Whonix-Workstations.
|image=https://www.whonix.org/w/images/0/01/Petunia-14052640.jpg
}}
{{Maintainer|
|status=stable
|about=About this {{Code2|{{PAGENAME}}}} Page
|difficulty=easy
|maintainer=[https://forums.whonix.org/users/0brand 0brand]
|support=[[Support]]
}}

= Introduction =

Whonix is a secure operating system comprised of two virtual machines which are isolated both from each other and the host. This configuration averts many threats posed by malware, misbehaving applications and user error. While Whonix protects against many real world threats, <ref>See: [[Security in Real World|Protection Against Real World Attacks]].</ref> it is still possible for skilled adversaries to compromise Whonix-Workstation ([[Qubes-Whonix]]: <code>anon-whonix</code>). 

If a single Whonix-Workstation is used for all anonymous activities and is exploited, the attacker gains access to available data and can monitor all online activity. To minimize the impact of a compromise, it is recommended to utilize multiple Whonix-Workstations to compartmentalize different identities and/or additional software. Depending on individual preferences and requirements, a second, third ... n<sup>th</sup> Whonix-Workstation VM can be created.

== Multiple Whonix-Workstation Rationale ==

Different torifed clients can be used in a completely isolated manner with Multiple Whonix-Workstations. By compartmentalizing each different identity or client, an attacker can only read the data in the compromised VM. For example, if Tor Browser in VM-1 was compromised it could not read a user's IRC identity in VM-2. <ref>Without using an additional exploit to successfully break out of the infected VM, which is a difficult task.</ref> 

One disadvantage of this configuration is that if the host Internet connection goes offline or Tor on Whonix-Gateway (<code>sys-whonix</code>) suddenly fails, then all Whonix-Workstations will go offline simultaneously. If multiple Tor clients were running and abruptly stop in unison, a network observer could link these activities to the same person. For instance, a strong correlation is formed if two Tor users in one IRC channel go offline at exactly the same time.

== Qubes-Whonix vs Non-Qubes-Whonix ==

[[Qubes|Qubes-Whonix]] is the recommended choice for multiple Whonix-Workstations because it is specifically designed for compartmentalization (a.k.a. sandboxing) of multiple running VMs. This provides significant speed and security advantages relative to the traditional Type 2 hypervisor model, where two (or more) Whonix VMs are run inside programs like [[VirtualBox]] on top of the host OS. For further information, see: [[Virtualization_Platform_Security#Type_1_vs_Type_2_Hypervisors|Type 1 vs Type 2 Hypervisors]] and [[Qubes/Why_use_Qubes_over_other_Virtualizers|Why use Qubes over other Virtualizers?]]

Qubes-Whonix also has a TemplateBased filesystem which saves time and improves usability compared to Non-Qubes-Whonix:

* '''Centralized Updates:''' [https://qubes-os.org/doc/glossary/#appvm AppVMs] are based on the corresponding TemplateVM's root filesystem. After updating the TemplateVM, those same updates will be reflected in the root filesystem of every [https://qubes-os.org/doc/glossary/#templatebasedvm TemplateBasedVM]. [[Non-Qubes-Whonix]] users must spend more time in updating each VM individually.
*  '''Minimal Disk Usage:''' TemplateBasedVMs require far less disk space than traditional VMs since the AppVM's root filesystem is based on the corresponding template. The AppVM only requires enough disk space to hold user files in the <code>/home</code> directory.
* '''VM Management:''' Cloning VMs is a simple two-step process which can be done in Qube Manager. Non-Qubes-Whonix requires a multi-step process to clone and configure each VM.

= Safety Precautions =

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text    = While multiple Whonix-Workstations are recommended, this is <u>not</u> an endorsement for using them simultaneously!
}}


It is safest to only use one Whonix-Workstation at a time and for a single activity. New risks are introduced by running multiple Whonix-Workstations at the same time. For instance, if a single Whonix-Workstation was compromised, it could potentially perform various side channel attacks to learn about running processes in other VMs, and not all of these can be defeated. Depending on user activities, a skilled adversary might be able to correlate multiple Whonix-Workstations to the same pseudonym.

'''Table:''' ''Cross-VM Attack Vectors''

{| class="wikitable"
|-
! scope="col"| '''Category'''
! scope="col"| '''Description'''
|-
! scope="row"| Distributed Denial of Service (DDOS) Attack
| 
If a [https://en.wikipedia.org/wiki/Denial-of-service_attack Distributed Denial of Service (DDOS) Attack] is launched from an infected Whonix VM, then: <br />
* Other Whonix-Workstations can be DDOSed, and there is no current defense.<br />
* Other Whonix-Gateways can also be DDOSed, and there is no current defense. 
|-
! scope="row"| Exploits <ref>To minimize the threat of exploits it is recommended to apply relevant instructions found in the [[System_Hardening_Checklist|System Hardening Checklist]].</ref>
| 
Following infection, an adversary could try to exploit the Whonix-Gateway or other Whonix-Workstations:<br />
* Non-Qubes-Whonix: At risk.<br />
* Qubes-Whonix: Users are safe, unless Whonix-Gateway is compromised first. <ref>For details, see [[#Firewall|Firewall]].</ref>
|-
! scope="row"| Identity Correlation through Circuit Sharing
| 
When different applications use the same Tor circuit and exit relay, these activities can be linked to the same pseudonym (see [[Stream Isolation]] for further details):<br />
* Non-Qubes-Whonix: This is not a threat so long as the Whonix-Workstations were not compromised. Multiple Whonix-Workstations which have different internal IPs configured (see the instructions further below) are automatically  [[Stream Isolation|stream-isolated]]. <ref>Since [https://www.torproject.org/docs/tor-manual.html.en IsolateClientAddr] is the Tor default.</ref><br />
* Qubes-Whonix: No further action is necessary; see [[#Firewall|Firewall]].
|-
! scope="row"| Impersonation
| 
* Non-Qubes-Whonix: A defense against impersonation <ref>Like a man-in-the-middle attack or malicious gateway.</ref> of other Whonix-Workstations or the Whonix-Gateway can be implemented via authentication. This is outlined in the [[#How-to: Use more than One Whonix-Workstation - More Security|How-to: Use more than One Whonix-Workstation - More Security]] section below.<br />
* Qubes-Whonix: No further defenses are required; see [[#Firewall|Firewall]].
|-
! scope="row"| System Stressing
| An adversary could stress any system, network or software components like CPU, HDD, RAM, network connection and other Whonix-Workstations. Potentially the host could be negatively affected as well.
|}

= How-to: Use more than One Whonix-Workstation - EASY =
== Qubes-Whonix ==

Using multiple Whonix-Workstations is simple in [[Qubes|Qubes-Whonix]]:

# Create an additional AppVM based on the Whonix-Workstation template (<code>{{whonix-ws}}</code>) and give it a distinctive name.
# Confirm the new AppVM is using <code>sys-whonix</code> as its [https://qubes-os.org/doc/glossary/#netvm NetVM].

If creating a new AppVM is unfamiliar, follow this link for step-by-step instructions: [[Qubes/Create_Workstation_AppVMs|Create Whonix Workstation AppVMs]].
 
== Non-Qubes-Whonix ==
<div class="toccolours mw-collapsible mw-collapsed">
If you are interested in this configuration, please press on Expand on the right.
<div class="mw-collapsible-content">

{{Non-Qubes-Whonix}} Only!

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       ='''Note:''' The following instructions only apply to Download/Default-Whonix-Workstations or Whonix VMs built from source code. To use another operating system like Windows, other GNU/Linux, BSD etc. please see the [[Other Operating Systems]] chapter instead.
}}
{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text       = Each additional Whonix-Workstation VM <u>must</u> have its own MAC address and internal LAN IP address.
}}

{{Box|text=
'''1.''' Clone a fresh Whonix-Workstation VM. 

* '''VirtualBox:''' In VirtualBox Manager, [https://dirkstrauss.com/clone-virtualbox-vm/ clone] a clean Whonix-Workstation.   
* '''KVM:''' In Virtual Machine Manager, clone a clean Whonix-Workstation: <code>Highlight Whonix-Workstation</code> -> <code>Open</code> -> <code>Virtual Machine</code> -> <code>Clone</code>

'''2.''' Assign a new MAC address to the cloned VM.
 
{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = '''Note:''' A new MAC address is necessary if an additional [[VirtualBox]] VM is imported. 
}}

* '''VirtualBox:''' In VirtualBox Manager, assign a new MAC address: <code>VirtualBox</code> -> <code>Settings</code> -> <code>Network</code> -> <code>Adapter 1</code> -> <code>Advanced</code> -> <code>Mac Address</code> -> <code>Create a new MAC address (press the green round arrow icon)</code> -> <code>OK</code>
* '''KVM:''' To change the internal network in KVM, see: [[KVM#Creating_Multiple_Internal_Networks|Creating Multiple Internal Networks]].

'''3.''' Edit the network interfaces file in Whonix-Workstation.

{{Open with root rights|filename=
/etc/network/interfaces.d/30_non-qubes-whonix
}}

Change the last octet. For example, change <code>10.152.152.11</code> to <code>10.152.152.12</code>

Save and exit.

'''4.''' Reboot.

Reboot the Whonix-Workstation or alternately restart the network.

{{CodeSelect|code=
sudo service networking restart
}}

Done.
}}
</div>
</div>

== How-to: Use more than One Whonix-Workstation - More Security ==
{{Anchor|Firewall}}
* [[Qubes|Qubes-Whonix]]: This step can be skipped. <ref>By default, AppVMs which are behind the same ProxyVM (or NetVM) are prevented from connecting to each other in Qubes.</ref>
* [[Non-Qubes-Whonix]]: See: [[Connections between Whonix-Gateway and Whonix-Workstation]].

= Multiple Whonix-Gateways =

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = Advanced users only.
}}

== Introduction ==

Multiple Whonix-Gateways can be used alongside multiple Whonix-Workstations, but this has both advantages and disadvantages. One security benefit is the isolation of separate Whonix-Gateway VM instances. In the event that one Whonix-Gateway is compromised, it is not certain the other(s) will be similarly compromised. On the downside, newly cloned Whonix-Gateway(s) will end up with a different set of Tor entry guards unless precautions are taken. <ref>Such as manually configuring identical Tor entry guards. Qube-Whonix users can [[Tor#Copy_Tor_Configuration_files_and_Settings_to_Another_sys-whonix_Instance|copy the Tor state folder to another <code>sys-whonix</code>]] instance or use the same [[Bridges]].</ref> <ref>At present, full instructions are not available for every Non-Qubes-Whonix platform.</ref> 

In this configuration ISPs are probably capable of detecting that two different Tor data folders are in use, but this is not necessarily an anonymity threat. Similarly, if multiple Tor Browsers are used with distinct Whonix-Gateways, then a different set of Tor entry guards will be used as well (unless by chance the same Tor guards are chosen for different Whonix-Gateways).

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       ='''Note''': It is far safer and easier to manage multiple Whonix-Gateways when only <u>one</u> is launched for user activities, rather than running many in parallel.
}}

== Qubes-Whonix ==

It is simple to create additional Whonix-Gateways (<code>sys-whonix</code> instances) in [[Qubes|Qubes-Whonix]]; see 
[[Qubes/Create_Gateway_ProxyVMs|Create Gateway ProxyVMs]].

The only requirement is that the newly created <code>sys-whonix</code> is based on the <code>{{whonix-gw}}</code> TemplateVM and has a <u>distinctive VM name</u>, so it is not confused with other VMs.

== Non-Qubes-Whonix ==
<div class="toccolours mw-collapsible mw-collapsed">
If you are interested in this configuration, please press on Expand on the right.
<div class="mw-collapsible-content">

=== Introduction ===
When multiple Whonix-Gateways are run in paralell, the risks explained in the [[#Safety_Precautions|Safety Precautions]] section equally apply.

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       ='''Note:''' These instructions only apply to Download/Default-Whonix-Workstations.
}}


{{Non-Qubes-Whonix}}

=== VirtualBox ===
In this case, it is necessary to change the Whonix-Gateway network ''interface2'' and Whonix-Workstation network ''interface1'' from internal network <code>Whonix</code> to something else.

=== KVM ===

See [[KVM#Multiple_Whonix-Gateways|Multiple Whonix-Gateways]].
</div>
</div>

= Multiple Qubes-Whonix TemplateVMs =

Multiple [[Qubes-Whonix]] TemplateVMs provides much greater flexibility over a single template when choosing software packages. The additional cloned templates can be customized with software to meet specific requirements; something impossible to achieve with a single TemplateVM. <ref>Optionally, the default template can be cloned and used as the default template for AppVMs. Having a “known-good” backup template available at all times is best practice.</ref>

* '''Packages from a later release:''' Installing packages from a later release could end up breaking the system. For example, mixing packages from [https://wiki.debian.org/DebianStable Debian Stable] with those of a later release like [https://wiki.debian.org/DebianTesting Debian Testing] can lead to an unstable system because of associated software dependencies required for full functionality. <ref>Using packages from different repositories can lead to [[Install Software#Dependency_Hell|Dependency Hell]].</ref> <ref>This problem can be avoided by cloning additional Whonix templates and preferring packages from a single repository in each TemplateVM.</ref> Prior to installing Debian packages from a later release, first read [[Install Software#Install_from_Debian_testing|Install from Debian testing]].
* '''Custom software:''' Additional cloned templates makes it easy to install custom software used for a specific application. For example, users could [[Tunnel UDP over Tor]] by configuring <code>{{whonix-ws}}</code> to route all applications through a VPN tunnel. However, this method also increases the risk of identity correlation. To mitigate this risk, the AppVM based on this template should only be used for the particular application that must be routed through the <i>tunnel-link</i>.  Before installing custom software it is recommended to first read [[Install Software#General_Advice|Install Software General Advice]].
* '''Untrusted packages:''' It is unwise to install untrusted packages in a template used for sensitive activities. With multiple cloned TemplateVMs, a single template can be designated as a less trusted domain for that purpose. <ref>It is strongly encouraged to only install signed packages from a trusted source.</ref> Read [https://qubes-os.org/doc/software-update-vm/#notes-on-trusting-your-templatevms Notes on trusting your TemplateVM(s)] prior to installing untrusted packages.     

== Cloning TemplateVMs ==
{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = '''Note:''' Each TemplatesVM's root filesystem runs independently from all other TemplateVMs. <ref>This applies to all TemplateVMs, even if they were cloned.</ref> Therefore, each individual TemplateVM must be updated separately.
}}


Cloning templates in [[Qubes-Whonix]] is easily accomplished via Qube Manager. Be careful with naming conventions for both TemplateVMs and AppVMs (based on those templates) so they are not confused with each other. This will minimize the chance of basing an AppVM on the wrong template. 

When creating AppVMs based on cloned TemplateVMs, a purpose-based naming convention is sensible so there is no ambiguity regarding the intended function of an AppVM. For example, if an AppVM is created to tunnel UDP over Tor, appending <code>tunnel-udp</code> (the purpose) to the end of <code>anon-whonix</code> would lead to the name <code>anon-whonix-tunnel-udp</code>. 

To clone Qubes-Whonix TemplateVMs, follow the instructions below.

{{Box|text=
Cloning Qubes VMs is a simple process in Qube Manager:

<code>Qube Manager</code> -> <code>VM to be Cloned</code> -> <code>Clone qube</code> -> <code>Enter name for Qube clone</code> <br />

'''Figure:''' ''Cloning Whonix qubes''<br />
[[Image:Screenshot-clone-vm-qubes.png]]

When prompted, give the newly cloned VM a name that is not easily confused with other VMs. This minimizes the chances of basing an AppVM on the wrong template; there could be serious security concerns if a "trusted" AppVM was based on the wrong TemplateVM with untrusted packages.

'''Figure:''' ''Clone Re-naming''<br />
[[Image:Screenshot_Qubes-clone-vm_add-name.png]]
</div>
</div>
}}

{{Box|text=
<u>NetVM</u>

{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = <u>Reminder</u>: In Qubes R4 and above the NetVM setting of TemplateVMs should be set to <code>None</code>. <ref>
Since TemplateVMs in Qubes R4 and above are supposed to be upgraded through qrexec based Qubes updates proxy.

* https://www.qubes-os.org/doc/software-update-vm/#technical-details-r40
* [https://github.com/QubesOS/qubes-issues/issues/1854 implement qrexec based updates proxy]
</ref>
}}
}}

{{Box|text=
<u>UpdatesProxy</u>

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px|alt=Whonix first time users warning]]
| text    = A cloned Whonix TemplateVM will by default be upgraded through <code>sys-whonix</code>. <ref>
Because [https://github.com/QubesOS/qubes-core-admin/blob/master/qubes-rpc-policy/qubes.UpdatesProxy.policy <code>/etc/qubes-rpc/policy/qubes.UpdatesProxy</code>] contains:
{{CodeSelect|code=
$tag:whonix-updatevm $default allow,target=sys-whonix
}}
Quote:
<blockquote>
Note that policy parsing stops at the first match, [...]
</blockquote>
</ref> This is a known Qubes usability issue. <ref>
* [https://github.com/QubesOS/qubes-issues/issues/3412 add UpdateVM setting to qubes-vm-settings]
* https://forums.whonix.org/t/cloned-whonix-templatevm-connects-upgrades-through-sys-whonix-even-if-netvm-is-set-to-a-different-whonix-gateway-proxyvm/5840
</ref>
}}


If you like to change the UpdatesProxy setting for any TemplateVM, apply the following steps.

{{Box|text=
In dom0. Open <code>/etc/qubes-rpc/policy/qubes.UpdatesProxy</code> with root rights.

{{CodeSelect|code=
sudo nano /etc/qubes-rpc/policy/qubes.UpdatesProxy
}}

TODO: the following steps require testing.

Add at the very top of that file.

Syntax:

<pre>
name-of-template-vm $default allow,target=name-of-proxy-vm
</pre>

For example:

{{CodeSelect|code=
whonix-ws-14-clone-1 $default allow,target=sys-whonix-cloned
}}

Save.

<pre>
<Ctrl-X> --> press Y --> <Enter>
</pre>

The procedure is now complete.
}}
}}

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
