{{Title|title=Full Raw Disk Backup}}
{{Header}}
{{#seo:
|description=1 to 1 disk backup
}}

{{stub}}

= Introduction =
TODO: what is a full raw disk backup

It is not possible to backup an operating system installed on an internal disk such as for example Qubes OS while that operating system is running from that operating system.

= Prerequisite Knowledge =
* How to install an operating system (Debian) on a external USB drive.

= Prerequisites =
* An installed operating system (such as for example Qubes OS) on an (internal) disk.
* An operating system installed on an external disk, most likely USB such as for example Debian.
* A separate external backup disk where the backup should be stored.

= Information Gathering =
== Qubes Users Recommendations ==
It is useful to run gparted from the Qubes installation which should backed up as full raw disk backup.

Tested in Qubes R4.0 only. In later Qubes versions with untrusted storage domain, these instructions might need changes.

gparted is a disk partitioning tool which will be used as an easy way to find out how many hard drives the system has and what size they have.

In dom0, install gparted.

{{CodeSelect|code=
sudo qubes-dom0-update gparted
}}

In dom0, run gparted.

{{CodeSelect|code=
sudo --set-home gparted
}}

Make notes. For example.

Note: Modify these notes according to what can be seen in gparted.

<pre>
/dev/sda (476.91 GiB)
</pre>

Check the button below the <code>X</code> (which would close the window) if there are multiple disks.

Obviously easiest if there is only 1 disk. Assuming there is only 1 disk.

Users of USBVM would only non-USB connected disks there.

= Recommendations =
USB boot operating system should have a graphical diff viewer such as meld installed.

After booting the operating system from USB.

{{Install Package|
package=meld lxsudo
}}

= Overview =
'''1.''' Boot from external USB drive.

'''2.''' Figure out the device paths

= Instructions =
In Linux, unfortunately device names and device paths are non-deterministic, unpredictable, might change with kernel versions and operating system upgrades.

A raw backup with the <code>dd</code> can lead to data loss if used incorrectly as <code>dd</code> is a very powerful tool.

For example, <code>sd'''a'''</code> is a device name and <code>/dev/sd'''a'''</code> is a device path. Other device path examples are <code>dev/sd'''b'''</code>, <code>dev/sd'''c'''</code>.

The actual <code>dd</code> command is not very difficult but the device paths need to be carefully determined before starting the backup, otherwise data loss is at risk.

'''1.''' Boot from external disk.

'''2.''' Do not attach any other disks at this time.

If any other disks are already attached, remove them for now for simplicity.

'''3.''' Write output of fdisk to file "old".

{{CodeSelect|code=
sudo fdisk -l > old
}}

'''4.''' Check with gparted.

See what disks are currently attached with an alternative tool such as gparted as well.

{{CodeSelect|code=
lxsudo gparted
}}

'''4.''' Attach another disk, the external disk which should be used for the backup.

'''5.''' Write output of disk to file "new".

{{CodeSelect|code=
sudo fdisk -l > new
}}

'''6.''' Compare file "old" with file "new" using "diff".

{{CodeSelect|code=
diff old new
}}

'''7.''' Compare file "old" with file "new" using "diff".

{{CodeSelect|code=
meld old new
}}

'''8.''' View contents of file <code>/etc/fstab</code>.

{{CodeSelect|code=
cat /etc/fstab
}}

Example printout.

<pre>
# /etc/fstab: static file system information.
#
# Use 'blkid' to print the universally unique identifier for a
# device; this may be used with UUID= as a more robust way to name devices
# that works even if disks are added and removed. See fstab(5).
#
# <file system> <mount point>   <type>  <options>       <dump>  <pass>
/dev/mapper/debian--vg-root /               ext4    errors=remount-ro 0       1

# /boot was on /dev/sdb1 during installation
UUID=86983f37-38db-401f-889a-bc93d83a3be4 /boot           ext2    defaults        0       2

#/dev/mapper/debian--vg-swap_1 none            swap    sw              0       0
</pre>

Watch out for the <code>UUID=</code> field. In above example it is <code>86983f37-38db-401f-889a-bc93d83a3be4</code>.

'''8.''' View output of the <code>blkid</code>.

For informational purposes only.

{{CodeSelect|code=
sudo blkid
}}

'''9.''' Confirm the device path of the boot device.

Compare output of file <code>/etc/fstab</code> with <code>blkid</code> command.

For example. Note: replace <code>UUID</code> with the actual <code>UUID</code> from <code>/etc/fstab</code>.

{{CodeSelect|code=
sudo blkid {{!}} grep 86983f37-38db-401f-889a-bc93d83a3be4
}}

Sample printout.

<pre>
/dev/sdb1: UUID="86983f37-38db-401f-889a-bc93d83a3be4" TYPE="ext4" PARTUUID="decf0fe9-01"
</pre>

In above example, the device path of the boot disk is <code>/dev/sd'''b'''</code>. <u>Not</u> <code>/dev/sd'''b'''<u>1</u></code>. The <code>1</code> means partition number <code>1</code>. When making raw disk backups of the full disk, partition numbers must be omitted. Otherwise it would just be a partition backup. In this case, 

'''10.''' Make some notes such as.

<pre>
Qubes internal disk 476.91 GiB
Debian external boot disk 931.42 GiB
Backup external disk 931.41 GiB
</pre>

'''11.''' Note the device paths.

According to above instructions.

For the author of this wiki page, <code>/dev/sd'''a'''</code> was the (Qubes) internal disk, <code>/dev/sd'''b'''</code> the (Debian) USB boot disk and <code>/dev/sd'''c'''</code> the USB backup drive. This might be different for readers!

'''12.''' Backup.

Syntax:

* Replace <code>if=/dev/xxx</code> with the actual device path of the drive which should be backed up.
* Replace <code>if=/dev/yyy</code> with the actual device path of the drive where the backup should be stored.

<blockquote>time dd bs=64K conv=noerror,sync status=progress if=/dev/xxx of=/dev/yyy</blockquote>

Example:

Note: DATA LOSS POSSIBLE if used incorrectly! Do not use this without prior verification of the device paths!

<blockquote>time dd bs=64K conv=noerror,sync status=progress if=/dev/sd<u>a</u> of=/dev/sd<u>c</u></blockquote>

<ref>
It is unfortunately not possible to compare. Running <code>diff /dev/sda /dev/sdc</code> for backup verification is not possible because of different partition table and disk id.
</ref>

The backup might take a long time.

'''13.''' Check exit code.

{{CodeSelect|code=
echo $?
}}

Expected output if success.

<pre>
0
</pre>

'''14.''' Done.

Backup is complete.

'''15.''' Restoration test.

Without restoration test, it's unclear if the backup could be restored in case needed.

= Footnotes =
<references />

{{Footer}}

[[Category:Documentation]]
