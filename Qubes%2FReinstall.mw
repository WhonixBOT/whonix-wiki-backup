{{DISPLAYTITLE:Reinstall Qubes-Whonix TemplateVMs}}
{{Header}}
{{#seo:
|description=How to Reinstall Qubes-Whonix TemplateVMs.
|image=https://www.whonix.org/w/images/5/55/Qubes-logo-icon.png
}}

== Introduction == 
On occasion it is necessary to reinstall a Whonix TemplateVM from the Qubes repository. <ref>https://qubes-os.org/doc/reinstall-template/</ref> This usually applies when the template is:

*'''Broken:''' TemplateVMs can become broken and/or unbootable for a number of reasons, like when [[Whonix_Debian_Packages#Which_meta_packages_are_safe_to_remove.3F|removing meta-packages]] that Whonix "depends" on to function properly, or after [[Install_Software#Install_from_Debian_testing|mixing packages]] from a later Debian release. 
*'''Misconfigured:''' Not all TemplateVM modifications are easily reversible. In some cases it may be necessary to reinstall the TemplateVM.
*'''Compromised:''' Users may suspect their TemplateVM has been compromised. For further information on this topic, see: [[FAQ#Am_I_Compromised.3F|Am I Compromised?]]

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px|alt=Whonix first time users warning]]
| text    = 
If the Whonix TemplateVM is broken, misconfigured or potentially compromised, discontinue using any VMs based on the affected template. 
}}


The obvious reason is any TemplateBasedVMs that are based on the affected TemplateVM will inherit the same issues. Disregarding this advice could lead to serious consequences. For example, a core component of the Whonix security model depends on <code>sys-whonix</code> forcing all traffic through Tor or blocking it. If <code>sys-whonix</code> was based on a TemplateVM with a misconfigured or broken firewall, the Whonix security model would be broken. <ref>https://whonix.org/Dev/Technical_Introduction#With_more_technical_terms</ref>

Qubes has its own [https://www.qubes-os.org/doc/reinstall-template/ template reinstall guide], however this guide should be preferred for re-installation of Qubes-Whonix, because this guide is Whonix specific and contains instructions how to properly set up all settings. <ref>
Using salt.
</ref>

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px|alt=Whonix first time users warning]]
| text    = [https://forums.whonix.org/t/qubes-whonix-support-ending-for-qubes-3-2-upgrade-to-qubes-r4-0-or-above-required/6113 '''Qubes-Whonix support ended for Qubes 3.2 on 2018-11-15 - upgrade to Qubes R4.0 or above required.''']
}}


{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = '''Note:''' The root file system of the affected TemplateVM will be lost during the reinstallation process. It is recommended to create a backup of any important files first. 
}}


It is simplest to reinstall Whonix TemplateVMs using the automated method.

=== Network Configuration ===

==== UpdateVM Setting ====

If the dom0 UpdateVM is based on a template that is broken or no longer trusted,<ref>Template is broken, misconfigured or compromised</ref> an alternate UpdateVM can be used temporarily. In other words, more specifically, if the user no longer trusts its Whonix-Gateway TemplateVM (<code>{{whonix-gw}}</code>) and/or its Whonix-Gateway ProxyVM (<code>sys-whonix</code>, then configure Qubes dom0 to use a different UpdateVM by applying the following steps.

<code>Qubes Manager</code> -> <code>System</code> -> <code>Global Settings</code> -> <code>Dom0 UpdateVM: <VM-name></code><ref> Set torified UpdateVM {{CodeSelect|code= qubes-prefs updatevm sys-whonix}} <br>Revert this change {{CodeSelect|code= qubes-prefs updatevm sys-firewall}}</br></ref>

=== Reinstall the Whonix TemplateVM ===
==== Reinstall ====
{{Box|text=
{{Qubes_Terminal}}

Execute the following command. Replace <code>qubes-template-package</code> with either: <code>qubes-template-whonix-ws-14</code> or <code>qubes-template-whonix-gw-14</code>, respectively.

{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qubes-templates-community --action=reinstall <qubes-template-package>
}}

For example, to reinstall <code>whonix-gw-14</code> TemplateVM. 

{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qubes-templates-community --action=reinstall qubes-template-whonix-gw-14 
}}

For example, to reinstall <code>whonix-ws-14</code> TemplateVM. 

{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qubes-templates-community --action=reinstall qubes-template-whonix-ws-14 
}}

Afterwards, any VMs based on the reinstalled TemplateVM must be restarted to reflect the updated file system.
}}

==== Settings ====
Use <code>salt</code> for settings setup. <ref>
[[Dev/Qubes#salt]]
</ref>

{{CodeSelect|code=
sudo qubesctl state.sls qvm.anon-whonix
}}

==== Optional Whonix DVM Template VM ====
{{Qubes Install DVM}}

=== Optional Updates over Tor ===
{{Qubes Install Updates over Tor}}

=== Done ===
The process to reinstall Whonix TemplateVMs is now complete. Users should disregard the chapter Manual Reinstallation below.

----

== Manual Reinstallation ==
<div class="toccolours mw-collapsible mw-collapsed">
'''Unfinished!''' See TODOs. Meanwhile use Automated Reinstallation above. Please press Expand on the right.
<div class="mw-collapsible-content">

Whonix TemplateVMs can be manually reinstalled using the following multi-step process. Note that "target TemplateVM" refers to the TemplateVM that will be reinstalled.

{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = If the target TemplateVM and / or dependent VMs will be discarded, <ref>Due to serious breakage, misconfiguration or suspected compromise.</ref> skip step 1 below. 
}}

The advantage of this method is, that it also works with non-Fedora based Qubes dom0 UpdateVMs, i.e. also with Debian based Qubes dom0 UpdateVMs.

TODO: salt?

TODO: DVM?

{{Box|text=
'''1.''' Clone the target TemplateVM.

* <code>Qube Manager</code> -> <code>TemplateVM to be cloned</code> -> <code><u>C</u>lone qube</code> -> <code>Enter name for qube clone</code> <ref>qvm-clone <target-template> <new-template-clone></ref>

'''2.''' Remove all VMs based on the target TemplateVM or temporarily set the VMs to use the template clone.

Set the VMs to the cloned template:

* <code>Qube Manager</code> -> <code>VM-name</code> -> <code>Qubes s<u>e</u>ttings</code> -> <code>Template:</code> <ref>qvm-prefs <vm-name> template <cloned-template></ref>  

To remove the VMs:

* <code>Qube Manager</code> -> <code>VM-name</code> -> <code><u>D</u>elete qube</code> -> <code>Confirm qube removal</code> <ref>qvm-remove <vm-name></ref>

'''3.''' Remove the target TemplateVM.
 
{{Qubes_Terminal}}

Run the following command replacing <code>qubes-template-package</code> with either: <code>qubes-template-whonix-ws-14</code> or <code>qubes-template-whonix-gw-14</code>, respectively.

{{CodeSelect|code=
sudo dnf remove <qubes-template-package>
}}

For example, the following command removes <code>whonix-gw-14</code>.

{{CodeSelect|code=
sudo dnf remove qubes-template-whonix-gw-14
}}

For example, the following command removes <code>whonix-ws-14</code>.

{{CodeSelect|code=
sudo dnf remove qubes-template-whonix-ws-14
}}

'''4.''' Reinstall the Whonix TemplateVM.

{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qube-templates-community --action=reinstall <qubes-template-package>
}}

For example, the following command will reinstall <code>whonix-gw-14</code> TemplateVM.

{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qube-templates-community --action=reinstall qubes-template-whonix-gw-14
}}

For example, the following command will reinstall <code>whonix-ws-14</code> TemplateVM.

{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qube-templates-community --action=reinstall qubes-template-whonix-ws-14
}}

'''5.''' If the VMs were previously deleted, proceed to step 6 to create new Whonix VMs. 

Otherwise, if the VMs were temporarily changed to the cloned TemplateVM, the reinstallation process is complete once the VMs are changed to the newly reinstalled TemplateVM: 

* <code>Qube Manager</code> -> <code>VM-name</code> -> <code>Qube s<u>e</u>ttings</code> -> <code>Template:</code>

'''6.''' Create new VMs based on the reinstalled TemplateVM.

* <code>Qube manager</code> -> <code><u>Q</u>ube</code> -> <code>Create new qube</code> <ref>qvm-create --template <reinstalled-template> --label red <vm-name></ref> 

'''7.''' ''Optional:'' Base all AppVMs on a clone of the reinstalled TemplateVM.

The newly reinstalled TemplateVM can itself be cloned, with that fresh clone acting as the default TemplateVM for AppVMs. The benefit of this approach is the reinstalled TemplateVM is maintained in a "known-good" state and only used for creating additional Whonix template clones. To clone the newly reinstalled TemplateVM: 

* <code>Qube Manager</code> -> <code>TemplateVM to be cloned</code> -> <code><u>C</u>lone qube</code> -> <code>Enter name for qube clone</code> 

Next change VMs to the newly cloned TemplateVM: 

* <code>Qube Manager</code> -> <code>VM-name</code> -> <code>Qubes s<u>e</u>ttings</code> -> <code>Template:</code>
}}
</div>
</div>

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
