{{DISPLAYTITLE:Reinstall Qubes-Whonix TemplateVMs}}
{{Header}}
{{#seo:
|description=How to Reinstall Qubes-Whonix TemplateVMs.
|image=https://www.whonix.org/w/images/5/55/Qubes-logo-icon.png
}}

= Introduction =
On occasion it is necessary to reinstall a Whonix TemplateVM from the Qubes repository. <ref>https://qubes-os.org/doc/reinstall-template/</ref> This usually applies when the template is:

*'''Upgrade:''' To get a newer [[Point Release]] or testers-only version of Whonix.
*'''Broken:''' TemplateVMs can become broken and/or unbootable for a number of reasons, like when [[Whonix_Debian_Packages#Which_meta_packages_are_safe_to_remove.3F|removing meta-packages]] that Whonix "depends" on to function properly, or after [[Install_Software#Install_from_Debian_testing|mixing packages]] from a later Debian release. 
*'''Misconfigured:''' Not all TemplateVM modifications are easily reversible. In some cases it may be necessary to reinstall the TemplateVM.
*'''Compromised:''' Users may suspect their TemplateVM has been compromised. For further information on this topic, see: [[FAQ#Am_I_Compromised.3F|Am I Compromised?]]

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text    = 
If the Whonix TemplateVM is broken, misconfigured or potentially compromised, discontinue using any VMs based on the affected template. 
}}


The obvious reason is any TemplateBasedVMs that are based on the affected TemplateVM will inherit the same issues. Disregarding this advice could lead to serious consequences. For example, a core component of the Whonix security model depends on <code>sys-whonix</code> forcing all traffic through Tor or blocking it. If <code>sys-whonix</code> was based on a TemplateVM with a misconfigured or broken firewall, the Whonix security model would be broken. <ref>https://whonix.org/Dev/Technical_Introduction#With_more_technical_terms</ref>

Qubes has its own [https://www.qubes-os.org/doc/reinstall-template/ template reinstall guide], however this guide on the Whonix website should be preferred for re-installation of Qubes-Whonix, because this guide is Whonix specific and contains instructions how to properly set up all settings. <ref>
Using salt.
</ref>


{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = '''Note:''' The root file system of the affected TemplateVM will be lost during the reinstallation process. It is recommended to create a backup of any important files first. 
}}


You can either:

* '''A)''' [[Qubes/Uninstall|Uninstall Qubes-Whonix]] and then [[Qubes/Install|Install Qubes-Whonix]], <u>OR</u>
* '''B)''' Follow the [[#Reinstall the Whonix TemplateVM|Reinstall the Whonix TemplateVM]] instructions below.

= Reinstall the Whonix TemplateVM =
== Qubes Version ==
{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px|alt=Whonix first time users warning]]
| text    = [https://forums.whonix.org/t/qubes-whonix-support-ending-for-qubes-3-2-upgrade-to-qubes-r4-0-or-above-required/6113 Qubes R4.0 or above required!]
}}

== UpdateVM Setting ==
Since only Fedora based UpdateVMs support <code>--action=upgrade</code> option for restalling the TemplateVM, it is recommended to create a dedicated Qubes dom0 UpdateVM based on Qubes Fedora template. Forcing dom0 updates over Tor is still possible by setting <code>sys-whonix</code> as NetVM for the UpdateVM. <ref>
* <code>sys-net</code> -> <code>sys-firewall</code> -> <code>sys-whonix</code> -> <code>UpdateVM</code>
* <code>UpdateVM</code> -> <code>sys-whonix</code> -> <code>sys-firewall</code> -> <code>sys-net</code>
</ref>

'''1.''' Create a new VM named <code>dom0-updatevm</code>.

{{Box|text=
* <code>Qubes VM Manager</code> -> <code>VM</code> -> <code>Create AppVM</code>
** Name and label: Name the AppVM. Don't include any personal information (if the AppVM is compromised, the attacker could run <code>qubesdb-read /name</code> to reveal the VM name). Name the AppVM something generic, for example: <code>dom0-updatevm</code>.
** Color: Choose a color label for the UpdateVM.
** Use this template: Choose the <u>Fedora</u> based TemplateVM. For example: <code>fedora-28</code>.
** Standalone: Leave the Standalone field unchecked.
** Type: Choose the type <code>AppVM</code>.
** Allow networking: Choose the desired NetVM from the list. For example: <code>sys-whonix</code>.
** Press: <code>OK</code>.
}}

'''2.''' Configure the NetVM setting of <code>dom0-updatevm</code>.
{{Box|text=
* <u>'''Option A)'''</u> If the user wants non-torified, clearnet Qubes dom0 updates, set the NetVM of <code>dom0-updatevm</code> for example to <code>sys-firewall</code>.
{{Box|text=
<code>Qube Manager</code> -> <code>dom0-updatevm</code> -> <code>Qube s<u>e</u>ttings</code> -> <code>Networking: sys-firewall</code> -> <code>OK</code> <ref>
{{CodeSelect|code=
qvm-prefs updatevm-name netvm sys-whonix
}}
</ref>
}}
* <u>'''Option B)'''</u> If the user wants torified Qubes dom0 updates, set the NetVM of <code>dom0-updatevm</code> to Whonix-Gateway.
{{Box|text=
<code>Qube Manager</code> -> <code>dom0-updatevm</code> -> <code>Qube s<u>e</u>ttings</code> -> <code>Networking: sys-whonix</code> -> <code>OK</code> <ref>
{{CodeSelect|code=
qvm-prefs updatevm-name netvm sys-whonix
}}
</ref>
}}
}}

'''3.''' The process of configuring the UpdateVM is now complete.

<ref>
If the dom0 UpdateVM is based on a template that is broken or no longer trusted, ref Template is broken, misconfigured or compromised ref an alternate UpdateVM can be used temporarily. In other words, more specifically, if the user no longer trusts its Whonix-Gateway TemplateVM (<code>{{whonix-gw}}</code>) and/or its Whonix-Gateway ProxyVM (<code>sys-whonix</code>), then configure Qubes dom0 to use a different UpdateVM by applying the following steps.

TODO
</ref>

== Update dom0 ==
{{Qubes_upgrade_dom0}}

== Reinstall ==
{{Box|text=
{{Qubes_Terminal}}

In the instructions below, first it will be checked if there is a newer version of the TemplateVM.

* If a newer TemplateVM version exists, install it. (<code>--action=upgrade</code>)
* If no newer TemplateVM version is available, reinstall the existing version. (<code>--action=reinstall</code>)

Unfortunately there is no combined upgrade and reinstall command. <ref>
[https://github.com/QubesOS/qubes-issues/issues/4518 qubes-dom0-update combined --action=upgrade --action=reinstall command]
</ref>

{{Box|text=
<u>Try upgrading</u> the TemplateVM.

This will only work if there is a new [[Point Release]] of the TemplateVM.

Execute the following command. Replace <code>qubes-template-package</code> with either: <code>qubes-template-whonix-ws-14</code> or <code>qubes-template-whonix-gw-14</code>, respectively. <ref>
{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qubes-templates*testing --action=upgrade <qubes-template-package>
}}
</ref>

{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qubes-templates-community --action=upgrade <qubes-template-package>
}}

For example, to reinstall and upgrade <code>whonix-gw-14</code> TemplateVM. <ref>
{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qubes-templates*testing --action=upgrade qubes-template-whonix-gw-14 
}}
</ref>

{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qubes-templates-community --action=upgrade qubes-template-whonix-gw-14 
}}

For example, to reinstall and upgrade <code>whonix-ws-14</code> TemplateVM. <ref>
{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qubes-templates*testing --action=upgrade qubes-template-whonix-ws-14 
}}
</ref>

{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qubes-templates-community --action=upgrade qubes-template-whonix-ws-14 
}}

Read the output of the above command. Possible outcomes, either:

* '''A)''' The TemplateVM gets upgraded. In that case you can skip the below section "Reinstall the TemplateVM". '''OR'''
* '''B)''' Above commands might finish relatively quickly and might say <code>No new updates available</code>. In that case, proceed with the section below "Reinstall the TemplateVM". '''OR'''
* '''C)''' TemplateVM upgrade is unsupported. This might happen if a non-Fedora based UpdateVM is used in conjunction with the <code>--action=upgrade</code> option. See:  [[Qubes/Reinstall#UpdateVM_Setting| UpdateVM Setting]] for more information. '''OR'''
* '''D)''' Some error such as networking issue.
}}

{{Box|text=
<u>Reinstall</u> the TemplateVM.

If above <code>--action=upgrade</code> did not actually reinstall the TemplateVM, it means that there is no new [[Point Release]] available at this point. It however also means, that the TemplateVM has not been actually reinstalled. To actually reinstall the TemplateVM, proceed as documented below.

If you are not sure, below commands are safe in any case. Should you already have the latest TemplateVM version, in worst case it would be re-installed yet another time, which is ok.

Execute the following command. Replace <code>qubes-template-package</code> with either: <code>qubes-template-whonix-ws-14</code> or <code>qubes-template-whonix-gw-14</code>, respectively.

{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qubes-templates-community --action=reinstall <qubes-template-package>
}}

For example, to reinstall <code>whonix-gw-14</code> TemplateVM. 

{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qubes-templates-community --action=reinstall qubes-template-whonix-gw-14 
}}

For example, to reinstall <code>whonix-ws-14</code> TemplateVM. 

{{CodeSelect|code=
sudo qubes-dom0-update --enablerepo=qubes-templates-community --action=reinstall qubes-template-whonix-ws-14 
}}

Read the output of the above command. Possible outcomes, either:

* '''A)''' The TemplateVM got reinstalled. '''OR'''
* '''B)''' Some error such as networking issue.
}}
}}

== Settings ==
Use <code>salt</code> for dom0 settings setup. <ref>
[[Dev/Qubes#salt]]
</ref>

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text    = This step is mandatory. <ref>
[https://github.com/QubesOS/qubes-issues/issues/3447 phase out manual use of qubes-dom0-update by user / replace it by salt]
</ref>
}}

{{CodeSelect|code=
sudo qubesctl state.sls qvm.anon-whonix
}}

== Optional Whonix DVM Template VM ==
{{Qubes Install DVM}}

== Optional Updates over Tor ==
{{Qubes Install Updates over Tor}}

== Optional: Enable AppArmor ==
{{Qubes_AppArmor}}

== Restart TemplateBasedVMs ==
Any VMs based on the reinstalled TemplateVM must be restarted to reflect the updated file system.

== Update and Launch Applications ==
{{Qubes Install Update and Launch Applications}}

== Done ==
The process to reinstall Whonix TemplateVMs is now complete. Users should disregard the chapter Manual Reinstallation below.

----

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
