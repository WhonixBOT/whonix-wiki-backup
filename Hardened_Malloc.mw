{{Header}}
{{#seo:
|description=Hardened Memory Allocator for many Applications to increase Security - installation from Whonix repository
|image=https://www.whonix.org/w/images/0/06/Malloc423.jpg
}}
[[image:Malloc423.jpg|thumb]]
= Introduction =

Hardened Malloc is a hardened memory allocator which can be used with many applications to increase security.

According to the author's GitHub description: <ref>https://github.com/GrapheneOS/hardened_malloc</ref>

<blockquote>
This is a security-focused general purpose memory allocator providing the malloc API along with various extensions. It provides substantial hardening against heap corruption vulnerabilities. The security-focused design also leads to much less metadata overhead and memory waste from fragmentation than a more traditional allocator design. It aims to provide decent overall performance with a focus on long-term performance and memory usage rather than allocator micro-benchmarks. It offers scalability via a configurable number of entirely independently arenas, with the internal locking within arenas further divided up per size class.
</blockquote>

Readers who wish to discuss the integration of Hardened Malloc with Whonix should refer to [https://forums.whonix.org/t/hardened-malloc/7474 this forum thread].

= Installation =

Hardened Malloc is available from the Whonix and [[Kicksecure]] APT repository. <ref>https://github.com/Whonix/hardened_malloc</ref> Users of these Linux distributions can install it easily with the following instructions.

Users of Debian (-based) Linux distributions other than Whonix or Kicksecure need to first add the Whonix APT repository, which is documented on the [[Whonix Packages for Debian Hosts]] wiki page. For other distributions, refer to the [[Hardened Malloc/Manual Installation|Hardened Malloc Manual Installation]] instructions.

{{Install Package|
package=hardened-malloc
}}

= How-to: Launch Applications with Hardened Malloc =
== Systemd Services ==

To launch individual systemd services with hardened malloc, add a drop-in systemd configuration snippet.

{{CodeSelect|code=
Environment="LD_PRELOAD='/usr/lib/libhardened_malloc.so/libhardened_malloc.so'"
}}

== Other Applications ==

To launch other applications with Hardened Malloc, the <code>LD_PRELOAD</code> environment variable must be edited before starting the application. For example, to launch <code>application-name</code> in this way, run.

{{CodeSelect|code=
LD_PRELOAD='/usr/lib/libhardened_malloc.so/libhardened_malloc.so' application-name
}}

== All Applications by Default ==

<u>Note</u>: This action may break numerous applications such as man, apt or Xorg.

It is possible to make all applications use Hardened Malloc as the default memory allocator. To configure this option, the path to the <code>hardened_malloc.so</code> library must be added to the <code>/etc/ld.so.preload</code> file. <ref>
feature request: [https://sourceware.org/bugzilla/show_bug.cgi?id=24913 <code>/etc/ld.so.preload.d</code> drop-in configuration folder support]
</ref>

{{Box|text=
'''1.''' 
{{Open with root rights|filename=
/etc/ld.so.preload
}}

'''2.''' Add the <code>hardened_malloc.so</code> library.

{{CodeSelect|code=
/usr/lib/libhardened_malloc.so/libhardened_malloc.so
}}

'''3.''' Save the file.

The procedure is complete.
}}

== Incompatible Applications ==
=== Browsers ===

Using Hardened Malloc with Tor Browser, Firefox or [[SecBrowser|SecBrowser â„¢]] is difficult and [[unsupported]]. <ref name=firefox-based>
These browsers are all based on Firefox, therefore the following applies equally to each of them.

<blockquote>
LD_PRELOAD='/path/to/libhardened_malloc.so' /path/to/program will do nothing or approximately nothing.
</blockquote>

The reason is recompilation is necessary.

<blockquote>
To successfully replace Firefox memory allocator you should either use LD_PRELOAD _with_ a --disable-jemalloc build OR Firefox's replace_malloc functionality:
https://searchfox.org/mozilla-central/source/memory/build/replace_malloc.h

Sources:

* https://lists.torproject.org/pipermail/tor-dev/2019-August/013982.html
* https://lists.torproject.org/pipermail/tor-dev/2019-August/013990.html
</blockquote>
</ref>

It is unknown whether other browsers can benefit from Hardened Malloc.

=== Others ===
Other applications might not easily benefit from Hardened Malloc for the same reasons outlined in the [[#Browsers|browsers]] section above.

Whether an application can benefit from Hardened Malloc or not depends on technical implementation details of the application in question. Vendors of applications will probably know if their application is compatible with Hardened Malloc. Community wiki contributions are most welcome -- please post any additional vendor Q&As here.

= Credits and Source Code =

The [https://github.com/GrapheneOS/hardened_malloc original] source software is maintained by security researcher, Daniel Micay.

[https://www.whonix.org/wiki/Hardened_Malloc This website] is the [https://en.wikipedia.org/wiki/Fork_(software_development) software fork] homepage for Hardened Malloc, with a focus on easy installation, added user documentation, and integration with [[Whonix]], [[Kicksecure]], Debian, and other distributions. The Whonix software fork source code can be found [https://github.com/Whonix/hardened_malloc here]. Continuous integration: [https://travis-ci.com/github/Whonix/hardened_malloc travis CI]

= Hardened Malloc Kicksecure Fork =
In development.

Forum development discussion: <br />
https://forums.whonix.org/t/hardened-malloc-hardened-memory-allocator/7474/69

<pre>
/usr/lib/libhardened_malloc.so/libhardened_malloc_kicksecure.so
</pre>

== Disable ==
Apply the following steps to disable hardened-malloc-kicksecure.

'''1)''' Boot into recovery mode. Optional.

This is only required if the system is no longer bootable. In this case, refer to [[Recovery#Recovery_Mode|boot into recovery mode]].

'''2)''' View the <code>/etc/ld.so.preload</code> file.

{{CodeSelect|code=
cat /etc/ld.so.preload
}}

'''3)''' Remove <code>/usr/lib/libhardened_malloc.so/libhardened_malloc_kicksecure.so</code> from <code>/etc/ld.so.preload</code>.

If not using <code>/etc/ld.so.preload</code> for anything else. Warning: this removes all entries from <code>/etc/ld.so.preload</code>.

{{CodeSelect|code=
sudo rm /etc/ld.so.preload
}}

== Issues ==
hot CPU issue

sudo apt purge rtkit


swap file creator do not run off if not on


sudo mandb -cq
mandb: zcat: Bad system call (core dumped)
...


breaks gsmartcontrol?

https://packages.debian.org/bullseye/powercap-utils

powercap intel-rapl:0: package locked by BIOS, monitoring only
https://github.com/intel/thermal_daemon/issues/148#issuecomment-388573608




sudo apt install linux-cpupower
sudo cpupower frequency-set --governor powersave

modprobe: ERROR: ../libkmod/libkmod-module.c:979 command_do() Error running install command for msr
modprobe: ERROR: could not insert 'msr': Operation not permitted
Setting cpu: 0
Setting cpu: 1
Setting cpu: 2
Setting cpu: 3

/etc/modprobe.d/30_security-misc.conf
install msr /bin/false




vbox log
all OK
no more log entries for 30 minutes while VM is working OK
00:18:45.237389 VirtualBoxClient: detected unresponsive VBoxSVC (rc=NS_ERROR_CALL_FAILED)
00:19:16.904964 VirtualBoxClient: detected working VBoxSVC (rc=NS_OK)

VBoxSVC.log
all OK
no more log entries for 30 minutes while VM is working OK
no new log entry after crash
The log ends there after crash then becomes
~/.config/VirtualBox/VBoxSVC.log.1




https://www.virtualbox.org/wiki/Core_dump

quote

VM
Note that this core dump can contain a memory dump of your guest which can include sensitive information.

Privacy information: Also be aware that the above kernel dumps could contain unrelated sensitive and private information about you and your system, e.g. stored passwords in memory. Unfortunately this is unavoidable in those situations, as a kernel dump essentially is an unmodified and unfiltered part of your computer's RAM (main memory).


tail -f ~/.config/VirtualBox/VBoxSVC.log

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
