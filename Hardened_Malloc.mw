{{Header}}
{{#seo:
|description=Hardened Memory Allocator for many Applications to increase Security - installation from Whonix repository
|image=https://www.whonix.org/w/images/0/06/Malloc423.jpg
}}
[[image:Malloc423.jpg|thumb]]
= Introduction =

Hardened Malloc is a hardened memory allocator which can be used with many applications to increase security.

According to the author's GitHub description: <ref>https://github.com/GrapheneOS/hardened_malloc</ref>

<blockquote>
This is a security-focused general purpose memory allocator providing the malloc API along with various extensions. It provides substantial hardening against heap corruption vulnerabilities. The security-focused design also leads to much less metadata overhead and memory waste from fragmentation than a more traditional allocator design. It aims to provide decent overall performance with a focus on long-term performance and memory usage rather than allocator micro-benchmarks. It offers scalability via a configurable number of entirely independently arenas, with the internal locking within arenas further divided up per size class.
</blockquote>

Readers who wish to discuss the integration of Hardened Malloc with Whonix should refer to [https://forums.whonix.org/t/hardened-malloc/7474 this forum thread].

= Installation =

Hardened Malloc is available from the Whonix and [[Kicksecure]] APT repository. <ref>https://github.com/Whonix/hardened_malloc</ref> Users of these Linux distributions can install it easily with the following instructions.

Users of Debian (-based) Linux distributions other than Whonix or Kicksecure need to first add the Whonix APT repository, which is documented on the [[Whonix Packages for Debian Hosts]] wiki page. For other distributions, refer to the [[Hardened Malloc/Manual Installation|Hardened Malloc Manual Installation]] instructions.

{{Install Package|
package=hardened-malloc
}}

= How-to: Launch Applications with Hardened Malloc =
== Systemd Services ==

To launch individual systemd services with hardened malloc, add a drop-in systemd configuration snippet.

{{CodeSelect|code=
Environment="LD_PRELOAD='/usr/lib/libhardened_malloc.so/libhardened_malloc.so'"
}}

== Other Applications ==

To launch other applications with Hardened Malloc, the <code>LD_PRELOAD</code> environment variable must be edited before starting the application. For example, to launch <code>application-name</code> in this way, run.

{{CodeSelect|code=
LD_PRELOAD='/usr/lib/libhardened_malloc.so/libhardened_malloc.so' application-name
}}

== All Applications by Default ==

<u>Note</u>: This action may break numerous applications such as man, apt or Xorg.

It is possible to make all applications use Hardened Malloc as the default memory allocator. To configure this option, the path to the <code>hardened_malloc.so</code> library must be added to the <code>/etc/ld.so.preload</code> file. <ref>
feature request: [https://sourceware.org/bugzilla/show_bug.cgi?id=24913 <code>/etc/ld.so.preload.d</code> drop-in configuration folder support]
</ref>

{{Box|text=
'''1.''' 
{{Open with root rights|filename=
/etc/ld.so.preload
}}

'''2.''' Add the <code>hardened_malloc.so</code> library.

{{CodeSelect|code=
/usr/lib/libhardened_malloc.so/libhardened_malloc.so
}}

'''3.''' Save the file.

The procedure is complete.
}}

== Incompatible Applications ==
=== Browsers ===

Using Hardened Malloc with Tor Browser, Firefox or [[SecBrowser|SecBrowser â„¢]] is difficult and [[unsupported]]. <ref name=firefox-based>
These browsers are all based on Firefox, therefore the following applies equally to each of them.

<blockquote>
LD_PRELOAD='/path/to/libhardened_malloc.so' /path/to/program will do nothing or approximately nothing.
</blockquote>

The reason is recompilation is necessary.

<blockquote>
To successfully replace Firefox memory allocator you should either use LD_PRELOAD _with_ a --disable-jemalloc build OR Firefox's replace_malloc functionality:
https://searchfox.org/mozilla-central/source/memory/build/replace_malloc.h

Sources:

* https://lists.torproject.org/pipermail/tor-dev/2019-August/013982.html
* https://lists.torproject.org/pipermail/tor-dev/2019-August/013990.html
</blockquote>
</ref>

It is unknown whether other browsers can benefit from Hardened Malloc.

=== Others ===
Other applications might not easily benefit from Hardened Malloc for the same reasons outlined in the [[#Browsers|browsers]] section above.

Whether an application can benefit from Hardened Malloc or not depends on technical implementation details of the application in question. Vendors of applications will probably know if their application is compatible with Hardened Malloc. Community wiki contributions are most welcome -- please post any additional vendor Q&As here.

= Credits and Source Code =

The [https://github.com/GrapheneOS/hardened_malloc original] source software is maintained by security researcher, Daniel Micay.

[https://www.whonix.org/wiki/Hardened_Malloc This website] is the [https://en.wikipedia.org/wiki/Fork_(software_development) software fork] homepage for Hardened Malloc, with a focus on easy installation, added user documentation, and integration with [[Whonix]], [[Kicksecure]], Debian, and other distributions. The Whonix software fork source code can be found [https://github.com/Whonix/hardened_malloc here]. Continuous integration: [https://travis-ci.com/github/Whonix/hardened_malloc travis CI]

= Footnotes =
{{reflist|close=1}}

= Hardened Malloc Kicksecure Fork =
== Issues ==
=== Chromium ===
<pre>
chromium 
fatal allocator error: invalid uninitialized allocator usage
Received signal 6
#0 0x59425ffb3529 (/usr/lib/chromium/chromium+0x51f9528)
#1 0x59425ff11253 (/usr/lib/chromium/chromium+0x5157252)
#2 0x59425ffb30b1 (/usr/lib/chromium/chromium+0x51f90b0)
#3 0x7b3117dfd730 (/usr/lib/x86_64-linux-gnu/libpthread-2.28.so+0x1272f)
#4 0x7b3111cbe7bb gsignal
#5 0x7b3111ca9535 abort
#6 0x7b3117e32076 (/usr/lib/libhardened_malloc.so/libhardened_malloc_kicksecure.so+0x7075)
#7 0x7b3117e311bf malloc_usable_size
#8 0x594260da4ed9 (/usr/lib/chromium/chromium+0x5feaed8)
#9 0x594260e6be4f (/usr/lib/chromium/chromium+0x60b1e4e)
#10 0x594260db5d40 (/usr/lib/chromium/chromium+0x5ffbd3f)
#11 0x594260d9c6ea (/usr/lib/chromium/chromium+0x5fe26e9)
#12 0x594260d971a6 (/usr/lib/chromium/chromium+0x5fdd1a5)
#13 0x594260d96f02 (/usr/lib/chromium/chromium+0x5fdcf01)
#14 0x594261511d9f (/usr/lib/chromium/chromium+0x6757d9e)
#15 0x594261513352 (/usr/lib/chromium/chromium+0x6759351)
#16 0x5942615131ee (/usr/lib/chromium/chromium+0x67591ed)
#17 0x59425ff5fa82 (/usr/lib/chromium/chromium+0x51a5a81)
#18 0x59425ff75662 (/usr/lib/chromium/chromium+0x51bb661)
#19 0x59425ff750a6 (/usr/lib/chromium/chromium+0x51bb0a5)
#20 0x59425ffc29ab (/usr/lib/chromium/chromium+0x52089aa)
#21 0x59425ff74c32 (/usr/lib/chromium/chromium+0x51bac31)
#22 0x59425ff81e76 (/usr/lib/chromium/chromium+0x51c7e75)
#23 0x59425ff81b91 (/usr/lib/chromium/chromium+0x51c7b90)
#24 0x59425ffc318e (/usr/lib/chromium/chromium+0x520918d)
#25 0x7b3117df2fa3 start_thread
#26 0x7b3111d804cf clone
  r8: 0000000000000000  r9: 00007b30ca7fa9b0 r10: 0000000000000008 r11: 0000000000000246
 r12: 00007b30ca7faec8 r13: 0000000000000000 r14: 0000000000000028 r15: 0000594264ad5910
  di: 0000000000000002  si: 00007b30ca7fa9b0  bp: 00007b30ca7fac60  bx: 0000000000000006
  dx: 0000000000000000  ax: 0000000000000000  cx: 00007b3111cbe7bb  sp: 00007b30ca7fa9b0
  ip: 00007b3111cbe7bb efl: 0000000000000246 cgf: 002b000000000033 erf: 0000000000000000
 trp: 0000000000000000 msk: 0000000000000000 cr2: 0000000000000000
[end of stack trace]
Calling _exit(1). Core file will not be generated.
</pre>

{{Footer}}

[[Category:Documentation]]
