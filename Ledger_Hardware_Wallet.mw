{{Header}}
{{#seo:
|description=HowTo: Ledger Hardware Wallet with Qubes
}}
{{Title|
title=HowTo: Ledger Hardware Wallet with Qubes
}}
{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = [[Qubes-Whonix]] testers only!
}}
{{#widget:Expand or Collapse All}}

= Introduction =
[https://www.ledgerwallet.com/ Ledger wallets] are a special type of commercial bitcoin wallet whereby a user's private keys are stored in a secure hardware device. Other commercial alternatives include Pi Wallet, TREZOR, BWALLET, KeepKey, Opendime, CoolWallet and others.

The major advantages of hardware wallets over software wallets include: <ref>https://en.bitcoin.it/wiki/Hardware_wallet</ref>

* Usually private keys are stored in a protected area of a microcontroller, and cannot be transferred out of the device in plaintext.
* Resistance to computer viruses that target theft from software wallets.
* More secure and interactive than paper wallets that require importation to software.
* Usually software on the device is open source.


The main principle is that cryptographic secrets (private keys) are fully isolated from easy-to-hack computers or smartphones. Ledger wallets use secure chips that are similar to the technology used in chip and PIN payment cards or SIM cards. <ref>https://ledger.zendesk.com/hc/en-us/articles/115005198485-Hardware-wallets-FAQ</ref>

= Security Risks =
{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text       = '''Warning:''' Hardware wallets are not bulletproof. The user must be sure to purchase a good-quality, authentic device manufactured by a trustworthy and technically competent company with a good reputation in security.
}}


Potential risks of hardware wallets include: <ref>https://en.bitcoin.it/wiki/Hardware_wallet</ref>

*  Malware swapping recipient Bitcoin addresses. Malware on a PC could potentially trick the user into sending Bitcoin to the wrong address. Multi-factor confirmation of a recipient's Bitcoin address mitigates this risk.
* Insecure RNG (Random Number Generator). Security is reliant on true randomness being generated by the source of entropy for the RNG, since it generates the wallet's private keys. This is hard to verify, and attackers may be able to recreate wallet keys if the RNG is insecure. <ref>The attacker generates psuedo-randomness that is indistinguishable from true randomness, but is still predictable.</ref>
* Imperfect implementation. If bugs are present in the software, firmware or hardware, then attackers may be able to gain unauthorized access to the hardware wallet. 
* Compromised production process. Hardware backdoors could be introduced via intentional or unintentional actions that leaves security holes in the final product.
* Device interdiction. No hardware wallet solution can deal with the threat of government programs that intercept hardware and modify them in transit to introduce backdoors.


Despite these risks, hardware wallets are considered a higher security solution than software wallets, since the latter must make private keys available in plain text in the computer's memory when transactions are signed - any compromise by Bitcoin-targeting malware would enable theft of Bitcoins. <ref>https://ledger.zendesk.com/hc/en-us/articles/115005198485-Hardware-wallets-FAQ</ref>

= Seed Backup Security =
Definitively good to have at least two ledger hardware wallets. During initial setup, the ledger does not verify all words of the seed. It only verifies 2 words of the 24 words seed. Meaning, when mistyping one word, one will later have trouble regaining access to ones coins. Two ledgers using the same seed should be generating the same addresses, which would proof, that one made a correct backup of the seed.

There is a [https://www.reddit.com/r/ledgerwallet/comments/6ez4qs/ledger_nano_s_seed_utility_app_released/ seed testing app], but by a third party, which adds complications and therefore is probably best avoided.

Alternatively, one could note some generated addresses, reset its ledger, re-setup with the seed and see if it still uses the same addresses.

= Wallet Testing Security =
Before storing any non-petty cash in a wallet, it is a good idea to send there only a small amount and then trying to send it back. This is because software bugs could lead to showing an address where one does not own its corresponding private key.

Such an incident where someone lost money because of such a software bug already happened with a different wallet, see the following [https://www.reddit.com/r/ethereum/comments/48rt6n/using_myetherwalletcom_just_burned_me_for/ user story] ([http://www.webcitation.org/6ucscCGxX w]).

= Threat Model =
TODO: explain better

The term account number will be used rather than address to avoid confusion in the following writeup.

Hardware wallets seek to secure the funds of users under the sane assumption, that the computer that the user is using may be compromised, i.e. infected by [[Malware]]. Once infected by malware, the malware can see everything the user can see without the user noticing, manipulate the user's screen (showing one account number while it should show another account number), see all key strokes (sniff passwords), download files and other things.

Therefore the computer display is considered untrusted. The display of the hardware device is considered trusted. This is because only the vendor enforce that only software signed by the hardware vendor can be used. Therefore unless these cryptographic verification process can be subverted, the hardware wallet is considered to be free of malware and therefore a secure display.

Once funds are on the devices they are safe, but getting the funds safely onto the device is not easy under this threat model.

Show account number on device

* The [https://chrome.google.com/webstore/detail/ledger-wallet-bitcoin/kkdpmhnladdopljabkgpacgpliggeeaf Ledger Wallet Bitcoin] has a "show address on device" button, which shows the account number on the secure ledger display.
* The [https://www.ledgerwallet.com/apps/ethereum Ledger Wallet Ethereum] and other wallets had no such function at the time of writing.
* myetherwallet has a show account number on device feature, but myetherwallet is browser based and should therefore be avoided (even when running locally). Usage of myetherwallet locally in conjunction with ledger hardware wallet is very difficult due to browser issues. <ref>
https://github.com/kvhnuke/etherwallet/issues/558#issuecomment-307307105
</ref>
* Conclusion: The regular user of the ledger hardware wallet will have a hard time figuring out its recipient account number in a secure manner not fraudulently modified by malware running on its computer.


Securely receiving money difficulty

* When receiving money (such as withdrawing money from crypto currency exchange) the account number is entered into the computer (insecure display). It could be modified by malware to redirect the withdraw to the attacker.
* Even if money has been received on the device, the balance is not shown on the hardware wallet secure display, meaning the user might believe to have received more than the user did receive.


Time of compromise matters

* Once funds are on the hardware wallet these are safe until the user attempts to spent them.
* So when the user's computer gets compromised later after stocking up funds, the user looses less but is then affacted by the difficulty of securely reviving money difficulty issue.


Sending money

* When sending money (to merchants or crypto currency exchanges), the recipient account number is shown on the computer (insecure display). It could be modified by malware to redirect the receiving account number to the attacker. Since the hardware wallet secure display will ask for confirmation (account number and amount), at least smaller transactions are protected. For example if the user has 1 Bitcoin but only wants to send 0.1 Bitcoin, the user has a chance to abort the transaction if the ledger display asks to confirm a transaction of more than expected.


Physical security

* When the hardware wallet and/or computer gets stolen, all funds are safe. (Under the assumption that the attacker is unable to circumvent the hardware wallet PIN entry and/or to otherwise extract the keys from the device.)
* If the user stored its hardware wallet and PIN in the same place and loose it, all funds will be lost.
* If the mnemonic phrase gets lost, all funds will be lost.
* Easier to keep private keys secured than computer full disk encryption. (Protections by hardware wallet secure element are not necessarily stronger than computer full disk encryption such as linux with luks.)


Usability

* more obscure to attack than "simple trojan horse": yes
* usability: easier to safely spit bitcoin / bitcoin cash / bitcoin gold
* easy to carry: yes
* easier than Qubes OS (offline vault VM): yes

* safer when doing a transaction during a meetup: yes

= Installation =
{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = If using the Nano S, Nano or HW1 ledger hardware wallets, a USB port is required.
}}

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = Comes with some technical challenges. Try first if you can pass a USB device to an AppVM which is easier to use in combination with Qubes to learn how to do that and to iron out eventual Qubes USBVM issues.
}}

== Qubes USB Proxy Installation ==
Mandatory for [[Qubes]] users.

{{Update}}

{{CodeSelect|code=
sudo apt-get update
}}

Install Qubes USB Proxy. <ref>
https://github.com/QubesOS/qubes-issues/issues/2473#issuecomment-273634599
</ref>

{{CodeSelect|code=
sudo apt-get install qubes-usb-proxy
}}

== Chromium Installation ==
Chromium is required to use the run the Chrome applications ledger bitcoin and ledger ethereum. No additional software installation or account creation is needed.

In Qubes TemplateVM.

Open a terminal (konsole). 

{{Update}}

{{CodeSelect|code=
sudo apt-get update
}}

Install Chromium.

{{CodeSelect|code=
sudo apt-get install chromium
}}

== electrum Installation ==
Optional. Only in case you want to install electrum.

{{Update}}

{{CodeSelect|code=
sudo apt-get update
}}

Install electrum and dependencies for electrum ledger hardware wallet support. <ref>
https://ledger.groovehq.com/knowledge_base/topics/how-to-setup-electrum-nano-slash-nano-s
</ref>

Currently does not work easily in Whonix 13 due to <code>libudev-dev</code> dependency issues. Meanwhile Debian stretch or later Whonix 14 should work.

{{CodeSelect|code=
apt-get install electrum libusb-1.0-0-dev libudev-dev python-btchip
}}

<ref>
Required? <code>ln -s /lib/x86_64-linux-gnu/libudev.so.1 /lib/x86_64-linux-gnu/libudev.so</code> Required?
</ref>

== udev Rules ==
In Qubes TemplateVM.

Open a terminal (konsole). <ref>Further research is required to confirm this step is required.</ref>

{{CodeSelect|code=
sudo adduser user plugdev
}}

{{Open with root rights
|filename=/etc/udev/rules.d/20-hw1.rules
}}

Add. <ref>
https://ledger.groovehq.com/knowledge_base/topics/ledger-wallet-is-not-recognized-on-linux
</ref>

{{CodeSelect|code=
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2581", ATTRS{idProduct}=="1b7c", MODE="0660", OWNER="user", GROUP="plugdev"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2581", ATTRS{idProduct}=="2b7c", MODE="0660", OWNER="user", GROUP="plugdev"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2581", ATTRS{idProduct}=="3b7c", MODE="0660", OWNER="user", GROUP="plugdev"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2581", ATTRS{idProduct}=="4b7c", MODE="0660", OWNER="user", GROUP="plugdev"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2581", ATTRS{idProduct}=="1807", MODE="0660", OWNER="user", GROUP="plugdev"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2581", ATTRS{idProduct}=="1808", MODE="0660", OWNER="user", GROUP="plugdev"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2c97", ATTRS{idProduct}=="0000", MODE="0660", OWNER="user", GROUP="plugdev"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2c97", ATTRS{idProduct}=="0001", MODE="0660", OWNER="user", GROUP="plugdev"

KERNEL=="hidraw*", SUBSYSTEM=="hidraw", MODE="0660", OWNER="user", GROUP="plugdev", ATTRS{idVendor}=="2c97"
KERNEL=="hidraw*", SUBSYSTEM=="hidraw", MODE="0660", OWNER="user", GROUP="plugdev", ATTRS{idVendor}=="2581"
}}

Save.

Shut down Qubes TemplateVM.

Start the VM which is supposed to interact with the ledger hardware wallet, which we will call <code>ledger VM</code>.

== Ledger App Installation ==
<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
For graphical user interface instructions, which are easier but less secure, click on expand on the right.
<div class="mw-collapsible-content">
'''Ledger Manager'''

https://chrome.google.com/webstore/detail/ledger-manager/beimhnaefocolcplfimocfiaiefpkgbf

'''Ledger Wallet Bitcoin'''

https://chrome.google.com/webstore/detail/ledger-wallet-bitcoin/kkdpmhnladdopljabkgpacgpliggeeaf

'''Ledger Wallet Ethereum'''

https://chrome.google.com/webstore/detail/ledger-wallet-ethereum/hmlhkialjkaldndjnlcdfdphcgeadkkm

'''Ledger Wallet Ripple'''

[[Undocumented]]. Please refer to command line instructions below or to instructions on the ledger hardware wallet homepage.

https://www.ledgerwallet.com/apps/ripple
</div>
</div>

<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
For graphical user interface instructions, which are easier but less secure, click on expand on the right.
<div class="mw-collapsible-content">
'''Security'''

These instructions are more secure, because we are using <code>{{Chrome web store only}}</code>, which results in only connections to Google (i.e. the Chrome Web Store) are allowed. Any other (accidental) connections to other destinations which could be harmful for privacy or security are prevented.

'''Ledger Manager'''

Run.

{{CodeSelect|code=
chromium {{Chrome web store only}} https://chrome.google.com/webstore/detail/ledger-manager/beimhnaefocolcplfimocfiaiefpkgbf
}}

'''Ledger Wallet Bitcoin'''

Run.

{{CodeSelect|code=
chromium {{Chrome web store only}} https://chrome.google.com/webstore/detail/ledger-wallet-bitcoin/kkdpmhnladdopljabkgpacgpliggeeaf
}}

'''Ledger Wallet Ethereum'''

Run.

{{CodeSelect|code=
chromium {{Chrome web store only}} https://chrome.google.com/webstore/detail/ledger-wallet-ethereum/hmlhkialjkaldndjnlcdfdphcgeadkkm
}}

'''Ledger Wallet Ripple'''

{{Open a Whonix-Workstation Terminal}}

Run.

{{CodeSelect|code=
curl {{Curl_Secure}} --location --remote-name https://apps.ledgerwallet.com/ripple/download/linux_deb_64.deb
}}
</div>
</div>

= Usage =
Physically connect the ledger hardware wallet to a USB port.

Enter the PIN.

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = Qubes won't detect ledger before the PIN has been entered. Guess: ledger does not announce itself before that.
}}

Start your <code>ledger VM</code>.

== Ledger Apps ==
Using Graphical user Interface

<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
For graphical user interface instructions, which are easier but less secure, click on expand on the right.
<div class="mw-collapsible-content">
'''Ledger Manger / Ledger Wallet Bitcoin / Ledger Wallet Ethereum'''

Start chromium.

Click apps.

Choose a ledger app and start it.

You can also refer to the instructions on the ledger hardware wallet website.

https://www.ledgerwallet.com/apps

'''Ledger Wallet Ripple'''

[[Undocumented]]. Please refer to command line instructions below or to instructions on the ledger hardware wallet homepage.
</div>
</div>

Using Command Line

<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
For command line instructions, which have worse usability but are more secure, click on expand on the right.
<div class="mw-collapsible-content">
'''Security'''

These instructions are more secure, because we are using <code>chromium</code> command line switch <code>--app-id=app-id</code>, which results in only starting the ledger app, so we limit outgoing connections to a minimum.

'''Ledger Manager'''

Run. <ref name=local>
Using <code>--host-rules="MAP * 127.0.0.1, EXCLUDE 127.0.0.1"</code> won't work.
</ref>

{{CodeSelect|code=
chromium --app-id=beimhnaefocolcplfimocfiaiefpkgbf
}}

'''Ledger Wallet Bitcoin'''

Run. <ref name=local />

{{CodeSelect|code=
chromium --app-id=kkdpmhnladdopljabkgpacgpliggeeaf
}}

'''Ledger Wallet Ethereum'''

Run. <ref name=local />

{{CodeSelect|code=
chromium --app-id=hmlhkialjkaldndjnlcdfdphcgeadkkm
}}

'''Ledger Wallet Ripple'''

Run.

{{CodeSelect|code=
sudo dpkg -i linux_deb_64.deb
}}
</div>
</div>

== electrum ==
{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = INFO: electrum crash bug in Debian stretch / Whonix 13 / 14 when trying to use a hardware wallet: Ledger Bitcoin App must be opened on the Ledger Hardware Wallet, otherwise electrum will crash. <ref>
<code>btchip.btchipException.BTChipException: Exception : Invalid status 6d00</code>

https://github.com/spesmilo/electrum/issues/1987

https://github.com/spesmilo/electrum/commit/4a5bece492876ff6a1cef1102db5572c8065a655#diff-0c426f356aa8b9f429e69bf86ebc422eR153

This bug is in the Debian stretch version of electrum and only fixed in a later version.
</ref>
}}

= Troubleshooting =
== Qubes R3.2 ==
Closing an Ledger app results in the USB device being disconnected from the <code>Ledger VM</code>. You have to re-attach it.

Sometimes the ledger manager app works consistently, but the ledger bitcoin app does not connect. In that case,

1) See overview of USB devices.

{{CodeSelect|code=
qvm-usb
}}

2) Remove USB device.

{{CodeSelect|code=
qvm-usb d sys-usb:4-3
}}

3) Physically disconnect the Ledger Hardware Wallet.

4) Physically re-connect the Ledger Hardware Wallet.

5) Connect the Ledger Hardware Wallet to the <code>Ledger VM</code>.

{{CodeSelect|code=
qvm-usb a ledger sys-usb:4-3
}}

6) Start Ledger App.

== Qubes R4 ==
Qubes R4 USB widget has some (maybe yet to be reported) bugs such as showing that USB device is connected to a VM while <code>qvm-usb</code> (the command line authority who's judgment should be trusted more) disagrees or showing the same USB device more than once in the menu. <ref>
[https://github.com/QubesOS/qubes-issues/issues/3266 USB devices shown multiple times in devices popup menu #3266]
</ref>

Physically connect the ledger hardware wallet to a USB port.

Run the following command to get an overview of USB devices detected by Qubes.

{{CodeSelect|code=
qvm-usb
}}

Should show something like this.

<pre>
BACKEND:DEVID  DESCRIPTION               USED BY
sys-usb:2-1.1  Logitech_USB_Keyboard     
sys-usb:2-1.2  PixArt_USB_Optical_Mouse  
sys-usb:2-1.4  Ledger_Nano_S_0001        
</pre>

Use the following command to connect the ledger hardware wallet to a VM of your choice. Replace <code>ledger-debian-stretch</code> with the actual name of your VM.

{{CodeSelect|code=
qvm-usb attach ledger-debian-stretch sys-usb:2-1.4
}}

== BIOS ==
The USB device might be passed to the <code>ledger VM</code>, but ledger apps might not recognize the ledger hardware wallet. In that case, in BIOS settings...

* try to disable <code>Legacy USB Support</code>
* try to disable <code>XHCI Pre-Boot Mode</code>
* try flipping other USB related BIOS options

No re-installation of Qubes required.

== Ledger ==
Try to connect to Ledger Manager first.

Try to update the firmware of the Ledger hardware wallet by connecting it to a non-Qubes Linux computer where connections are possibly using Ledger Manager.

See also [[Dev/Ledger Hardware Wallet]].

= Footnotes =
<references />

{{Footer}}

[[Category:Documentation]]
