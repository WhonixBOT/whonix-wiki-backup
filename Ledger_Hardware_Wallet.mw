{{Header}}
{{#seo:
|description=How-to: Ledger Hardware Wallet with Qubes
|image=https://www.whonix.org/w/images/1/13/Hardware-159264640.png
}}
{{Title|
title=How-to: Ledger Hardware Wallet with Qubes
}}
{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = [[{{q project name short}}|{{q project name}}]] testers only!
}}
{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text    = The concepts in this chapter are still valid but the applications and corresponding installation instructions may have changed in the meantime.
}}
{{#widget:Expand or Collapse All}}

= Introduction =
[https://www.ledgerwallet.com/ Ledger wallets] are a special type of commercial bitcoin wallet whereby a user's private keys are stored in a secure hardware device. Other commercial alternatives include Pi Wallet, TREZOR, BWALLET, KeepKey, Opendime, CoolWallet and others.

The major advantages of hardware wallets over software wallets include: <ref>https://en.bitcoin.it/wiki/Hardware_wallet</ref>

* Usually private keys are stored in a protected area of a microcontroller, and cannot be transferred out of the device in plaintext.
* Resistance to computer viruses that target theft from software wallets.
* More secure and interactive than paper wallets that require importation to software.
* Usually software on the device is open source.

The main principle is that cryptographic secrets (private keys) are fully isolated from easy-to-hack computers or smartphones. Ledger wallets use secure chips that are similar to the technology used in chip and PIN payment cards or SIM cards. <ref>https://ledger.zendesk.com/hc/en-us/articles/115005198485-Hardware-wallets-FAQ</ref>

= Security Factors =

== Security Risks ==

{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text    = '''Warning:''' Hardware wallets are not bulletproof. The user must be sure to purchase a good-quality, authentic device manufactured by a trustworthy and technically competent company with a good reputation in security.
}}

Potential risks of hardware wallets include: <ref>https://en.bitcoin.it/wiki/Hardware_wallet</ref>

* <u>Compromised production process</u>: Hardware backdoors could be introduced via intentional or unintentional actions that leaves security holes in the final product.
* <u>Device interdiction</u>: No hardware wallet solution can deal with the threat of government programs that intercept hardware and modify them in transit to introduce backdoors.
* <u>Imperfect implementation</u>: If bugs are present in the software, firmware or hardware, then attackers may be able to gain unauthorized access to the hardware wallet. 
* <u>Insecure Random Number Generator (RNG)</u>: Security is reliant upon true randomness being generated by the source of entropy for the RNG, since it generates the wallet's private keys. This is hard to verify, and attackers may be able to recreate wallet keys if the RNG is insecure. <ref>The attacker generates psuedo-randomness that is indistinguishable from true randomness, but is still predictable.</ref>
*  <u>Malware swapping recipient Bitcoin addresses</u>: Malware on a PC could potentially trick the user into sending Bitcoin to the wrong address. Multi-factor confirmation of a recipient's Bitcoin address mitigates this risk.

Despite these risks, hardware wallets are considered a higher security solution than software wallets, since the latter must make private keys available in plain text in the computer's memory when transactions are signed -- any compromise by Bitcoin-targeting malware would enable theft of Bitcoins. <ref>https://ledger.zendesk.com/hc/en-us/articles/115005198485-Hardware-wallets-FAQ</ref>

== Seed Backup Security ==

It is definitively safer to have at least two ledger hardware wallets. During initial setup the ledger does not verify all words of the seed; it only verifies two words of the 24-word seed. This means if one word is mistyped, it will be difficult later on to regain access to personal coins. On the other hand, two ledgers using the same seed should generate the same addresses, which proves the seed was correctly backed up.

Seed testing applications are available like [https://github.com/parkerhoyes/bolos-app-seedutility BOLOS Seed Utility App]. <ref><blockquote>This repository contains an application for the Ledger Nano S that allows the user to verify the backup of their BIP 39 mnemonic by comparing it to the master seed stored on the device.</blockquote></ref> <ref>https://www.reddit.com/r/ledgerwallet/comments/6ez4qs/ledger_nano_s_seed_utility_app_released/</ref> It is probably safer to avoid these tools since they are maintained by a third party and this adds complexity to the procedure.

Another alternative is to:
# note some generated addresses
# reset the ledger
# re-setup with the seed and see if it still uses the same addresses

== Wallet Testing Security ==

Before storing any significant funds in a wallet, it is recommended to first test sending a small amount there and then trying to send it back. The reason is software bugs could potentially lead to the presentation of an address where the user does not own the corresponding private key.

The threat of losing funds due to software bugs is not just hypothetical. For instance, [https://www.reddit.com/r/ethereum/comments/48rt6n/using_myetherwalletcom_just_burned_me_for/ this user] <ref>[http://www.webcitation.org/6ucscCGxX w]</ref> utilizing MyEtherWallet.com lost over one thousand dollars due to a historical bug in the Ethereum Javascript implementation.

== Threat Model ==

See [[Hardware Wallet Security]].

= Installation =
{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = A USB port is required if using the Nano S, Nano or HW1 ledger hardware wallets.
-----
This comes with some technical challenges, although it is easier to use in combination with Qubes. First learn how to pass a USB device to an AppVM and attempt that procedure in order to iron out any eventual Qubes USBVM issues.
}}

== Qubes USB Proxy Installation ==

This step is mandatory for [[Qubes]] users.

Install Qubes USB Proxy. <ref>See:
[https://github.com/QubesOS/qubes-issues/issues/2473#issuecomment-273634599 Problem with adding USB device to a VM].
</ref>

{{Install_Package|package=
qubes-usb-proxy
}}

== Chromium Installation ==

Chromium is required to run the Chrome applications ledger bitcoin and ledger ethereum. No additional software installation or account creation is needed.

In Qubes TemplateVM.

Open a terminal (konsole). 

Install Chromium.

{{Install_Package|package=
chromium
}}

== Electrum Installation ==

This step is optional and only necessary if you intend to use Electrum.

[[Electrum]] is installed by default in {{Workstation product name}}, but several dependencies are required for a hardware wallet. <ref>https://electrum.readthedocs.io/en/latest/hardware-linux.html</ref> <ref>Broken link: 
https://ledger.groovehq.com/knowledge_base/topics/how-to-setup-electrum-nano-slash-nano-s
</ref>

{{Install_Package|package=
libudev-dev libusb-1.0-0-dev python3-btchip
}}

<ref>
This is probably outdated:

* Was not required. <code>ln -s /lib/x86_64-linux-gnu/libudev.so.1 /lib/x86_64-linux-gnu/libudev.so</code>
* https://github.com/spesmilo/electrum/issues/3422#issuecomment-348063118
* Install <code>python3-btchip</code> (<code>btchip-python</code> ?). Unfortunately it is not available from Debian's repository. Therefore we have to install it using python-pip.

TODO: bug report against https://packages.debian.org/buster/python-btchip ?

python-pip warning: See [[Install_Software#Avoid_Third_Party_Package_Managers|Avoid Third Party Package Managers]]!

{{CodeSelect|code=
python3 -m pip install btchip-python
}}
</ref>

== udev Rules ==
{{Box|text=
'''1.''' Open a terminal in Qubes TemplateVM.

Open a terminal (konsole). <ref>Further research is required to confirm this step is required. The issue appears to have been fixed, see: [https://github.com/spesmilo/electrum/issues/3947 Ledger Nano S not detected on Linux].</ref>

{{CodeSelect|code=
sudo adduser user plugdev
}}

{{Open with root rights
|filename=/etc/udev/rules.d/20-hw1.rules
}}

'''2.''' Add the following settings. <ref>Broken link:
https://ledger.groovehq.com/knowledge_base/topics/ledger-wallet-is-not-recognized-on-linux
</ref>

{{CodeSelect|code=
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2581", ATTRS{idProduct}=="1b7c", MODE="0660", OWNER="user", GROUP="plugdev"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2581", ATTRS{idProduct}=="2b7c", MODE="0660", OWNER="user", GROUP="plugdev"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2581", ATTRS{idProduct}=="3b7c", MODE="0660", OWNER="user", GROUP="plugdev"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2581", ATTRS{idProduct}=="4b7c", MODE="0660", OWNER="user", GROUP="plugdev"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2581", ATTRS{idProduct}=="1807", MODE="0660", OWNER="user", GROUP="plugdev"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2581", ATTRS{idProduct}=="1808", MODE="0660", OWNER="user", GROUP="plugdev"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2c97", ATTRS{idProduct}=="0000", MODE="0660", OWNER="user", GROUP="plugdev"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2c97", ATTRS{idProduct}=="0001", MODE="0660", OWNER="user", GROUP="plugdev"

KERNEL=="hidraw*", SUBSYSTEM=="hidraw", MODE="0660", OWNER="user", GROUP="plugdev", ATTRS{idVendor}=="2c97"
KERNEL=="hidraw*", SUBSYSTEM=="hidraw", MODE="0660", OWNER="user", GROUP="plugdev", ATTRS{idVendor}=="2581"
}}

Save.

'''3.''' Shut down Qubes TemplateVM.

'''4.''' Start the VM which is supposed to interact with the ledger hardware wallet, which we will call <code>ledger VM</code>.
}}

== Ledger Application Installation ==

=== Graphical User Interface ===

<div class="toccolours mw-collapsible mw-collapsed">
For graphical user interface instructions, which are easier but less secure, click on expand on the right.
<div class="mw-collapsible-content">
'''Ledger Manager'''

https://chrome.google.com/webstore/detail/ledger-manager/beimhnaefocolcplfimocfiaiefpkgbf
-----
'''Ledger Wallet Bitcoin'''

https://chrome.google.com/webstore/detail/ledger-wallet-bitcoin/kkdpmhnladdopljabkgpacgpliggeeaf
-----
'''Ledger Wallet Ethereum'''

https://chrome.google.com/webstore/detail/ledger-wallet-ethereum/hmlhkialjkaldndjnlcdfdphcgeadkkm
-----
'''Ledger Wallet Ripple'''

[[Undocumented]]. Please refer to command line instructions below or instructions on the [https://www.ledgerwallet.com/apps/ripple ledger hardware wallet homepage].

</div>
</div>

=== Command Line ===

<div class="toccolours mw-collapsible mw-collapsed">
For command line instructions, which have worse usability but are more secure, click on expand on the right.
<div class="mw-collapsible-content">
'''Security'''

These instructions are more secure, because <code>{{Chrome web store only}}</code> is used; only connections to Google (the Chrome Web Store) are allowed. Any (accidental) connections to other destinations which could be harmful for privacy or security are prevented.
-----
'''Ledger Manager'''

Run.

{{CodeSelect|code=
chromium {{Chrome web store only}} https://chrome.google.com/webstore/detail/ledger-manager/beimhnaefocolcplfimocfiaiefpkgbf
}}
-----
'''Ledger Wallet Bitcoin'''

Run.

{{CodeSelect|code=
chromium {{Chrome web store only}} https://chrome.google.com/webstore/detail/ledger-wallet-bitcoin/kkdpmhnladdopljabkgpacgpliggeeaf
}}
-----
'''Ledger Wallet Ethereum'''

Run.

{{CodeSelect|code=
chromium {{Chrome web store only}} https://chrome.google.com/webstore/detail/ledger-wallet-ethereum/hmlhkialjkaldndjnlcdfdphcgeadkkm
}}
-----
'''Ledger Wallet Ripple'''

{{Open_a _product_ws_terminal}}

Run.

{{CodeSelect|code=
curl {{Curl_Secure}} --location --remote-name https://apps.ledgerwallet.com/ripple/download/linux_deb_64.deb
}}
</div>
</div>

= Usage =

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Qubes will not detect ledger before the PIN has been entered. This is probably because ledger does not announce itself before that.
}}

# Physically connect the ledger hardware wallet to a USB port.
# Enter the PIN.
# Start the <code>ledger VM</code>.

== Ledger Applications ==

=== Graphical User Interface ===

<div class="toccolours mw-collapsible mw-collapsed">
For graphical user interface instructions, which are easier but less secure, click on expand on the right.
<div class="mw-collapsible-content">
'''Ledger Manger / Ledger Wallet Bitcoin / Ledger Wallet Ethereum'''

# Start Chromium.
# Click applications.
# Choose a ledger application and start it.

You can also refer to the instructions on the [https://www.ledgerwallet.com/apps ledger hardware wallet homepage].
-----
'''Ledger Wallet Ripple'''

[[Undocumented]]. Please refer to command line instructions below or the instructions on the [https://www.ledgerwallet.com/apps ledger hardware wallet homepage].
</div>
</div>

=== Command Line ===

<div class="toccolours mw-collapsible mw-collapsed">
For command line instructions, which have worse usability but are more secure, click on expand on the right.
<div class="mw-collapsible-content">
'''Security'''

These instructions are more secure, because <code>chromium</code> is launched on the command line with switch <code>--app-id=app-id</code>. This results in only starting the ledger application so outgoing connections are limited to a minimum.
-----
'''Ledger Manager'''

Run. <ref name=local>
Note: using <code>--host-rules="MAP * 127.0.0.1, EXCLUDE 127.0.0.1"</code> will not work.
</ref>

{{CodeSelect|code=
chromium --app-id=beimhnaefocolcplfimocfiaiefpkgbf
}}
-----
'''Ledger Wallet Bitcoin'''

Run. <ref name=local />

{{CodeSelect|code=
chromium --app-id=kkdpmhnladdopljabkgpacgpliggeeaf
}}
-----
'''Ledger Wallet Ethereum'''

Run. <ref name=local />

{{CodeSelect|code=
chromium --app-id=hmlhkialjkaldndjnlcdfdphcgeadkkm
}}
-----
'''Ledger Wallet Ripple'''

Run.

{{CodeSelect|code=
sudo dpkg -i linux_deb_64.deb
}}
</div>
</div>

== Electrum ==

An Electrum wallet will only show legacy bitcoin addresses and their balances or segwit wallet bitcoin addresses and their balances, not both. It is possible to have multiple Electrum wallets and switch between them.

Electrum will ask for <code>derivation path</code>.

* The default is <code>m/44'/0'/0'</code> for legacy bitcoin addresses.
* You should use <code>m/49'/0'/0'</code> for segwit bitcoin addresses.

= Troubleshooting =
== Qubes R4 ==
Qubes R4 USB widget has some (maybe yet to be reported) bugs such as showing that USB device is connected to a VM while <code>qvm-usb</code> (the command line authority who's judgment should be trusted more) disagrees or showing the same USB device more than once in the menu. <ref>
[https://github.com/QubesOS/qubes-issues/issues/3266 USB devices shown multiple times in devices popup menu #3266]
</ref>

Physically connect the ledger hardware wallet to a USB port.

Run the following command to get an overview of USB devices detected by Qubes.

{{CodeSelect|code=
qvm-usb
}}

Should show something like this.

<pre>
BACKEND:DEVID  DESCRIPTION               USED BY
sys-usb:2-1.1  Logitech_USB_Keyboard     
sys-usb:2-1.2  PixArt_USB_Optical_Mouse  
sys-usb:2-1.4  Ledger_Nano_S_0001        
</pre>

Use the following command to connect the ledger hardware wallet to a VM of your choice. Replace <code>ledger-debian-stretch</code> with the actual name of your VM.

{{CodeSelect|code=
qvm-usb attach ledger-debian-stretch sys-usb:2-1.4
}}

== BIOS ==
The USB device might be passed to the <code>ledger VM</code>, but ledger apps might not recognize the ledger hardware wallet. In that case, in BIOS settings...

* try to disable <code>Legacy USB Support</code>
* try to disable <code>XHCI Pre-Boot Mode</code>
* try flipping other USB related BIOS options

No re-installation of Qubes required.

== Ledger ==
Try to connect to Ledger Manager first.

Try to update the firmware of the Ledger hardware wallet by connecting it to a non-Qubes Linux computer where connections are possibly using Ledger Manager.

See also [[Dev/Ledger Hardware Wallet]].

= Donations =
After installing a hardware wallet, please consider making a [[Donate|donation]] to {{project name}} to keep it running for many years to come.

Donate Bitcoin (BTC) to {{project_name}}.

{{Pay Bitcoin}}

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
