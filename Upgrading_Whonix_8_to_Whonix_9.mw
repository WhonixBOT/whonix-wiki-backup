{{Header}}
{{#seo:
|description=How to Upgrade from Whonix 8.x to Whonix 9.x
}}

{{Testing}}

'''UNFINISHED!'''

'''Not yet possible!''' (Since testers repository not yet updated.)

= Before you start =
== If you want to upgrade Whonix-Gateway as well as Whonix-Workstation ==
1. Backup your data. <br />
2. Upgrade Whonix-Workstation. <br />
3. Power off Whonix-Workstation. <br />
4. Upgrade Whonix-Gatway. <br />
5. Restart Whonix-Gateway. <br />
6. Restart Whonix-Workstation <br />

== If you only want to upgrade Whonix-Workstation ==
1. Backup your data. <br />
2. Upgrade Whonix-Workstation. <br />
3. Power off Whonix-Workstation. <br />
4. [[Download|Get]] Whonix-Gatway 9.x. <br />
5. Start Whonix-Gateway. <br />
6. Start Whonix-Workstation <br />

You can ignore the following errors.

== Non-Critical Errors / Warnings ==
You may see the following non-crtiical errors / warnings. Those can be safely ignored.
<pre>
/usr/lib/whonix/uwtwrapper: line 107: /usr/bin/apt-get: syntax error: operand expected (error token is "/usr/bin/apt-get")
</pre>
<pre>
dpkg: warning: while removing whonix-workstation-files, directory '/usr/share/whonix' not empty so not removed
</pre>
<pre>
dpkg: warning: while removing whonix-gateway-files, directory '/usr/share/whonix' not empty so not removed
</pre>
<pre>
line 7: /usr/share/whonix/postinst.d/pre.bsh: No such file or directory
</pre>

Other warnings / errors should be reported.

= Upgrading Whonix-Workstation =
'''[[Download|Downloading]] a new Whonix-Workstation will be probably easier than applying the following instructions for upgrading.'''

Become root.

<pre>
sudo su
</pre>

Temporarily disable uwtwrapper. <ref name=uwtwrapper />

<pre>
echo uwtwrapper_global=0 > /etc/whonix.d/30_uwt_default
</pre>

(It will be automatically enabled again after upgrading. No further action required. <ref name=uwtwrapper2 />

Enable Whonix's {{Code2|wheezy}} repository.

<pre>
whonix_repository --enable --codename wheezy
</pre>

Enable extensive debugging so reporting eventual bugs becomes easier.

<pre>
export DEBDEBUG=1
</pre>

Will be fixed after the upgrade.

Update your package lists.

<pre>
apt-get update
</pre>

Upgrade. (During the upgrade the packages {{Code|whonix-workstation-files}} as well as {{Code|whonix-shared-files}} will be removed. This is expected.) <ref name=aptupgrade />

<pre>
apt-get install whonix-workstation
</pre>

Dist-upgrade.

<pre>
apt-get dist-upgrade
</pre>

Purge {{Code2|whonix-shared-files}} to get rid of deprecated config files. <ref name=oldconfigs />

<pre>
dpkg --purge whonix-shared-files ; echo $?
</pre>

Purge {{Code2|whonix-workstation-files}} to get rid of deprecated config files.

<pre>
dpkg --purge whonix-workstation-files ; echo $?
</pre>

Power off.

<pre>
poweroff
</pre>

Your upgraded Whonix-Workstation will not be able to connect yet, because that requires either an upgraded Whonix-Gateway or a Whonix-Gateway 9.x. As soon you upgraded your Whonix-Gateway or downloaded a Whonix-Gateway 9.x, you should be able to connect.

= Upgrading Whonix-Gateway =
'''[[Download|Downloading]] a new Whonix-Gateway will be probably easier than applying the following instructions for upgrading.'''

Warning: Your changes in {{Code|/etc/tor/torrc}} will be lost! Backup your torrc <ref>
sudo cp /etc/tor/torrc /etc/tor/torrc.mybackup
</ref> in case you care to restore your settings.

Become root.

<pre>
sudo su
</pre>

Temporarily disable uwtwrapper. <ref name=uwtwrapper>
This is related to [[Stream Isolation]].
Because during upgrade the following code would cause issues. (Because the marker file /usr/share/whonix/whonix_[gateway|workstation] gets removed.)

<pre>
   if [ -f "/usr/share/whonix/whonix_workstation" ]; then
      uwtwrapper_gateway_ip="192.168.0.10"
   elif [ -f "/usr/share/whonix/whonix_gateway" ]; then
      uwtwrapper_gateway_ip="127.0.0.1"
   else
      error "/usr/bin/"$SCRIPTNAME" uwt wrapper could not determine if this is Whonix-Workstation or Whonix-Gateway."
      error "Please report this bug!"
   fi
</pre>
</ref>

<pre>
echo uwtwrapper_global=0 > /etc/whonix.d/30_uwt_default
</pre>

(It will be automatically enabled again after upgrading. No further action required. <ref name=uwtwrapper2>After upgrading the [https://github.com/Whonix/uwt uwt] package will be installed, which will enable uwtwrapper again.</ref>)

Enable Whonix's {{Code2|wheezy}} repository.

<pre>
whonix_repository --enable --codename wheezy
</pre>

Enable extensive debugging so reporting eventual bugs becomes easier.

<pre>
export DEBDEBUG=1
</pre>

Update your package lists. <ref>We need to use uwt because the feature for transparent proxying Whonix-Gateway's own traffic is disabled by default.</ref>

<pre>
uwt -i 127.0.0.1 -p 9050 apt-get update
</pre>

Upgrade. (During the upgrade the packages {{Code|whonix-gateway-files}} as well as {{Code|whonix-shared-files}} will be removed. This is expected.) <ref name=aptupgrade>
Upgrading using {{Code|sudo apt-get dist-upgrade}} is not possible due to extensive changes on how Whonix is packaged. (The -files packages were [https://github.com/Whonix/Whonix/issues/40 split into multiple packages].)

Not all packages are strictly required. For example the ...-build-... packages won't do anything. However, they don't hurt either. We're mimicking the behavior of the [https://github.com/Whonix/Whonix/blob/master/build-steps.d/1700_install-packages 1700_install-packages] build step here to end up with a system that is as similar to Whonix 9.x as possible. This is useful to make eventual issues / differences of upgraded Whonix 8.x systems vs Whonix 9.x as unlikely as possible.
</ref>

<pre>
uwt -i 127.0.0.1 -p 9050 apt-get install whonix-gateway
</pre>

Dist-upgrade.

<pre>
uwt -i 127.0.0.1 -p 9050 apt-get dist-upgrade
</pre>

Purge {{Code2|whonix-shared-files}} to get rid of deprecated config files. <ref name=oldconfigs>
Otherwise old config files would interfere.
</ref>

<pre>
dpkg --purge whonix-shared-files ; echo $?
</pre>

Purge {{Code2|whonix-gateway-files}} to get rid of deprecated config files.

<pre>
dpkg --purge whonix-gateway-files ; echo $?
</pre>

Reboot required.

<pre>
reboot
</pre>

= Recovery =
== Whonix-Workstation ==
<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
If you upgraded using "apt-get dist-upgrade" and now getting the following error.

<pre>
Errors were encountered while processing:
 /var/cache/apt/archives/tb-starter_3%3a0.2-2_all.deb
 /var/cache/apt/archives/whonix-base-files_3%3a0.2-2_all.deb
</pre>

And want to fix this, then click on expand on the right.

'''[[Download|Downloading]] a new Whonix-Workstation will be probably easier than applying the following instructions for upgrading.'''
<div class="mw-collapsible-content">
<pre>
sudo su
</pre>

<pre>
dpkg --purge whonix-workstation-files ; echo $?
</pre>

<pre>
dpkg --purge whonix-shared-files ; echo $?
</pre>

<pre>
apt-get install tb-updater
</pre>

Be patient when you see about ~14 times.

<pre>
sudo: unable to resolve host host
</pre>

Will take a while.

If you use a Whonix 8 Gateway.

<pre>
echo "nameserver 192.168.0.10" > "/etc/resolv.conf"
</pre>

Or if you use a Whonix 9 Gateway.

<pre>
echo "nameserver 10.152.152.10"  > "/etc/resolv.conf"
</pre>

<pre>
apt-get install whonix-workstation
</pre>
</div>
</div>

== Whonix-Gateway ==
<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
In case you run "apt-get dist-upgrade" now having broken apt-get and want to fix it.

<u>'''UNFINISHED'''</u> Probably very difficult to fix.

'''[[Download|Downloading]] a new Whonix-Gateway will be probably easier than applying the following instructions for upgrading.'''
<div class="mw-collapsible-content">
<pre>
sudo su

echo "GATEWAY_TRANSPARENT_TCP=1" >> /etc/whonix.d/60_temp
echo "GATEWAY_TRANSPARENT_DNS=1" >> /etc/whonix.d/60_temp

apt-get install -f
apt-get install whonix-gateway

dpkg --purge whonix-shared-files ; echo $?
dpkg --purge whonix-gateway-files ; echo $?

rm /etc/whonix_firewall.d/60_temp
</pre>
</div>
</div>

= Footnotes =
<references />

[[Category:Documentation]]

{{Footer}}
