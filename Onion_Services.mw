{{Header}}
{{#seo:
|description=Anonymously host any server with {{project name}} and Tor onion services
|image=https://www.whonix.org/w/images/1/12/Fly-agaric808110640.jpg
}}

= Tor Onion Services - EASY =
== Introduction ==
Be sure to read and understand [https://www.torproject.org/docs/hidden-services.html.en Tor: Onion Service Protocol] (general information) and [https://www.torproject.org/docs/tor-onion-service Configuring Onion Services for Tor] (standard setup, no isolated proxy) first. Note that onion services are always only reachable using Tor or tunnel services, such as tor2web, ([https://trac.torproject.org/projects/tor/wiki/doc/tor2web be careful]). Also review Riseup's [https://riseup.net/en/security/network-security/tor/onionservices-best-practices Tor Hidden (Onion) Services Best Practices guide].

You do not need SSL <ref>https://en.wikipedia.org/wiki/Secure_Sockets_Layer</ref>, because connections to Tor onion services are end-to-end encrypted by default. <ref>To be exact, only tor-to-tor, see [[Onion_Services#Notes_about_End-to-end_security_of_Onion_Services|Notes about End-to-end security of Onion Services]].</ref><ref>http://www.quora.com/Is-there-an-SSL-equivalent-for-Tor-Hidden-Services</ref> This is handy, as you do not have to bother with self signed certificates or certificate authorities.

Another interesting property is they can serve as a drop-in Global Server Load Balancing and Layer 3 DDoS-resistance solution.<ref>https://archive.is/Aaqsz</ref> This raises the bar to withstanding attacks that the entire Tor network can tolerate. Same with [[I2P|I2P Eepsties]]. Tor can be also considered a very simple to configure encrypted transport alternative to IPSec.<ref>https://lists.torproject.org/pipermail/tor-talk/2016-October/042360.html
</ref>

An adversary can see whether the service (and presumably Tor) is up and running or not.

Even if someone hacks your hidden server software (<code>micro-httpd</code>, <code>nginx</code>, <code>apache</code>, etc.), the attacker can not steal your onion service key or bypass Tor, see [[Comparison with Others#Attacks|Attack on Whonix]]. The key is stored on the Whonix-Gateway. Once you cleaned your Whonix-Workstation, no one can impersonate your onion service anymore.

== Web Server Software Recommendations ==
* Avoid the <code>Apache</code> web server. It has much more functionality, leak potential and attack surface than smaller and lighter alternatives.
** If you are using the Apache web server, see the following footnotes. <ref>
It is advised to install [https://packages.debian.org/{{Stable {{project name}} based on Debian codename}}/libapache2-mod-removeip libapache2-mod-removeip].

{{Install_Package|package=
libapache2-mod-removeip
}}
</ref> <ref>
(Source: [http://sourceforge.net/p/whonix/discussion/general/thread/407fce8f/?limit=25#478a old forum])

Stop Apache.

In {{Code|ports.conf}}:

<pre>
NameVirtualHost 127.0.0.1:80
Listen 127.0.0.1:80
ServerName localhost
</pre>

In {{Code|sites-available/default}}:
<pre>
</pre>

Start Apache.

Now Apache is not listening on {{Code|10.152.152.10}}, but only on {{Code|127.0.0.1}}. So now we somehow need to redirect {{Code|10.152.152.10:80}} to {{Code|127.0.0.1:80}}.

It can be done with a firewall rule or netcat:

{{CodeSelect|code=
sudo ncat -l 10.152.152.10 80 -c 'ncat 127.0.0.1 80'
}}
</ref>

* If your needs are limited to hosting static pages then look no further than <code>micro-httpd</code> available from Debian repos. It is a bare-bones daemon made up of 150 lines of code.<ref>https://wiki.debian.org/WebServers</ref>

* The <code>Nginx</code> web server is a recommended alternative.

== Security Recommendations ==
* '''Credits''': Some of these instructions are paraphrased from Sarah Jamie Lewis' write-up after running OnionScan<ref>https://mascherari.press/why-onionscan-should-worry-you/</ref> on the Onion web. All credit goes to her.<ref>https://mascherari.press/thwarting-identity-correlation-attacks/</ref> OnionScan<ref>https://github.com/s-rah/onionscan</ref> is an open source pen-testing suite that exposes misconfiguration errors that expose Hidden Servers. '''Do''' run it before your service goes live. 

* '''Application Level Leaks''': Beware of application level leaks. See [[Protocol-Leak-Protection and Fingerprinting-Protection]] for definition.

* '''Hide IP''': IP hiding instructions for your specific server software should be applied.
** This is because a combination of a webserver that forwards IP addresses to web apps such as for example mediawiki would be a discouraged case, since mediawiki by default puts IPs of anonymous editors in the public accessible editor logs. The IP would be 10.152.152.10. That could not be used to identify you, because that is not your real external IP address, but it would identify the server as an onion service behind a Whonix-Gateway.<ref>
Since it is easy to know that the internal LAN IP 10.152.152.10 is usually used by Whonix-Gateway.
</ref>

* '''Server Software Hardening''': If any instructions for hardening the server instructions are available it is recommended to apply them. While using {{project name}} we're quite confident that there are no IP/DNS leaks, but hardening the server software is still recommended but the responsibility of the user.

* '''General Hardening''': In the [[Security Guide]] and in the [[Advanced Security Guide]] you'll find pointers for hardening.

* '''Mitigate DoS attacks''': Its good practice to setup access to your site through reverse proxies to mitigate layer 7 DoS attacks and information leaks about your setup.

* '''Disable Banner'''s: For SSH, FTP, SMTP and HTTP servers which leak info about the a daemon's name and version. If your SSH instance is for private use, use it with an Authenticated Onion Service to protect your server from brute-force and remote exploitation.

* '''Dedicated Onion Address''': Each service you host should get its own dedicated onion address to prevent correlation between multiple instances running in the same VM.

* '''ALPaCA''': An advanced website fingerprinting client/server mitigation named ALPaCA in development that applies server-side padding to requests sent out to Tor Browser. Once ts ready, service operators can run it to protect against this class of correlation attacks.<ref>https://github.com/camelids/</ref><ref>[https://petsymposium.org/2017/papers/issue2/paper54-2017-2-source.pdf Website Fingerprinting Defenses at the
Application Layer]</ref><ref>https://www.esat.kuleuven.be/cosic/?p=6743</ref>

== Hidden Webserver ==
==== Whonix-Gateway ====
On your Whonix-Gateway:

====== Step 1: open Tor config ======
{{Open_/usr/local/etc/torrc.d/50_user.conf}}

====== Step 2: edit Tor config ======
{{Box|text=
(all {{project name}} platforms)

You need to add two settings to <code>/usr/local/etc/torrc.d/50_user.conf</code>.

* A <code>HiddenServiceDir</code> configuration directive declaring where onion services files (hostname file and private key file) should be stored.
* A <code>HiddenServicePort</code> configuration directive declaring,
** the virtual port and
** the IP and port of the Whonix-Workstation that will run a server service that processing incoming onion service connections.
* <code>HiddenServiceVersion</code> configuration directive declaring which onion service versino to use (<code>2</code> or <code>3</code>).
}}

{{Box|text=
To do that, add the following three lines.

{{Box|text=
[[Qubes|Qubes-Whonix]]: 

{{IP-of-Qubes-Whonix-Workstation-AppVM}}

{{CodeSelect|code=
HiddenServiceDir /var/lib/tor/hidden_service/
HiddenServicePort 80 IP-of-Qubes-Whonix-Workstation-AppVM:80
HiddenServiceVersion 3
}}
}}

{{Box|text=
[[Non-Qubes-Whonix]]:

{{CodeSelect|code=
HiddenServiceDir /var/lib/tor/hidden_service/
HiddenServicePort 80 10.152.152.11:80
HiddenServiceVersion 3
}}
}}
}}

{{Box|text=
(all {{project name}} platforms) 

Save.
}}

====== Step 3: make changes to Tor config take effect ======
{{Reload Tor}}

====== Step 4: get your onion hostname ======
To get your Tor onion service url.

{{CodeSelect|code=
sudo cat /var/lib/tor/hidden_service/hostname
}}

====== Step 5: backup your Tor onion service private key ======
{{
Backups_Tor_Onion_Service_private_key
|private_key_file=/var/lib/tor/hidden_service/private_key
}}

==== Whonix-Workstation ====
On your Whonix-Workstation:
===== Step 1: Install Server Software =====

Either,

'''A)''' Run the following commands to install micro-httpd. <u>OR</u>

{{Install_Package|package=
micro-httpd
}}

'''B)''' Run the following commands to install nginx.

{{Install_Package|package=
nginx
}}

===== Step 2: Open Whonix-Workstation Firewall Port =====
{{Firewall Settings Workstation}}

Add.

{{CodeSelect|code=
EXTERNAL_OPEN_PORTS+=" 80 "
}}

Save.

{{Reload_Firewall_Whonix-Workstation}}

===== Step 3: Final Notes =====
Done.

<u>Note</u>, that it may take up to 30 minutes (or so?) until a fresh .onion domain gets reachable.

<u>Note</u>, accessing 127.0.0.1 {{Tor_Browser_Local_Connections}}.

=== Debugging ===
On Whonix-Gateway.

Check permissions.

{{CodeSelect|code=
sudo ls -la /var/lib/tor/hidden_service/
}}

In case you manually restored your hidden_service keys as root, Tor will fail to start. The folder must be owned by debian-tor. In that case, fix the permissions.

{{CodeSelect|code=
sudo chown debian-tor:debian-tor /var/lib/tor/hidden_service/
}}

In Whonix-Workstation. 

Check if the service is available on 127.0.0.1:80.

{{CodeSelect|code=
## Circumventing {{project name}} curl stream isolation wrapper.
{{Curl_Plain}} 127.0.0.1:80
}}

[[Qubes|Qubes-Whonix]]: In Qubes-Whonix-Workstation, check if the service is available on Qubes-Whonix-Workstation IP, port 80.

{{CodeSelect|code=
## Circumventing {{project name}} curl stream isolation wrapper.
{{Curl_Plain}} $(qubesdb-read /qubes-ip):80
}}

[[Non-Qubes-Whonix]]: In Whonix-Workstation, check if the service is available on 10.152.152.11:80.

{{CodeSelect|code=
## Circumventing {{project name}} curl stream isolation wrapper.
{{Curl_Plain}} 10.152.152.11:80
}}

Note: Tor Browser will allow connections to ''127.0.0.1:80'' but not to ''10.152.152.11:80''.

== Tips settings up any onion service ==
Please test the example Hidden Webserver above first. It helps understanding this in general and will ease debugging.

Quoted from the Tor manual<ref>https://www.torproject.org/docs/tor-manual.html.en</ref>:

<pre>HiddenServiceDir DIRECTORY

Store data files for an onion service in DIRECTORY. Every onion service must have a separate
directory. You may use this option multiple times to specify multiple services. DIRECTORY
must be an existing directory.</pre>
Quoted from the Tor manual<ref>https://www.torproject.org/docs/tor-manual.html.en</ref>:

<pre>HiddenServicePort VIRTPORT [TARGET]

Configure a virtual port VIRTPORT for an onion service. You may use this option multiple
times; each time applies to the service using the most recent hiddenservicedir. By default,
this option maps the virtual port to the same port on 127.0.0.1 over TCP. You may override
the target port, address, or both by specifying a target of addr, port, or addr:port. You
may also have multiple lines with the same VIRTPORT: when a user connects to that VIRTPORT,
one of the TARGETs from those lines will be chosen at random.</pre>

== Hidden VoIP Server ==
On the [[VoIP]] page is an example for a Hidden VoIP Mumble Server.

= Tor Onion Services - ADVANCED =
== Onion Services Security Enhancements ==
See:

* https://blog.torproject.org/announcing-vanguards-add-onion-services
* https://github.com/mikeperry-tor/vanguards

== How Onion Services Connections Work ==
{{Template:Onion_Services_Technical}}

== Onion Services Security ==
'''Not {{project name}} specific! Talking about Tor in general.'''

How safe are Tor Onion Services?

This is a difficult question. Therefore state relevant facts, quotes and links here.

* At time of writing there are no known attacks used in the wild constantly deanonymizing Tor onion services.
* The following is outdated since [https://blog.torproject.org/tors-fall-harvest-next-generation-onion-services NextGenOnions] (<code>HiddenServiceVersion 3</code>)
* <s>80 bit name hash and RSA-1024 sized keys</s>
* <s>Quote Mike Perry {{Code|Tor core people}}<ref>https://www.torproject.org/about/corepeople.html.en</ref>): http://www.mail-archive.com/liberationtech@lists.stanford.edu/msg05418.html</s>
* <s>Quote Mike Perry: http://www.mail-archive.com/liberationtech@lists.stanford.edu/msg05462.html</s>
* <s>Also see, [https://blog.torproject.org/blog/hidden-services-need-some-love The Tor Project Blog: Onion Services need some love].</s>
* <s>[https://conference.hitb.org/hitbsecconf2015ams/sessions/non-hidden-hidden-services-considered-harmful-attacks-and-detection Non-Hidden Onion Services Considered Harmful: Attacks and Detection] <ref>
https://forums.whonix.org/t/cryptolog-for-whonix-website/3369/12
</ref></s>

{{Anchor|Hidden Service Authentication}}

== Onion Service Authentication ==
=== Introduction ===
By default Onion Service names are known to the public as they are broadcast to Onion Service directories. This information becomes sequestered in search crawlers allowing anyone to try and connect and probe your Hidden Server even if this wasn't your intention.

To set up a Hidden service in a private mode, only accessible by just you or additionally your trusted associates, there is a little known feature in Tor feature known as Onion Services Authentication. <ref>http://tor.stackexchange.com/questions/219/how-to-use-hidden-service-authentication How to use Onion Service Authentication?</ref><ref>https://gitweb.torproject.org/torspec.git/tree/proposals/121-hidden-service-authentication.txt</ref> When activated, no one (not even the Onion Service Directories) can derive your .onion address from the descriptors nor can they know the introduction points to your server and consequently will not be able to connect to you.

This feature allows the HS operator to generate multiple shared secrets - giving access to different parties which is revocable. Configurable with the "stealth" auth type used with HiddenServiceAuthorizeClient. Meaning that clients who are banned will no longer know about the HS' introduction points anymore.

[https://www.torproject.org/docs/tor-manual.html.en Tor manual]

=== Server Setup ===
On Whonix-Gateway.

{{Open /usr/local/etc/torrc.d/50_user.conf}}

See the following example. Adjust it for your purposes and add it.

{{CodeSelect|code=
HiddenServiceDir /var/lib/tor/hidden_service/
HiddenServicePort 22 127.0.0.1:22
HiddenServicePort 5900 127.0.0.1:5900
HiddenServiceVersion 3
## syntax:
## HiddenServiceAuthorizeClient auth-type client-name,client-name,…
## The auth-type can either be 'basic' for a general-purpose authorization protocol or 'stealth' for a less scalable protocol that also hides service activity from unauthorized clients.
## Valid client names are 1 to 16 characters long and only use characters in A-Za-z0-9+-_ (no spaces). 
HiddenServiceAuthorizeClient stealth 1234567890123456
}}

Save.

{{Reload Tor}}

To get your Tor onion service url and password, run.

{{CodeSelect|code=
sudo cat /var/lib/tor/hidden_service/hostname
}}

Should show something like this.

<pre>
xxxxxxxxxxxxxxxx.onion 0123456789012345678901 # client: 1234567890123456
</pre>

This is the authentication cookie that was generated by Tor that should be shared with the one supposed being allowed to connect,

* preferably face-to-face or,
* or via OpenPGP encrypted e-mail or OTR encrypted chat over Tor involving both parties.

Note that you can generate a unique authentication cookie for every individual or group you grant access to. This gives you the ability to revoke access if the need arises. It is an all or none rule for granting access to an onion service. If you want to limit that on a subdomain level you are advised to implement it by compartmentalizing your services under different onion service addresses running on a Multiple Workstation setup.

=== Client Setup ===


{{Open /usr/local/etc/torrc.d/50_user.conf}}

{{CodeSelect|code=
HidServAuth <onion-address> <auth-cookie>
}}

{{Reload Tor}}

Done.

== Notes about End-to-end Security of Onion Services ==
Hidden services are not really "end-to-end" encrypted, they encrypted only Tor to End. (or "Tor to Tor") The communication between the browser or server and Tor is sent in clear text. This doesn't really constitute a security issue, as localhost (or Workstation to Gateway on an isolated network), is supposed to be secure. But it has some security implications:

With onion services alone, without TLS enabled, the adversary only needs to compromise Whonix-Gateway to get knowledge of the content of the connection and the clients identity/location. To compromise the content of the connection, the adversary only needs to compromise either the gateway or the workstation.

With onion services, and TLS enabled, an adversary needs to compromise Whonix-Workstation to gain knowledge of the content of the connection. The adversary would have to compromise Whonix-Gateway as well, to gain knowledge of the client's identity/location.

It is possible to use onion services and TLS at the same time, i.e. https://****************.onion. There are only a very few onion services reachable over TLS. For example https://pad.riseup.net/ can be reached over https://5jp7xtmox6jyoqd5.onion/. But since this only offers benefits to users of {{project name}} (and other Tor gateway implementations), there is no demand. It would provide some nice defense in depth as it eliminates a single point of failure.

It would open the question, how would the certificate be verified?

That's simple for private sites, where server and clients know each other. They simply verify it over preshared secure channel, for example, a meeting.

And public onion services? It is unlikely, that certificate authorities will give out certificates for .onion sites. Startssl.com declined, because .onion is no .gTLD, see [https://trac.torproject.org/projects/tor/ticket/6116 Bug #6116: apply for .onion gTLD at IANA]. Although you could try asking other certificate authorities, if they offer SSL certificates for people who can prove that they own a .onion domain. You can prove, that you have control over the domain by editing its contents on their request.

But CAs should not be relied on anyway. See chapter [[SSL]].

Onion Services with {{project name}} are still safer than running Tor and the server software on the same host, because even when misconfigured, there can be, by design, no IP or DNS leaks.

== See Also ==
* [[Hosting_Location_Hidden_Services|Hosting Location Hidden Services]]
* [[Onion_Services_Guides|Onion Services Guides]]

= References =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
