{{Header}}
{{#seo:
|description=Preventing Tor over Tor for the Tor Browser Bundle (TBB), TorChat and others.
}}

= Why? =
See [[DoNot#Prevent_Tor_over_Tor_scenarios.]]

= Implementation =
Implemented in three ways on Whonix-Workstation.

* Implemented in [https://github.com/Whonix/anon-ws-disable-stacked-tor anon-ws-disable-stacked-tor], [https://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/debian/control {{Code|debian/control}}]. The package uses the "Provides: tor" field<ref>See "7.5 Virtual packages - Provides" on http://www.debian.org/doc/debian-policy/ch-relationships.html</ref>, which should avoid any kinds of conflicts, in case upstream releases a higher version of Tor. This won't work for packages, which depend on an explicit version of Tor (such as TorChat). This is non-ideal, since for example the {{Code|torchat}} package will install Tor, but still acceptable, because of the following additional implementations.

* Tor's autostart is disabled in {{Code|/etc/default/tor}} (dpkg-diverted using config-package-dev), so even if the {{Code|tor}} package gets installed, it won't be automatically started.

* {{Code|rinetd}} is configured by [https://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/etc/rinetd.conf.anondist {{Code|/etc/rinetd.conf}}] to listen on
** Tor's default ports. I.e.
*** system Tor's {{Code|127.0.0.1:9050}}, {{Code|127.0.0.1:9051}} and,
*** TBB's {{Code|127.0.0.1:9150}}, {{Code|127.0.0.1:9051}}
*** Tor Messenger's {{Code|127.0.0.1:9152}}, {{Code|127.0.0.1:9153}}
** Those are forwarded to Whonix-Gateway.
** This prevents the default Tor Browser Bundle, Tor Messenger and/or Tor package by The Tor Project from opening these default ports, which will result in Tor failing to open its listening port and therefore exiting, thus preventing Tor over Tor.

https://forums.whonix.org/t/socat-running-on-ws-called-from/2225

https://www.whonix.org/wiki/Dev/Whonix_Packages#anon-ws-disable-stacked-tor

= Whonix 14 =
We mimic a functional Tor as good as possible.

anon-ws-disable-stacked-tor is also providing:

* Tor Control Unix Domain Socket file: /var/run/tor/control, which is redirected to Control Port Filter Proxy on Whonix-Gateway.
* Tor Control Auth Cookie: a functional /var/run/tor/control.authcookie that works with [[Dev/Control_Port_Filter_Proxy|Control Port Filter Proxy]].
* Tor Socks Unix Domain Socket file: /var/run/tor/socks that is redirected to Whonix-Gateway Tor port 9050

https://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/etc/anon-ws-disable-stacked-tor.d/30_anon-dist.conf

Required for Tor Browser connectivity, SocksSocket:

* https://phabricator.whonix.org/T192
* https://trac.torproject.org/projects/tor/ticket/14272#comment:3
* https://trac.torproject.org/projects/tor/ticket/20111#comment:5

= Debugging =
Run.

{{CodeSelect|code=
echo "$TOR_SOCKS_IPC_PATH"
}}

Should show the following.

<pre>
/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock
</pre>

----

Run.

{{CodeSelect|code=
echo "$TOR_CONTROL_IPC_PATH"
}}

Should show the following.

<pre>
/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9151.sock
</pre>

Also please run.

{{CodeSelect|code=
UWT_DEV_PASSTHROUGH=1 curl 127.0.0.1:9150
}}

Should show the following.

<pre>
<html>
<head>
<title>Tor is not an HTTP Proxy</title>
</head>
<body>
<h1>Tor is not an HTTP Proxy</h1>
<p>
It appears you have configured your web browser to use Tor as an HTTP proxy.
This is not correct: Tor is a SOCKS proxy, not an HTTP proxy.
Please configure your client accordingly.
</p>
<p>
See <a href="https://www.torproject.org/documentation.html">https://www.torproject.org/documentation.html</a> for more information.
<!-- Plus this comment, to make the body response more than 512 bytes, so      IE will be willing to display it. Comment comment comment comment      comment comment comment comment comment comment comment comment.-->
</p>
</body>
</html
</pre>

Run a similar command.

{{CodeSelect|code=
echo GET | socat - UNIX-CONNECT:/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock
}}

Should show the same as above.

-----

Next one to try.

{{CodeSelect|code=
UWT_DEV_PASSTHROUGH=1 curl 127.0.0.1:9151
}}

Should show the following.

<pre>
510 Request filtered
...
</pre>

Run a similar command.

{{CodeSelect|code=
echo GET | socat - UNIX-CONNECT:/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9151.sock
}}

Should show.

<pre>
510 Request filtered
</pre>

-----

= Footnotes =
<references />

{{Footer}}

[[Category:Design]]
