{{Header}}
<!--
Copyright:

   Whonix Advanced Security Guide wiki page Copyright (C) Amnesia <amnesia at boum dot org>
   Whonix Advanced Security Guide wiki page Copyright (C) 2012 - 2017 Patrick Schleizer <adrelanos@riseup.net>
   
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 3 of the License, or
   (at your option) any later version.
         
   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.
      
   You should have received a copy of the GNU General Public License
   along with this program; if not, write to:

    Free Software Foundation, Inc. 
    51 Franklin St, Fifth Floor
    Boston, MA 02110-1301, USA.

On Debian GNU/Linux systems, the complete text of the GNU General Public
License can be found in the /usr/share/common-licenses' directory.

The complete text of the GNU General Public License can also be found online on gnu.org <https://www.gnu.org/licenses/gpl.html>, in Whonix virtual machine images in /usr/share/common-licenses/GPL-3 file or on Github <https://github.com/Whonix/Whonix/blob/master/GPLv3>.
-->
<!--
Wiki pages found in the Advanced Security Guide contain material from the Tails Protection against cold boot attacks page; see: <http://git.immerda.ch/?p=amnesia.git;a=blob;f=wiki/src/doc/advanced_topics/cold_boot_attacks.mdwn;hb=d249db72228b498407d85fb762b49ec155871ded>.
-->
{{#seo:
|description=Whonix Gateway Security Hardening
|og:image=https://www.whonix.org/w/images/9/92/Gatewayhardening.jpg
}}

= Disable Control Port Filter Proxy =

== Introduction ==

{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = '''Tip:''' Disabling [https://www.whonix.org/wiki/Dev/CPFP Control Port Filter Proxy] (onion-grater) can improve security by decreasing the attack surface, while sacrificing usability.
}}


If onion-grater is disabled, users will no longer receive helpful Whonix notifications when Tor is not fully bootstrapped, since the whonixcheck and sdwdate tools rely upon it.

== How ==

=== On Whonix-Gateway ===

==== Deactivate onion-grater in Firewall ====

{{Firewall Settings}}

Add the following content.

{{CodeSelect|code=
CONTROL_PORT_FILTER_PROXY_ENABLE=0
}}

Save.

{{Reload Firewall}}

==== Deactivate onion-grater ====
Stop onion-grater.

{{CodeSelect|code=
sudo service onion-grater stop
}}

Disable autostart of onion-grater.

{{CodeSelect|code=
sudo systemctl mask onion-grater
}}

Reboot.

Check if onion-grater is still running or disabled.

{{CodeSelect|code=
ps aux {{!}} grep onion-grater
}}

If output similar to the following appears, then disabling did not work.

<pre>
onion-g+   911  3.2  1.9  66444 20644 ?        Ss   12:21   0:00 /usr/bin/python3 -u /usr/lib/onion-grater --debug --listen-interface eth1
</pre>

==== Deactivate whonixcheck onion-grater Running Test ====

{{Open with root rights|filename=
/etc/whonix.d/50_user.conf
}}

Add the following content.

{{CodeSelect|code=
whonixcheck_skip_functions+=" check_control_port_filter_running "
}}

Save.

=== On Whonix-Workstation ===

==== Deactivate [[whonixcheck]]'s Tor Bootstrap Test ====

Because it relies on onion-grater.

{{Open with root rights|filename=
/etc/whonix.d/50_user.conf
}}

Add the following content.

{{CodeSelect|code=
whonixcheck_skip_functions+=" check_tor_bootstrap "
}}

Save.

==== Deactivate sdwdate connectivity test ====
Whonix-Workstation only.

{{Open with root rights|filename=
/usr/lib/anon-shared-helper-scripts/te_pe_tb_check
}}

Replace the existing content with the following text.

{{CodeSelect|code=
#!/bin/bash
exit 0
}}

Save.

Restart sdwdate.

{{CodeSelect|code=
sudo systemctl restart sdwdate
}}

Done.

Be aware that this setting will not persist after any upgrade of sdwdate, nor is sdwdate currently configurable. <ref>Any Whonix users interested in further development should create a relevant ticket on [http://phabricator.dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion Phabricator].</ref>

==== Tor Browser Updater ==== 

If a user wants to update [[Tor Browser]] using [[Tor_Browser#Update_Tor_Browser|Tor Browser Updater by Whonix developers]] while onion-grater is disabled, then follow the steps below. <ref>It is simply easier to update using [[Tor_Browser#Tor_Browser_Internal_Updater|Tor Browser's internal updater]] instead.</ref>

{{CodeSelect|code=
update-torbrowser --no-tor-con-check
}}

Or create a file ''/etc/torbrowser.d/50_user.conf'' with the following content.

{{CodeSelect|code=
TB_NO_TOR_CON_CHECK="1"
}}

= Static VirtualBox IP =

Instead of using DHCP to obtain the internal IP address for the Whonix-Workstation eth0 NAT adapter, a static IP could be used instead. This might marginally improve security since the DHCP package can then be removed.

Open ''/etc/network/interfaces.d/30_non-qubes-whonix'' [https://github.com/Whonix/whonix-gw-network-conf/blob/master/etc/network/interfaces.d/30_non-qubes-whonix on GitHub] and read the comments. Then, comment out DHCP and comment in Static VirtualBox IP.

= Footnotes =
{{reflist|close=1}}

= License =
{{License_Amnesia|{{FULLPAGENAME}}}}

{{Footer}}

[[Category:Documentation]]
