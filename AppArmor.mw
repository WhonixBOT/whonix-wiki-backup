{{Header}}
{{#seo:
|description=AppArmor profiles (Security Hardening) for Whonix and other Linux distributions.
|image=https://www.whonix.org/w/images/f/f1/Coat-of-mail-948960640.jpg
}}
__FORCETOC__

= Installation =

It is recommended to install the available [https://en.wikipedia.org/wiki/AppArmor AppArmor] profiles for improved security on the Whonix platform.

{{mbox
| image      = [[File:Ambox_warning_pn.svg.png|40px|alt=Exterimental AppArmor Profile Warning]]
| text       = Testers only!
}}

== Qubes Users Note ==
{{mbox
| image   = [[File:Ambox_notice.png|40px|alt=Qubes-Whonix Note]]
| text    =
[[Qubes-Whonix]] users require some extra steps to set up AppArmor. [[Non-Qubes-Whonix]] users can skip this section. <ref>{{Non-Qubes-Whonix}}</ref>
}}
<br />
<div class="toccolours mw-collapsible mw-collapsed">
If you are interested, click on Expand on the right.
<div class="mw-collapsible-content">
Complete the following steps in dom0 for <u>both</u> <code>{{whonix-gw}}</code> and <code>{{whonix-ws}}</code> TemplateVMs. After these settings are applied in the Whonix templates, the <code>sys-whonix</code> (ProxyVM) and <code>anon-whonix</code> (AppVM) will inherit the AppArmor kernel settings. 

It is unnecessary to recreate the <code>sys-whonix</code> and <code>anon-whonix</code> TemplateBasedVMs to benefit from the new kernel parameters. <ref>[https://github.com/QubesOS/qubes-issues/issues/1091 Since Qubes R3.0, TemplateBasedVMs inherit the kernelopts setting of their TemplateVM].</ref> It is also important to verify AppArmor is active in both <code>sys-whonix</code> and <code>anon-whonix</code> after making these changes.

=== Whonix-Gateway ===

'''1.''' Open a dom0 terminal.

<code>Qubes App Launcher (blue/grey "Q")</code> -> <code>System Tools</code> -> <code>Xfce Terminal
</code>

'''2.''' List the current kernel parameters.

{{CodeSelect|code=
qvm-prefs -g {{whonix-gw}} kernelopts
}}

Qubes R4.0 and later releases will show.<br />

{{Code2|nopat}}

'''3.''' Keep the existing kernel parameters and add 'apparmor=1 security=apparmor'.

For example.

{{CodeSelect|code=
qvm-prefs -s {{whonix-gw}} kernelopts "nopat apparmor=1 security=apparmor"
}}
{{CodeSelect|code=
qvm-prefs -s sys-whonix kernelopts "nopat apparmor=1 security=apparmor"
}}

'''4.''' List the kernel parameters again. <ref>Hit the up arrow key twice; it is unnecessary to type the command again.</ref>

{{CodeSelect|code=
qvm-prefs -g {{whonix-gw}} kernelopts
}}

The output should show AppArmor is part of the new kernel parameters. For example.<br />

''nopat apparmor=1 security=apparmor''

'''5.''' Start <code>sys-whonix</code> ProxyVM and confirm AppArmor is active.

{{CodeSelect|code=
sudo aa-status --enabled ; echo $?
}}

The output should show.<br />

{{Code2|0}}

=== Whonix-Workstation ===

'''1.''' Open a dom0 terminal.

<code>Qubes App Launcher (blue/grey "Q")</code> -> <code>System Tools</code> -> <code>Xfce Terminal
</code>

'''2.''' List the current kernel parameters.

{{CodeSelect|code=
qvm-prefs -g {{whonix-ws}} kernelopts
}}

Qubes R4.0 and later releases will show.<br />

{{Code2|nopat}}

'''3.''' Keep the existing kernel parameters and add 'apparmor=1 security=apparmor'. 

For example.

{{CodeSelect|code=
qvm-prefs -s {{whonix-ws}} kernelopts "nopat apparmor=1 security=apparmor"
}}
{{CodeSelect|code=
qvm-prefs -s anon-whonix kernelopts "nopat apparmor=1 security=apparmor"
}}

'''4.''' List the current kernel parameters again. <ref>Hit the up arrow key twice; it is unnecessary to type the command again.</ref>

{{CodeSelect|code=
qvm-prefs -g {{whonix-ws}} kernelopts
}}

The output should show AppArmor is part of the new kernel parameters. For example.<br />

''nopat apparmor=1 security=apparmor''

'''5.''' Start <code>anon-whonix</code> AppVM and confirm AppArmor is active.

{{CodeSelect|code=
sudo aa-status --enabled ; echo $?
}}

The output should show.<br />

{{Code2|0}}
</div>
</div>

== Install all AppArmor Profiles ==
The easiest method is to install all available AppArmor profiles. This can result in a few profiles being enforced for software that is not installed, but this will not have any adverse impacts.
{{CodeSelect|code=
sudo apt-get install apparmor-profiles-hardened-debian
}}

== Install Select AppArmor Profiles ==
<div class="toccolours mw-collapsible mw-collapsed">
Click on Expand on the right side.
<div class="mw-collapsible-content">
Profile for [[Tor Browser]]. Useful in Whonix-Workstation. <ref>Tor Browser is installed by [[Tor Browser#Update Tor Browser|tb-updater]]; the latter is a default Whonix application.</ref>
{{CodeSelect|code=
sudo apt-get install apparmor-profile-torbrowser
}}

Profile for [[Sdwdate|sdwdate]]. <ref>The network [[Dev/TimeSync|time sync]] is installed in Whonix by default.</ref> Useful in Whonix-Gateway and Whonix-Workstation.
{{CodeSelect|code=
sudo apt-get install apparmor-profile-sdwdate
}}

Profile for the [[HexChat]] client. Useful in Whonix-Workstation.
{{CodeSelect|code=
sudo apt-get install apparmor-profile-xchat
}}

Profile for the [[E-Mail#Mozilla_Thunderbird_with_TorBirdy|Mozilla Thunderbird]] [[E-Mail]] client. Useful in Whonix-Workstation.
{{CodeSelect|code=
sudo apt-get install apparmor-profile-icedove
}}

Profile for [[whonixcheck]]. Useful in Whonix-Gateway and Whonix-Workstation.
{{CodeSelect|code=
sudo apt-get install apparmor-profile-whonixcheck
}}

Profile for [[VirtualBox]]. This is useful on the host, but instructions are not available for this procedure. It is also useful if running VirtualBox inside VirtualBox.
{{CodeSelect|code=
sudo apt-get install apparmor-profile-virtualbox
}}
</div>
</div>

== Revert any Whonix Repository Change ==

If AppArmor profiles were installed from the testers repository, reverting to the {{Code2|stable}} repository is recommended.

{{CodeSelect|code=
sudo whonix_repository --enable --repository stable
}}

Update the package lists.

{{CodeSelect|code=
sudo apt-get update
}}

== Profile Unloading ==

The name of the specific profile to unload must be known in advance; refer to the [[#Install_Select_AppArmor_Profiles|list]] further above.

If it is necessary to disable an AppArmor profile, first list those which are available.
{{CodeSelect|code=
ls /etc/apparmor.d/
}}

Once a profile is loaded in the kernel, it can be easily removed.

{{CodeSelect|code=
sudo aa-disable /etc/apparmor.d/profile-name
}}

This command expects the profile file to exist, so if it has been manually deleted or removed via apt-get purge, it can only be unloaded by rebooting.

= Common Operations =

== Maintain Tor Browser Functionality ==

Tor Browser upgrades frequently break the Whonix AppArmor profile used to contain it. Even when AppArmor-related fixes are confirmed in Phabricator, most often the packages are not made available to Whonix stable or even the developer version. This means manual profile fixes are often required until the [[About#Whonix_Version|next Whonix version is released]].

If Tor Browser is non-functional with the available AppArmor profile, follow these steps to rectify the problem.
{{Box|text=
'''1.''' Open a terminal in Whonix-Workstation (<code>{{whonix-ws}}</code>).

<code>{{whonix-ws}}</code> -> <code>Konsole</code>

'''2.''' List the available AppArmor profiles.

{{CodeSelect|code=
ls /etc/apparmor.d/
}}

'''3.''' Edit the Tor Browser AppArmor profile.

Note: change the name of the file to match whatever version is installed on the system.

{{CodeSelect|code=
sudo nano /etc/apparmor.d/home.*.tor-browser_*Browser.firefox
}}

'''4.''' Navigate to the Whonix Github resource for AppArmor.

The latest git commits can be found [https://github.com/Whonix/apparmor-profile-torbrowser here].

Select <code>Code</code> -> <code>etc/apparmor.d</code> -> <code>home.tor-browser.firefox</code>

Select the <code>Raw</code> button on the right-hand side. <ref>Otherwise essential profile formatting might break or unwanted content (such as line numbers) might be copied inadvertently, leading to a non-functional profile.</ref>

{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = It is recommended to check the profile does not contain any unexpected content. For greater security, utilize a different viewer and/or retrieve the profile using git and perform git commit gpg verification.
}}


Cut and paste the profile text into the old Tor Browser profile which is open in nano. Save and exit.

'''5.''' Enforce the new Tor Browser profile.

In the command below, change the name of the file to match whatever version is installed on the system. 

In Whonix-Workstation (<code>{{whonix-ws}}</code>), run.

{{CodeSelect|code=
sudo aa-enforce /etc/apparmor.d/home.*.tor-browser_*.Browser.firefox
}}

'''6.''' Shutdown Whonix-Workstation (<code>{{whonix-ws}}</code>).

'''7.''' Restart Whonix-Workstation (<code>anon-whonix</code>).

Launch Tor Browser. If everything has been applied correctly, Tor Browser will have full functionality. If the following AppArmor warning appears, it can be safely ignored.

<pre>Profile: /home/**/tor-browser*/Browser/firefox Operation: open Name: /dev/ Denied: r Logfile: /var/log/kern.log For more information, please see: https://wiki.ubuntu.com/DebuggingApparmor</pre>

'''8.''' Manually check AppArmor is correctly running and enforced.

In a terminal, run.

{{CodeSelect|code=
sudo aa-status
}}

The output should show the Tor Browser profile is loaded and in enforce mode.
}}

== Correcting Other Whonix AppArmor Profiles ==

The same method can be used to resolve other AppArmor problems impacting full functionality of applications in Whonix. For instance, in Whonix 13 the <code>whonixcheck</code> AppArmor profile caused continuous "denied" messages in [[Qubes-Whonix]]. Correcting this issue was quite simple: <ref>This issue was fixed in the Whonix 14 release.</ref>

* Navigate to the [https://raw.githubusercontent.com/Whonix/whonixcheck/master/etc/apparmor.d/usr.bin.whonixcheck raw, updated whonixcheck profile].
* Replace the existing content in ''/etc/apparmor.d/usr.bin.whonixcheck'' with the updated github content, in both TemplateVMs <code>{{whonix-gw}}</code> and <code>{{whonix-ws}}</code>.
* Shut down both TemplateVMs and any running instances of <code>sys-whonix</code> and <code>anon-whonix</code>.
* Restart <code>sys-whonix</code> and <code>anon-whonix</code>.

== Inspecting and Disabling AppArmor Notifications ==

From Whonix 14, [https://packages.debian.org/stretch/apparmor-notify apparmor-notify] is no longer installed by default. This means desktop notifications will not appear concerning AppArmor denied messages, which are stored in ''/var/log/audit/audit.log'' <ref>To install it, run: <code>sudo apt-get update && sudo apt-get install apparmor-notify</code></ref> <ref>https://forums.whonix.org/t/whonix-14-debian-stretch-apparmor-related-changes/3563</ref> <ref>The Debian default location is ''/var/log/kern.log''</ref> 

=== Inspect Notifications ===

To inspect relevant logs, run.

{{Open with root rights|filename=
/var/log/audit/audit.log
}}

To show denied AppArmor messages of any age, run.

{{CodeSelect|code=
sudo cat /var/log/audit/audit.log {{!}} grep -i DENIED
}}

It is possible to keep watching the file as it is appended. This is useful for reproducing AppArmor denied messages and testing amended profiles.

{{CodeSelect|code=
sudo tail -f /var/log/audit/audit.log {{!}} grep --line-buffered DENIED
}}

=== Disable Notifications ===

If apparmor-notify is manually installed, then on occasion an application may be functional but AppArmor "denied" messages constantly appear. Rather than updating the relevant AppArmor profile(s), it is possible to disable notifications instead.

In the offending Whonix (App)VM, launch Konsole and run.

{{CodeSelect|code=
sudo killall aa-notify
}}

To revert this change, reboot the VM.

== More Profiles ==
It is possible to utilize profiles by other vendors, but this is unsupported by Whonix developers. As a reminder, it is not necessary to install AppArmor profiles for any applications that are unlikely to be used (such as dovecot). Additional options include:

* Debian has packages that can be [https://wiki.debian.org/AppArmor/HowToUse#Enable_.2F_install_more_profiles easily installed via the APT package manager]. 
* Ubuntu also [https://bazaar.launchpad.net/~apparmor-dev/apparmor-profiles/master/files/head:/ubuntu/16.10/ provides profiles]. It is not easy to download these as a package to be installed in Debian. Further, the profiles may or may not differ from (or complement) profiles listed earlier.

= Support =
* Need help? Visit the [https://forums.whonix.org/c/apparmor Whonix AppArmor Forum].
* [https://forums.whonix.org/t/profile-creation-advice/1127 Profile Creation Advice].

= Development =
* [https://forums.whonix.org/t/whonix-apparmor-profiles-development-discussion/108 Whonix AppArmor Profiles Development Discussion].
* [https://phabricator.whonix.org/tag/apparmor/ Open Tasks].

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]]
