{{Header}}
{{#seo:
|description=AppArmor profiles (Security Hardening) for Whonix and other Linux. Tor Browser and more soon.
|image=https://www.whonix.org/w/images/f/f1/Coat-of-mail-948960640.jpg
}}
__FORCETOC__

=== Introduction ===
[https://en.wikipedia.org/wiki/AppArmor AppArmor] profiles. For better security.

=== Installation ===
==== Introduction ====
{{mbox
| image      = [[File:Ambox_warning_pn.svg.png|40px|alt=Exterimental AppArmor Profile Warning]]
| text       = 
Testers only!
}}
<br />
{{mbox
| image   = [[File:Ambox_notice.png|40px|alt=Qubes-Whonix Note]]
| text       =
[[Qubes-Whonix]] users require some extra instructions for setting up AppArmor. [[Non-Qubes-Whonix]] users can skip this. ({{Non-Qubes-Whonix}})
}}
<br />
{{Qubes AppArmor}}

The profiles packages are available from [[Whonix-APT-Repository|Whonix's APT repository]].

{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = '''Tip:''' It is strongly recommended to switch to the Whonix {{Code2|testers}} repository before installing profiles. The profiles in the {{Code2|stable}} repository are much older and have some issues. Note that switching to the {{Code2|testers}} repository will also update other packages from that same repository [https://www.whonix.org/old-forum/index.php/topic,1548.0.html unless the user knows how to avoid this] (advanced users only).
}}


Enable Whonix's {{Code2|testers}} repository.

{{CodeSelect|code=
sudo whonix_repository --enable --repository testers
}}

In Whonix-Workstation as well as on Whonix-Gateway.

{{Update}}

{{CodeSelect|code=
sudo apt-get update
}}

==== If you want to install all of them ====
The easiest way to install all of them. You might end up with a few apparmor profiles for software that you have not installed, but then they don't have any effect, so it does not matter.
{{CodeSelect|code=
sudo apt-get install apparmor-profiles-whonix
}}

==== If you only want to install specific ones ====
<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
Click on expand on the right side.
<div class="mw-collapsible-content">
Profile for [[Tor Browser]]. Useful in Whonix-Workstation. <ref>Tor Browser is installed by [[Tor Browser#Update Tor Browser|tb-updater]], which comes installed by default in Whonix.</ref>
{{CodeSelect|code=
sudo apt-get install apparmor-profile-torbrowser
}}

Profile for [[Sdwdate|sdwdate]]. <ref>The network [[Dev/TimeSync|time sync]] is installed in Whonix by default.</ref> Useful for Whonix-Gateway and Whonix-Workstation.
{{CodeSelect|code=
sudo apt-get install apparmor-profile-sdwdate
}}

Profile for the [[HexChat]] [[Chat]] client. Useful in Whonix-Workstation.
{{CodeSelect|code=
sudo apt-get install apparmor-profile-xchat
}}

Profile for the [[E-Mail#Mozilla_Thunderbird_with_TorBirdy|Mozilla Thunderbird]] [[E-Mail]] client. Useful in Whonix-Workstation.
{{CodeSelect|code=
sudo apt-get install apparmor-profile-icedove
}}

Profile for [[whonixcheck]]. Useful for Whonix-Gateway and Whonix-Workstation.
{{CodeSelect|code=
sudo apt-get install apparmor-profile-whonixcheck
}}

Profile for [[VirtualBox]]. This is useful on the host, but there are no instructions for that yet. It is also useful if running VirtualBox inside VirtualBox.
{{CodeSelect|code=
sudo apt-get install apparmor-profile-virtualbox
}}
</div>
</div>

=== Profile Unloading ===
<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
{{mbox
| type      = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text       = '''Tip:''' Only complete these steps to disable an AppArmor profile.
}}
<br />
Click on expand on the right side.
<div class="mw-collapsible-content">
To view the list of all available profiles, run.
{{CodeSelect|code=
ls /etc/apparmor.d/
}}

Once the profile is loaded in the kernel, to remove it run.

{{CodeSelect|code=
sudo aa-disable /etc/apparmor.d/profile-name
}}

This command expects the profile file to exist. This means if the profile has been deleted manually or via apt-get purge, it can only be unloaded by rebooting.

The user must know the name of the specific profile to unload - refer to the [[#If you only want to install specific ones|list]] further above.
</div>
</div>

== Maintain a Functional Tor Browser ==

Tor Browser upgrades frequently break the Whonix AppArmor profile used to contain it. Even when AppArmor related fixes are confirmed in Phabricator, most often the packages are not made available to Whonix stable or even the developer version. This means manual profile fixes are required until [[About#Whonix_Version|the next Whonix version is released]].

At the time of writing, Tor Browser is non-functional with the available profile in the repositories. Advanced users can follow these steps to rectify the problem.

'''1. Open a terminal in Whonix-Workstation TemplateVM'''

<code>Whonix-WS TemplateVM</code> -> <code>Konsole</code>

'''2. List the available AppArmor profiles'''

{{CodeSelect|code=
ls /etc/apparmor.d/
}}

'''3. Edit the Tor Browser AppArmor profile'''

Note: change the name of the file to match whatever version is installed on the system.

{{CodeSelect|code=
sudo nano /etc/apparmor.d/home.*.tor-browser_*Browser.firefox
}}

'''4. Navigate to the Whonix Github resource for AppArmor'''

The latest git commits can be found [https://github.com/Whonix/apparmor-profile-torbrowser here].

Select <code>Code</code> -> <code>etc/apparmor.d</code> -> <code>home.tor-browser.firefox</code>

Cut and paste the profile text into the old Tor Browser profile which is open in nano. Save and exit.

'''5. Enforce the new Tor Browser profile'''

In the Whonix-Workstation TemplateVM, run.

{{CodeSelect|code=
sudo aa-enforce /etc/apparmor.d/home.*.tor-browser_*.Browser.firefox
}}

'''6. Shutdown Whonix-Workstation TemplateVM and any running instances of Whonix-Workstation AppVM'''

'''7. Restart the Whonix-Workstation AppVM'''

Launch Tor Browser. If everything has been applied correctly, Tor Browser will have full functionality. If the following AppArmor warning appears, it can be safely ignored.

<pre>Profile: /home/**/tor-browser*/Browser/firefox Operation: open Name: /dev/ Denied: r Logfile: /var/log/kern.log For more information, please see: https://wiki.ubuntu.com/DebuggingApparmor</pre>

To manually check AppArmor is really running and enforced, in a terminal run.

{{CodeSelect|code=
sudo aa-status
}}

The output should show the Tor Browser profile is loaded and in enforce mode.

== Killing AppArmor Notifications ==

If applications are functional, sometimes users will want to remove AppArmor denied notifications rather than update the AppArmor profiles. To do this, run the following command in Konsole in the offending Whonix (App)VM.

<pre>
sudo killall aa-notify
</pre>

To revert this change, run.

<pre>
sudo apt-get install --reinstall apparmor-notify
</pre>

Then reboot the VM.

== More Profiles ==
Users can also utilize profiles by other vendors, but this is unsupported by Whonix developers. It is not necessary to install an AppArmor profile for applications that will not be used. For example, it is unnecessary to install the dovecot AppArmor profile if it will never be run.

* Debian has packages that you can be easily installed from the apt repository - https://wiki.debian.org/AppArmor/HowToUse#Enable_.2F_install_more_profiles
* Ubuntu also provides profiles. These are not so easy to download as a package to be installed in Debian. The profiles may or may not differ or complement those profiles listed further above. http://bazaar.launchpad.net/~apparmor-dev/apparmor-profiles/master/files/head:/ubuntu/16.04/

== Support ==
* Need help? Go to [https://forums.whonix.org/c/apparmor Whonix AppArmor Forum].
* [https://forums.whonix.org/t/profile-creation-advice/1127 Profile Creation Advice]

== Development ==
* [https://forums.whonix.org/t/whonix-apparmor-profiles-development-discussion/108 Whonix AppArmor Profiles Development Discussion]
* [https://phabricator.whonix.org/tag/apparmor/ Open Tasks]

Whonix 14 and above:

https://forums.whonix.org/t/whonix-14-debian-stretch-apparmor-related-changes

{{CodeSelect|code=
sudo apt-get update && sudo apt-get install apparmor-notify
}}

{{CodeSelect|code=
kdesudo kwrite /var/log/audit/audit.log
}}

<!-- EDITORS NOTE: '{{!}}' is a magic word for '|'.-->
{{CodeSelect|code=
sudo cat /var/log/audit/audit.log {{!}} grep DENIED
}}

{{CodeSelect|code=
sudo tail -f /var/log/audit/audit.log {{!}} grep --line-buffered DENIED
}}

== Footnotes ==
<references/>

{{Footer}}

[[Category:Documentation]]
